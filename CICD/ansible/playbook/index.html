<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>PlayBook | 代码推演录</title><meta name="author" content="Aquarius"><meta name="copyright" content="Aquarius"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="1 YAML语言介绍YAML官方网站  ansible yaml 官网 1.1 YAML语法简介在单一文件第一行，用连续三个连字号”-“ 开始，还有选择性的连续三个点号( … )用来表示文件的结尾 次行开始正常写Playbook的内容，一般建议写明该Playbook的功能 使用#号注释代码 缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的 缩进不支持">
<meta property="og:type" content="article">
<meta property="og:title" content="PlayBook">
<meta property="og:url" content="https://aquapluto.github.io/CICD/ansible/playbook/">
<meta property="og:site_name" content="代码推演录">
<meta property="og:description" content="1 YAML语言介绍YAML官方网站  ansible yaml 官网 1.1 YAML语法简介在单一文件第一行，用连续三个连字号”-“ 开始，还有选择性的连续三个点号( … )用来表示文件的结尾 次行开始正常写Playbook的内容，一般建议写明该Playbook的功能 使用#号注释代码 缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的 缩进不支持">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://aquapluto.github.io/img/paper2.jpg">
<meta property="article:published_time" content="2025-09-13T10:07:48.000Z">
<meta property="article:modified_time" content="2025-09-13T13:29:55.452Z">
<meta property="article:author" content="Aquarius">
<meta property="article:tag" content="Ansible">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aquapluto.github.io/img/paper2.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "PlayBook",
  "url": "https://aquapluto.github.io/CICD/ansible/playbook/",
  "image": "https://aquapluto.github.io/img/paper2.jpg",
  "datePublished": "2025-09-13T10:07:48.000Z",
  "dateModified": "2025-09-13T13:29:55.452Z",
  "author": [
    {
      "@type": "Person",
      "name": "Aquarius",
      "url": "https://AquaPluto.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://aquapluto.github.io/CICD/ansible/playbook/"><link rel="preconnect" href="//unpkg.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://unpkg.com/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PlayBook',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/wave.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">138</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/software-manage/"><span>软件包管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/OOM/"><span>OOM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/swap/"><span>Swap分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/data-synchronization/"><span>数据的实时同步</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/mail/"><span>邮件服务</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/kernel-manage/"><span>内核和启动管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-lock/"><span>进程锁</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/queue/"><span>队列实现线程并发控制</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/MySQL/SQL/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/Redis/deploy/"><span>部署安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Tomcat/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>存储</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/conspect/"><span>存储概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/nfs/"><span>NFS</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/conspect/"><span>Docker概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/image/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/container/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/volume/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/network/"><span>网络管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/compose/"><span>Docker-Compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/conspect/"><span>镜像概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/dockerfile/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/build/"><span>构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/harbor/"><span>镜像仓库</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/management/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-cgroup/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-usage/"><span>监控容器真实的cpu使用率</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/containerd/"><span>Containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>K8s</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kubernetes概论</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/architecture/"><span>Kubernetes架构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/cri/"><span>容器运行时接口CRI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/list-watch/"><span>List-Watch机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/object/"><span>Kubernetes对象</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/namespace/"><span>Namespace</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/kubectl/"><span>kubectl命令</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>部署安装</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/explanation/"><span>部署说明</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/docker/"><span>基于docker部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/containerd/"><span>基于containerd部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/cluster/"><span>集群管理指南</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Pod</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/conspect/"><span>Pod概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/configuration/"><span>Pod的配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/schedule/"><span>Pod的调度</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/eviction/"><span>Pod的驱逐</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>控制器</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/introduce/"><span>控制器介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/deployment/"><span>Deployment</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/statefulset/"><span>StatefulSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/daemonset/"><span>DaemonSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/job-cronjob/"><span>Job和CronJob</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/HPA/"><span>HPA</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/operator/"><span>Operator</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务发现与负载均衡</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/service/"><span>Service</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/ingress/"><span>Ingress</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/coredns/"><span>CoreDNS</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/localdns/"><span>LocalDNS</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>数据存储持久化</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/csi/"><span>存储接口CSI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/pv-pvc/"><span>PV和PVC</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/storageclass/"><span>StorageClass</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/configmap-secret/"><span>ConfigMap和Secret</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>认证与鉴权体系</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/conspect/"><span>体系概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/kubeconfig/"><span>kubeconfig</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/user-account/"><span>User Account</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/service-account/"><span>Service Account</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/introduce/"><span>prometheus概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/query-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/indicators-remarked/"><span>指标重新打标</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/pushmanager/"><span>Pushmanager</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/cluster-ha/"><span>集群与高可用</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/ha/"><span>高可用架构</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/grafana/"><span>Grafana</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/streaming/"><span>基于流处理的可观测性架构</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/paper2.jpg);"><nav id="nav"><!-- 左侧博客信息区域--><span id="blog-info"><a class="nav-site-title" href="/"></a><a class="nav-page-title" href="/"><span class="site-name">PlayBook</span></a></span><!-- 新增的导航菜单容器（居中布局关键）--><div id="nav-menus-container"><!-- 菜单主体部分--><div id="menus"><!-- 菜单项--><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/software-manage/"><span>软件包管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/OOM/"><span>OOM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/swap/"><span>Swap分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/data-synchronization/"><span>数据的实时同步</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/mail/"><span>邮件服务</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/kernel-manage/"><span>内核和启动管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-lock/"><span>进程锁</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/queue/"><span>队列实现线程并发控制</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/MySQL/SQL/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/Redis/deploy/"><span>部署安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Tomcat/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>存储</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/conspect/"><span>存储概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/nfs/"><span>NFS</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/conspect/"><span>Docker概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/image/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/container/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/volume/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/network/"><span>网络管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/compose/"><span>Docker-Compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/conspect/"><span>镜像概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/dockerfile/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/build/"><span>构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/harbor/"><span>镜像仓库</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/management/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-cgroup/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-usage/"><span>监控容器真实的cpu使用率</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/containerd/"><span>Containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>K8s</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kubernetes概论</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/architecture/"><span>Kubernetes架构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/cri/"><span>容器运行时接口CRI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/list-watch/"><span>List-Watch机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/object/"><span>Kubernetes对象</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/namespace/"><span>Namespace</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/kubectl/"><span>kubectl命令</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>部署安装</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/explanation/"><span>部署说明</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/docker/"><span>基于docker部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/containerd/"><span>基于containerd部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/cluster/"><span>集群管理指南</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Pod</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/conspect/"><span>Pod概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/configuration/"><span>Pod的配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/schedule/"><span>Pod的调度</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/eviction/"><span>Pod的驱逐</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>控制器</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/introduce/"><span>控制器介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/deployment/"><span>Deployment</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/statefulset/"><span>StatefulSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/daemonset/"><span>DaemonSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/job-cronjob/"><span>Job和CronJob</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/HPA/"><span>HPA</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/operator/"><span>Operator</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务发现与负载均衡</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/service/"><span>Service</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/ingress/"><span>Ingress</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/coredns/"><span>CoreDNS</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/localdns/"><span>LocalDNS</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>数据存储持久化</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/csi/"><span>存储接口CSI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/pv-pvc/"><span>PV和PVC</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/storageclass/"><span>StorageClass</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/configmap-secret/"><span>ConfigMap和Secret</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>认证与鉴权体系</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/conspect/"><span>体系概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/kubeconfig/"><span>kubeconfig</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/user-account/"><span>User Account</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/service-account/"><span>Service Account</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/introduce/"><span>prometheus概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/query-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/indicators-remarked/"><span>指标重新打标</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/pushmanager/"><span>Pushmanager</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/cluster-ha/"><span>集群与高可用</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/ha/"><span>高可用架构</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/grafana/"><span>Grafana</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/streaming/"><span>基于流处理的可观测性架构</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><!-- 右侧功能区域（新增容器）--><div id="nav-right-container"><!-- 搜索按钮（移动到右侧）--><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></span></div><!-- 移动端汉堡菜单按钮--><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">PlayBook</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-13T10:07:48.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-13T13:29:55.452Z" title="更新于 2025-09-13 21:29">2025-09-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CICD/">CICD</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">9.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1-YAML语言介绍"><a href="#1-YAML语言介绍" class="headerlink" title="1 YAML语言介绍"></a>1 YAML语言介绍</h1><p><a target="_blank" rel="noopener" href="http://www.yaml.org/">YAML官方网站</a>  <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html">ansible yaml 官网</a></p>
<h2 id="1-1-YAML语法简介"><a href="#1-1-YAML语法简介" class="headerlink" title="1.1 YAML语法简介"></a>1.1 YAML语法简介</h2><p>在单一文件第一行，用连续三个连字号”-“ 开始，还有选择性的连续三个点号( … )用来表示文件的结尾</p>
<p>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</p>
<p>使用#号注释代码</p>
<p>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</p>
<p>缩进不支持tab，必须使用空格进行缩进</p>
<p>缩进的空格数不重要，只要相同层级的元素左对齐即可</p>
<p>YAML文件内容是区别大小写的，key&#x2F;value的值均需大小写敏感</p>
<p>多个key&#x2F;value可同行写也可换行写，同行使用，分隔</p>
<p>key后面冒号要加一个空格，比如 key: value</p>
<p>value可是个字符串，也可是另一个列表</p>
<p>YAML文件扩展名通常为yml或yaml</p>
<h2 id="1-2-支持的数据类型"><a href="#1-2-支持的数据类型" class="headerlink" title="1.2 支持的数据类型"></a>1.2 支持的数据类型</h2><p>YAML 支持以下常用几种数据类型：</p>
<ul>
<li>标量：单个的、不可再分的值</li>
<li>对象：键值对的集合，又称为: 字典（dictionary）&#x2F; 哈希（hashes） &#x2F; 映射（mapping）</li>
<li>数组：一组按次序排列的值，又称为: 列表（list）&#x2F; 序列（sequence）</li>
</ul>
<h3 id="1-2-1-scalar-标量"><a href="#1-2-1-scalar-标量" class="headerlink" title="1.2.1 scalar 标量"></a>1.2.1 scalar 标量</h3><p>key对应value</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name: wang</span><br><span class="line">age: 18</span><br></pre></td></tr></table></figure>

<p>使用缩进的方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name:</span><br><span class="line">  wang</span><br><span class="line">age:</span><br><span class="line">  18</span><br></pre></td></tr></table></figure>

<p>标量是最基本的，不可再分的值，包括：</p>
<ul>
<li>字符串</li>
<li>布尔值</li>
<li>整数</li>
<li>浮点数</li>
<li>Null</li>
<li>时间</li>
<li>日期</li>
</ul>
<h3 id="1-2-2-Dictionary-字典"><a href="#1-2-2-Dictionary-字典" class="headerlink" title="1.2.2 Dictionary 字典"></a>1.2.2 Dictionary 字典</h3><p>一个字典是由一个或多个key与value构成</p>
<p>key和value之间用冒号 ：分隔</p>
<p>冒号 : 后面有一个空格</p>
<p>所有 k&#x2F;v 可以放在一行，,每个 k&#x2F;v 之间用逗号分隔</p>
<p>所有每个 k&#x2F;v 也可以分别放在不同行,一对k&#x2F;v放在独立的一行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">account: &#123; name: wang, age: 30 &#125;</span><br></pre></td></tr></table></figure>

<p>使用缩进方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">account:</span><br><span class="line">  name: wang</span><br><span class="line">  age: 18</span><br><span class="line">  gender: male</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#不同行</span></span><br><span class="line"><span class="comment"># An employee record</span></span><br><span class="line">name: Example Developer</span><br><span class="line">job: Developer</span><br><span class="line">skill: Elite(社会精英)</span><br><span class="line"></span><br><span class="line"><span class="comment">#同一行,也可以将key:value放置于&#123;&#125;中进行表示，用,分隔多个key:value</span></span><br><span class="line"><span class="comment"># An employee record</span></span><br><span class="line">&#123;name: <span class="string">&quot;Example Developer&quot;</span>, job: <span class="string">&quot;Developer&quot;</span>, skill: <span class="string">&quot;Elite&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-3-List-列表"><a href="#1-2-3-List-列表" class="headerlink" title="1.2.3 List 列表"></a>1.2.3 List 列表</h3><p>列表由多个元素组成, 本质就是数组</p>
<p>每个元素放在不同行，每个元素一行,且元素前均使用中横线 - 开头，并且中横线 - 和元素之间有一个空格</p>
<p>也可以将所有元素用 [ ] 括起来放在同一行,每个元素之间用逗号分隔</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">course: [ linux , golang , python ]</span><br></pre></td></tr></table></figure>

<p>也可以写成以 - 开头的多行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">course:</span><br><span class="line">  - linux</span><br><span class="line">  - golang</span><br><span class="line">  - python</span><br></pre></td></tr></table></figure>

<p>元素里也可以包含字典</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">course:</span><br><span class="line">- linux: manjaro</span><br><span class="line">  price: 10000</span><br><span class="line">- golang: gin</span><br><span class="line">  class: 49</span><br><span class="line">- python: django</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#不同行,行以-开头,后面有一个空格</span></span><br><span class="line"><span class="comment"># A list of tasty fruits</span></span><br><span class="line">- Apple</span><br><span class="line">- Orange</span><br><span class="line">- Strawberry</span><br><span class="line">- Mango</span><br><span class="line"></span><br><span class="line"><span class="comment">#同一行</span></span><br><span class="line">[Apple,Orange,Strawberry,Mango]</span><br></pre></td></tr></table></figure>

<p>范例：YAML 表示一个家庭、</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">:#同一行</span><br><span class="line">name: John Smith</span><br><span class="line">age: 41</span><br><span class="line">gender: Male</span><br><span class="line">spouse: &#123; name: Jane Smith, age: 37, gender: Female &#125; </span><br><span class="line">children: [ &#123;name: Jimmy Smith,age: 17, gender: Male&#125;, &#123;name: Jenny Smith, age:13, gender: Female&#125;, &#123;name: hao Smith, age: 20, gender: Male &#125; ]</span><br><span class="line">  </span><br><span class="line"><span class="comment">#不同行</span></span><br><span class="line">name: John Smith</span><br><span class="line">age: 41</span><br><span class="line">gender: Male</span><br><span class="line">spouse:</span><br><span class="line">  name: Jane Smith  									</span><br><span class="line">  age: 37</span><br><span class="line">  gender: Female</span><br><span class="line">children: </span><br><span class="line">  - name: Jimmy Smith   												</span><br><span class="line">    age: 17</span><br><span class="line">    gender: Male</span><br><span class="line">  - &#123;name: Jenny Smith, age: 13, gender: Female&#125;</span><br><span class="line">  - &#123;name: hao Smith, age: 20, gender: Male &#125; </span><br></pre></td></tr></table></figure>

<h2 id="1-3-三种常见的数据格式"><a href="#1-3-三种常见的数据格式" class="headerlink" title="1.3 三种常见的数据格式"></a>1.3 三种常见的数据格式</h2><p>XML：Extensible Markup Language，可扩展标记语言，可用于数据交换和配置</p>
<p>JSON：JavaScript Object Notation, JavaScript 对象表记法，主要用来数据交换或配置，不支持注释</p>
<p>YAML：YAML Ain’t Markup Language YAML 不是一种标记语言， 主要用来配置，大小写敏感，不支持tab</p>
<p><img src="/CICD/ansible/playbook/1753696014178-9c28a875-1a05-4301-afe5-f271efb3d1cd.png" alt="img"></p>
<p>可以用工具互相转换，参考网站：</p>
<p><a target="_blank" rel="noopener" href="https://www.json2yaml.com/">https://www.json2yaml.com/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.bejson.com/json/json2yaml/">http://www.bejson.com/json/json2yaml/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.json.cn/">https://www.json.cn/</a></p>
<h1 id="2-Playbook命令"><a href="#2-Playbook命令" class="headerlink" title="2 Playbook命令"></a>2 Playbook命令</h1><p>格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook &lt;filename.yml&gt; ... [options]</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">OK=3 		  <span class="comment">#3个task 执行成功</span></span><br><span class="line">change=3      <span class="comment">#3个task 都导致了系统状态发生了改变，如果是查询类task，可以在playbook文件中加上 changed_when:false</span></span><br><span class="line">unreachable=0 <span class="comment">#0个task不可达</span></span><br><span class="line">failed=0      <span class="comment">#0个task执行失败</span></span><br><span class="line">skipped=0     <span class="comment">#跳过0个task</span></span><br><span class="line">rescued=0     <span class="comment">#0个task被拒绝执行</span></span><br><span class="line">ignored=0     <span class="comment">#忽略0个task</span></span><br></pre></td></tr></table></figure>

<p>选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--syntax,--syntax-check    				<span class="comment">#语法检查,功能相当于bash -n</span></span><br><span class="line">-C --check 								<span class="comment">#模拟执行dry run ,只检测可能会发生的改变，但不真正执行操作</span></span><br><span class="line">--list-hosts   							<span class="comment">#列出运行任务的主机</span></span><br><span class="line">--list-tags 							<span class="comment">#列出tag</span></span><br><span class="line">--list-tasks 							<span class="comment">#列出plabook中所有 task</span></span><br><span class="line">--<span class="built_in">limit</span> 主机列表 						 <span class="comment">#只针对主机列表中的特定主机执行</span></span><br><span class="line">-i INVENTORY, --inventory INVENTORY  	<span class="comment">#指定主机清单文件,通常一个项对应一个主机清单文件</span></span><br><span class="line">--start-at-task START_AT_TASK 			<span class="comment">#从指定task开始执行,而非从头开始,START_AT_TASK为任务的name</span></span><br><span class="line">-v -vv  -vvv 							<span class="comment">#显示过程</span></span><br><span class="line">-k|--ask-pass 							<span class="comment">#远程连接密码</span></span><br><span class="line">-T|--<span class="built_in">timeout</span> 							<span class="comment">#连接超时时长，默认10S</span></span><br><span class="line">-e|--extra-vars 						<span class="comment">#定义变量</span></span><br><span class="line">--become-user 							<span class="comment">#以指定用户执行</span></span><br><span class="line">--flush-cache 							<span class="comment">#刷新facts</span></span><br><span class="line">-skip-tags 								<span class="comment">#跳过指定的tags</span></span><br><span class="line">-t|--tags 								<span class="comment">#只执行特定tag对应的task</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky86 ~]# <span class="built_in">cat</span> hello.yaml</span><br><span class="line">--- <span class="comment"># this is test playbook</span></span><br><span class="line">- hosts: group3 						<span class="comment">#指定主机分组</span></span><br><span class="line">  gather_facts: no 						<span class="comment">#不收集主机信息</span></span><br><span class="line">  remote_user: root 					<span class="comment">#远程执行用户</span></span><br><span class="line">  tasks: 								<span class="comment">#task列表</span></span><br><span class="line">  	- name: task-cmd 					<span class="comment">#task名称</span></span><br><span class="line">      <span class="built_in">command</span>: <span class="built_in">echo</span> <span class="string">&quot;hello ansible&quot;</span> 	<span class="comment">#具体执行的模块和参数</span></span><br><span class="line">  </span><br><span class="line">  	- name: task-shell 					<span class="comment">#task名称</span></span><br><span class="line">      shell: <span class="built_in">id</span> 						<span class="comment">#具体执行的模块和参数</span></span><br><span class="line">      remote_user: tom 					<span class="comment">#指定模块的执行用户</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">#语法检查</span></span><br><span class="line">[root@ubuntu ~]# ansible-playbook --syntax-check hello.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#模拟执行</span></span><br><span class="line">[root@ubuntu ~]# ansible-playbook -C hello.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#只在指定主机上执行</span></span><br><span class="line">[root@ubuntu ~]# ansible-playbook -C hello.yaml -l 10.0.0.150</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出所有主机</span></span><br><span class="line">[root@ubuntu ~]# ansible-playbook hello.yaml --list-hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出所有tag</span></span><br><span class="line">[root@ubuntu ~]# ansible-playbook hello.yaml --list-tags</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出所有task</span></span><br><span class="line">[root@ubuntu ~]# ansible-playbook hello.yaml --list-tasks</span><br></pre></td></tr></table></figure>

<h1 id="3-Playbook概念"><a href="#3-Playbook概念" class="headerlink" title="3 Playbook概念"></a>3 Playbook概念</h1><p>在 ansible 中，较简单的任务，我们可以直接调用单个模块来完成，但是，如果遇到复杂的需求，需要调用大量模块才能完成一个需求，或多个任务间有依赖的时候，使用单条命令就特别不方便，这种情况下，我们就可以使用 playbook 来实现这种需求</p>
<p>在 ansible 中，我们写好 playbook，服务器作演员，由服务器根据我们编排的剧本，完成环境安装，服务部署，系统搭建，状态检测等各种各样的功能。</p>
<p><strong>playbook 文件规范</strong></p>
<ul>
<li>扩展名为 yaml 或 yml</li>
<li>第一行用 <code>“---”</code> (英文输入法下的中划线) 表示 yaml 的开始，一般不写，如果有多个 yaml 文件合并，则可用此标识每个 yaml 文件内容，使用 <code>#</code> 作为注释</li>
<li>大小写敏感</li>
<li>缩进符要统一，用空格键缩进，不要用 tab</li>
<li>缩进空格的数量不重要，但是，相同层级的左边缩进，要保持一致，要对齐，就是说，同样的缩进，代表同样的级别</li>
<li>使用 <code>“-”(英文输入法下的中划线)+一个空格</code> 来表示单个列表项</li>
<li>使用 <code>”:”(冒号)+空格</code> 来表示一个键值对</li>
<li>使用 <code>“&#123;&#125;”(花括号)</code>  来表示一个键值表</li>
<li><strong>一个 name 只能有一个 task</strong></li>
</ul>
<h1 id="4-Playbook组成"><a href="#4-Playbook组成" class="headerlink" title="4 Playbook组成"></a>4 Playbook组成</h1><ul>
<li>一个 playbook(剧本)文件是一个YAML语言编写的文本文件</li>
<li>通常一个playbook只包括一个play，但可以包括多个Play</li>
<li>一个play的主要包括两部分: 主机和tasks. 即实现在指定一组主机上执行一个tasks定义好的任务列表。</li>
<li>一个tasks中可以有一个或多个task任务</li>
<li>每一个Task本质上就是调用ansible的一个module</li>
<li>在复杂场景中，一个playbook中也可以包括多个play，实现对多组不同的主机执行不同的任务</li>
</ul>
<h1 id="5-Playbook组件"><a href="#5-Playbook组件" class="headerlink" title="5 Playbook组件"></a>5 Playbook组件</h1><p>playbook 是由一个或多个 “play” 组成的列表。playbook 的主要功能在于，将多个 play 组织在一个playbook 文件中，让多台预定义的主机按照 playbook 中编排的内容来完成一系列复杂的功能。一个 playbook 至少要包含 name 和 tasks 两部份。</p>
<h2 id="5-1-hosts组件"><a href="#5-1-hosts组件" class="headerlink" title="5.1 hosts组件"></a>5.1 hosts组件</h2><p>Hosts：playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机列表，须事先定义在主机清单中，其值可以是通配符，主机或组，可以用 <code>-i</code> 选项指定自定义的主机清单文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.206</span> 			<span class="comment">#IP写法</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.1</span><span class="string">.*</span>			<span class="comment">#通配符</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node.linux-magedu.com</span> 	<span class="comment">#主机名写法</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">group1</span> 				<span class="comment">#分组写法</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">group1:group2</span> 			<span class="comment">#分组写法，或者关系，两个分组并集</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">group1:&amp;group2</span> 		<span class="comment">#分组写法，与关系，两个分组交集</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">group1:!group2</span> 		<span class="comment">#分组写法，非关系，两个分组差集</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2-tasks列表和task组件"><a href="#5-2-tasks列表和task组件" class="headerlink" title="5.2 tasks列表和task组件"></a>5.2 tasks列表和task组件</h2><p>tasks：定义要在远程主机上执行的任务列表，play的主体部分，各任务按顺序在 hosts 中指定的主机上执行，即<strong>所有主机做完当前任务，才会开始下一个任务</strong>。</p>
<p>task：执行指定模块，后面跟上预定的参数，参数中可以使用变量。每个task是一个字典，一个完整的代码块功能需最少元素需包括 name 和 task，一个name只能包括一个task</p>
<ul>
<li>模块的执行是幂等的，这意味着多次执行是安全的，因为其结果均一致，如果在执行过程中发生错误，则会全部回滚（包括前面己执行成功的）</li>
<li>每个 task 都应该定义name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤</li>
<li>如果没有指定 name ，则 action 的结果将用于输出</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">group</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">id</span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-remote-user组件"><a href="#5-3-remote-user组件" class="headerlink" title="5.3 remote_user组件"></a>5.3 remote_user组件</h2><p>remote_user：指定任务在远程主机上执行时所使用的用户，可以是任意用户，前提是用户是存在的，默认 root</p>
<ul>
<li>可用于 Host 和 task 中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用 sudo_user 指定sudo时切换的用户</li>
<li>可以全局指定，也可以在特定 task 中指定，切换用户执行需要先完成登录校验或者用 -k 选项手动输入ssh 密码</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">group1</span> 			<span class="comment">#指定主机分组</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span> 			<span class="comment">#不收集主机信息</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">tom</span> 			<span class="comment">#全局设置远程执行用户</span></span><br><span class="line">  <span class="attr">tasks:</span> 					<span class="comment">#task列表</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task1</span> 			<span class="comment">#task名称,此task以tom身份认行</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">id</span> 			<span class="comment">#具体执行的模块和参数</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task2</span> 			<span class="comment">#task名称,此task以jerry身份连接主机执行</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">id</span> 			<span class="comment">#具体执行的模块和参数  </span></span><br><span class="line">      <span class="attr">remote_user:</span> <span class="string">jerry</span></span><br><span class="line">  </span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task3</span> 			<span class="comment">#task名称,此task以jerry身份运行sudo到root执行</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">id</span> 			<span class="comment">#具体执行的模块和参数  </span></span><br><span class="line">        <span class="attr">remote_user:</span> <span class="string">jerry</span></span><br><span class="line">        <span class="attr">sudo:</span> <span class="literal">yes</span>				<span class="comment">#默认sudo为root</span></span><br><span class="line">  </span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task4</span> 			<span class="comment">#task名称,此task以jerry身份运行sudo到tom执行</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">id</span> 			<span class="comment">#具体执行的模块和参数  </span></span><br><span class="line">         <span class="attr">remote_user:</span> <span class="string">jerry</span></span><br><span class="line">        <span class="attr">sudo:</span> <span class="literal">yes</span> 			<span class="comment">#默认sudo为root</span></span><br><span class="line">        <span class="attr">sudo_user:</span> <span class="string">tom</span>		<span class="comment">#sudo为tom</span></span><br></pre></td></tr></table></figure>

<h2 id="5-4-ignore-errors组件"><a href="#5-4-ignore-errors组件" class="headerlink" title="5.4 ignore_errors组件"></a>5.4 ignore_errors组件</h2><p>在同一个 playbook中，如果一个task出错，默认将不会继续执行后续的其它 task</p>
<p>利用 <code>ignore_errors: yes</code> 可以忽略此task的错误,继续向下执行playbook其它 task，此项也可以配置为全局选项</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">group</span></span><br><span class="line">  <span class="attr">ignore_errors:</span> <span class="literal">yes</span>  <span class="comment"># 全局配置</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task-1</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">id1</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">yes</span>  <span class="comment"># 忽略此task的错误</span></span><br></pre></td></tr></table></figure>

<h2 id="5-5-handlers和notify组件"><a href="#5-5-handlers和notify组件" class="headerlink" title="5.5 handlers和notify组件"></a>5.5 handlers和notify组件</h2><p>notify 和 handlers：配合使用，某任务的状态在运行后为changed时，可通过”notify”通知给相应的 handlers 任务，可以达到一种触发调用的效果，(类似于函数调用或触发器)，由特定条件触发的操作，满足条件方才执行，否则不执行</p>
<ul>
<li>handlers本质上也是 tasks，其中的 task 与前述的 task 并没有本质上的不同，只不过 handlers 中定义的 task，不会主动执行，只有notify关注的资源（task）发生变化时， notify去通知相应的handelrs，才会调用handler中定义的 task，没有改变则不会触发handlers</li>
<li>handers中的 task，是在playbook的 tasks 中所有的 task 都执行完成之后才调用，就算多个task触发了相同的handlers， 此handlers也仅会在所有task结束后运行一次，这样是为了避免多次触发同一个hander</li>
<li>handlers是在所有前面的 tasks 都成功执行才会执行，如果前面任何一个task失败，会导致handler跳过执行</li>
</ul>
<p>范例：当文件发生变化时，重启服务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">rocky</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=/root/nginx_v2/linux.magedu.com.conf</span> <span class="string">dest=/etc/nginx/conf.d/</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">service</span> 	<span class="comment">#当配置文件发生了变化时,通知重启服务,与handlers的name相匹配</span></span><br><span class="line">  <span class="attr">handlers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">service</span></span><br><span class="line">       <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>

<p>在 task 中使用 notify 来调用 handlers 中的任务，如果该 task 执行成功，但在该 task 之后的其它 task 执行失败，则会导致 notify 通知的 handlers 中的任务不会被调用，如果不论后面的task成功与否，都希望handlers能执行, 可以使用 <code>force_handlers: yes</code> 强制执行handler</p>
<p>force_handlers 是以整个 playbook 的角度来理解的，在 playbook 中，如果有 task 执行失败，那整个 playbook 也执行失败，就算后面有task，也不会继续执行，那么对应的handler也就不会执行了，所以force_handlers保证的是己成功执行的 task 对应的 handlers 一定会被执行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">force_handlers:</span> <span class="literal">yes</span>  <span class="comment">#force_handlers 可以保证handlers-1被执行，因为task-1任务执行成功</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task-1</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;task-1&quot;</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">handlers-1</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task-2</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echoooooo</span> <span class="string">&quot;task-2&quot;</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">handlers-2</span>  <span class="comment">#task-2执行失败，handlers-2不会执行</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task-3</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;task-3&quot;</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">handlers-3</span>  <span class="comment">#因为task-2执行失败，playbook不会继续执行task-3，所以不论成功与否，handers-3都不会执行</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">handlers-1</span></span><br><span class="line">    <span class="attr">debug:</span> <span class="string">msg=&quot;handlers-1&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">handlers-2</span></span><br><span class="line">    <span class="attr">debug:</span> <span class="string">msg=&quot;handlers-2&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">handlers-3</span></span><br><span class="line">    <span class="attr">debug:</span> <span class="string">msg=&quot;handlers-3&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-6-tags组件"><a href="#5-6-tags组件" class="headerlink" title="5.6 tags组件"></a>5.6 tags组件</h2><p>tags：还可以通过”tags”给 task 打标签，可在ansible-playbook命令上使用 <code>-t</code> 指定进行调用，定义哪些代码内容可以被忽略。ansible虽然具有幂等性，会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags执行特定的 task</p>
<ul>
<li>可以一个task对应多个tag，也可以多个task对应同一个tag</li>
<li>还有另外3个特殊关键字用于标签，tagged，untagged 和 all，tagged 表示所有被 tag 标记的任务，untagged 表示所有没有被标记的任务，all 表示所有任务。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">copy:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">files/httpd.conf</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/httpd/conf/</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">conf</span></span><br></pre></td></tr></table></figure>

<h1 id="6-Variables变量"><a href="#6-Variables变量" class="headerlink" title="6 Variables变量"></a>6 Variables变量</h1><p>Playbook中同样也支持变量，通过 variables 定义 playbook 运行时需要的使用的变量，有多种定义方式，内置变量或自定义变量</p>
<ul>
<li>变量名：仅能由字母、数字和下划线组成，区分大小写，且只能以字母开头</li>
<li>变量定义：<code>variable=value</code> 或 <code>variable: value</code></li>
<li>变量调用方式：通过 <code>&#123;&#123; variable_name &#125;&#125;</code> 调用变量，且变量名前后建议加空格，有时用 <code>&quot;&#123;&#123; variable_name &#125;&#125;&quot;</code> 才生效</li>
</ul>
<p>变量优先级（从高到低））：<code>-e 选项定义变量 --&gt; playbook中vars_files --&gt; playbook中vars变量定义 --&gt; host_vars/主机名文件 --&gt; 主机清单中主机变量--&gt; group_vars/主机组名文件 --&gt; group_vars/all文件 --&gt; 主机清单组变量</code></p>
<h2 id="6-1-使用-setup-模块中变量"><a href="#6-1-使用-setup-模块中变量" class="headerlink" title="6.1 使用 setup 模块中变量"></a>6.1 使用 setup 模块中变量</h2><p>setup：默认会自动调用的模块，获取远程主机的一些信息都是放在 facts 变量中的，在playbook中，可以直接使用 gather_facts 选项来获得目标主机的信息，默认是yes</p>
<p>facts中所有可用变量请参考官方文档：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_vars_facts.html#id3">ansible_facts</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">rocky</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show-facts</span></span><br><span class="line">    <span class="attr">debug:</span> <span class="string">msg=&#123;&#123;</span> <span class="string">ansible_facts</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show-facts-hostname</span></span><br><span class="line">    <span class="attr">debug:</span> <span class="string">msg=&#123;&#123;</span> <span class="string">ansible_hostname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show-facts-ipv4-A</span></span><br><span class="line">    <span class="attr">debug:</span> <span class="string">msg=&#123;&#123;</span> <span class="string">ansible_facts[&quot;eth0&quot;][&quot;ipv4&quot;][&quot;address&quot;]</span> <span class="string">&#125;&#125;--&#123;&#123;</span> <span class="string">ansible_facts.eth0.ipv4.address</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show-facts-ipv4-B</span></span><br><span class="line">    <span class="attr">debug:</span> <span class="string">msg=&#123;&#123;</span> <span class="string">ansible_eth0[&quot;ipv4&quot;][&quot;address&quot;]</span> <span class="string">&#125;&#125;--&#123;&#123;</span> <span class="string">ansible_eth0.ipv4.address</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show-facts-ipv4-C</span></span><br><span class="line">    <span class="attr">debug:</span> <span class="string">msg=&#123;&#123;</span> <span class="string">ansible_default_ipv4[&quot;address&quot;]</span> <span class="string">&#125;&#125;--&#123;&#123;</span> <span class="string">ansible_default_ipv4.address</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>每次执行playbook，默认会收集每个主机的所有facts变量，每次执行都需要消耗一定的资源和时间，在不需要facts变量时可以禁用该项 <code>gather_facts: no</code> 来加快 playbook 的执行效率。</p>
<p>如果又需要使用 facts 中的内容，还希望执行的速度快，这时候可以设置 facts 的缓存，可以在 ansible 的配置文件中设置在本地做缓存，也可以将 facts 变量信息存在 redis 服务器中，以便在频繁执行时减少资源消耗</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">gathering=smart|implicit|explicit 		  <span class="comment">#facts策略，默认smart，新版默认implicit</span></span><br><span class="line">fact_caching_timeout=86400 			      <span class="comment">#本地缓存时长，默认86400S</span></span><br><span class="line">fact_caching=memeory|jsonfile|redis 	  <span class="comment">#缓存类型，默认memory</span></span><br><span class="line">fact_caching_connection=/path|REDIS       <span class="comment">#缓存路径或redis信息</span></span><br></pre></td></tr></table></figure>

<p>gathering 参数说明</p>
<ul>
<li>smart：远程主机信息如果有本地缓存，则使用缓存，如果没有，就去抓取，再存到缓存中，下次就直接使用缓存信息</li>
<li>implicit：不使用缓存，每次都抓取新的，可以使用 gather_facts: no 来限制不去抓取新的</li>
<li>explicit：不收集主机信息，除非在playbook中用 gather_facts: yes 显式指定</li>
</ul>
<p>fact_caching 参数说明</p>
<ul>
<li>memeory：只在当前有效，下次还是要重新抓取</li>
<li>jsonfile：本地缓存，<code>fact_caching_connection</code> 需要指定本地缓存路径</li>
<li>redis：使用 redis 缓存，<code>fact_caching_connection</code> 的格式为 <code>REDIS_IP:REDIS_PORT:REDIS_DB_NUMBER[:REDIS_PASSWORD]</code></li>
</ul>
<h2 id="6-2-register注册变量"><a href="#6-2-register注册变量" class="headerlink" title="6.2 register注册变量"></a>6.2 register注册变量</h2><p>在playbook中可以使用register将捕获命令的输出保存在临时变量中，方便后续调用此变量，比如可以使用debug模块进行显示输出</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">dbsrvs</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span> <span class="string">variable</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">hostname</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">name</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;print variable&quot;</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; name &#125;&#125;</span>&quot;</span>          		 <span class="comment">#输出register注册的name变量的全部信息,注意变量要加&quot; &quot;引起来</span></span><br><span class="line">      <span class="comment">#msg: &quot;&#123;&#123; name.cmd &#125;&#125;&quot;       		 #显示命令</span></span><br><span class="line">      <span class="comment">#msg: &quot;&#123;&#123; name.rc &#125;&#125;&quot;       		 #显示命令成功与否，相当于$?</span></span><br><span class="line">      <span class="comment">#msg: &quot;&#123;&#123; name.stdout &#125;&#125;&quot;     	 #显示命令的输出结果为字符串形式,所有结果都放在一行里显示,适合于结果是单行输出</span></span><br><span class="line">      <span class="comment">#msg: &quot;&#123;&#123; name.stdout_lines &#125;&#125;&quot;  	 #显示命令的输出结果为列表形式,逐行标准输出,适用于多行显示</span></span><br><span class="line">      <span class="comment">#msg: &quot;&#123;&#123; name[&#x27;stdout_lines&#x27;] &#125;&#125;&quot; #显示命令的执行结果为列表形式,和效果上面相同</span></span><br><span class="line">      <span class="comment">#msg: &quot;&#123;&#123; name.stdout_lines[0] &#125;&#125;&quot; #显示命令的输出结果的列表中的第一个元素</span></span><br></pre></td></tr></table></figure>

<p>范例：修改主机名形式为 web_&lt;随机字符&gt;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">generate</span> <span class="string">random</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">openssl</span> <span class="string">rand</span> <span class="string">-base64</span> <span class="number">12</span> <span class="string">|</span> <span class="string">tr</span> <span class="string">-dc</span> <span class="string">&#x27;[:alnum:]&#x27;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">num</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">random</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; num &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">change</span> <span class="string">hostname</span></span><br><span class="line">    <span class="attr">hostname:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">web-&#123;&#123;</span> <span class="string">num.stdout</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-3-在playbook命令行中定义变量"><a href="#6-3-在playbook命令行中定义变量" class="headerlink" title="6.3 在playbook命令行中定义变量"></a>6.3 在playbook命令行中定义变量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#直接在命令行中指定  </span></span><br><span class="line">[root@ubuntu ~]# ansible-playbook -e <span class="built_in">uname</span>=tom -e age=18 -e gender=M var1.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#多个变量一次定义</span></span><br><span class="line">[root@ubuntu ~]# ansible-playbook -e <span class="string">&quot;uname=tom age=18 gender=M&quot;</span> var1.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#从文件中读取</span></span><br><span class="line">[root@ubuntu ~]# <span class="built_in">cat</span> var.txt</span><br><span class="line"><span class="built_in">uname</span>: jerry</span><br><span class="line">age: 20</span><br><span class="line">gender: F</span><br><span class="line"></span><br><span class="line"><span class="comment">#文件前面要加 @</span></span><br><span class="line">[root@ubuntu ~]# ansible-playbook -e <span class="string">&quot;@/root/var.txt&quot;</span> var1.yaml</span><br><span class="line">[root@ubuntu ~]# ansible-playbook -e <span class="string">&quot;@./var.txt&quot;</span> var1.yaml</span><br></pre></td></tr></table></figure>

<h2 id="6-4-在playbook文件中定义变量"><a href="#6-4-在playbook文件中定义变量" class="headerlink" title="6.4 在playbook文件中定义变量"></a>6.4 在playbook文件中定义变量</h2><p>此方式定义的是私有变量，即只能在当前playbook中使用，不能被其它Playbook共用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">user1</span></span><br><span class="line">    <span class="attr">groupname:</span> <span class="string">group1</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span> &#123;&#123; <span class="string">groupname</span> &#125;&#125;</span><br><span class="line">    <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">groupname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span> &#123;&#123; <span class="string">username</span> &#125;&#125;</span><br><span class="line">    <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">username</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">groupname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br></pre></td></tr></table></figure>

<p>范例：变量的相互调用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">&quot;txt&quot;</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ansible_nodename &#125;&#125;</span>.<span class="template-variable">&#123;&#123;suffix&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">var</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">path=&quot;/data/&#123;&#123;file&#125;&#125;&quot;</span> <span class="string">state=touch</span></span><br></pre></td></tr></table></figure>

<h2 id="6-5-playbook公共的变量文件"><a href="#6-5-playbook公共的变量文件" class="headerlink" title="6.5 playbook公共的变量文件"></a>6.5 playbook公共的变量文件</h2><p>可以在一个独立的 yaml 文件中定义公共变量，在其它的playbook文件中可以引用变量文件中的变量</p>
<p>此方式比playbook中定义的变量优化级高</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment">#cat vars.yml</span></span><br><span class="line"><span class="attr">var1:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">var2:</span> <span class="string">nginx</span></span><br><span class="line">   </span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment">#cat var.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars.yml</span>  <span class="comment"># 可以使用相对路径和绝对路径的写法</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">httpd</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">name=/app/&#123;&#123;</span> <span class="string">var1</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">nginx</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">name=/app/&#123;&#123;</span> <span class="string">var2</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span></span><br></pre></td></tr></table></figure>

<h2 id="6-6-在主机清单中定义主机和主机组的变量"><a href="#6-6-在主机清单中定义主机和主机组的变量" class="headerlink" title="6.6 在主机清单中定义主机和主机组的变量"></a>6.6 在主机清单中定义主机和主机组的变量</h2><p>主机变量：在 inventory 主机清单文件中为指定的主机定义变量以便于在playbook中使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">www1.wang.org http_port=80 maxRequestsPerChild=808</span><br><span class="line">www2.wang.org http_port=8080 maxRequestsPerChild=909</span><br></pre></td></tr></table></figure>

<p>主机组变量：在inventory 主机清单文件中赋予给指定组内所有主机上的在playbook中可用的变量，如果和主机变量是同名，优先级低于主机变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">10.0.0.8 </span><br><span class="line">10.0.0.18</span><br><span class="line"></span><br><span class="line">[webservers:vars]	<span class="comment"># webservers组所拥有</span></span><br><span class="line">ntp_server=ntp.wang.org</span><br><span class="line">nfs_server=nfs.wang.org</span><br><span class="line"></span><br><span class="line">[all:vars]	<span class="comment"># 所有主机所拥有</span></span><br><span class="line">ntp_server=ntp.wang.org</span><br><span class="line">nfs_server=nfs.wang.org</span><br></pre></td></tr></table></figure>

<h2 id="6-7-针对当前项目的主机和主机组的变量"><a href="#6-7-针对当前项目的主机和主机组的变量" class="headerlink" title="6.7 针对当前项目的主机和主机组的变量"></a>6.7 针对当前项目的主机和主机组的变量</h2><p>上面的方式是针对所有项目都有效，而官方更建议的方式是使用ansible特定项目的主机变量和组变量</p>
<p>生产建议在每个项目对应的目录中创建额外的两个变量目录，分别是host_vars和group_vars</p>
<ul>
<li>host_vars下面的文件名和主机清单主机名一致，针对单个主机进行变量定义<ul>
<li>格式：host_vars&#x2F;hostname</li>
</ul>
</li>
<li>group_vars下面的文件名和主机清单中组名一致，针对单个组进行变量定义<ul>
<li>格式：group_vars&#x2F;groupname</li>
</ul>
</li>
<li>group_vars&#x2F;all 文件内定义的变量对所有组都有效</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@ubuntu</span> <span class="string">~</span>]<span class="comment">#cat hostname.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">change</span> <span class="string">hostname</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">name=web-&#123;&#123;</span> <span class="string">id</span> <span class="string">&#125;&#125;.&#123;&#123;</span> <span class="string">domain</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      </span><br><span class="line">[<span class="string">root@ubuntu</span> <span class="string">~</span>]<span class="comment">#cat /etc/ansible/hosts</span></span><br><span class="line">[<span class="string">webserver</span>]</span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span><span class="number">.8</span></span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span><span class="number">.18</span></span><br><span class="line"></span><br><span class="line">[<span class="string">appserver</span>]</span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span><span class="number">.28</span></span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span><span class="number">.38</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@ubuntu</span> <span class="string">~</span>]<span class="comment">#cat host_vars/10.0.0.8</span></span><br><span class="line"><span class="attr">id:</span> <span class="number">8</span></span><br><span class="line">[<span class="string">root@ubuntu</span> <span class="string">~</span>]<span class="comment">#cat host_vars/10.0.0.18</span></span><br><span class="line"><span class="attr">id:</span> <span class="number">18</span></span><br><span class="line">[<span class="string">root@ubuntu</span> <span class="string">~</span>]<span class="comment">#cat host_vars/10.0.0.28</span></span><br><span class="line"><span class="attr">id:</span> <span class="number">28</span></span><br><span class="line">[<span class="string">root@ubuntu</span> <span class="string">~</span>]<span class="comment">#cat host_vars/10.0.0.38</span></span><br><span class="line"><span class="attr">id:</span> <span class="number">38</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@ubuntu</span> <span class="string">~</span>]<span class="comment">#cat group_vars/webserver</span></span><br><span class="line"><span class="attr">domain:</span> <span class="string">wang.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#不属于webserver组的使用</span></span><br><span class="line">[<span class="string">root@ubuntu</span> <span class="string">~</span>]<span class="comment">#cat group_vars/all</span></span><br><span class="line"><span class="attr">domain:</span> <span class="string">wu.org</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@ubuntu</span> <span class="string">~</span>]<span class="comment">#ansible-playbook hostname.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#最终结果是</span></span><br><span class="line">[<span class="string">root@10.0.0.8</span> <span class="string">~</span>]<span class="comment">#hostname</span></span><br><span class="line"><span class="string">web-8.wang.org</span></span><br><span class="line">[<span class="string">root@10.0.0.18</span> <span class="string">~</span>]<span class="comment">#hostname</span></span><br><span class="line"><span class="string">web-18.wang.org</span></span><br><span class="line">[<span class="string">root@10.0.0.28</span> <span class="string">~</span>]<span class="comment">#hostname</span></span><br><span class="line"><span class="string">web-28.wu.org</span></span><br><span class="line">[<span class="string">root@10.0.0.38</span> <span class="string">~</span>]<span class="comment">#hostname</span></span><br><span class="line"><span class="string">web-38.wu.org</span></span><br></pre></td></tr></table></figure>

<h1 id="7-Templates模板"><a href="#7-Templates模板" class="headerlink" title="7 Templates模板"></a>7 Templates模板</h1><p>templates：模板模块，配合变量使用的模板文件，可以实现批量执行时，在不同主机上用同一个模板生成不同配置文件的功能，可替换模板文件中的变量并实现一些简单逻辑的文件，用于根据每个主机的不同环境而为生成不同的文件。模板文件中支持嵌套jinja2语言的指令，来实现变量、条件判断、循环等功能。</p>
<p>template文件建议存放在和 playbook 文件同级目录的 templates 目录下，且以 <code>.j2</code> 结尾，这样在 playbook 中使用模板文件时，就不需要指定模板文件的路径了。</p>
<p>范例：利用template生成不同的nginx配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment">#mkdir templates</span></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment">#vim templates/nginx.conf.j2</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">worker_processes</span> &#123;&#123; <span class="string">ansible_processor_vcpus*2</span> &#125;&#125;<span class="string">;</span>  <span class="comment">#根据不同主机的CPU核数生成不同的配置</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">~</span>]<span class="comment">#vim temnginx.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=nginx</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">config</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">hosts</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span>	</span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<p>template中也可以使用流程控制 for 循环和 if 条件判断，实现动态生成文件功能</p>
<p>for 循环格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> i <span class="keyword">in</span> EXPR %&#125;</span><br><span class="line">    ...</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>if 条件判断格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#单分支</span></span><br><span class="line">&#123;% <span class="keyword">if</span> EXPR %&#125;</span><br><span class="line">...</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#双分支</span></span><br><span class="line">&#123;% <span class="keyword">if</span> EXPR %&#125;</span><br><span class="line">...</span><br><span class="line">&#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">...</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#多分支</span></span><br><span class="line">&#123;% <span class="keyword">if</span> EXPR %&#125;</span><br><span class="line">...</span><br><span class="line">&#123;% <span class="keyword">elif</span> EXPR %&#125;</span><br><span class="line">...</span><br><span class="line">&#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">...</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>playbook 文件  <code>templnginx5.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">nginx_vhosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">listen:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">root:</span> <span class="string">&quot;/var/www/nginx/web1/&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">listen:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">server_name:</span> <span class="string">&quot;web2.wang.org&quot;</span></span><br><span class="line">      <span class="attr">root:</span> <span class="string">&quot;/var/www/nginx/web2/&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">listen:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">server_name:</span> <span class="string">&quot;web3.wang.org&quot;</span></span><br><span class="line">      <span class="attr">root:</span> <span class="string">&quot;/var/www/nginx/web3/&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">nginx.conf5.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/data/nginx5.conf</span></span><br></pre></td></tr></table></figure>

<p>模版文件 <code>templates/nginx.conf5.j2</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> vhost <span class="keyword">in</span> nginx_vhosts %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen &#123;&#123; vhost.listen &#125;&#125;;</span><br><span class="line">  &#123;% <span class="keyword">if</span> vhost.server_name <span class="keyword">is</span> defined %&#125;</span><br><span class="line">server_name &#123;&#123; vhost.server_name &#125;&#125;;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">root &#123;&#123; vhost.root &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>生成结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 8080;</span><br><span class="line">  root /var/www/nginx/web1/;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 8080;</span><br><span class="line">  server_name web2.wang.org;</span><br><span class="line">  root /var/www/nginx/web2/;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 8080;</span><br><span class="line">  server_name web3.wang.org;</span><br><span class="line">  root /var/www/nginx/web3/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="8-流程控制"><a href="#8-流程控制" class="headerlink" title="8 流程控制"></a>8 流程控制</h1><h2 id="8-1-循环迭代-loop"><a href="#8-1-循环迭代-loop" class="headerlink" title="8.1 循环迭代 loop"></a>8.1 循环迭代 loop</h2><p> ansible 的 task 中，如果要重复执行相同的模块，则可以使用循环的方式来实现</p>
<p>对于迭代项的引用，要使用固定内置变量 item 来引用，这是固定写法。</p>
<p>范例：安装多个安装包</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Httpd</span> <span class="string">and</span> <span class="string">Php-fpm</span> <span class="string">Package</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">loop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">php-fpm</span></span><br></pre></td></tr></table></figure>

<p>在迭代中，还可以嵌套子变量，关联多个变量在一起使用</p>
<p>范例：批量修改用户密码</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">ssh-host</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">change</span> <span class="string">user</span> <span class="string">passwd</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.name &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.chpass | password_hash(&#x27;sha512&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">update_password:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">loop:</span></span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;root&#x27;</span>, <span class="attr">chpass:</span> <span class="string">&#x27;123456&#x27;</span> &#125;</span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;app&#x27;</span>, <span class="attr">chpass:</span> <span class="string">&#x27;654321&#x27;</span> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-2-条件判断-when"><a href="#8-2-条件判断-when" class="headerlink" title="8.2 条件判断 when"></a>8.2 条件判断 when</h2><p>可以实现条件测试。例如可以根据变量、facts或此前任务的执行结果来做为某task执行与否的前提，通过在task后添加when子句即可使用 jinja2 的语法格式条件测试</p>
<p>范例: 判断服务状态决定是否重新启动</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">nginx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">systemctl</span> <span class="string">is-active</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_nginx</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug</span> <span class="string">var</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">check_nginx</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Httpd</span> <span class="string">Restart</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">check_nginx.rc</span> <span class="string">==</span> <span class="number">0</span>  <span class="comment">#如果nginx服务没启动，就重新启动</span></span><br><span class="line">      <span class="comment">#failed_when: check_nginx.rc != 0 	#条件不成立才执行,和when相反</span></span><br></pre></td></tr></table></figure>

<p>范例: 多条件判断写法</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;shut down CentOS 6 and Debian 7 systems&quot;</span></span><br><span class="line">    <span class="attr">shell:</span></span><br><span class="line">      <span class="attr">cmd:</span> <span class="string">/sbin/shutdown</span> <span class="string">-h</span> <span class="string">now</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span> <span class="string">and</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;6&quot;</span><span class="string">)</span> <span class="string">or</span> <span class="string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;Debian&quot;</span> <span class="string">and</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;7&quot;</span><span class="string">)</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;shut down CentOS 7 systems&quot;</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/sbin/shutdown</span> <span class="string">-h</span> <span class="string">now</span></span><br><span class="line">    <span class="attr">when:</span>  <span class="comment"># when的列表形式表示 and 关系</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;7&quot;</span></span><br></pre></td></tr></table></figure>

<p>其他判断条件</p>
<ul>
<li>操作系统版本判断的第二种写法：<code>ansible_distribution_file_variety == &quot;Debian&quot;</code></li>
<li>操作系统主版本号判断的第二种写法：<code>ansible_distribution_major_version == &quot;7&quot;</code></li>
<li>判断变量是否被定义：<code>name is undefined</code>，name指定要判断的变量名</li>
<li>对主机名进行条件判断：<code>ansible_fqdn is match (&quot;web*&quot;)</code></li>
</ul>
<h2 id="8-3-分组-block"><a href="#8-3-分组-block" class="headerlink" title="8.3 分组 block"></a>8.3 分组 block</h2><p>当想在满足同样条件下，执行多个任务时，就需要分组。而不再针对每个任务都用相同的when来做条件判断</p>
<p>使用 block 可以对 task 任务进行分组，将多个 task 任务放到一个 block 下，可以在写一个 when 判断的情况下调用多个 task 任务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&quot;first&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&quot;second&quot;</span></span><br><span class="line">    <span class="attr">when:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;8&quot;</span></span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line"><span class="comment">#相当于下面写法</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&quot;first&quot;</span></span><br><span class="line">       <span class="attr">when:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;8&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg=&quot;second&quot;</span></span><br><span class="line">       <span class="attr">when:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;8&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="8-4-changed-when"><a href="#8-4-changed-when" class="headerlink" title="8.4 changed_when"></a>8.4 changed_when</h2><p>第一个作用：关闭 changed 状态 </p>
<p>只有在 task 的执行结果返回状态为 changed 的时候，我们才认为该 task 是真实执行了，在远程主机上产生了数据变化，但是在 ansible 中，不是所有模块都具有幂等性，对于某些不会产生数据变化的 task，ansible 也会给出 changed 输出。所以当确定某个task不会对被控制端产生数据变化时，而不想显示的是黄色的changed状态，可以通过 <code>changed_when: false</code> 来避免这一情况</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task-1</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">id</span></span><br><span class="line">    <span class="attr">changed_when:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>第二个作用：自定义条件判断</p>
<p>Ansible 在执行任务之后，会依据任务的执行状况判断该任务是否使系统状态发生了改变，并且在输出结果里标记为 <code>changed</code> 或者 <code>ok</code>。不过，有时候 Ansible 默认的判断规则不符合我们的需求，这时就可以使用 <code>changed_when</code> 来自定义判断逻辑。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-t</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_nginx_config</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="string">&quot;&#x27;successful&#x27; in check_nginx_config.stdout&quot;</span>  <span class="comment">#自定义条件判断任务是否发生了变更</span></span><br></pre></td></tr></table></figure>

<h2 id="8-5-滚动执行"><a href="#8-5-滚动执行" class="headerlink" title="8.5 滚动执行"></a>8.5 滚动执行</h2><p>默认情况下，Ansible将尝试并行管理playbook中所有的机器，如果一个 playbook 中有多个 task，在有多台远程主机的情况下，需要在所有远程主机上执行完当前的 task 之后才执行下一个 task，如果主机过多，或者需要执行的task 比较消耗时间，则会导致所有主机都处于一个执行中状态。如下图，先在 A,B,C 三台主机上执行 Task-1，再在三台主机上执行 Task-2</p>
<p><img src="/CICD/ansible/playbook/62f3d115a6e449a193e44df91ddd2eaf.png" alt="null"></p>
<p>这样的话，在有些场景中是不利于的。比如升级场景，我们希望是先A主机执行完所有task，再到B主机依次执行，就不会导致所有主机都处于一个执行中状态，都无法对外提供服务。所以对于滚动更新用例，可以使用 serial 关键字定义Ansible一次应管理多少主机，还可以将 serial 关键字指定为百分比，表示每次并行执行的主机数占总数的比例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">serial:</span> <span class="number">2</span>  <span class="comment">#每次只同时处理2个主机</span></span><br><span class="line">  <span class="comment">#serial: &quot;20%&quot;  #每次只同时处理20%的主机</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task</span> <span class="string">one</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">hostname</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task</span> <span class="string">two</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">hostname</span></span><br></pre></td></tr></table></figure>

<h2 id="8-6-委派至其它主机执行"><a href="#8-6-委派至其它主机执行" class="headerlink" title="8.6 委派至其它主机执行"></a>8.6 委派至其它主机执行</h2><p>利用委托技术，可以在非当前被控主机的其它主机上执行指定操作，即可以在非指定的主机上执行 task，委派时必须要有key验证</p>
<p>范例：将任务委派给指定的主机执行</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在10.0.0.8上执行hostname -I，而非当前主机localhost</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">ip</span> <span class="string">address</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">hostname</span> <span class="string">-I</span></span><br><span class="line">      <span class="attr">delegate_to:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.8</span>  <span class="comment">#指定当前任务被委派给的目标主机</span></span><br><span class="line">      <span class="attr">delegate_facts:</span> <span class="literal">true</span>  <span class="comment">#收集被委派的目标主机的facts信息</span></span><br></pre></td></tr></table></figure>

<p>范例: 将任务被委派给控制端ansible主机执行</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在本地执行ifconfig,而非10.0.0.8，下面展示三种实现方式</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.8</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">ip</span> <span class="string">address</span></span><br><span class="line">      <span class="attr">local_action:</span>  <span class="comment">#旧语法，委派给控制端ansible主机执行</span></span><br><span class="line">        <span class="attr">module:</span> <span class="string">command</span></span><br><span class="line">        <span class="attr">args:</span> <span class="string">ifconfig</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">hostname</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">hostname</span></span><br><span class="line">      <span class="attr">connection:</span> <span class="string">local</span>  <span class="comment">#委派给控制端ansible主机执行</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kernel</span> <span class="string">version</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">uname</span> <span class="string">-r</span></span><br><span class="line">      <span class="attr">delegate_to:</span> <span class="string">localhost</span>  <span class="comment">#委派给控制端ansible主机执行</span></span><br></pre></td></tr></table></figure>

<h2 id="8-7-只执行一次-run-once"><a href="#8-7-只执行一次-run-once" class="headerlink" title="8.7 只执行一次 run_once"></a>8.7 只执行一次 run_once</h2><p>利用 run_once 指令可以只执行一次，而非在所有被控主机都执行，通常会在第一个匹配的主机上执行该任务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">hostname</span> <span class="string">command</span> <span class="string">once</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">hostname</span></span><br><span class="line">      <span class="attr">run_once:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="8-8-yaml文件的相互调用"><a href="#8-8-yaml文件的相互调用" class="headerlink" title="8.8 yaml文件的相互调用"></a>8.8 yaml文件的相互调用</h2><p>利用 include 或 include_tasks 可以在某个 task 中调用其它的只有 task 内容的 yaml 文件，include 在 2.16 版本之后被弃用，建议使用 include_tasks 来实现包含。include_tasks 一次只能引用一个 yaml 文件</p>
<p>注意：一个task只有一个include_tasks生效，也可以配合when和变量一起使用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#a.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">a</span> <span class="string">job</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">wall</span> <span class="string">run</span> <span class="string">a</span> <span class="string">job</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">excute</span> <span class="string">b.yml</span></span><br><span class="line">      <span class="attr">include_tasks:</span> <span class="string">b.yml</span>  <span class="comment">#调用b.yml执行task</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#b.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">b</span> <span class="string">job</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">wall</span> <span class="string">run</span> <span class="string">b</span> <span class="string">job</span></span><br></pre></td></tr></table></figure>

<p>import_playbook 合并多个 playbook 文件，将多个包含完整内容的 yaml 文件交由一个 yaml 统一调用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@ansible</span> <span class="string">ansible</span>]<span class="comment">#cat main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">tasks1.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">tasks2.yml</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">ansible</span>]<span class="comment">#cat tasks1.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">task1</span> <span class="string">job</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">wall</span> <span class="string">run</span> <span class="string">task1</span> <span class="string">job</span></span><br><span class="line">          </span><br><span class="line">[<span class="string">root@ansible</span> <span class="string">ansible</span>]<span class="comment">#cat tasks2.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">dbsrvs</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">task2</span> <span class="string">job</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">wall</span> <span class="string">run</span> <span class="string">task2</span> <span class="string">job</span></span><br></pre></td></tr></table></figure>

<h1 id="9-实战案例"><a href="#9-实战案例" class="headerlink" title="9 实战案例"></a>9 实战案例</h1><h2 id="9-1-创建-mysql-用户"><a href="#9-1-创建-mysql-用户" class="headerlink" title="9.1 创建 mysql 用户"></a>9.1 创建 mysql 用户</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.46</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;create mysql_group&quot;</span></span><br><span class="line">      <span class="attr">group:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">system:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">gid:</span> <span class="number">306</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;create mysql_user&quot;</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">create_home:</span> <span class="literal">no</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">/bin/nologin</span></span><br><span class="line">        <span class="attr">system:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">uid:</span> <span class="number">306</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure>

<h2 id="9-2-安装-nginx"><a href="#9-2-安装-nginx" class="headerlink" title="9.2 安装 nginx"></a>9.2 安装 nginx</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span> <span class="string">page</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=files/index.html</span> <span class="string">dest=/usr/share/nginx/html/index.html</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<h2 id="9-3-安装-docker"><a href="#9-3-安装-docker" class="headerlink" title="9.3 安装 docker"></a>9.3 安装 docker</h2><p>需要调用的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ansible]# vim /etc/ansible/hosts</span><br><span class="line">[ubuntu]</span><br><span class="line">10.0.0.100</span><br><span class="line">10.0.0.200</span><br><span class="line"></span><br><span class="line">[root@centos8 ansible]# vim vars.yml</span><br><span class="line">docker_version: 5:19.03.15~3-0~ubuntu-</span><br><span class="line">ubuntu1804: bionic</span><br><span class="line">ubuntu2004: focal</span><br><span class="line"></span><br><span class="line">[root@centos8 ansible]# vim files/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>install_docker.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">ubuntu</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">packages</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">apt-transport-https</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ca-certificates</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">curl</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">software-properties-common</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">import</span> <span class="string">key</span></span><br><span class="line">      <span class="attr">apt_key:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">import</span> <span class="string">installation</span> <span class="string">source</span> <span class="string">on</span> <span class="string">ubuntu1804</span></span><br><span class="line">      <span class="attr">apt_repository:</span></span><br><span class="line">        <span class="attr">repo:</span> <span class="string">&quot;deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu <span class="template-variable">&#123;&#123; ubuntu1804 &#125;&#125;</span> stable&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;18&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">import</span> <span class="string">installation</span> <span class="string">source</span> <span class="string">on</span> <span class="string">ubuntu2004</span></span><br><span class="line">      <span class="attr">apt_repository:</span></span><br><span class="line">        <span class="attr">repo:</span> <span class="string">&quot;deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu <span class="template-variable">&#123;&#123; ubuntu2004 &#125;&#125;</span> stable&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;20&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">docker</span> <span class="string">for</span> <span class="string">ubuntu1804</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">docker-ce=&#123;&#123;</span> <span class="string">docker_version</span> <span class="string">&#125;&#125;&#123;&#123;</span> <span class="string">ubuntu1804</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">docker-ce-cli=&#123;&#123;</span> <span class="string">docker_version</span> <span class="string">&#125;&#125;&#123;&#123;</span> <span class="string">ubuntu1804</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;18&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">docker</span> <span class="string">for</span> <span class="string">ubuntu2004</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">docker-ce=&#123;&#123;</span> <span class="string">docker_version</span> <span class="string">&#125;&#125;&#123;&#123;</span> <span class="string">ubuntu2004</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">docker-ce-cli=&#123;&#123;</span> <span class="string">docker_version</span> <span class="string">&#125;&#125;&#123;&#123;</span> <span class="string">ubuntu2004</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;20&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mkdir</span> <span class="string">/etc/docker</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/docker</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aliyun</span> <span class="string">Mirror</span> <span class="string">acceleration</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">/data/ansible/files/daemon.json</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/docker/</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">load</span> <span class="string">daemon</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">daemon_reload:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">docker</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">docker</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<p>验证安装是否成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ansible]# ansible ubuntu -a <span class="string">&quot;docker version&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="9-4-安装-docker-harbor"><a href="#9-4-安装-docker-harbor" class="headerlink" title="9.4 安装 docker harbor"></a>9.4 安装 docker harbor</h2><p>需要调用的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ansible]# vim vars.yml</span><br><span class="line">docker_version: 5:19.03.15~3-0~ubuntu-</span><br><span class="line">ubuntu1804: bionic</span><br><span class="line">ubuntu2004: focal</span><br><span class="line">docker_compose_version: 1.27.4</span><br><span class="line">harbor_version: 1.7.6</span><br><span class="line"></span><br><span class="line">[root@centos8 ansible]# vim files/harbor.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">IPADDR=`hostname -I|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">HARBOR_ADMIN_PASSWORD=123456</span><br><span class="line">sed -i.bak -e <span class="string">&#x27;s/^hostname =.*/hostname = &#x27;</span><span class="variable">$IPADDR</span><span class="string">&#x27;/&#x27;</span> -e <span class="string">&#x27;s/^harbor_admin_password =.*/harbor_admin_password = &#x27;</span><span class="variable">$HARBOR_ADMIN_PASSWORD</span><span class="string">&#x27;/&#x27;</span> /apps/harbor/harbor.cfg</span><br><span class="line"></span><br><span class="line">[root@centos8 files]# vim files/harbor.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Harbor</span><br><span class="line">After=docker.service systemd-networkd.service systemd-resolved.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">Documentation=http://github.com/vmware/harbor</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">ExecStart=/usr/bin/docker-compose -f /apps/harbor/docker-compose.yml up</span><br><span class="line">ExecStop=/usr/bin/docker-compose -f /apps/harbor/docker-compose.yml down</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@centos8 ansible]# vim files/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]                                            </span><br><span class="line">&#125;</span><br><span class="line">                                                   </span><br><span class="line">[root@centos8 ansible]# <span class="built_in">ls</span> files/</span><br><span class="line">daemon.json  docker-compose-Linux-x86_64-1.27.4  harbor-offline-installer-v1.7.6.tgz  harbor.service  harbor.sh</span><br></pre></td></tr></table></figure>

<p>install_docker_harbor.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">ubuntu</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">packages</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">apt-transport-https</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">ca-certificates</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">curl</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">software-properties-common</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">import</span> <span class="string">key</span></span><br><span class="line">      <span class="attr">apt_key:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">import</span> <span class="string">installation</span> <span class="string">source</span> <span class="string">on</span> <span class="string">ubuntu1804</span></span><br><span class="line">      <span class="attr">apt_repository:</span></span><br><span class="line">        <span class="attr">repo:</span> <span class="string">&quot;deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu <span class="template-variable">&#123;&#123; ubuntu1804 &#125;&#125;</span> stable&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;18&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">import</span> <span class="string">installation</span> <span class="string">source</span> <span class="string">on</span> <span class="string">ubuntu2004</span></span><br><span class="line">      <span class="attr">apt_repository:</span></span><br><span class="line">        <span class="attr">repo:</span> <span class="string">&quot;deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu <span class="template-variable">&#123;&#123; ubuntu2004 &#125;&#125;</span> stable&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;20&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">docker</span> <span class="string">for</span> <span class="string">ubuntu1804</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;docker-ce=<span class="template-variable">&#123;&#123; docker_version &#125;&#125;</span><span class="template-variable">&#123;&#123; ubuntu1804 &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;docker-ce-cli=<span class="template-variable">&#123;&#123; docker_version &#125;&#125;</span><span class="template-variable">&#123;&#123; ubuntu1804 &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;18&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">docker</span> <span class="string">for</span> <span class="string">ubuntu2004</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;docker-ce=<span class="template-variable">&#123;&#123; docker_version &#125;&#125;</span><span class="template-variable">&#123;&#123; ubuntu2004 &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;docker-ce-cli=<span class="template-variable">&#123;&#123; docker_version &#125;&#125;</span><span class="template-variable">&#123;&#123; ubuntu2004 &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;20&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mkdir</span> <span class="string">/etc/docker</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/docker</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aliyun</span> <span class="string">Mirror</span> <span class="string">acceleration</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">/data/ansible/files/daemon.json</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/docker/</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">load</span> <span class="string">daemon</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">daemon_reload:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">docker</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">docker</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">compose</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">&quot;/data/ansible/files/docker-compose-Linux-x86_64-<span class="template-variable">&#123;&#123; docker_compose_version &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/usr/bin/docker-compose</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">excute</span> <span class="string">permission</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/usr/bin/docker-compose</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&#x27;0755&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mkdir</span> <span class="string">/apps</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/apps</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">unarchive</span>  <span class="string">harbor</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">unarchive:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">&quot;/data/ansible/files/harbor-offline-installer-v<span class="template-variable">&#123;&#123; harbor_version &#125;&#125;</span>.tgz&quot;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/apps/</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">harbor.cfg</span></span><br><span class="line">      <span class="attr">script:</span> <span class="string">/data/ansible/files/harbor.sh</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">python</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">python</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">harbor</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">/apps/harbor/install.sh</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">harbor.service</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">/data/ansible/files/harbor.service</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/lib/systemd/system/</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service</span> <span class="string">enable</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">harbor</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">daemon_reload:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<h2 id="9-5-安装-Redis"><a href="#9-5-安装-Redis" class="headerlink" title="9.5 安装 Redis"></a>9.5 安装 Redis</h2><p>redis_server.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">dbservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Redis</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Redis</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./files/redis.conf.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/redis.conf</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&#x27;0640&#x27;</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Redis</span> <span class="string">Server</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Redis</span> <span class="string">Server</span> <span class="string">with</span> <span class="string">Systemd</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Redis</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h2 id="9-6-安装-NFS-服务端"><a href="#9-6-安装-NFS-服务端" class="headerlink" title="9.6 安装 NFS 服务端"></a>9.6 安装 NFS 服务端</h2><p>需要调用的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible playbook]# <span class="built_in">cat</span> ./exports.j2</span><br><span class="line">/nfs_test 10.0.0.0/24(rw,all_squash,anonuid=666,anongid=666)</span><br></pre></td></tr></table></figure>

<p>install_nfs_server.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">1</span><span class="string">.</span> <span class="string">Install</span> <span class="string">NFS</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs-utils</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">2</span><span class="string">.</span> <span class="string">Configure</span> <span class="string">NFS</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./exports.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/exports</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">NFS</span> <span class="string">Server</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">3</span><span class="string">.</span> <span class="string">Init</span> <span class="string">Group</span></span><br><span class="line">      <span class="attr">group:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">gid:</span> <span class="number">666</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">4</span><span class="string">.</span> <span class="string">Init</span> <span class="string">User</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">uid:</span> <span class="number">666</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">/sbin/nologin</span></span><br><span class="line">        <span class="attr">create_home:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">5</span><span class="string">.</span> <span class="string">Init</span> <span class="string">Create</span> <span class="string">Directory</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/nfs_test</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">www</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&#x27;0755&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">6</span><span class="string">.</span> <span class="string">Start</span> <span class="string">NFS</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">NFS</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://AquaPluto.github.io">Aquarius</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://aquapluto.github.io/CICD/ansible/playbook/">https://aquapluto.github.io/CICD/ansible/playbook/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://AquaPluto.github.io" target="_blank">代码推演录</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Ansible/">Ansible</a></div><div class="post-share"><div class="social-share" data-image="/img/paper2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/CICD/ansible/role/" title="Role角色"><img class="cover" src="/img/paper1.jpg" onerror="onerror=null;src='/img/error-page.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Role角色</div></div><div class="info-2"><div class="info-item-1">Ansible Roles目录编排...</div></div></div></a><a class="pagination-related" href="/CICD/ansible/module/" title="常用模块"><img class="cover" src="/img/paper6.png" onerror="onerror=null;src='/img/error-page.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">常用模块</div></div><div class="info-2"><div class="info-item-1">1 命令执行相关1.1 Comma...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/CICD/ansible/command/" title="相关命令"><img class="cover" src="/img/paper5.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="info-item-2">相关命令</div></div><div class="info-2"><div class="info-item-1">1 Ansible相关工具   命...</div></div></div></a><a class="pagination-related" href="/CICD/ansible/deploy/" title="部署与配置"><img class="cover" src="/img/paper3.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="info-item-2">部署与配置</div></div><div class="info-2"><div class="info-item-1">1 Ansible安装ansibl...</div></div></div></a><a class="pagination-related" href="/CICD/ansible/introduce/" title="架构概述"><img class="cover" src="/img/paper2.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="info-item-2">架构概述</div></div><div class="info-2"><div class="info-item-1">1 Ansible介绍Ansibl...</div></div></div></a><a class="pagination-related" href="/CICD/ansible/module/" title="常用模块"><img class="cover" src="/img/paper6.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="info-item-2">常用模块</div></div><div class="info-2"><div class="info-item-1">1 命令执行相关1.1 Comma...</div></div></div></a><a class="pagination-related" href="/CICD/ansible/role/" title="Role角色"><img class="cover" src="/img/paper1.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="info-item-2">Role角色</div></div><div class="info-2"><div class="info-item-1">Ansible Roles目录编排...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Aquarius</div><div class="author-info-description">分享运维开发相关技术</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">138</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/AquaPluto"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/AquaPluto" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://blog.csdn.net/m0_75233142" target="_blank" title="CSDN"><i class="fa-solid fa-code" style="color: #8a2be2;"></i></a><a class="social-icon" href="mailto:wujunlinq@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><p>持续更新文章中，有问题请添加wx</p>
<div>
  <img src="/img/wx.jpg" alt="wx" style="width: 100px">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-YAML%E8%AF%AD%E8%A8%80%E4%BB%8B%E7%BB%8D"><span class="toc-text">1 YAML语言介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-YAML%E8%AF%AD%E6%B3%95%E7%AE%80%E4%BB%8B"><span class="toc-text">1.1 YAML语法简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">1.2 支持的数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-scalar-%E6%A0%87%E9%87%8F"><span class="toc-text">1.2.1 scalar 标量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-Dictionary-%E5%AD%97%E5%85%B8"><span class="toc-text">1.2.2 Dictionary 字典</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-List-%E5%88%97%E8%A1%A8"><span class="toc-text">1.2.3 List 列表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E4%B8%89%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-text">1.3 三种常见的数据格式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Playbook%E5%91%BD%E4%BB%A4"><span class="toc-text">2 Playbook命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Playbook%E6%A6%82%E5%BF%B5"><span class="toc-text">3 Playbook概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Playbook%E7%BB%84%E6%88%90"><span class="toc-text">4 Playbook组成</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Playbook%E7%BB%84%E4%BB%B6"><span class="toc-text">5 Playbook组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-hosts%E7%BB%84%E4%BB%B6"><span class="toc-text">5.1 hosts组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-tasks%E5%88%97%E8%A1%A8%E5%92%8Ctask%E7%BB%84%E4%BB%B6"><span class="toc-text">5.2 tasks列表和task组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-remote-user%E7%BB%84%E4%BB%B6"><span class="toc-text">5.3 remote_user组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-ignore-errors%E7%BB%84%E4%BB%B6"><span class="toc-text">5.4 ignore_errors组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-handlers%E5%92%8Cnotify%E7%BB%84%E4%BB%B6"><span class="toc-text">5.5 handlers和notify组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-tags%E7%BB%84%E4%BB%B6"><span class="toc-text">5.6 tags组件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-Variables%E5%8F%98%E9%87%8F"><span class="toc-text">6 Variables变量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E4%BD%BF%E7%94%A8-setup-%E6%A8%A1%E5%9D%97%E4%B8%AD%E5%8F%98%E9%87%8F"><span class="toc-text">6.1 使用 setup 模块中变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-register%E6%B3%A8%E5%86%8C%E5%8F%98%E9%87%8F"><span class="toc-text">6.2 register注册变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E5%9C%A8playbook%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-text">6.3 在playbook命令行中定义变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E5%9C%A8playbook%E6%96%87%E4%BB%B6%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-text">6.4 在playbook文件中定义变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-playbook%E5%85%AC%E5%85%B1%E7%9A%84%E5%8F%98%E9%87%8F%E6%96%87%E4%BB%B6"><span class="toc-text">6.5 playbook公共的变量文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-%E5%9C%A8%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95%E4%B8%AD%E5%AE%9A%E4%B9%89%E4%B8%BB%E6%9C%BA%E5%92%8C%E4%B8%BB%E6%9C%BA%E7%BB%84%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-text">6.6 在主机清单中定义主机和主机组的变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-7-%E9%92%88%E5%AF%B9%E5%BD%93%E5%89%8D%E9%A1%B9%E7%9B%AE%E7%9A%84%E4%B8%BB%E6%9C%BA%E5%92%8C%E4%B8%BB%E6%9C%BA%E7%BB%84%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-text">6.7 针对当前项目的主机和主机组的变量</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Templates%E6%A8%A1%E6%9D%BF"><span class="toc-text">7 Templates模板</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-text">8 流程控制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E5%BE%AA%E7%8E%AF%E8%BF%AD%E4%BB%A3-loop"><span class="toc-text">8.1 循环迭代 loop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD-when"><span class="toc-text">8.2 条件判断 when</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E5%88%86%E7%BB%84-block"><span class="toc-text">8.3 分组 block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-changed-when"><span class="toc-text">8.4 changed_when</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-5-%E6%BB%9A%E5%8A%A8%E6%89%A7%E8%A1%8C"><span class="toc-text">8.5 滚动执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-6-%E5%A7%94%E6%B4%BE%E8%87%B3%E5%85%B6%E5%AE%83%E4%B8%BB%E6%9C%BA%E6%89%A7%E8%A1%8C"><span class="toc-text">8.6 委派至其它主机执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-7-%E5%8F%AA%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1-run-once"><span class="toc-text">8.7 只执行一次 run_once</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-8-yaml%E6%96%87%E4%BB%B6%E7%9A%84%E7%9B%B8%E4%BA%92%E8%B0%83%E7%94%A8"><span class="toc-text">8.8 yaml文件的相互调用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-text">9 实战案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E5%88%9B%E5%BB%BA-mysql-%E7%94%A8%E6%88%B7"><span class="toc-text">9.1 创建 mysql 用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E5%AE%89%E8%A3%85-nginx"><span class="toc-text">9.2 安装 nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E5%AE%89%E8%A3%85-docker"><span class="toc-text">9.3 安装 docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-%E5%AE%89%E8%A3%85-docker-harbor"><span class="toc-text">9.4 安装 docker harbor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-5-%E5%AE%89%E8%A3%85-Redis"><span class="toc-text">9.5 安装 Redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-6-%E5%AE%89%E8%A3%85-NFS-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-text">9.6 安装 NFS 服务端</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Kubernetes/deploy/cluster/" title="集群管理指南"><img src="/img/paper5.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="集群管理指南"/></a><div class="content"><a class="title" href="/Kubernetes/deploy/cluster/" title="集群管理指南">集群管理指南</a><time datetime="2025-09-21T02:38:40.000Z" title="发表于 2025-09-21 10:38">2025-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/role/" title="Role角色"><img src="/img/paper1.jpg" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="Role角色"/></a><div class="content"><a class="title" href="/CICD/ansible/role/" title="Role角色">Role角色</a><time datetime="2025-09-13T10:07:53.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/playbook/" title="PlayBook"><img src="/img/paper2.jpg" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="PlayBook"/></a><div class="content"><a class="title" href="/CICD/ansible/playbook/" title="PlayBook">PlayBook</a><time datetime="2025-09-13T10:07:48.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/module/" title="常用模块"><img src="/img/paper6.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="常用模块"/></a><div class="content"><a class="title" href="/CICD/ansible/module/" title="常用模块">常用模块</a><time datetime="2025-09-13T10:07:42.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/command/" title="相关命令"><img src="/img/paper5.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="相关命令"/></a><div class="content"><a class="title" href="/CICD/ansible/command/" title="相关命令">相关命令</a><time datetime="2025-09-13T10:07:38.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Aquarius</span></div><div class="footer_custom_text"><style>
div#runtime {
  font-size: 13px;
  font-weight: bold;
}

div#ghbdages_list {
  height: 1.5rem;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 10px
}

.github-badge {
  display: flex;
  align-items: center;
  margin-inline: 6px;
}
</style>
<div id="runtime"></div>
<div id="ghbdages"></div>
<script>
  function createtime() {
    const now = new Date();
    const grt = new Date("08/01/2025 00:00:00"); // 网站诞生时间

    // 计算天、小时、分钟和秒
    const days = Math.floor((now - grt) / (1000 * 60 * 60 * 24));
    const hours = Math.floor(((now - grt) / (1000 * 60 * 60)) % 24)
      .toString()
      .padStart(2, "0");
    const minutes = Math.floor(((now - grt) / (1000 * 60)) % 60)
      .toString()
      .padStart(2, "0");
    const seconds = Math.floor(((now - grt) / 1000) % 60)
      .toString()
      .padStart(2, "0");

    // HTML 输出
    const currentTimeHtml = `
          <div>
              本站已运行 ${days} 天 ${hours} 小时 ${minutes} 分 ${seconds} 秒 
          </div>`;

    const runtime = document.getElementById("runtime");
    if (runtime) runtime.innerHTML = currentTimeHtml;
  }

  // 设置每秒调用函数
  setInterval(createtime, 1000);

  function renderBadge() {
    const currentTimeHtml = `
      <div id="ghbdages_list">
          <a class="github-badge" target="_blank" href="https://hexo.io/" title="hexo:7.3.0">
              <img src="https://img.shields.io/badge/Frame-Hexo-blue?logo=hexo" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://github.com/" title="github">
              <img src="https://img.shields.io/badge/Code-GitHub-181717?logo=GitHub&color=%23FF7102" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://vercel.com/" title="vercel">
              <img src="https://img.shields.io/badge/Host-Vercel-%23F0D722?logo=Vercel" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://analytics.sysio.ai/" title="umami">
              <img src="https://img.shields.io/badge/Analytics-Umami-%237FB100?logo=umami&logoColor=%237FB100" alt="Static Badge">
          </a>
      </div>`;

    const ghbdages = document.getElementById("ghbdages");
    if (ghbdages) {
      ghbdages.innerHTML = currentTimeHtml;
    }
  }

  window.onload = renderBadge;
</script>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/instant.page/instantpage.js" type="module"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://unpkg.com/mathjax/es5/tex-mml-chtml.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://unpkg.com/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://cdn.jsdelivr.net/gh/xiabo2/CDN@latest/fishes.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://unpkg.com/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章..." type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>