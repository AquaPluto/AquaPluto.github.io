<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Pod的配置 | 代码推演录</title><meta name="author" content="Aquarius"><meta name="copyright" content="Aquarius"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="1 钩子函数Hook钩子函数是由kubelet发起的，提供了两种hook函数 1.1 postStart在容器创建后立即执行，注意由于是异步执行，它无法保证一定在容器的 ENTRYPQINT 前运行  如果一些初始化工作一定要在业务容器运行前运行，那就用 init containers来定制 如果这些初始化工作没有要求必须在业务容器运行前运行，那就用postStart来定制  主要用于资源部署、环">
<meta property="og:type" content="article">
<meta property="og:title" content="Pod的配置">
<meta property="og:url" content="https://aquapluto.github.io/Kubernetes/pod/configuration/">
<meta property="og:site_name" content="代码推演录">
<meta property="og:description" content="1 钩子函数Hook钩子函数是由kubelet发起的，提供了两种hook函数 1.1 postStart在容器创建后立即执行，注意由于是异步执行，它无法保证一定在容器的 ENTRYPQINT 前运行  如果一些初始化工作一定要在业务容器运行前运行，那就用 init containers来定制 如果这些初始化工作没有要求必须在业务容器运行前运行，那就用postStart来定制  主要用于资源部署、环">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://aquapluto.github.io/img/paper5.png">
<meta property="article:published_time" content="2025-09-12T06:18:37.000Z">
<meta property="article:modified_time" content="2025-09-12T08:19:34.812Z">
<meta property="article:author" content="Aquarius">
<meta property="article:tag" content="Pod">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aquapluto.github.io/img/paper5.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Pod的配置",
  "url": "https://aquapluto.github.io/Kubernetes/pod/configuration/",
  "image": "https://aquapluto.github.io/img/paper5.png",
  "datePublished": "2025-09-12T06:18:37.000Z",
  "dateModified": "2025-09-12T08:19:34.812Z",
  "author": [
    {
      "@type": "Person",
      "name": "Aquarius",
      "url": "https://AquaPluto.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://aquapluto.github.io/Kubernetes/pod/configuration/"><link rel="preconnect" href="//unpkg.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://unpkg.com/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Pod的配置',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/wave.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">138</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/software-manage/"><span>软件包管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/OOM/"><span>OOM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/swap/"><span>Swap分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/data-synchronization/"><span>数据的实时同步</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/mail/"><span>邮件服务</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/kernel-manage/"><span>内核和启动管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-lock/"><span>进程锁</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/queue/"><span>队列实现线程并发控制</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/MySQL/SQL/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/Redis/deploy/"><span>部署安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Tomcat/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>存储</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/conspect/"><span>存储概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/nfs/"><span>NFS</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/conspect/"><span>Docker概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/image/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/container/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/volume/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/network/"><span>网络管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/compose/"><span>Docker-Compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/conspect/"><span>镜像概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/dockerfile/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/build/"><span>构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/harbor/"><span>镜像仓库</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/management/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-cgroup/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-usage/"><span>监控容器真实的cpu使用率</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/containerd/"><span>Containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>K8s</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kubernetes概论</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/architecture/"><span>Kubernetes架构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/cri/"><span>容器运行时接口CRI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/list-watch/"><span>List-Watch机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/object/"><span>Kubernetes对象</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/namespace/"><span>Namespace</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/kubectl/"><span>kubectl命令</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>部署安装</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/explanation/"><span>部署说明</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/docker/"><span>基于docker部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/containerd/"><span>基于containerd部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/cluster/"><span>集群管理指南</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Pod</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/conspect/"><span>Pod概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/configuration/"><span>Pod的配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/schedule/"><span>Pod的调度</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/eviction/"><span>Pod的驱逐</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>控制器</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/introduce/"><span>控制器介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/deployment/"><span>Deployment</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/statefulset/"><span>StatefulSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/daemonset/"><span>DaemonSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/job-cronjob/"><span>Job和CronJob</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/HPA/"><span>HPA</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/operator/"><span>Operator</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务发现与负载均衡</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/service/"><span>Service</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/ingress/"><span>Ingress</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/coredns/"><span>CoreDNS</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/localdns/"><span>LocalDNS</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>数据存储持久化</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/csi/"><span>存储接口CSI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/pv-pvc/"><span>PV和PVC</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/storageclass/"><span>StorageClass</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/configmap-secret/"><span>ConfigMap和Secret</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>认证与鉴权体系</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/conspect/"><span>体系概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/kubeconfig/"><span>kubeconfig</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/user-account/"><span>User Account</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/service-account/"><span>Service Account</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/introduce/"><span>prometheus概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/query-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/indicators-remarked/"><span>指标重新打标</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/pushmanager/"><span>Pushmanager</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/cluster-ha/"><span>集群与高可用</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/ha/"><span>高可用架构</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/grafana/"><span>Grafana</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/streaming/"><span>基于流处理的可观测性架构</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/paper5.png);"><nav id="nav"><!-- 左侧博客信息区域--><span id="blog-info"><a class="nav-site-title" href="/"></a><a class="nav-page-title" href="/"><span class="site-name">Pod的配置</span></a></span><!-- 新增的导航菜单容器（居中布局关键）--><div id="nav-menus-container"><!-- 菜单主体部分--><div id="menus"><!-- 菜单项--><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/software-manage/"><span>软件包管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/OOM/"><span>OOM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/swap/"><span>Swap分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/data-synchronization/"><span>数据的实时同步</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/mail/"><span>邮件服务</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/kernel-manage/"><span>内核和启动管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-lock/"><span>进程锁</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/queue/"><span>队列实现线程并发控制</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/MySQL/SQL/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/Redis/deploy/"><span>部署安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Tomcat/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>存储</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/conspect/"><span>存储概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/nfs/"><span>NFS</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/conspect/"><span>Docker概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/image/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/container/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/volume/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/network/"><span>网络管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/compose/"><span>Docker-Compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/conspect/"><span>镜像概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/dockerfile/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/build/"><span>构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/harbor/"><span>镜像仓库</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/management/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-cgroup/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-usage/"><span>监控容器真实的cpu使用率</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/containerd/"><span>Containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>K8s</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kubernetes概论</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/architecture/"><span>Kubernetes架构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/cri/"><span>容器运行时接口CRI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/list-watch/"><span>List-Watch机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/object/"><span>Kubernetes对象</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/namespace/"><span>Namespace</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/kubectl/"><span>kubectl命令</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>部署安装</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/explanation/"><span>部署说明</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/docker/"><span>基于docker部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/containerd/"><span>基于containerd部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/cluster/"><span>集群管理指南</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Pod</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/conspect/"><span>Pod概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/configuration/"><span>Pod的配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/schedule/"><span>Pod的调度</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/eviction/"><span>Pod的驱逐</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>控制器</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/introduce/"><span>控制器介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/deployment/"><span>Deployment</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/statefulset/"><span>StatefulSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/daemonset/"><span>DaemonSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/job-cronjob/"><span>Job和CronJob</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/HPA/"><span>HPA</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/operator/"><span>Operator</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务发现与负载均衡</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/service/"><span>Service</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/ingress/"><span>Ingress</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/coredns/"><span>CoreDNS</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/localdns/"><span>LocalDNS</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>数据存储持久化</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/csi/"><span>存储接口CSI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/pv-pvc/"><span>PV和PVC</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/storageclass/"><span>StorageClass</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/configmap-secret/"><span>ConfigMap和Secret</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>认证与鉴权体系</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/conspect/"><span>体系概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/kubeconfig/"><span>kubeconfig</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/user-account/"><span>User Account</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/service-account/"><span>Service Account</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/introduce/"><span>prometheus概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/query-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/indicators-remarked/"><span>指标重新打标</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/pushmanager/"><span>Pushmanager</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/cluster-ha/"><span>集群与高可用</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/ha/"><span>高可用架构</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/grafana/"><span>Grafana</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/streaming/"><span>基于流处理的可观测性架构</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><!-- 右侧功能区域（新增容器）--><div id="nav-right-container"><!-- 搜索按钮（移动到右侧）--><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></span></div><!-- 移动端汉堡菜单按钮--><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Pod的配置</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-12T06:18:37.000Z" title="发表于 2025-09-12 14:18">2025-09-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-12T08:19:34.812Z" title="更新于 2025-09-12 16:19">2025-09-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/kubernetes/">kubernetes</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">14.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>60分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1-钩子函数"><a href="#1-钩子函数" class="headerlink" title="1 钩子函数"></a>1 钩子函数</h1><p>Hook钩子函数是由kubelet发起的，提供了两种hook函数</p>
<h2 id="1-1-postStart"><a href="#1-1-postStart" class="headerlink" title="1.1 postStart"></a>1.1 postStart</h2><p>在容器创建后立即执行，注意由于是异步执行，它无法保证一定在容器的 ENTRYPQINT 前运行</p>
<ul>
<li>如果一些初始化工作一定要在业务容器运行前运行，那就用 init containers来定制</li>
<li>如果这些初始化工作没有要求必须在业务容器运行前运行，那就用postStart来定制</li>
</ul>
<p>主要用于资源部署、环境准备等。不过需要注意的是如果钩子花费时间过长以及于不能运行或者挂起，容器将不能达到Running状态</p>
<p>postStart失败，容器会被杀死，并根据RestartPolicy决定是否重启</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">poststart</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">poststart</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.15-alpine</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span>   <span class="comment"># 生命周期事件</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;mkdir&quot;</span>,<span class="string">&quot;-p&quot;</span>,<span class="string">&quot;/usr/share/nginx/html/haha&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="1-2-preStop"><a href="#1-2-preStop" class="headerlink" title="1.2 preStop"></a>1.2 preStop</h2><p>当用户请求删除含有 Pod 的资源对象时(如 Deployment等)，K8S 为了让应用程序优雅关闭(即让应用程序完成正在处理的请求后，再关闭软件)，K8S 提供两种信息通知</p>
<ul>
<li>默认：K8S 通知 node 执行容器 stop 命令，容器运行时会先向容器中 PID 为1的进程发送系统信号SIGTERM，然后等待容器中的应用程序终止执行，如果等待时间达到设定的超时时间，或者默认超时时间(30s)，会继续发送 SIGKILL 的系统信号强行 kill 掉进程</li>
<li>在发送终止信号之前执行PreStop钩子函数，它是阻塞的，意味着它是同步的</li>
</ul>
<p>主要用于资源清理、优雅关闭应用程序、通知其他系统等。</p>
<p>当 Pod 开始终止时，Kubernetes 会执行 prestop 钩子。钩子有一个超时时间(默认为 30 秒)。如果钩子在超时时间内没有成功完成，Kubernetes 会终止Pod，而不再继续等待钩子完成。</p>
<p>如果钩子运行失败，也会强制删除pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prestop</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prestop</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.15-alpine</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span>  <span class="comment"># 生命周期事件</span></span><br><span class="line">      <span class="attr">preStop:</span>                                      </span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 60000000&quot;</span>]     <span class="comment"># 容器终止前sleep 60000000秒</span></span><br></pre></td></tr></table></figure>

<h1 id="2-配置Pod"><a href="#2-配置Pod" class="headerlink" title="2 配置Pod"></a>2 配置Pod</h1><h2 id="2-1-指定容器启动命令"><a href="#2-1-指定容器启动命令" class="headerlink" title="2.1 指定容器启动命令"></a>2.1 指定容器启动命令</h2><p>command：</p>
<ul>
<li>用于指定容器启动时运行的命令，相当于 Docker 的 ENTRYPOINT。</li>
<li>如果没有设置 command，则使用容器镜像中的默认入口点。如果设置将覆盖 Docker 镜像的 ENTRYPOINT</li>
<li>command 通常是一个字符串数组，第一个元素是命令，后续元素是命令的参数（可以为空）。</li>
</ul>
<p>args：</p>
<ul>
<li>用于指定传递给 command 的参数，相当于 Docker 的 <code>CMD</code>。</li>
<li>如果没有设置 args，则使用容器镜像中的默认命令参数。如果设置将覆盖 Docker 镜像的 CMD</li>
<li>args 也是一个字符串数组，每个元素是一个参数。</li>
</ul>
<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]#vim pod-demoapp.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">    - <span class="string">&quot;-c&quot;</span></span><br><span class="line">    args:</span><br><span class="line">    - <span class="string">&quot;sleep 9999&quot;</span></span><br><span class="line">  restartPolicy: OnFailure</span><br><span class="line"></span><br><span class="line"><span class="comment">#另一种写法</span></span><br><span class="line"><span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">args: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 9999&quot;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="comment">#不用args</span></span><br><span class="line"><span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 9999&quot;</span>]</span><br><span class="line"><span class="built_in">command</span>:</span><br><span class="line">    - <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">    - <span class="string">&quot;-c&quot;</span></span><br><span class="line">    - <span class="string">&quot;sleep 9999&quot;</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl apply -f pod-demoapp.yaml </span><br><span class="line">pod/pod-demo created</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl <span class="built_in">exec</span> pod-demo -- ps aux</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 <span class="built_in">sleep</span> 9999</span><br><span class="line">    7 root      0:00 ps aux</span><br></pre></td></tr></table></figure>

<h2 id="2-2-通过环境变量向容器传递参数"><a href="#2-2-通过环境变量向容器传递参数" class="headerlink" title="2.2 通过环境变量向容器传递参数"></a>2.2 通过环境变量向容器传递参数</h2><p>环境变量是容器化应用的常用配置方式之一</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">假如有一个nginx镜像，我们想要启动两个容器，一个做web服务器，一个做负载均衡，怎么做？</span><br><span class="line">1.基于基础的nginx镜像，调试好各自的配置文件，各自做各自的镜像</span><br><span class="line">    a.强耦合方式</span><br><span class="line">    b.一般来说有测试环境，预生产环境和生产环境，每个环境所需的资源不同，就要每个环境都要做一个镜像</span><br><span class="line">    b.不推荐使用，除非环境很简单</span><br><span class="line">2.基于卷的方式，在宿主机中调试好配置文件，让两个容器加载各自所需要的配置文件</span><br><span class="line">    a.在kubernetes中，pod如果崩掉会创建在另一个节点，那怎么加载配置文件呢？就要去多使用一个服务器做共享存储了</span><br><span class="line">3.通过环境变量向容器传递参数</span><br></pre></td></tr></table></figure>

<p>在容器上嵌套使用env字段</p>
<ul>
<li>每个环境变量需要通过name给出既定的名称</li>
<li>传递的值则定义在value字段上</li>
</ul>
<p>查看帮助</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]#kubectl explain pods.spec.containers</span><br></pre></td></tr></table></figure>

<p>注意：用 env 传递参数时，可能因为版本的不同，yaml 文件里的 value 的写法不同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#正常可以这么写</span></span><br><span class="line">value: wpdb</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果报错</span></span><br><span class="line">Error from server (BadRequest): error when creating <span class="string">&quot;pod-mysql.yaml&quot;</span>: Pod <span class="keyword">in</span> version <span class="string">&quot;v1&quot;</span> cannot be handled as a Pod: json: cannot unmarshal number into Go struct field EnvVar.spec.containers.env.value of <span class="built_in">type</span> string</span><br><span class="line"></span><br><span class="line"><span class="comment">#报错说要从数字类型更改为字符串类型，就要这么写</span></span><br><span class="line">value: <span class="string">&quot;wpdb&quot;</span></span><br></pre></td></tr></table></figure>

<p>范例：通过创建service资源部署MySQL和WordPress</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]#kubectl create service clusterip mysql --tcp=3306:3306 --dry-run=client -o yaml &gt;&gt; pod-mysql.yaml </span><br><span class="line"></span><br><span class="line"><span class="comment">#最终的内容</span></span><br><span class="line">[root@master1 ~]#vim pod-mysql.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: blog</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">  labels:</span><br><span class="line">    app: db</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysql</span><br><span class="line">    image: mysql:8.0				<span class="comment">#默认从docker-hub上拉取镜像，将来被调度到哪个node节点，哪个就有mysql镜像</span></span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;123456&quot;</span></span><br><span class="line">    - name: MYSQL_USER</span><br><span class="line">      value: <span class="string">&quot;wpuser&quot;</span></span><br><span class="line">    - name: MYSQL_PASSWORD</span><br><span class="line">      value: <span class="string">&quot;wppass&quot;</span></span><br><span class="line">    - name: MYSQL_DATABASE</span><br><span class="line">      value: <span class="string">&quot;wordpress&quot;</span></span><br><span class="line">  restartPolicy: OnFailure</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service			<span class="comment">#Service资源用于抽象Pod的访问方式，这里用于访问MySQL数据库的Pod</span></span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql</span><br><span class="line">  name: mysql</span><br><span class="line">  namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: 3306-3306</span><br><span class="line">    port: 3306</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3306</span><br><span class="line">  selector:</span><br><span class="line">    app: db				<span class="comment">#这里的选择器要和上面pod指定的label一致，不然service无法根据标签进行调度</span></span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  </span><br><span class="line">[root@master1 ~]#kubectl apply -f pod-mysql.yaml </span><br><span class="line">namespace/blog created</span><br><span class="line">pod/mysql created</span><br><span class="line">service/mysql created</span><br><span class="line"></span><br><span class="line"><span class="comment">#同时查看不同的资源类型要用,隔开，不能用空格</span></span><br><span class="line">[root@master1 ~]#kubectl get pods,services -n blog -o wide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP            NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/mysql   1/1     Running   0          10m   10.244.1.10   node1.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   SELECTOR</span><br><span class="line">service/mysql   ClusterIP   10.107.97.149   &lt;none&gt;        3306/TCP   10m   app=db</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl describe services mysql -n blog</span><br><span class="line">Name:              mysql</span><br><span class="line">Namespace:         blog</span><br><span class="line">Labels:            app=mysql</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          app=db</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Family Policy:  SingleStack</span><br><span class="line">IP Families:       IPv4</span><br><span class="line">IP:                10.107.97.149</span><br><span class="line">IPs:               10.107.97.149</span><br><span class="line">Port:              3306-3306  3306/TCP</span><br><span class="line">TargetPort:        3306/TCP</span><br><span class="line">Endpoints:         10.244.1.10:3306</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>说明：WordPress Pod 要访问 MySQL Service，当它们处于同一名称空间时，使用 <code>WORDPRESS_DB_HOST: &quot;mysql&quot;</code> 就能正确解析到 MySQL Service。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]#kubectl create service loadbalancer wordpress --tcp=80:80 --dry-run=client -o yaml &gt;&gt; wordpress.yaml </span><br><span class="line"></span><br><span class="line">[root@master1 ~]#vim wordpress.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">   name: wordpress</span><br><span class="line">   labels:</span><br><span class="line">     app: wordpress</span><br><span class="line">   namespace: blog</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">     - name: wordpress</span><br><span class="line">       image: wordpress:6</span><br><span class="line">       <span class="built_in">env</span>:</span><br><span class="line">       - name: WORDPRESS_DB_HOST</span><br><span class="line">         value: <span class="string">&quot;mysql&quot;</span>				<span class="comment">#这里要写的是pod-mysql.yaml中service里面的name，不然WordPress无法连接数据库</span></span><br><span class="line">       - name: WORDPRESS_DB_USER</span><br><span class="line">         value: <span class="string">&quot;wpuser&quot;</span></span><br><span class="line">       - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">         value: <span class="string">&quot;wppass&quot;</span></span><br><span class="line">       - name: WORDPRESS_DB_NAME</span><br><span class="line">         value: <span class="string">&quot;wordpress&quot;</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: wordpress</span><br><span class="line">  name: wordpress</span><br><span class="line">  namespace: blog					<span class="comment">#这里要指定名称空间，如果不指定，即不和mysql在同一个名称空间，那么WORDPRESS_DB_HOST的value要写成mysql.blog，并且在Pod上面要创建namespace</span></span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: 80-80</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: wordpress</span><br><span class="line">  <span class="built_in">type</span>: LoadBalancer</span><br><span class="line">  </span><br><span class="line">[root@master1 ~]#kubectl apply -f wordpress.yaml </span><br><span class="line">pod/wordpress created</span><br><span class="line">service/wordpress created</span><br><span class="line"></span><br><span class="line"><span class="comment">#因为本环境安装不了OpenELB，所以EXTERNAL-IP没有，我们要使用 任一节点ip:31079 进行访问</span></span><br><span class="line">[root@master1 ~]#kubectl get pods,services wordpress -n blog -o wide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP            NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/wordpress   1/1     Running   0          11m   10.244.2.11   node2.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class="line">service/wordpress   LoadBalancer   10.109.206.0   &lt;pending&gt;     80:31079/TCP   11m   app=wordpress</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl describe services wordpress -n blog</span><br><span class="line">Name:                     wordpress</span><br><span class="line">Namespace:                blog</span><br><span class="line">Labels:                   app=wordpress</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 app=wordpress</span><br><span class="line">Type:                     LoadBalancer</span><br><span class="line">IP Family Policy:         SingleStack</span><br><span class="line">IP Families:              IPv4</span><br><span class="line">IP:                       10.109.206.0</span><br><span class="line">IPs:                      10.109.206.0</span><br><span class="line">Port:                     80-80  80/TCP</span><br><span class="line">TargetPort:               80/TCP</span><br><span class="line">NodePort:                 80-80  31079/TCP</span><br><span class="line">Endpoints:                10.244.2.11:80</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-镜像拉取策略"><a href="#2-3-镜像拉取策略" class="headerlink" title="2.3 镜像拉取策略"></a>2.3 镜像拉取策略</h2><p>由imagePullPolicy参数控制</p>
<ul>
<li><p>Always : 不管本地有没有镜像，都要从仓库中下载镜像</p>
</li>
<li><ul>
<li>好处：如果有人侵入将镜像换成了带有病毒的，而Always不会使用原有镜像，可以规避这种情况<br>- 坏处：消耗大量的网络带宽</li>
</ul>
</li>
<li><p>Never : 从来不从仓库下载镜像, 只用本地镜像,本地没有就算了,适用于无法使用网络的机器</p>
</li>
<li><p>IfNotPresent: 如果本地存在就直接使用, 不存在才从仓库下载, 但 Tag 为 latest 的 Image 除外，这种将自动使用Always策略</p>
</li>
</ul>
<p>默认的策略是：</p>
<ul>
<li>当镜像标签版本是latest，默认策略就是Always</li>
<li>如果指定特定版本默认拉取策略就是IfNotPresent。</li>
</ul>
<h2 id="2-4-Pod的重启策略"><a href="#2-4-Pod的重启策略" class="headerlink" title="2.4 Pod的重启策略"></a>2.4 Pod的重启策略</h2><p>决定了容器终止后是否应该重启，在spec字段的 restartPolicy 中定义</p>
<table>
<thead>
<tr>
<th>重启策略</th>
<th>解释</th>
<th>适用场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Always</td>
<td>无论容器如何终止（成功或失败【exit code】），都会重新启动容器。这是 Kubernetes Pod 的默认重启策略。</td>
<td>适用于长期运行的服务（例如 Web 服务器），需要在任何情况下保持运行。</td>
<td>容器只要挂了，就会立即重启，这样是很耗费资源的。所以Always重启策略是这么做的：第一次容器挂了立即重启，如果再挂了就要延时10s重启，第三次挂了就等20s重启…… 依次类推</td>
</tr>
<tr>
<td>OnFailure</td>
<td>只有在容器非正常退出（退出状态码不为 0，即错误退出）时，才会重新启动容器。如果容器正常结束（退出状态码为 0），不会重新启动。</td>
<td>适用于批处理任务（非服务）或作业（Job），希望在任务失败时重试，但任务成功完成后不再重启。</td>
<td></td>
</tr>
<tr>
<td>Never</td>
<td>容器终止后，不会重新启动，无论其退出状态码如何。</td>
<td>适用于希望一次性运行的任务，任务结束后不需要重启的情况。</td>
<td></td>
</tr>
</tbody></table>
<p>查看重启策略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~# kubectl get pod my-pod -o yaml | grep restartPolicy</span><br></pre></td></tr></table></figure>

<p>重启策略在静态Pod和普通Pod中的应用</p>
<ul>
<li>静态pod：不允许设置RestartPolicy</li>
<li>裸Pod：可以设置三种策略Always、OnFailure、Never</li>
<li>Deployment 和 ReplicaSet：只能使用 <code>restartPolicy: Always</code>，确保 Pod 总是保持运行，适用于长期运行的应用。</li>
<li>Job 和 CronJob：只能使用 <code>restartPolicy: OnFailure/Never</code>，适用于一次性或定期运行的任务，确保任务失败时重试。</li>
</ul>
<h2 id="2-5-探针-Pod健康检查"><a href="#2-5-探针-Pod健康检查" class="headerlink" title="2.5 探针-Pod健康检查"></a>2.5 探针-Pod健康检查</h2><p>探针就是用来检测容器或容器的服务是否存活的一种机制，帮我们周期性检测服务状态，自动完成上下线或者重启</p>
<h3 id="2-5-1-探针类型"><a href="#2-5-1-探针类型" class="headerlink" title="2.5.1 探针类型"></a>2.5.1 探针类型</h3><p>Pod支持的监测类型</p>
<ul>
<li>启动探针 startup Probe：专门用于处理容器启动时间较长的场景。它仅在容器启动期间执行，一旦成功通过后，启动探针将不再执行，再运行后续的探针。这有助于避免由于应用程序初始化时间过长而导致的其他探针误判。</li>
<li>存活探针 liveness Probe：用于确定容器内的应用程序是否仍在运行，用于判断Pod是否需要重启。如果探测失败，kubelet将根据配置的重启策略对容器进行处理。</li>
<li>就绪探针 readiness Probe：用于检测容器内的程序是否健康，即是否准备好接受流量，控制Pod的网络流量流向。如果就绪探针返回成功，表明容器已准备就绪，可以接受流量。当就绪探针检测失败后，Pod的 <code>IP:Port</code> 会从对应的EndPoint列表中删除，即service不会再去访问该pod，防止流量被发送到该容器，直到探针再次成功为止</li>
</ul>
<p>存活探针和就绪探针的区别</p>
<ul>
<li>存活探针主要用于恢复容器故障；就绪探针主要用于控制流量，确保只有健康的容器才会接收到流量。</li>
<li>在生产环境中，推荐同时使用存活探针和就绪探针，以确保应用程序的健康、可用和可靠。</li>
</ul>
<p>监测机制</p>
<ul>
<li><code>Exec Action</code>：根据指定命令结果的状态码判定</li>
<li><code>TcpSocket Action</code>：根据相应TCP套接字连接建立状态判定，实际上就是检查端口</li>
<li><code>HTTPGet Action</code>：根据指定https&#x2F;http服务URL的响应状态码判定</li>
</ul>
<p>配置参数</p>
<ul>
<li><code>initialDelaySeconds</code>：首次监测的延迟时间，为了给予容器足够的时间来完成启动和初始化过程，避免因为过早的探测导致误报</li>
<li><code>periodSeconds</code>：监测的间隔时间</li>
<li><code>timeoutSeconds</code>：监测失败的超时时间，如果在指定的时间内探针没有收到响应，则认为该次探测失败</li>
<li><code>successThreshold</code>：监测成功的阈值，即监测成功几次才能认为是成功</li>
<li><code>failureThreshold</code>：监测失败的阈值，即监测失败几次才能认为是失败</li>
</ul>
<p>引入 startup Probe 是专门应对容器启动时间不固定的场景，需要把 <code>failureThreshold</code> 尽量设置大点，检测时间长没关系；而 liveness Probe 和 readiness Probe 启动之后检测要短平快，及时检测到问题</p>
<h3 id="2-5-2-探针示例"><a href="#2-5-2-探针示例" class="headerlink" title="2.5.2 探针示例"></a>2.5.2 探针示例</h3><p>范例：同时定义了三种探针</p>
<ul>
<li>startup使用了Exec Action</li>
<li>liveness和readiness使用HTTPGet Action</li>
</ul>
<p>测试效果</p>
<ul>
<li>liveness：<code>URL “/livez”</code> 支持以POST方法为livez参数设定不同值，非OK值都以5xx响应码响应；</li>
<li>readiness：<code>URL “/readyz”</code> 支持以POST方法为readyz参数设定不同值，非OK值都以5xx响应码响应；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-probe-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/demoapp:v1.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;&quot;$(curl -s 127.0.0.1/livez)&quot;==&quot;OK&quot;&#x27;</span>]</span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&#x27;/livez&#x27;</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&#x27;/readyz&#x27;</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<p>范例：startup</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">startup-exec-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/demoapp:v1.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;[ &quot;$(/usr/bin/curl -s http://127.0.0.1/livez)&quot; == &quot;OK&quot; ]&#x27;</span>]</span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">#说明[ &quot;$(/usr/bin/curl -s http://127.0.0.1/livez)&quot; == &quot;OK&quot; ]</span></span><br><span class="line"><span class="string">/usr/bin/curl</span> <span class="string">-s</span> <span class="string">http://127.0.0.1/livez</span>		</span><br><span class="line"><span class="comment">#结果为OK或FALIS</span></span><br><span class="line"><span class="string">$(/usr/bin/curl</span> <span class="string">-s</span> <span class="string">http://127.0.0.1/livez)</span>	</span><br><span class="line"><span class="comment">#变量值，取决于/usr/bin/curl -s http://127.0.0.1/livez的结果</span></span><br><span class="line">[ <span class="string">&quot;$(/usr/bin/curl -s http://127.0.0.1/livez)&quot;</span> <span class="string">==</span> <span class="string">&quot;OK&quot;</span> ]	</span><br><span class="line"><span class="comment">#[]条件测试，$(/usr/bin/curl -s http://127.0.0.1/livez)的值如果为OK，则为0,否则非0</span></span><br></pre></td></tr></table></figure>

<p>范例：liveness-exec</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#vim liveness-exec-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-exec-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    livenessProbe:</span><br><span class="line">      <span class="built_in">exec</span>:</span><br><span class="line">        <span class="comment">#command: [&#x27;/bin/sh&#x27;, &#x27;-c&#x27;, &#x27;[ &quot;$(curl -s 127.0.0.1/livez)&quot; == &quot;OK&quot; ]&#x27;]</span></span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;[ &quot;$(/usr/bin/curl -s http://127.0.0.1/livez)&quot; == &quot;OK&quot; ]&#x27;</span>]</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      periodSeconds: 5</span><br><span class="line">      </span><br><span class="line">[root@master1 pods]#kubectl apply -f liveness-exec-demo.yaml</span><br><span class="line">pod/liveness-exec-demo created</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl get pods -o wide</span><br><span class="line">NAME                      READY   STATUS    RESTARTS      AGE   IP            NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">liveness-exec-demo        1/1     Running   0             31m   10.244.2.19   node2.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl describe pods liveness-exec-demo</span><br><span class="line">Restart Count:  0		<span class="comment">#重启次数</span></span><br><span class="line">Liveness:       <span class="built_in">exec</span> [/bin/sh -c [ <span class="string">&quot;<span class="subst">$(/usr/bin/curl -s http://127.0.0.1/livez)</span>&quot;</span> == <span class="string">&quot;OK&quot;</span> ]] delay=5s <span class="built_in">timeout</span>=1s period=5s <span class="comment">#success=1 #failure=3</span></span><br><span class="line">Events:					<span class="comment">#发生事件</span></span><br><span class="line">  Type     Reason     Age    From               Message</span><br><span class="line">  ----     ------     ----   ----               -------</span><br><span class="line">  Normal   Scheduled  3m19s  default-scheduler  Successfully assigned default/liveness-exec-demo to node2.wang.org</span><br><span class="line">  Normal   Pulled     3m18s  kubelet            Container image <span class="string">&quot;ikubernetes/demoapp:v1.0&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    3m18s  kubelet            Created container demo</span><br><span class="line">  Normal   Started    3m18s  kubelet            Started container demo</span><br><span class="line">  Warning  Unhealthy  3m8s   kubelet            Liveness probe failed: <span class="built_in">command</span> <span class="string">&quot;/bin/sh -c [ \&quot;<span class="subst">$(/usr/bin/curl -s http://127.0.0.1/livez)</span>\&quot; == \&quot;OK\&quot; ]&quot;</span> timed out		<span class="comment">#这里失败，但是没有重启，所以推断它只是首次监测失败</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#模拟失败</span></span><br><span class="line">[root@master1 pods]#curl -X POST -d <span class="string">&#x27;livez=FALI&#x27;</span> 10.244.2.19/livez</span><br><span class="line">[root@master1 pods]#curl 10.244.2.19/livez</span><br><span class="line">FALI</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl describe pods liveness-exec-demo</span><br><span class="line">Events:					</span><br><span class="line">  Type     Reason     Age    			From               Message</span><br><span class="line">  ----     ------     ----   			----               -------</span><br><span class="line">  Normal   Scheduled  3m19s  			default-scheduler  Successfully assigned default/liveness-exec-demo to node2.wang.org</span><br><span class="line">  Normal   Pulled     3m18s  			kubelet            Container image <span class="string">&quot;ikubernetes/demoapp:v1.0&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    3m18s  			kubelet            Created container demo</span><br><span class="line">  Normal   Started    3m18s  			kubelet            Started container demo</span><br><span class="line">  Warning  Unhealthy  3m8s   			kubelet            Liveness probe failed: <span class="built_in">command</span> <span class="string">&quot;/bin/sh -c [ \&quot;<span class="subst">$(/usr/bin/curl -s http://127.0.0.1/livez)</span>\&quot; == \&quot;OK\&quot; ]&quot;</span> timed out</span><br><span class="line">  Warning  Unhealthy  3S(x3 over 13s)   kubelet            Liveness probe failed:</span><br><span class="line">  Normal   Killing    3s  				kubelet            Container demo faild liveness prode,will be resarted</span><br><span class="line">  </span><br><span class="line">[root@master1 pods]#kubectl get pods -o wide</span><br><span class="line">NAME                      READY   STATUS    RESTARTS      		  AGE   IP            NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">liveness-exec-demo        1/1     Running   1(8s ago)             31m   10.244.2.19   node2.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#curl 10.244.2.19/livez</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>范例：liveness-tcpsocket</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#vim liveness-tcpsocket-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-tcpsocket-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80</span><br><span class="line">    securityContext:  <span class="comment">#设置安全上下文</span></span><br><span class="line">      capabilities:</span><br><span class="line">        add:</span><br><span class="line">        - NET_ADMIN  <span class="comment">#允许在容器内执行iptables命令，一般来说iptables只能在宿主机执行，这里写主要是为了模拟失败</span></span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: http  <span class="comment">#使用ports定义的name来引用，也可以写80</span></span><br><span class="line">      periodSeconds: 5</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      </span><br><span class="line">[root@master1 pods]#kubectl apply -f liveness-tcpsocket-demo.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl get pods -o wide</span><br><span class="line">NAME                      READY   STATUS    RESTARTS      AGE   IP            NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">liveness-exec-demo        1/1     Running   0             40m   10.244.2.19   node2.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">liveness-tcpsocket-demo   1/1     Running   0             24s   10.244.1.16   node1.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl describe pods liveness-tcpsocket-demo</span><br><span class="line">Liveness:       tcp-socket :http delay=5s <span class="built_in">timeout</span>=1s period=5s <span class="comment">#success=1 #failure=3</span></span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  2m17s  default-scheduler  Successfully assigned default/liveness-tcpsocket-demo to node1.wang.org</span><br><span class="line">  Normal  Pulled     2m17s  kubelet            Container image <span class="string">&quot;ikubernetes/demoapp:v1.0&quot;</span> already present on machine</span><br><span class="line">  Normal  Created    2m17s  kubelet            Created container demo</span><br><span class="line">  Normal  Started    2m16s  kubelet            Started container demo</span><br><span class="line">  </span><br><span class="line"><span class="comment">#模拟失败</span></span><br><span class="line">[root@master1 pods]#kubectl <span class="built_in">exec</span> -it liveness-tcpsocket-demo -- /bin/sh</span><br><span class="line">[root@liveness-tcpsocket-demo /]# iptables -A INPUT -p tcp --dport=80 -j REJECT</span><br><span class="line">[root@liveness-tcpsocket-demo /]# iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    3   180 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 3 packets, 264 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination    </span><br><span class="line"> </span><br><span class="line">[root@master1 pods]#kubectl describe pods liveness-tcpsocket-demo</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                   From               Message</span><br><span class="line">  ----     ------     ----                  ----               -------</span><br><span class="line">  Normal   Scheduled  9m4s                  default-scheduler  Successfully assigned default/liveness-tcpsocket-demo to node1.wang.org</span><br><span class="line">  Warning  Unhealthy  2m13s                 kubelet            Liveness probe failed: dial tcp 10.244.1.16:80: connect: connection refused</span><br><span class="line">  Normal   Killing    83s (x3 over 3m3s)    kubelet            Container demo failed liveness probe, will be restarted</span><br><span class="line">  Normal   Pulled     53s (x4 over 9m4s)    kubelet            Container image <span class="string">&quot;ikubernetes/demoapp:v1.0&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    53s (x4 over 9m4s)    kubelet            Created container demo</span><br><span class="line">  Normal   Started    53s (x4 over 9m3s)    kubelet            Started container demo</span><br><span class="line">  Warning  Unhealthy  38s (x10 over 3m13s)  kubelet            Liveness probe failed: dial tcp 10.244.1.16:80: i/o <span class="built_in">timeout</span></span><br><span class="line">  </span><br><span class="line">[root@master1 pods]#kubectl get pods -o wide</span><br><span class="line">NAME                      READY   STATUS    RESTARTS      AGE     IP            NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">liveness-exec-demo        1/1     Running   0             47m     10.244.2.19   node2.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">liveness-tcpsocket-demo   1/1     Running   3 (50s ago)   7m22s   10.244.1.16   node1.wang.org   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>范例：liveness-httpget</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#vim liveness-httpget-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-httpget-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: <span class="string">&#x27;/livez&#x27;</span>		<span class="comment">#指定向本地哪个路径发起请求，默认为根</span></span><br><span class="line">        port: 80</span><br><span class="line">        scheme: HTTP</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      </span><br><span class="line">[root@master1 pods]#kubectl apply -f liveness-httpget-demo.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl get pods -o wide</span><br><span class="line">NAME                      READY   STATUS    RESTARTS       AGE   IP            NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">liveness-exec-demo        1/1     Running   0              52m   10.244.2.19   node2.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">liveness-httpget-demo     1/1     Running   0              10s   10.244.2.20   node2.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">liveness-tcpsocket-demo   1/1     Running   6 (102s ago)   12m   10.244.1.16   node1.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl describe pods liveness-httpget-demo</span><br><span class="line">Liveness:       http-get http://:80/livez delay=5s <span class="built_in">timeout</span>=1s period=10s <span class="comment">#success=1 #failure=3</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age   From               Message</span><br><span class="line">  ----     ------     ----  ----               -------</span><br><span class="line">  Normal   Scheduled  56s   default-scheduler  Successfully assigned default/liveness-httpget-demo to node2.wang.org</span><br><span class="line">  Normal   Pulled     56s   kubelet            Container image <span class="string">&quot;ikubernetes/demoapp:v1.0&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    56s   kubelet            Created container demo</span><br><span class="line">  Normal   Started    56s   kubelet            Started container demo</span><br><span class="line">  Warning  Unhealthy  45s   kubelet            Liveness probe failed: Get <span class="string">&quot;http://10.244.2.20:80/livez&quot;</span>: context deadline exceeded (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br><span class="line">  </span><br><span class="line"><span class="comment">#模拟失败方法跟exec一样</span></span><br></pre></td></tr></table></figure>

<p>范例：readiness</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#kubectl create service clusterip readiness-httpget-demo --tcp=80:80 --dry-run=client -o yaml &gt;&gt; readiness-httpget-demo.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#vim readiness-httpget-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: readiness-httpget-demo</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    name: readiness-httpget-demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    readinessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: <span class="string">&#x27;/readyz&#x27;</span></span><br><span class="line">        port: 80</span><br><span class="line">        scheme: HTTP</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      timeoutSeconds: 2</span><br><span class="line">      periodSeconds: 5</span><br><span class="line">      failureThreshold: 3</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: readiness-httpget-demo</span><br><span class="line">  name: readiness-httpget-demo</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: 80-80</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    name: readiness-httpget-demo</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  </span><br><span class="line">[root@master1 pods]#kubectl apply -f readiness-httpget-demo.yaml </span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl get pods,services -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS      AGE   IP            NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/readiness-httpget-demo    1/1     Running   0             44s   10.244.1.17   node1.wang.org   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">service/readiness-httpget-demo   ClusterIP   10.99.186.245   &lt;none&gt;        80/TCP    44s   name=readiness-httpget-demo</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl describe service readiness-httpget-demo</span><br><span class="line">Name:              readiness-httpget-demo</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            app=readiness-httpget-demo</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          name=readiness-httpget-demo</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Family Policy:  SingleStack</span><br><span class="line">IP Families:       IPv4</span><br><span class="line">IP:                10.99.186.245</span><br><span class="line">IPs:               10.99.186.245</span><br><span class="line">Port:              80-80  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.244.1.17:80  <span class="comment"># 有说明可以作为可用后端</span></span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl describe pods readiness-httpget-demo</span><br><span class="line">Readiness:      http-get http://:80/readyz delay=15s <span class="built_in">timeout</span>=2s period=5s <span class="comment">#success=1 #failure=3</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                    From               Message</span><br><span class="line">  ----     ------     ----                   ----               -------</span><br><span class="line">  Normal   Scheduled  2m47s                  default-scheduler  Successfully assigned default/readiness-httpget-demo to node1.wang.org</span><br><span class="line">  Normal   Pulled     2m47s                  kubelet            Container image <span class="string">&quot;ikubernetes/demoapp:v1.0&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    2m47s                  kubelet            Created container demo</span><br><span class="line">  Normal   Started    2m47s                  kubelet            Started container demo</span><br><span class="line">  Warning  Unhealthy  2m15s (x3 over 2m25s)  kubelet            Readiness probe failed: Get <span class="string">&quot;http://10.244.1.17:80/readyz&quot;</span>: context deadline exceeded (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br><span class="line">  </span><br><span class="line"><span class="comment">#模拟失败</span></span><br><span class="line">[root@master1 pods]#curl -X POST -d <span class="string">&#x27;readyz=FALI&#x27;</span> 10.244.1.17/readyz</span><br><span class="line">[root@master1 pods]#curl 10.244.1.17/readyz</span><br><span class="line">FALI</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl describe pods readiness-httpget-demo</span><br><span class="line">Readiness:      http-get http://:80/readyz delay=15s <span class="built_in">timeout</span>=2s period=5s <span class="comment">#success=1 #failure=3</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                    From               Message</span><br><span class="line">  ----     ------     ----                   ----               -------</span><br><span class="line">  Normal   Scheduled  2m47s                  default-scheduler  Successfully assigned default/readiness-httpget-demo to node1.wang.org</span><br><span class="line">  Normal   Pulled     2m47s                  kubelet            Container image <span class="string">&quot;ikubernetes/demoapp:v1.0&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    2m47s                  kubelet            Created container demo</span><br><span class="line">  Normal   Started    2m47s                  kubelet            Started container demo</span><br><span class="line">  Warning  Unhealthy  111s(x3 over 2mls) 	 kubelet 			Readiness probe failed: Get <span class="string">&quot;http://10.244.1.17/readyz&quot;</span>: context deadline exceeded (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br><span class="line">  Warning  Unhealthy  3s(x8 over 33s)  		 kubelet            Readiness probe failed: HTTp probe failed with statuscode: 507</span><br><span class="line">  </span><br><span class="line">[root@master1 pods]#kubectl describe service readiness-httpget-demo</span><br><span class="line">Name:              readiness-httpget-demo</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            app=readiness-httpget-demo</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          name=readiness-httpget-demo</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Family Policy:  SingleStack</span><br><span class="line">IP Families:       IPv4</span><br><span class="line">IP:                10.99.186.245</span><br><span class="line">IPs:               10.99.186.245</span><br><span class="line">Port:              80-80  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         					<span class="comment">#被移除</span></span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># READY表示就绪状态</span></span><br><span class="line">[root@master1 pods]#kubectl get pods</span><br><span class="line">NAME                    READY   STATUS    RESTARTS        AGE</span><br><span class="line">readiness-httpget-demo  0/1     Running   7 (2d20h ago)   2d20h</span><br></pre></td></tr></table></figure>

<h2 id="2-6-Security-Context"><a href="#2-6-Security-Context" class="headerlink" title="2.6 Security Context"></a>2.6 Security Context</h2><h3 id="2-6-1-Security-Context介绍"><a href="#2-6-1-Security-Context介绍" class="headerlink" title="2.6.1 Security Context介绍"></a>2.6.1 Security Context介绍</h3><p>在容器中，里面的root用户是虚拟的，并不像宿主机的root用户具有所有权限，但有时我们需要给它们赋予一些权限，但我们不可能给它们所有的权限，而容器的本质就是宿主机上运行的一个进程，为了运行安全，必须要给进程的权限加以控制，就需要用到Security Context来设置</p>
<p>Security Context（安全上下文）是Kubernetes 中用于定义 Pod 或容器安全设置的配置，允许用户为Pod或容器定义一系列特权与访问控制设置。Pod和容器的Security Context设置主要包括以下几个方面：</p>
<ul>
<li>用户和组ID<ul>
<li>可以设置容器内进程的用户(<code>runAsUser</code>)和组(<code>runAsGroup</code>)ID，以控制进程的权限</li>
<li>有效避免以root用户身份运行容器进程</li>
</ul>
</li>
<li>特权设置<ul>
<li>可以启用特权模式( <code>privileged</code> )，让容器内的root变成真正的管理员账号</li>
<li>只能在容器级别设置</li>
</ul>
</li>
<li>访问控制<ul>
<li>Linux Capabilities：给某个特定的进程赋予root用户的部分特权而非全部特权</li>
<li>AppArmor：使用程序文件来限制单个程序的权限，即在安全配置文件中指定特定程序被允许执行的操作</li>
<li>SELinux：为对象分配 SELinux 标签</li>
<li>Seccomp：使用配置文件来限制容器中进程的系统调用(system call)</li>
</ul>
</li>
<li>AllowPrivilegeEscalation(允许特权扩大)<ul>
<li>此项配置是一个布尔值，定义了一个进程是否可以比其父进程获得更多的特权，直接效果是容器的进程上是否被设置no_new_privs 标记。当出现如下情况时，AllowPrivilegeEscalation 的值始终为 true<ul>
<li>容器以 privileged 模式运行</li>
<li>容器拥有 <code>CAP_SYS_ADMIN</code> 的 Linux capability</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Kubernetes支持在Pod及容器级别分别使用安全上下文，提供了三种配置安全上下文的方法：</p>
<ul>
<li>容器级别：仅应用到指定的容器</li>
<li>Pod级别：应用到 Pod 内所有容器以及 volume</li>
<li>Pod Security Policy(PSP)：应用到集群内部所有 Pod 以及 Vo]ume（已弃用）</li>
</ul>
<p>查看帮助</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pod级别</span></span><br><span class="line">[root@master1 pods]#kubectl explain pod.spec.securityContext</span><br><span class="line"></span><br><span class="line"><span class="comment">#容器级别</span></span><br><span class="line">[root@master1 pods]#kubectl explain pod.spec.containers.securityContext</span><br></pre></td></tr></table></figure>

<p>安全上下文的应用场景</p>
<ul>
<li>自定义对象访问权限：通过设置安全上下文，你可以控制容器对其他Kubernetes对象的访问权限。例如，你可以限制容器只能访问特定的<a href="https://cloud.baidu.com/product/bos.html">存储</a>卷或不允许容器访问某些API端点。</li>
<li>控制容器的运行方式：通过设置容器的安全上下文，你可以决定容器以特权模式还是非特权模式运行。特权模式允许容器执行一些特权操作，而非特权模式则限制容器的权限以增强安全性。</li>
<li>SELinux和Linux Capabilities：安全上下文可以与SELinux和Linux Capabilities结合使用，为容器提供更细粒度的权限控制。SELinux为对象分配Security标签，而Linux Capabilities则允许为容器分配部分特权，而不是root用户的所有特权。</li>
<li>进程能力限制：通过设置容器的安全上下文，可以限制进程的系统调用能力，以减少潜在的安全风险。例如，使用Seccomp可以过滤容器的进程系统调用，从而降低潜在的安全风险。</li>
<li>防止特权提升：通过配置安全上下文的AllowPrivilegeEscalation选项，可以防止容器内的进程获得比其父进程更多的特权。这有助于防止潜在的特权提升攻击。</li>
</ul>
<p>查看capabilities的帮助</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://man7.org/linux/man-pages/man7/capabilities.7.html</span><br></pre></td></tr></table></figure>

<p>常用选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CAP_NET_ADMIN</span></span><br><span class="line">执行各种与网络相关的操作：</span><br><span class="line">接口配置；</span><br><span class="line">管理IP防火墙、伪装和记帐；</span><br><span class="line">修改路由表；</span><br><span class="line">绑定到任何地址以进行透明代理；</span><br><span class="line">设置服务类型 (TOS)；</span><br><span class="line">清除驱动程序统计信息；</span><br><span class="line">设置混杂模式；</span><br><span class="line">启用多播；</span><br><span class="line">使用setsockopt(2)设置以下套接字选项：SO_DEBUG、SO_MARK、SO_PRIORITY（对于 0 到 6 范围之外的优先级）、SO_RCVBUFFORCE和 SO_SNDBUFFORCE。</span><br><span class="line"></span><br><span class="line"><span class="comment">#CAP_NET_BIND_SERVICE</span></span><br><span class="line">将套接字绑定到Internet域特权端口（端口号小于 1024），即普通用户具有使用特权端口的权限。CAP_NET_ADMIN里也具有这个功能</span><br><span class="line"></span><br><span class="line"><span class="comment">#CAP_CHOWN</span></span><br><span class="line">对文件UID和GID进行任意更改</span><br></pre></td></tr></table></figure>

<h3 id="2-6-2-设置Pod级的Security-Context"><a href="#2-6-2-设置Pod级的Security-Context" class="headerlink" title="2.6.2 设置Pod级的Security Context"></a>2.6.2 设置Pod级的Security Context</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">security-context-pod-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">securityContext:</span>  <span class="comment"># Pod级别的安全上下文配置，作用于所有容器</span></span><br><span class="line">    <span class="attr">runAsUser:</span> <span class="number">1000</span>  <span class="comment"># 所有容器内的进程以UID 1000身份运行</span></span><br><span class="line">    <span class="attr">runAsGroup:</span> <span class="number">3000</span>  <span class="comment"># 所有容器内的进程以GID 3000身份运行（省略时默认GID为0，即root组）</span></span><br><span class="line">    <span class="attr">fsGroup:</span> <span class="number">2000</span>  <span class="comment"># Pod中所有容器挂载的卷（支持的卷类型）及卷内文件的GID为2000</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-volume</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sec-ctx-demo</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;sleep 60m&#x27;</span>]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/pod/demo</span>  <span class="comment"># 卷挂载路径，受fsGroup影响，该路径的GID及该路径下创建的子文件的GID都为2000</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="2-6-3-设置Container级的Security-Context"><a href="#2-6-3-设置Container级的Security-Context" class="headerlink" title="2.6.3 设置Container级的Security Context"></a>2.6.3 设置Container级的Security Context</h3><p>Container级与Pod级冲突时，容器级会覆盖Pod级，并且容器级的Security Context设置不会影响Pod中的数据卷</p>
<p>范例：使用capabilities</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#vim securitycontext-capabilities-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: securitycontext-capabilities-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>]</span><br><span class="line">    args: [<span class="string">&quot;/sbin/iptables -t nat -A PREROUTING -p tcp --dport 8080 -j REDIRECT --to-port 80 &amp;&amp; /usr/bin/python3 /usr/local/bin/demo.py&quot;</span>]</span><br><span class="line">    securityContext:</span><br><span class="line">      capabilities:	  <span class="comment">#用于设置容器安全上下文的一个字段，它允许你为容器添加或删除特定的Linux功能，比如网络接口数据</span></span><br><span class="line">        add: [<span class="string">&#x27;NET_ADMIN&#x27;</span>]		<span class="comment">#为容器添加了NET_ADMIN功能</span></span><br><span class="line">        <span class="comment">#drop: [&#x27;CHOWN&#x27;]		#从容器中删除CHOWN这个Linux功能</span></span><br></pre></td></tr></table></figure>

<p>范例：指定普通用户来运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#vim liveness-tcpsocket-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-tcpsocket-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80</span><br><span class="line">    securityContext:</span><br><span class="line">      runAsUser: 1001	<span class="comment">#指定用户</span></span><br><span class="line">      runAsGroup: 1001	<span class="comment">#指定用户组</span></span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: http  <span class="comment">#使用ports定义的name来引用，也可以写80</span></span><br><span class="line">      periodSeconds: 5</span><br><span class="line">      initialDelaySeconds: 5</span><br></pre></td></tr></table></figure>

<p>测试的时候，发现普通用户可以监听80端口，按道理来说普通用户不可以监听1023以内的端口的，估计是新版kubernetes默认可以监听，可以进行禁用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#vim liveness-tcpsocket-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-tcpsocket-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80</span><br><span class="line">    securityContext:</span><br><span class="line">      capabilities:</span><br><span class="line">        drop: [<span class="string">&#x27;NET_BIND_SERVICE&#x27;</span>]	<span class="comment">#从容器中删除NET_BIND_SERVICE这个Linux功能</span></span><br><span class="line">      runAsUser: 1001	<span class="comment">#指定用户</span></span><br><span class="line">      runAsGroup: 1001	<span class="comment">#指定用户组</span></span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: http  <span class="comment">#使用ports定义的name来引用，也可以写80</span></span><br><span class="line">      periodSeconds: 5</span><br><span class="line">      initialDelaySeconds: 5</span><br></pre></td></tr></table></figure>

<p>范例：开启特权模式</p>
<p>场景：k8s部署ES的时候需要初始化很多linux的内核参数。但是文件系统挂载到pod容器中就会变成read-only，难以进行操作实现需求。所以需要给Pod privileged权限，然后在容器的初始化脚本或代码中去修改sysctl参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo3</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;sleep 60m&#x27;</span>]</span><br><span class="line">      <span class="attr">securityContext:</span>  <span class="comment"># #只能在container级设置，pod级无法设置</span></span><br><span class="line">        <span class="attr">privileged:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>容器内修改的内核参数，不会影响宿主机上的内核参数，因为容器使用的是宿主机的内核，但隔离了部分内核的功能，即使容器是在 privileged 模式下运行，某些行为还是受到限制的，特别是那些能够影响到宿主机本身的操作，所以这些修改是隔离在容器层面的，并不会应用到宿主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-01~]# kubectl <span class="built_in">exec</span> -ti demo3 sh</span><br><span class="line">/ <span class="comment"># cat/proc/sys/net/ipv4/ip_forward</span></span><br><span class="line">1</span><br><span class="line">/ <span class="comment"># echo 0 &gt; /proc/sys/net/ipv4/ip_forward</span></span><br><span class="line">/ <span class="comment"># cat/proc/sys/net/ipv4/ip_forward</span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">[root@k8s-master-01~]# <span class="built_in">cat</span> /proc/sys/net/ipv4/ip_forward</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h1 id="3-Downward-API"><a href="#3-Downward-API" class="headerlink" title="3 Downward API"></a>3 Downward API</h1><p>基于Downward API机制可以把容器所在pod的一些状态信息（pod名字、pod的ip、调度的节点，pod的注释、Label、Annotation）注入到容器中（在容器体现的形式可以是环境变量、也可以某个文件中的文件），这些信息可能会被容器内的应用用到，比如用Pod名字作为日志记录的一个字段用于表示日志来源</p>
<p>注意：</p>
<ul>
<li>Downward API 能够获取到的信息，一定是 Pod 里的容器进程启动之前就能够确定下来的信息。</li>
<li>而如果你想要获取 Pod 容器运行后才会出现的信息，比如，容器进程的 PID，那就肯定不能使用 Downward API 了，而应该考虑在 Pod 里定义一个 sidecar 容器来获取了。</li>
</ul>
<p>Downward API可以通过两种方式将Pod和容器的元数据注入容器内部</p>
<ul>
<li><p>环境变量：将Pod或Container信息设置为容器内的环境变量</p>
</li>
<li><p>Volume挂载：将Pod或Container的信息以文件形式挂载到容器内部</p>
</li>
</ul>
<h2 id="3-1-Doward-APl支持的Pod与Container信息"><a href="#3-1-Doward-APl支持的Pod与Container信息" class="headerlink" title="3.1 Doward APl支持的Pod与Container信息"></a>3.1 Doward APl支持的Pod与Container信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1.使用 fieldRef 可以声明使用:</span><br><span class="line">metadata.name       <span class="comment"># Pod的名字</span></span><br><span class="line">metadata.namespace  <span class="comment"># Pod的Namespace</span></span><br><span class="line">metadata.uid        <span class="comment"># Pod的UID</span></span><br><span class="line">metadata.labels[<span class="string">&#x27;&lt;KEY&gt;&#x27;</span>]       <span class="comment"># Pod某个Label的值，通过&lt;KEY&gt;进行引用</span></span><br><span class="line">metadata.annotations[<span class="string">&#x27;&lt;KEY&gt;&#x27;</span>]  <span class="comment"># Pod某个Annotation的值，通过&lt;KEY&gt;进行引用</span></span><br><span class="line">metadata.labels          <span class="comment"># Pod的所有Labe1</span></span><br><span class="line">metadata.annotations     <span class="comment"># Pod的所有Annotation</span></span><br><span class="line">spec.nodeName            <span class="comment"># 宿主机名字</span></span><br><span class="line">spec.serviceAccountName  <span class="comment"># Pod的Service Account的名字</span></span><br><span class="line">status.hostIp  <span class="comment"># 宿主机IP</span></span><br><span class="line">status.podIP   <span class="comment"># Pod的IP</span></span><br><span class="line"></span><br><span class="line">2.使用resourceFieldRef 可以声明使用:</span><br><span class="line">容器的 CPU <span class="built_in">limit</span></span><br><span class="line">容器的 CPU request</span><br><span class="line">容器的 memory <span class="built_in">limit</span></span><br><span class="line">容器的 memory request</span><br></pre></td></tr></table></figure>

<h2 id="3-2-环境变量"><a href="#3-2-环境变量" class="headerlink" title="3.2 环境变量"></a>3.2 环境变量</h2><p><code>fieldRef</code> 获取Pod的基本信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">	<span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">	<span class="attr">metadata:</span></span><br><span class="line">	  <span class="attr">name:</span> <span class="string">env-pod</span></span><br><span class="line">	<span class="attr">spec:</span></span><br><span class="line">	  <span class="attr">containers:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">env-pod</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">registry.cn-shanghai.aliyuncs.com/egon-k8s-test/busybox:v1.0</span></span><br><span class="line">		<span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">		<span class="attr">args:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;do</span></span><br><span class="line">		  <span class="string">echo</span> <span class="string">-en</span> <span class="string">&quot;\n&quot;</span><span class="string">;</span></span><br><span class="line">		  <span class="string">env;</span></span><br><span class="line">		  <span class="string">echo</span> <span class="string">&quot;===============&quot;</span><span class="string">;</span></span><br><span class="line">		  <span class="string">sleep</span> <span class="number">300</span><span class="string">;</span></span><br><span class="line">		  <span class="string">done;</span></span><br><span class="line">		<span class="attr">env:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">		  <span class="attr">valueFrom:</span></span><br><span class="line">			<span class="attr">fieldRef:</span></span><br><span class="line">			  <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">		  <span class="attr">valueFrom:</span></span><br><span class="line">			<span class="attr">fieldRef:</span></span><br><span class="line">			  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">		  <span class="attr">valueFrom:</span></span><br><span class="line">			<span class="attr">fieldRef:</span></span><br><span class="line">			  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">		  <span class="attr">valueFrom:</span></span><br><span class="line">			<span class="attr">fieldRef:</span></span><br><span class="line">			  <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br></pre></td></tr></table></figure>

<p><code>resourceFieldRef</code> 获取容器的资源申请和资源限制的信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">	<span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">	<span class="attr">metadata:</span></span><br><span class="line">	  <span class="attr">name:</span> <span class="string">dapi-envars-resourcefieldref</span></span><br><span class="line">	<span class="attr">spec:</span></span><br><span class="line">	  <span class="attr">containers:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">		  <span class="attr">image:</span> <span class="string">registry.cn-shanghai.aliyuncs.com/egon-k8s-test/busybox:v1.0</span></span><br><span class="line">		  <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">		  <span class="attr">args:</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">			  <span class="string">echo</span> <span class="string">-en</span> <span class="string">&#x27;\n&#x27;</span><span class="string">;</span></span><br><span class="line">			  <span class="string">printenv</span> <span class="string">MY_CPU_REQUEST</span> <span class="string">MY_CPU_LIMIT;</span></span><br><span class="line">			  <span class="string">printenv</span> <span class="string">MY_MEM_REQUEST</span> <span class="string">MY_MEM_LIMIT;</span></span><br><span class="line">			  <span class="string">sleep</span> <span class="number">10</span><span class="string">;</span></span><br><span class="line">			<span class="string">done;</span></span><br><span class="line">		  <span class="attr">resources:</span></span><br><span class="line">			<span class="attr">requests:</span></span><br><span class="line">			  <span class="attr">memory:</span> <span class="string">&quot;32Mi&quot;</span></span><br><span class="line">			  <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">			<span class="attr">limits:</span></span><br><span class="line">			  <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">			  <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">		  <span class="attr">env:</span></span><br><span class="line">			<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MY_CPU_REQUEST</span>  <span class="comment"># 1</span></span><br><span class="line">			  <span class="attr">valueFrom:</span></span><br><span class="line">				<span class="attr">resourceFieldRef:</span></span><br><span class="line">				  <span class="attr">containerName:</span> <span class="string">test-container</span></span><br><span class="line">				  <span class="attr">resource:</span> <span class="string">requests.cpu</span></span><br><span class="line">			<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MY_CPU_LIMIT</span>    <span class="comment"># 2</span></span><br><span class="line">			  <span class="attr">valueFrom:</span></span><br><span class="line">				<span class="attr">resourceFieldRef:</span></span><br><span class="line">				  <span class="attr">containerName:</span> <span class="string">test-container</span></span><br><span class="line">				  <span class="attr">resource:</span> <span class="string">limits.cpu</span></span><br><span class="line">			<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MY_MEM_REQUEST</span>  <span class="comment"># 32Mi</span></span><br><span class="line">			  <span class="attr">valueFrom:</span></span><br><span class="line">				<span class="attr">resourceFieldRef:</span></span><br><span class="line">				  <span class="attr">containerName:</span> <span class="string">test-container</span></span><br><span class="line">				  <span class="attr">resource:</span> <span class="string">requests.memory</span></span><br><span class="line">			<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MY_MEM_LIMIT</span>  <span class="comment"># &quot;64Mi&quot;</span></span><br><span class="line">			  <span class="attr">valueFrom:</span></span><br><span class="line">				<span class="attr">resourceFieldRef:</span></span><br><span class="line">				  <span class="attr">containerName:</span> <span class="string">test-container</span></span><br><span class="line">				  <span class="attr">resource:</span> <span class="string">limits.memory</span></span><br><span class="line">	  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<h2 id="3-3-Volume挂载"><a href="#3-3-Volume挂载" class="headerlink" title="3.3 Volume挂载"></a>3.3 Volume挂载</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">	<span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">	<span class="attr">metadata:</span></span><br><span class="line">	  <span class="attr">name:</span> <span class="string">volume-pod</span></span><br><span class="line">	  <span class="attr">labels:</span></span><br><span class="line">		<span class="attr">k8s-app:</span> <span class="string">test-volume</span></span><br><span class="line">		<span class="attr">node-env:</span> <span class="string">test</span></span><br><span class="line">	  <span class="attr">annotations:</span></span><br><span class="line">		<span class="attr">user:</span> <span class="string">egon</span></span><br><span class="line">		<span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">		<span class="attr">build:</span> <span class="string">test</span></span><br><span class="line">	<span class="attr">spec:</span></span><br><span class="line">	  <span class="attr">volumes:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">		<span class="attr">downwardAPI:</span></span><br><span class="line">		  <span class="attr">items:</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">labels</span></span><br><span class="line">			<span class="attr">fieldRef:</span></span><br><span class="line">			  <span class="attr">fieldPath:</span> <span class="string">metadata.labels</span></span><br><span class="line">		  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">annotations</span></span><br><span class="line">			<span class="attr">fieldRef:</span></span><br><span class="line">			  <span class="attr">fieldPath:</span> <span class="string">metadata.annotations</span></span><br><span class="line">	  <span class="attr">containers:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume-pod</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">		<span class="attr">args:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">		<span class="attr">volumeMounts:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">		  <span class="attr">mountPath:</span> <span class="string">/etc/podinfo</span></span><br></pre></td></tr></table></figure>

<h1 id="4-Pod的设计模式"><a href="#4-Pod的设计模式" class="headerlink" title="4 Pod的设计模式"></a>4 Pod的设计模式</h1><p>基于容器的分布式系统中常用的3类设计模式</p>
<ul>
<li>单容器模式：单一容器形式运行的应用，适合于那些小型且独立的应用，不需要与其他服务紧密协作</li>
<li>单节点模式：由强耦合的多个容器协同共生，比如Redis实例要运行两个容器，一个提供服务，另一个暴露指标给Prometheus监控</li>
<li>多节点模式：基于特定部署单元（Pod）实现分布式算法，比如Redis集群要实现的读写分离</li>
</ul>
<p>单节点多容器模式</p>
<ul>
<li>一种跨容器的设计模式，有以下四种模式</li>
<li>目的是在单个节点之上同时运行多个共生关系的容器，因而容器管理系统需要由将它们作为一个原子单位进行统一调度</li>
<li>Pod概念就是这个设计模式的实现之一，将一组容器（具有<strong>超亲密关系</strong>）组合在一起，并以原子方式进行管理。这种模式使得容器能够共享IP地址和端口空间，以及存储卷等资源</li>
</ul>
<h2 id="4-1-Sidecar模式：服务辅助"><a href="#4-1-Sidecar模式：服务辅助" class="headerlink" title="4.1 Sidecar模式：服务辅助"></a>4.1 Sidecar模式：服务辅助</h2><p>Pod中的应用由主应用程序（通常是基于HTTP协议的应用程序）以及一个Sidecar容器组成</p>
<p>辅助容器用于为主容器提供辅助服务以增强主容器的功能，是主应用程序是必不可少的一部分，但却未必非得运行为应用的一部分，可以认为是用来扩展主容器的功能而不必修改其代码</p>
<p>这种模式主要是为了解耦主应用，让主应用专注于核心业务逻辑，与辅助功能分离。例如监控Redis，主应用容器负责业务逻辑处理，辅助容器负责暴露指标给Prometheus。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># demoapp负责自身业务处理，nginx为他做反向代理</span></span><br><span class="line">[root@master1 pods]#vim sidecar-container-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: sidecar-container-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:1.24-alpine</span><br><span class="line">    </span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">env</span>:</span><br><span class="line">    - name: HOST</span><br><span class="line">      value: <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    - name: PORT</span><br><span class="line">      value: <span class="string">&quot;8080&quot;</span></span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl apply -f sidecar-container-demo.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 pods]#kubectl get pods</span><br><span class="line">NAME                      READY   STATUS    RESTARTS        AGE</span><br><span class="line">sidecar-container-demo    2/2     Running   0               73s</span><br><span class="line"></span><br><span class="line"><span class="comment">#-c表示指定容器</span></span><br><span class="line">[root@master1 pods]#kubectl <span class="built_in">exec</span> -it sidecar-container-demo -c demo -- /bin/sh</span><br><span class="line">[root@sidecar-container-demo /]# ps aux</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 python3 /usr/local/bin/demo.py</span><br><span class="line">    8 root      0:00 /bin/sh</span><br><span class="line">   14 root      0:00 ps axu</span><br><span class="line">   </span><br><span class="line">[root@master1 pods]#kubectl <span class="built_in">exec</span> -it sidecar-container-demo -c nginx -- /bin/sh</span><br><span class="line">/ <span class="comment"># ps aux</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 nginx: master process nginx -g daemon off;</span><br><span class="line">   30 nginx     0:00 nginx: worker process</span><br><span class="line">   31 nginx     0:00 nginx: worker process</span><br><span class="line">   32 nginx     0:00 nginx: worker process</span><br><span class="line">   33 nginx     0:00 nginx: worker process</span><br><span class="line">   40 root      0:00 /bin/sh</span><br><span class="line">   47 root      0:00 ps aux</span><br><span class="line">   </span><br><span class="line">/ <span class="comment"># cd /etc/nginx/</span></span><br><span class="line">/etc/nginx <span class="comment"># ls</span></span><br><span class="line">conf.d          fastcgi_params  modules         scgi_params</span><br><span class="line">fastcgi.conf    mime.types      nginx.conf      uwsgi_params</span><br></pre></td></tr></table></figure>

<h2 id="4-2-Ambassador模式：网络代理"><a href="#4-2-Ambassador模式：网络代理" class="headerlink" title="4.2 Ambassador模式：网络代理"></a>4.2 Ambassador模式：网络代理</h2><p>Pod中的应用由主应用程序和一个Ambassador容器组成</p>
<p>辅助容器代表主容器发送网络请求至外部环境中，即作为主应用与外部服务之间的代理，因此可以将其视作主容器应用的“大使”</p>
<p>应用场景：云原生应用程序需要诸如断路、路由、计量和监视等功能，但更新已有的应用程序或现有代码库以添加这些功能可能很困难，甚至难以实现，进程通信代理便成了一种有效的解决方案</p>
<p>例如，一个微服务应用需要调用多个第三方的天气、地图等 API，大使容器可以统一处理这些 API 的调用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#vim ambassador-container-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: ambassador-container-demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: curl</span><br><span class="line">    image: ikubernetes/admin-box:v1.2</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;999999&quot;</span>]</span><br><span class="line">    </span><br><span class="line">  - name: ambassador</span><br><span class="line">    image: bitnami/kubectl:latest</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;kubectl proxy&quot;</span>]  <span class="comment">#创建一个代理服务器，curl容器通过它来访问本地的Kubernetes API服务器</span></span><br><span class="line">    args:</span><br><span class="line">    <span class="comment"># 传递给 kubectl proxy 的选项，若需要改变默认监听的tcp/8001端口，可以额外附加“--port=NUM”选项；</span></span><br><span class="line">    - --server=<span class="string">&quot;https://kubernetes.default.svc&quot;</span></span><br><span class="line">    - --certificate-authority=<span class="string">&quot;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&quot;</span></span><br><span class="line">    - --token=<span class="string">&quot;<span class="subst">$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>&quot;</span></span><br><span class="line">    - --accept-paths=<span class="string">&#x27;^.\*&#x27;</span></span><br><span class="line">    </span><br><span class="line">[root@master1 pods]#kubectl <span class="built_in">exec</span> -it ambassador-container-demo -c curl -- /bin/sh</span><br><span class="line">root@ambassador-container-demo <span class="comment"># curl localhost:8001/api/</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;APIVersions&quot;</span>,</span><br><span class="line">  <span class="string">&quot;versions&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;v1&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;serverAddressByClientCIDRs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;clientCIDR&quot;</span>: <span class="string">&quot;0.0.0.0/0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;serverAddress&quot;</span>: <span class="string">&quot;10.0.0.183:6443&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-Adapter模式：接口转换（适配器）"><a href="#4-3-Adapter模式：接口转换（适配器）" class="headerlink" title="4.3 Adapter模式：接口转换（适配器）"></a>4.3 Adapter模式：接口转换（适配器）</h2><p>Pod中的应用由主应用程序和一个Adapter容器组成</p>
<p>Adapter容器为主应用程序提供一致的接口，实现了模块重用，支持标准化和规范化主容器应用程序的输出，即将主应用的输出或输入转换为其他系统能够理解的格式，以便于外部服务进行聚合</p>
<p>允许一个容器充当其他容器或外部工具与主应用容器之间交互的适配器。这在需要将遗留系统或外部服务与现代微服务架构集成时非常有用。适配器容器可以转换数据格式、协议或者处理认证等任务，使得主应用容器可以更容易地与其他系统进行通信。</p>
<p>例如，主应用输出的是 XML 格式的数据，而外部系统需要 JSON 格式，适配器容器可以完成 XML 到 JSON 的转换；主应用使用 HTTP 协议，而外部系统使用 gRPC 协议，适配器容器可以在两者之间进行协议转换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#vim adapter-container-demo.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-conf</span><br><span class="line">data:</span><br><span class="line">  default.conf: |</span><br><span class="line">    server &#123;</span><br><span class="line">      listen       80;</span><br><span class="line">      server_name  localhost;</span><br><span class="line">      location / &#123;</span><br><span class="line">          root   /usr/share/nginx/html;</span><br><span class="line">          index  index.html index.htm;</span><br><span class="line">      &#125;</span><br><span class="line">      error_page   500 502 503 504  /50x.html;</span><br><span class="line">      location = /50x.html &#123;</span><br><span class="line">          root   /usr/share/nginx/html;</span><br><span class="line">      &#125;</span><br><span class="line">      location /nginx_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">        allow 127.0.0.1;</span><br><span class="line">        deny all;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: adapter-container-demo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80  <span class="comment">#表明nginx容器内部使用的是80端口</span></span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /etc/nginx/conf.d/</span><br><span class="line">      name: nginx-conf</span><br><span class="line">      readOnly: <span class="literal">true</span></span><br><span class="line">      </span><br><span class="line">  - name: adapter</span><br><span class="line">    image: nginx/nginx-prometheus-exporter:latest  <span class="comment">#暴露nginx的指标，并转换为Prometheus兼容的格式给Prometheus监控</span></span><br><span class="line">    args: [<span class="string">&quot;-nginx.scrape-uri&quot;</span>,<span class="string">&quot;http://localhost/nginx_status&quot;</span>]</span><br><span class="line">    ports:</span><br><span class="line">    <span class="comment"># nginx-prometheus-exporter默认监听tcp/9113端口</span></span><br><span class="line">    - name: exporter</span><br><span class="line">      containerPort: 9113</span><br><span class="line">  volumes:</span><br><span class="line">  - name: nginx-conf</span><br><span class="line">    configMap:</span><br><span class="line">      name: nginx-conf</span><br><span class="line">      items:</span><br><span class="line">      - key: default.conf</span><br><span class="line">        path: default.conf</span><br></pre></td></tr></table></figure>

<h2 id="4-4-Init-Container模式：初始化容器"><a href="#4-4-Init-Container模式：初始化容器" class="headerlink" title="4.4 Init Container模式：初始化容器"></a>4.4 Init Container模式：初始化容器</h2><p>一个Pod中可以同时定义多个Init容器，在containers定义的业务容器启动之前先启动，串行运行以完成初始化</p>
<p>Init容器负责初始化包括在文件系统上设置必要的特殊权限、数据库模式设置或为主应用程序提供初始数据等，但这些初始化逻辑无法包含在应用程序的镜像文件中，或者出于安全原因，应用程序镜像没有执行初始化活动的权限等等</p>
<p>Init容器重启</p>
<ul>
<li>整个pod只要不重启，init容器就会只执行一次，并且init容器并不一定会重新运行</li>
<li>如果是自主式pod<ul>
<li>只更新了containers业务容器的镜像，不会触发pod的重启，那自然也不会不会重新执行init容器</li>
<li>更新initcontainer的镜像，也不会触发pod的重启，，那自然也不会不会重新执行init容器</li>
</ul>
</li>
<li>如果是由控制器管控的pod，那必然会运行init容器</li>
</ul>
<p>init容器运行失败，会依据pod的重启策略进行重启；init容器通常无需设置探针，探测通常设置在containers业务容器中</p>
<p>init container应用场景</p>
<ul>
<li>在启动前检测依赖的上下游服务端口是否就绪</li>
<li>做启动前的初始化配置，例如数据库初始化</li>
<li>启动前将pod信息注册到配置中心等场景</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 pods]#vim init-container-demo.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: init-container-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment">#在demo程序创建之前配置完成iptables规则</span></span><br><span class="line">  initContainers:</span><br><span class="line">  - name: iptables-init</span><br><span class="line">    image: ikubernetes/admin-box:latest</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>: [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">    args: [<span class="string">&#x27;iptables -t nat -A PREROUTING -p tcp --dport 8080 -j REDIRECT --to-port 80&#x27;</span>]</span><br><span class="line">    securityContext:</span><br><span class="line">      capabilities:</span><br><span class="line">        add:</span><br><span class="line">        - NET_ADMIN</span><br><span class="line">        </span><br><span class="line">  containers:</span><br><span class="line">  - name: demo</span><br><span class="line">    image: ikubernetes/demoapp:v1.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80</span><br></pre></td></tr></table></figure>

<h1 id="5-标签和标签选择器"><a href="#5-标签和标签选择器" class="headerlink" title="5 标签和标签选择器"></a>5 标签和标签选择器</h1><h2 id="5-1-附加标签"><a href="#5-1-附加标签" class="headerlink" title="5.1 附加标签"></a>5.1 附加标签</h2><p>标签：附加在资源对象上的键值型元数据</p>
<p>键标识：由“键前缀（可选）”和“键名”组成，格式为<code>“key_prefix/key_name”</code></p>
<ul>
<li>键前缀必须使用DNS域名格式</li>
<li>键名的命名格式：支持字母、数字、连接号、下划线和点号，且只能以字母或数字开头；最长63个字符；</li>
</ul>
<p>Pod 和 Node 的 label</p>
<ul>
<li>pod 的 label 与 node 的 label 操作方式几乎相同</li>
<li>node 的 label 用于 pod 调度到指定 label 的 node 节点</li>
<li>pod 的 label 用于controller关联控制的 pod</li>
</ul>
<p>通过YAML创建Pod时添加标签</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-stress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p><code>kubectl get pods --show-labels </code> 查看标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]#kubectl get pods --show-labels </span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">configmaps-env-demo        1/1     Running   0          25h   &lt;none&gt;</span><br><span class="line">pod-669649fb6-l6xdc        1/1     Running   0          25h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-669649fb6-v2f5h        1/1     Running   0          25h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-test-b896f97bf-lc7dv   1/1     Running   0          25h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line">pod-test-b896f97bf-nx4lf   1/1     Running   0          25h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line">secrets-env-demo           1/1     Running   0          23h   &lt;none&gt;</span><br><span class="line">secrets-volume-demo        1/1     Running   0          23h   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><code>kubectl label</code> 命令可管理对象的标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">kubectl label [--overwrite] (-f FILENAME | TYPE NAME) KEY_1=VAL_1 ... KEY_N=VAL_N [--resource-version=version] [options]</span><br><span class="line"><span class="comment">#赋予标签</span></span><br><span class="line">[root@master1 ~]#kubectl label pods secrets-env-demo app=mysql version=8.0</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods secrets-env-demo --show-labels </span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">secrets-env-demo           1/1     Running   0          23h   app=mysql,version=8.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#改标签，直接改会报错</span></span><br><span class="line">[root@master1 ~]#kubectl label pods secrets-env-demo version=8.1</span><br><span class="line">error: <span class="string">&#x27;version&#x27;</span> already has a value (8.0), and --overwrite is <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--overwrite 表示覆盖</span></span><br><span class="line">[root@master1 ~]#kubectl label --overwrite pods secrets-env-demo version=8.1</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods secrets-env-demo --show-labels </span><br><span class="line">NAME               READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">secrets-env-demo   1/1     Running   0          23h   app=mysql,version=8.1</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除标签</span></span><br><span class="line">[root@master1 ~]#kubectl label pods secrets-env-demo version-</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods secrets-env-demo --show-labels </span><br><span class="line">NAME               READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">secrets-env-demo   1/1     Running   0          23h   app=mysql</span><br></pre></td></tr></table></figure>

<p><code>kubectl annotate</code> 用于给Kubernetes对象添加注解。注解是一种元数据，可以用于描述对象的状态、行为或其他相关信息。通过注解，用户可以在不修改原始对象的情况下，为对象添加额外的信息，以便于管理和监控。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl annotate &lt;资源类型&gt; &lt;资源名称&gt; &lt;注解键&gt; [=&lt;注解值&gt;] [--overwrite]</span><br><span class="line">[root@master1 ~]#kubectl annotate pods secrets-env-demo app=mysql</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods secrets-env-demo -o yaml</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    app: mysql</span><br></pre></td></tr></table></figure>

<h2 id="5-2-标签选择器"><a href="#5-2-标签选择器" class="headerlink" title="5.2 标签选择器"></a>5.2 标签选择器</h2><p>Label Selector：用于对pod进行分类，同一类pod会拥有相同的标签，一个label是一个key&#x3D;value的键值组合，然后可以通过label selector（标签选择器）查询和筛选拥有某些label的资源对象。</p>
<p>标签选择器：基于标签筛选对象的过滤条件，支持两种类型</p>
<ul>
<li>基于等值关系的选择器</li>
<li>操作符：&#x3D;或&#x3D;&#x3D;、!&#x3D;</li>
<li>基于集合关系的选择器<ul>
<li>操作符：in、notin和exists</li>
<li>使用格式：KEY in (VALUE1, VALUE2, …)、 KEY notin (VALUE1, VALUE2, …)、KEY 和 !KEY</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]#kubectl label pods secrets-volume-demo app=mysql volume_type=nfs</span><br><span class="line">pod/secrets-volume-demo labeled</span><br><span class="line">[root@master1 ~]#kubectl label pods configmaps-env-demo app=nginx volume_type=nfs </span><br><span class="line">pod/configmaps-env-demo labeled</span><br><span class="line">[root@master1 ~]#kubectl get pods --show-labels </span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">configmaps-env-demo        1/1     Running   0          26h   app=nginx,volume_type=nfs</span><br><span class="line">pod-669649fb6-l6xdc        1/1     Running   0          26h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-669649fb6-v2f5h        1/1     Running   0          26h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-test-b896f97bf-lc7dv   1/1     Running   0          26h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line">pod-test-b896f97bf-nx4lf   1/1     Running   0          26h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line">secrets-env-demo           1/1     Running   0          24h   app=mysql</span><br><span class="line">secrets-volume-demo        1/1     Running   0          23h   app=mysql,volume_type=nfs</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods -l app=mysql --show-labels </span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">secrets-env-demo      1/1     Running   0          24h   app=mysql</span><br><span class="line">secrets-volume-demo   1/1     Running   0          23h   app=mysql,volume_type=nfs</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods -l app!=mysql --show-labels </span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">configmaps-env-demo        1/1     Running   0          26h   app=nginx,volume_type=nfs</span><br><span class="line">pod-669649fb6-l6xdc        1/1     Running   0          26h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-669649fb6-v2f5h        1/1     Running   0          26h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-test-b896f97bf-lc7dv   1/1     Running   0          26h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line">pod-test-b896f97bf-nx4lf   1/1     Running   0          26h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods -l <span class="string">&#x27;app in (mysql,nginx)&#x27;</span> --show-labels </span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">configmaps-env-demo   1/1     Running   0          26h   app=nginx,volume_type=nfs</span><br><span class="line">secrets-env-demo      1/1     Running   0          24h   app=mysql</span><br><span class="line">secrets-volume-demo   1/1     Running   0          23h   app=mysql,volume_type=nfs</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods -l <span class="string">&#x27;app notin (mysql,nginx)&#x27;</span> --show-labels </span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">pod-669649fb6-l6xdc        1/1     Running   0          26h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-669649fb6-v2f5h        1/1     Running   0          26h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-test-b896f97bf-lc7dv   1/1     Running   0          26h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line">pod-test-b896f97bf-nx4lf   1/1     Running   0          26h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods -l volume_type --show-labels </span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">configmaps-env-demo   1/1     Running   0          26h   app=nginx,volume_type=nfs</span><br><span class="line">secrets-volume-demo   1/1     Running   0          23h   app=mysql,volume_type=nfs</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#kubectl get pods -l <span class="string">&#x27;!volume_type&#x27;</span> --show-labels </span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">pod-669649fb6-l6xdc        1/1     Running   0          26h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-669649fb6-v2f5h        1/1     Running   0          26h   app=pod,pod-template-hash=669649fb6</span><br><span class="line">pod-test-b896f97bf-lc7dv   1/1     Running   0          26h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line">pod-test-b896f97bf-nx4lf   1/1     Running   0          26h   app=pod-test,pod-template-hash=b896f97bf</span><br><span class="line">secrets-env-demo           1/1     Running   0          24h   app=mysql</span><br></pre></td></tr></table></figure>

<h1 id="6-实现Pod的平滑关闭"><a href="#6-实现Pod的平滑关闭" class="headerlink" title="6 实现Pod的平滑关闭"></a>6 实现Pod的平滑关闭</h1><h2 id="6-1-思路"><a href="#6-1-思路" class="headerlink" title="6.1 思路"></a>6.1 思路</h2><p>在k8s中发起pod删除指令后，pod并不会立即删除，而是先将pod 的DeleteTimestap置位，让pod先进入Terminating态</p>
<p>接下来<code>containerd-shim</code>将向容器首进程发送<code>SIGTERM</code>信号，然后会等待10s(默认可改terminationGracePeriodSeconds参数)后发送<code>SIGKILL</code>信号。中间的等待时间给用户提供了优雅退出(graceful stop)机制，当然在此期间你会看到pod一直处于Terminating状态，我们可以为应用捕获<code>SIGTERM</code>注册handler，利用 terminationGracePeriodSeconds 的时间内执行完清理资源操作。</p>
<p>这里有两个问题需要注意:</p>
<ol>
<li>全程只看到给1号进程发送信号，但实际上现象是容器退出后相关进程会全部消失 查阅资料后，了解到由于<code>PID=1</code>进程的特殊性，1号进程退出后，由其而生的<code>PID-namespace</code>被销毁，内核将向该namespace下所有子进程发送<code>SIGKILL</code>信号。 注意这里 子进程们是直接被kill的，不存在优雅结束的机会，所以这就用到了我们上一小节演示的tini进程来转发term信号给容器内的其他进程。</li>
<li>进程被kill后，如何被回收 <code>dockerDaemon</code>发起创建容器请求，由<code>containerd</code>接收并创建<code>containerd-shim</code>，<code>containerd-shim</code>即上面提到的0号进程。所以实际的创建容器、容器内执行指令等都是此进程在做。 同时，<code>containerd-shim</code>具有回收僵尸进程的功能，容器1号进程退出后，内核清理其下子孙进程，这些子孙进程被<code>containerd-shim</code>收养并清理。 注意：如果1号进程不被Kill，那么其下进程如果有僵尸进程，是无法被处理的。所以用户开发的容器首进程要注意回收退出进程。</li>
</ol>
<p>注意：</p>
<ul>
<li>一个pod被删除需要等到pod内所有容器都被清理掉之后才行 (当然pod删除过程也包含preStop的执行等)</li>
<li>每次发版过程中，pod会在Terminating状态停留很久，可能是由于deployment滚动更新时，旧版本可删除pod会被立刻置位DeleteTimestamp，至于删除还需要等待一段平滑退出的时间，然后pod内所有容器都退出后，pod才会被删除，这可能是造成退出过慢的系统性原因。但退出慢并不影响更新速度。</li>
<li>docket退出的容器不会被清理，但是k8s中的kubelet会清理</li>
</ul>
<h2 id="6-2-正确使用tini"><a href="#6-2-正确使用tini" class="headerlink" title="6.2 正确使用tini"></a>6.2 正确使用tini</h2><p>在k8s中使用 tini 跟你直接用docker启动 tini 容器还是有区别的</p>
<ul>
<li>你直接用docker run –init启动容器，dockerfile文件里定制的CMD可以是一条用&amp;&amp;符号链接的shell命令，此时你的容器内1号进程是tini，你的这条shell命令也就是你的业务进程直接就是挂在tini下面、是它的儿子进程</li>
<li>而在k8s里为POD定制COMMAND，正常来说支持单独一条命令，你无法使用&amp;&amp;或分号来链接多条命令，如果要支持这种普通的shell命令，你需要用bash -c 包裹，例如 <code>bash -c &quot;命令1 &amp;&amp; 命令2 ;命令3&quot;</code>，此时，当你把tini命令打到了容器里，启动时，进程的父子关系就成了这个样子<ul>
<li>tini为1号进程<ul>
<li>bash进程成了1号进程的直接子进程，它若退出，tini则随即结束</li>
<li>业务进程则是bash进程的子进程</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>此时，当删除pod时，容器内的1号进程tini收到的是SIGTERM信号，然后tini默认只会把该信号转发给它的儿子即bash进程，而不会发给它的孙子即业务进程</p>
<p>而tini的儿子bash收到SIGTERM后会立即退出，随即引起tini的退出，tini退出则容器结束，然后开始清理容器的pids namespace空间，容器所有其他进程都会收到强制杀死的SIGKILL信号。如何解决这个问题呢</p>
<ul>
<li>在dockerfile里为容器定义变量ENV TINI_KILL_PROCESS_GROUP 1，配置后，<code>SIGTREM</code>信号将传递给子进程所在进程组的所有进程(即由bash而生的进程可收到信号)。</li>
<li>在bash -c的基础上，再添一个参数 -i，即<code>bash -ic</code>，-i 代表开启交互式模式，开启后bash会忽略SIGTERM信号，等到它的子进程都挂掉后，它会随即一起结束。</li>
</ul>
<p>例如开启 init 是，启动命令为<code>[&quot;bash&quot;, &quot;-ic&quot;, &quot;cd . &amp;&amp; sleep 10d&quot;]</code>，此时进程视图为：</p>
<p><img src="/Kubernetes/pod/configuration/1752744824817-4cb28453-6268-4bae-b021-50e340d221ac.png" alt="img"></p>
<p>正常启动时，init作为1号进程，bash进程作为1号子进程，业务进程又作为bash进程的子进程</p>
<p>容器正常退出时，init收到SIGTERM信号，传递信号给其子进程(6号)所在进程组的所有进程(6和16)，bash处于交互模式忽略信 号不作为, 业务容器接受SIGTERM信号，处理后退出，bash紧随业务进程退出。</p>
<p>容器异常退出时，业务进程(16)异常退出，bash紧随业务进程退出。 init进程接受到子进程(6号bash)退出信号SIGCHILD，退出容器。</p>
<p>想在k8s中使用tini，由于k8s目前还未提供init开关参数，若想让k8s支持init，我们有三种方式实现，推荐第三种方式</p>
<p><strong>方式1：配置全局使用init</strong></p>
<p>可以修改docker的配置文件，开启全局使用init，如此K8s创建的所有容器都将开启<code>init</code>，所以该方法并不是特别推荐</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">可在 /etc/docker/daemon.json 文件中添加<span class="punctuation">:</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;init&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>方式2：开关模式</strong></p>
<p>需要修改K8s代码，最终决定使用<code>container.Env</code>来设置init开关，原因：annotation和label均为pod级别，而pod下支持多个容器，全局设置不够灵活。故写入环境变量，作为container级别的配置。<br>(理想状态是将 init 作为<code>pod.spec.containers[n].init</code>字段交由使用者配置)</p>
<p>注意：如果想用label或annotation做init标记，需要注意代码修改比env多一些，因为在构造容器config时，label和annotation不会继承pod的，而env是会完整复制pod内定义的</p>
<p>代码修改比较简单，在<code>pkg/kubelet/dockershim/docker_container.go</code>文件中添加</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">init := <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> i, _ := <span class="keyword">range</span> config.Envs &#123;</span><br><span class="line">    <span class="keyword">if</span> config.Envs[i].Key == <span class="string">&quot;CONTAINER_S_INIT&quot;</span> &#123;</span><br><span class="line">        init = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">createConfig := dockertypes.ContainerCreateConfig&#123;</span><br><span class="line">    ...   <span class="comment">// 一些容器参数的设置</span></span><br><span class="line">    HostConfig: &amp;dockercontainer.HostConfig&#123;</span><br><span class="line">        ...   </span><br><span class="line">        Init: &amp;init,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>方式3</strong>：虽然不能像docker启动容器那样，直接用 –init 参数，但是我们可以在编写dockerfile文件时，把tini命令打包到容器内</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ===============需要先下载好一个tini命令，然后编写dockerfile文件如下，制作成一个容器===============</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">ENV</span> TINI_VERSION v0.<span class="number">19.0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 1、从网上下载tini，官网地址https://github.com/krallin/tini/releases/</span></span><br><span class="line"><span class="comment"># ADD https://github.com/krallin/tini/releases/download/$&#123;TINI_VERSION&#125;/tini /tini</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 2、基本本地下载好的tini命令</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> tini /tini</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /tini</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> test.py /opt    </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/tini&quot;</span>,<span class="string">&quot;--&quot;</span>]</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Run your program under Tini</span></span><br><span class="line"><span class="comment"># CMD [&quot;/your/program&quot;, &quot;-and&quot;, &quot;-its&quot;, &quot;arguments&quot;]</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># ===============然后启动时，就不需要指定--init参数了===============</span></span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d --name test1 t1:v1 </span></span><br></pre></td></tr></table></figure>

<p>设置环境变量TINI_KILL_PROCESS_GROUP，这里又有两种方式</p>
<ul>
<li>方式1：在构建容器的镜像时，在dockerfile文件中设置变量：ENV TINI_KILL_PROCESS_GROUP 1</li>
<li>方式2：在pod的yaml文件里设置该ENV</li>
</ul>
<p>在编写yaml时， 如果有COMMAND涉及到多条业务指令，可使用<code>bash -ic</code>包裹业务指令，例如COMMAND: <code>[&quot;bash&quot;, &quot;-ic&quot;, &quot;cd . &amp;&amp; sleep 10d&quot;]</code>，如此便可以使：</p>
<ul>
<li>bash负责启动业务进程，把它们作为自己的儿子</li>
<li>pod退出时业务进程可处理<code>SIGTERM</code>后很快完成容器退出</li>
</ul>
<p>总结</p>
<ul>
<li>k8s的kubelet不创建容器，它是调用containerd&#x2F;func来创建一个shim进程，然后由shim来创建容器的init进程</li>
<li>containerd在中止容器时，会向它的init发送一个term信号，这个代表平滑退出，而向init的子进程发送的是强制杀死的sigkill信号，如果子进程有一些数据正在写有网络连接正在操作比如数据库数据呢，那么强制杀死就可能导致数据错误</li>
<li>所以我们需要将init进程收到的term信号转发给子进程，这就用到了工具tini，用该工具取代容器内的init可以达到这一目标，我们更希望进程收到 SIGTERM 信号而不是 SIGKILL 信号</li>
</ul>
<h1 id="7-使用Cgroups限制Pod的PID数"><a href="#7-使用Cgroups限制Pod的PID数" class="headerlink" title="7 使用Cgroups限制Pod的PID数"></a>7 使用Cgroups限制Pod的PID数</h1><h2 id="7-1-场景介绍"><a href="#7-1-场景介绍" class="headerlink" title="7.1 场景介绍"></a>7.1 场景介绍</h2><p>Kubernetes 里面的 Pod 资源是最小的计算单元，抽象了一组（一个或多个）容器。容器也是 Linux 系统上的进程，但基于 Namespace 和 Cgroups(Control groups) 等技术实现了不同程度的隔离。 简单来说 Namespace 可以让每个进程有独立的 PID, IPC 和网络空间。Cgroups 可以控制进程的资源占用，比如 CPU ，内存和允许的最大进程数等等。</p>
<p>之前遇到过这样一个问题，我们的服务会调用执行外部的命令，每调用一次外部命令就会 fork 产生子进程。但是由于代码上的 bug ，没有及时对子进程回收，然后这个容器不断 fork 产生子进程，耗尽了宿主机的进程表空间，最终导致整个系统不响应，影响了其它的服务。这种问题除了让开发人员修复 bug 外，也需要在系统层面对进程数量进行限制。所以，如果一个容器里面运行的服务会 fork 产生子进程，就很有必要使用 Cgroups 的 pids 控制器限制这个容器能运行的最大进程数量。</p>
<h2 id="7-2-Kubelet开启PodPidsLimit功能"><a href="#7-2-Kubelet开启PodPidsLimit功能" class="headerlink" title="7.2 Kubelet开启PodPidsLimit功能"></a>7.2 Kubelet开启PodPidsLimit功能</h2><p>Kubernetes 里面的每个节点都会运行一个叫做 Kubelet 的服务，负责节点上容器的状态和生命周期，比如创建和删除容器。根据 Kubernetes 的官方文档 <a href="https://kubernetes.io/docs/concepts/policy/pid-limiting/">Process ID Limits And Reservations</a> 内容，可以设置 Kubelet 服务的 <code>--pod-max-pids</code> 配置选项，之后在该节点上创建的容器，最终都会使用 Cgroups pid 控制器限制容器的进程数量。</p>
<blockquote>
<p>说明：在某些 Linux 安装环境中，操作系统会将 PID 约束设置为一个较低的默认值，例如 <code>32768</code>。这时可以考虑提升 <code>/proc/sys/kernel/pid_max</code> 的设置值。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubelet 使用 systemd 启动的，可以通过编辑 /etc/sysconfig/kubelet</span></span><br><span class="line"><span class="comment"># 添加额外的启动参数，设置 pod 最大进程数为 1024</span></span><br><span class="line">$ vim /etc/sysconfig/kubelet</span><br><span class="line">KUBELET_EXTRA_ARGS=<span class="string">&quot;--pod-max-pids=1024</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"># 重启 kubelet 服务</span></span><br><span class="line"><span class="string">$ systemctl restart kubelet</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"># 查看参数是否生效</span></span><br><span class="line"><span class="string">$ ps faux | grep kubelet | grep pod-max-pids</span></span><br><span class="line"><span class="string">root     104865 10.5  0.6 1731392 107368 ?      Ssl  11:56   0:30 /usr/bin/kubelet ... --pod-max-pids=10 --feature-gates=SupportPodPidsLimit=true</span></span><br></pre></td></tr></table></figure>

<h2 id="7-3-验证PodPidsLimit"><a href="#7-3-验证PodPidsLimit" class="headerlink" title="7.3 验证PodPidsLimit"></a>7.3 验证PodPidsLimit</h2><p>现在来测试下如果容器内不断 fork 子进程，数目到达 1024 个时会触发什么行为。</p>
<p>参考 <a href="https://en.wikipedia.org/wiki/Fork_bomb">Fork bomb</a> 的内容，可以创建一个 pod，不断 fork 子进程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建普通的 nginx pod yaml</span></span><br><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; test-nginx.yaml</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test-nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nginx</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 创建到 Kubernetes 集群</span></span><br><span class="line">$ kubectl apply -f test-nginx.yaml</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 进入 nginx 容器模拟 fork bomb </span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -ti test-nginx bash</span><br><span class="line">root@test-nginx:/# bash -c <span class="string">&quot;fork() &#123; fork | fork &amp;  &#125;; fork&quot;</span></span><br><span class="line">environment: fork: retry: Resource temporarily unavailable</span><br><span class="line">environment: fork: retry: Resource temporarily unavailable</span><br><span class="line">environment: fork: retry: Resource temporarily unavailable</span><br></pre></td></tr></table></figure>

<p>通过进入一个 nginx 容器里面使用 bash 运行 fork bomb 命令，我们会发现当 fork 的子进程达到限制的上限数目后，会报 <code>retry: Resource temporarily unavailable</code> 的错误，这个时候再看下宿主机的 fork 进程数目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过在外部宿主机执行下面的命令，会发现 fork 的进程数目接近 1024 个</span></span><br><span class="line">$ ps faux | grep fork | <span class="built_in">wc</span> -l</span><br><span class="line">1019</span><br></pre></td></tr></table></figure>

<p>通过以上的实验，发现能够通过设置 Kubelet 的 <code>--pod-max-pids</code> 选项，限制容器类的进程数，避免容器进程数不断上升最终耗尽宿主机资源，拖垮整个宿主机系统。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://AquaPluto.github.io">Aquarius</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://aquapluto.github.io/Kubernetes/pod/configuration/">https://aquapluto.github.io/Kubernetes/pod/configuration/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://AquaPluto.github.io" target="_blank">代码推演录</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Pod/">Pod</a></div><div class="post-share"><div class="social-share" data-image="/img/paper5.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/Kubernetes/pod/schedule/" title="Pod的调度"><img class="cover" src="/img/paper4.png" onerror="onerror=null;src='/img/error-page.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Pod的调度</div></div><div class="info-2"><div class="info-item-1">1 调度的概念调度指的就是创建新p...</div></div></div></a><a class="pagination-related" href="/Kubernetes/pod/conspect/" title="Pod概论"><img class="cover" src="/img/paper6.png" onerror="onerror=null;src='/img/error-page.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Pod概论</div></div><div class="info-2"><div class="info-item-1">1 Pod概念Kubernetes...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/Kubernetes/pod/conspect/" title="Pod概论"><img class="cover" src="/img/paper6.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-12</div><div class="info-item-2">Pod概论</div></div><div class="info-2"><div class="info-item-1">1 Pod概念Kubernetes...</div></div></div></a><a class="pagination-related" href="/Kubernetes/pod/eviction/" title="Pod的驱逐"><img class="cover" src="/img/paper3.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-12</div><div class="info-item-2">Pod的驱逐</div></div><div class="info-2"><div class="info-item-1">1 驱逐的概念驱逐(Evictio...</div></div></div></a><a class="pagination-related" href="/Kubernetes/pod/schedule/" title="Pod的调度"><img class="cover" src="/img/paper4.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-12</div><div class="info-item-2">Pod的调度</div></div><div class="info-2"><div class="info-item-1">1 调度的概念调度指的就是创建新p...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Aquarius</div><div class="author-info-description">分享运维开发相关技术</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">138</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" href="https://github.com/AquaPluto"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/AquaPluto" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://blog.csdn.net/m0_75233142" target="_blank" title="CSDN"><i class="fa-solid fa-code" style="color: #8a2be2;"></i></a><a class="social-icon" href="mailto:wujunlinq@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><p>持续更新文章中，有问题请添加wx</p>
<div>
  <img src="/img/wx.jpg" alt="wx" style="width: 100px">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0"><span class="toc-text">1 钩子函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-postStart"><span class="toc-text">1.1 postStart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-preStop"><span class="toc-text">1.2 preStop</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AEPod"><span class="toc-text">2 配置Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%8C%87%E5%AE%9A%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">2.1 指定容器启动命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E9%80%9A%E8%BF%87%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%90%91%E5%AE%B9%E5%99%A8%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0"><span class="toc-text">2.2 通过环境变量向容器传递参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E9%95%9C%E5%83%8F%E6%8B%89%E5%8F%96%E7%AD%96%E7%95%A5"><span class="toc-text">2.3 镜像拉取策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Pod%E7%9A%84%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-text">2.4 Pod的重启策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E6%8E%A2%E9%92%88-Pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-text">2.5 探针-Pod健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-%E6%8E%A2%E9%92%88%E7%B1%BB%E5%9E%8B"><span class="toc-text">2.5.1 探针类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-2-%E6%8E%A2%E9%92%88%E7%A4%BA%E4%BE%8B"><span class="toc-text">2.5.2 探针示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-Security-Context"><span class="toc-text">2.6 Security Context</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-1-Security-Context%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.6.1 Security Context介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-2-%E8%AE%BE%E7%BD%AEPod%E7%BA%A7%E7%9A%84Security-Context"><span class="toc-text">2.6.2 设置Pod级的Security Context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-3-%E8%AE%BE%E7%BD%AEContainer%E7%BA%A7%E7%9A%84Security-Context"><span class="toc-text">2.6.3 设置Container级的Security Context</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Downward-API"><span class="toc-text">3 Downward API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Doward-APl%E6%94%AF%E6%8C%81%E7%9A%84Pod%E4%B8%8EContainer%E4%BF%A1%E6%81%AF"><span class="toc-text">3.1 Doward APl支持的Pod与Container信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-text">3.2 环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Volume%E6%8C%82%E8%BD%BD"><span class="toc-text">3.3 Volume挂载</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Pod%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-text">4 Pod的设计模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-Sidecar%E6%A8%A1%E5%BC%8F%EF%BC%9A%E6%9C%8D%E5%8A%A1%E8%BE%85%E5%8A%A9"><span class="toc-text">4.1 Sidecar模式：服务辅助</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Ambassador%E6%A8%A1%E5%BC%8F%EF%BC%9A%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86"><span class="toc-text">4.2 Ambassador模式：网络代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-Adapter%E6%A8%A1%E5%BC%8F%EF%BC%9A%E6%8E%A5%E5%8F%A3%E8%BD%AC%E6%8D%A2%EF%BC%88%E9%80%82%E9%85%8D%E5%99%A8%EF%BC%89"><span class="toc-text">4.3 Adapter模式：接口转换（适配器）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Init-Container%E6%A8%A1%E5%BC%8F%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%B9%E5%99%A8"><span class="toc-text">4.4 Init Container模式：初始化容器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E6%A0%87%E7%AD%BE%E5%92%8C%E6%A0%87%E7%AD%BE%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-text">5 标签和标签选择器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E9%99%84%E5%8A%A0%E6%A0%87%E7%AD%BE"><span class="toc-text">5.1 附加标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%A0%87%E7%AD%BE%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-text">5.2 标签选择器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E5%AE%9E%E7%8E%B0Pod%E7%9A%84%E5%B9%B3%E6%BB%91%E5%85%B3%E9%97%AD"><span class="toc-text">6 实现Pod的平滑关闭</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%80%9D%E8%B7%AF"><span class="toc-text">6.1 思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8tini"><span class="toc-text">6.2 正确使用tini</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E4%BD%BF%E7%94%A8Cgroups%E9%99%90%E5%88%B6Pod%E7%9A%84PID%E6%95%B0"><span class="toc-text">7 使用Cgroups限制Pod的PID数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E5%9C%BA%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="toc-text">7.1 场景介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-Kubelet%E5%BC%80%E5%90%AFPodPidsLimit%E5%8A%9F%E8%83%BD"><span class="toc-text">7.2 Kubelet开启PodPidsLimit功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E9%AA%8C%E8%AF%81PodPidsLimit"><span class="toc-text">7.3 验证PodPidsLimit</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/role/" title="Role角色"><img src="/img/paper3.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="Role角色"/></a><div class="content"><a class="title" href="/CICD/ansible/role/" title="Role角色">Role角色</a><time datetime="2025-09-13T10:07:53.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/playbook/" title="PlayBook"><img src="/img/paper2.jpg" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="PlayBook"/></a><div class="content"><a class="title" href="/CICD/ansible/playbook/" title="PlayBook">PlayBook</a><time datetime="2025-09-13T10:07:48.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/module/" title="常用模块"><img src="/img/paper4.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="常用模块"/></a><div class="content"><a class="title" href="/CICD/ansible/module/" title="常用模块">常用模块</a><time datetime="2025-09-13T10:07:42.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/command/" title="相关命令"><img src="/img/paper6.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="相关命令"/></a><div class="content"><a class="title" href="/CICD/ansible/command/" title="相关命令">相关命令</a><time datetime="2025-09-13T10:07:38.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/deploy/" title="部署与配置"><img src="/img/paper1.jpg" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="部署与配置"/></a><div class="content"><a class="title" href="/CICD/ansible/deploy/" title="部署与配置">部署与配置</a><time datetime="2025-09-13T10:07:29.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Aquarius</span></div><div class="footer_custom_text"><style>
div#runtime {
  font-size: 13px;
  font-weight: bold;
}

div#ghbdages_list {
  height: 1.5rem;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 10px
}

.github-badge {
  display: flex;
  align-items: center;
  margin-inline: 6px;
}
</style>
<div id="runtime"></div>
<div id="ghbdages"></div>
<script>
  function createtime() {
    const now = new Date();
    const grt = new Date("08/01/2025 00:00:00"); // 网站诞生时间

    // 计算天、小时、分钟和秒
    const days = Math.floor((now - grt) / (1000 * 60 * 60 * 24));
    const hours = Math.floor(((now - grt) / (1000 * 60 * 60)) % 24)
      .toString()
      .padStart(2, "0");
    const minutes = Math.floor(((now - grt) / (1000 * 60)) % 60)
      .toString()
      .padStart(2, "0");
    const seconds = Math.floor(((now - grt) / 1000) % 60)
      .toString()
      .padStart(2, "0");

    // HTML 输出
    const currentTimeHtml = `
          <div>
              本站已运行 ${days} 天 ${hours} 小时 ${minutes} 分 ${seconds} 秒 
          </div>`;

    const runtime = document.getElementById("runtime");
    if (runtime) runtime.innerHTML = currentTimeHtml;
  }

  // 设置每秒调用函数
  setInterval(createtime, 1000);

  function renderBadge() {
    const currentTimeHtml = `
      <div id="ghbdages_list">
          <a class="github-badge" target="_blank" href="https://hexo.io/" title="hexo:7.3.0">
              <img src="https://img.shields.io/badge/Frame-Hexo-blue?logo=hexo" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://github.com/" title="github">
              <img src="https://img.shields.io/badge/Code-GitHub-181717?logo=GitHub&color=%23FF7102" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://vercel.com/" title="vercel">
              <img src="https://img.shields.io/badge/Host-Vercel-%23F0D722?logo=Vercel" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://analytics.sysio.ai/" title="umami">
              <img src="https://img.shields.io/badge/Analytics-Umami-%237FB100?logo=umami&logoColor=%237FB100" alt="Static Badge">
          </a>
      </div>`;

    const ghbdages = document.getElementById("ghbdages");
    if (ghbdages) {
      ghbdages.innerHTML = currentTimeHtml;
    }
  }

  window.onload = renderBadge;
</script>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/instant.page/instantpage.js" type="module"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://unpkg.com/mathjax/es5/tex-mml-chtml.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://unpkg.com/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://cdn.jsdelivr.net/gh/xiabo2/CDN@latest/fishes.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://unpkg.com/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章..." type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>