<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>iptables | 代码推演录</title><meta name="author" content="Aquarius"><meta name="copyright" content="Aquarius"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="1 iptables的组成iptables由五个表table和五个链chain以及一些规则组成 链 chain：  内置链：对应内核中的每一个勾子函数 （INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING）  自定义链：用于对内置链进行扩展或补充，可实现更灵活的规则组织管理机制；只有Hook钩子调用自定义链时，才生效   五个表table：filter、nat、">
<meta property="og:type" content="article">
<meta property="og:title" content="iptables">
<meta property="og:url" content="https://aquapluto.github.io/Linux/firewall/iptables/">
<meta property="og:site_name" content="代码推演录">
<meta property="og:description" content="1 iptables的组成iptables由五个表table和五个链chain以及一些规则组成 链 chain：  内置链：对应内核中的每一个勾子函数 （INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING）  自定义链：用于对内置链进行扩展或补充，可实现更灵活的规则组织管理机制；只有Hook钩子调用自定义链时，才生效   五个表table：filter、nat、">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://aquapluto.github.io/img/paper1.jpg">
<meta property="article:published_time" content="2025-08-21T03:02:08.000Z">
<meta property="article:modified_time" content="2025-08-28T12:33:05.228Z">
<meta property="article:author" content="Aquarius">
<meta property="article:tag" content="防火墙">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aquapluto.github.io/img/paper1.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "iptables",
  "url": "https://aquapluto.github.io/Linux/firewall/iptables/",
  "image": "https://aquapluto.github.io/img/paper1.jpg",
  "datePublished": "2025-08-21T03:02:08.000Z",
  "dateModified": "2025-08-28T12:33:05.228Z",
  "author": [
    {
      "@type": "Person",
      "name": "Aquarius",
      "url": "https://AquaPluto.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://aquapluto.github.io/Linux/firewall/iptables/"><link rel="preconnect" href="//unpkg.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://unpkg.com/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'iptables',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/wave.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机网络</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/network/network-layer/"><span>网络层</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/network/transport-layer/"><span>传输层</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/network/application-layer/"><span>应用层</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/network/network-architecture/"><span>物理网络架构全链路</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>软件包管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/software-manage/introduce/"><span>软件包介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/software-manage/Centos/"><span>Centos软件管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/software-manage/Ubuntu/"><span>Ubuntu软件管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/software-manage/source-code-compilation/"><span>源码编译安装</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/performance-analysis/"><span>性能分析命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-command/"><span>磁盘管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration-command/"><span>网络配置命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/file-share/"><span>文件共享服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/MySQL/SQL%E8%AF%AD%E5%8F%A5/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Redis/Redis%E5%AE%89%E8%A3%85/"><span>Redis安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kafka/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>网络模式</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>docker compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>构建镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/container/mirror/"><span>概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/mirror/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/mirror/"><span>docker build构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/mirror/"><span>分布式镜像仓库Harbor</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/container/process/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/process/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/process/"><span>监控容器真实的cpu使用率</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/process/"><span>不可中断睡眠对容器的影响</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/containerd/"><span>containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Kubernetes</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/conspect/"><span>概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/deploy/"><span>部署安装</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/pod/"><span>Pod</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/controller/"><span>控制器</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/service-loadbalancer/"><span>服务发现与负载均衡</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/data-storage/"><span>数据存储持久化</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/certification-authentication/"><span>认证与鉴权体系</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/network/"><span>网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/helm/"><span>Helm</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/monitor/"><span>监控</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/introduce/"><span>概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/deploy/"><span>部署安装</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/query-results-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/indicators-re-marked/"><span>指标重新打标</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Grafana</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/grafana/deploy/"><span>部署安装</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/grafana/data-source/"><span>配置数据源</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/grafana/charts/"><span>自定义图表</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/role/"><span>Role角色</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/paper1.jpg);"><nav id="nav"><!-- 左侧博客信息区域--><span id="blog-info"><a class="nav-site-title" href="/"></a><a class="nav-page-title" href="/"><span class="site-name">iptables</span></a></span><!-- 新增的导航菜单容器（居中布局关键）--><div id="nav-menus-container"><!-- 菜单主体部分--><div id="menus"><!-- 菜单项--><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机网络</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/network/network-layer/"><span>网络层</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/network/transport-layer/"><span>传输层</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/network/application-layer/"><span>应用层</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/computer-basics/network/network-architecture/"><span>物理网络架构全链路</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/linux-basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>软件包管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/software-manage/introduce/"><span>软件包介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/software-manage/Centos/"><span>Centos软件管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/software-manage/Ubuntu/"><span>Ubuntu软件管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/software-manage/source-code-compilation/"><span>源码编译安装</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/performance-analysis/"><span>性能分析命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-command/"><span>磁盘管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration-command/"><span>网络配置命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/file-share/"><span>文件共享服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/MySQL/SQL%E8%AF%AD%E5%8F%A5/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Redis/Redis%E5%AE%89%E8%A3%85/"><span>Redis安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kafka/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>网络模式</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/docker/"><span>docker compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>构建镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/container/mirror/"><span>概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/mirror/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/mirror/"><span>docker build构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/mirror/"><span>分布式镜像仓库Harbor</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/container/process/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/process/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/process/"><span>监控容器真实的cpu使用率</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/container/process/"><span>不可中断睡眠对容器的影响</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/container/containerd/"><span>containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Kubernetes</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/conspect/"><span>概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/deploy/"><span>部署安装</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/pod/"><span>Pod</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/controller/"><span>控制器</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/service-loadbalancer/"><span>服务发现与负载均衡</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/data-storage/"><span>数据存储持久化</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/certification-authentication/"><span>认证与鉴权体系</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/network/"><span>网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/helm/"><span>Helm</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/kubernetes/monitor/"><span>监控</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/introduce/"><span>概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/deploy/"><span>部署安装</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/query-results-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/prometheus/indicators-re-marked/"><span>指标重新打标</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Grafana</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/grafana/deploy/"><span>部署安装</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/grafana/data-source/"><span>配置数据源</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/monitor/grafana/charts/"><span>自定义图表</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/role/"><span>Role角色</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><!-- 右侧功能区域（新增容器）--><div id="nav-right-container"><!-- 搜索按钮（移动到右侧）--><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></span></div><!-- 移动端汉堡菜单按钮--><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">iptables</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-21T03:02:08.000Z" title="发表于 2025-08-21 11:02">2025-08-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-28T12:33:05.228Z" title="更新于 2025-08-28 20:33">2025-08-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">18.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>84分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1-iptables的组成"><a href="#1-iptables的组成" class="headerlink" title="1 iptables的组成"></a>1 iptables的组成</h1><p>iptables由五个表table和五个链chain以及一些规则组成</p>
<p>链 chain：</p>
<ul>
<li><p>内置链：对应内核中的每一个勾子函数 （INPUT，OUTPUT，FORWARD，PREROUTING，POSTROUTING）</p>
</li>
<li><p>自定义链：用于对内置链进行扩展或补充，可实现更灵活的规则组织管理机制；只有Hook钩子调用自定义链时，才生效</p>
</li>
</ul>
<p>五个表table：filter、nat、mangle、raw、security</p>
<ul>
<li><p>filter：过滤规则表，根据预定义的规则过滤符合条件的数据包，默认表，实现防火墙功能</p>
</li>
<li><p>nat：network address translation 地址转换规则表，实现共享上网，端口和IP映射</p>
</li>
<li><p>mangle：修改数据标记位规则表，即对数据包进行重构或修改，比如服务类型、TTL（生存时间）等字段</p>
</li>
<li><p>raw：关闭启用的数据连接跟踪机制，加快封包穿越防火墙速度，决定了数据包是否应被状态跟踪机制（如连接跟踪）处理</p>
</li>
<li><p>security：用于强制访问控制（MAC）网络规则，由Linux安全模块（如SELinux）实现</p>
</li>
</ul>
<p>表的优先级由高到低的顺序为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">security --&gt;raw--&gt;mangle--&gt;nat--&gt;filter</span><br></pre></td></tr></table></figure>

<p><strong>表和链对应关系</strong></p>
<p><img src="/Linux/firewall/iptables/1753757574823-6f39b017-1989-4176-b9b2-53f0769e5f5c.png" alt="null"></p>
<p>filter表</p>
<ul>
<li><p>INPUT：负责过滤所有目标地址是本机地址的数据包，通俗来讲，就是过滤进入主机的数据包（能否让数据包进入服务器）</p>
</li>
<li><p>FORWARD：路过，负责转发流经主机的数据包，起转发的作用，和NAT关系大，在LVS NAT模式中，net.ipv4.ip_forward&#x3D;0</p>
</li>
<li><p>OUTPUT：处理所有源地址是本机地址的数据包，通俗来讲，就是处理从主机发出去的数据包，当数据包从本地主机发送至外部网络时，确定哪些本地系统发出的数据包可以被发送到外部网络</p>
</li>
</ul>
<p>nat表</p>
<ul>
<li><p>OUTPUT：和主机放出去的数据包有关，改变主机发出数据包的目的地址</p>
</li>
<li><p>PREROUTING：在数据包到达防火墙时，进行路由判断之前执行的规则，作用是改变数据包的目的地址、目的端口等</p>
</li>
<li><p>POSTROUTING：在数据包离开防火墙时进行路由判断之后执行的规则，作用是改变数据包的源地址、源端口等</p>
</li>
</ul>
<p><strong>数据包过滤匹配流程</strong></p>
<p><img src="/Linux/firewall/iptables/1751382687887-b5e89823-d4ee-430d-a1a9-0b116749283e.png" alt="img"></p>
<p><strong>内核中数据包的传输过程</strong></p>
<ul>
<li><p>当一个数据包进入网卡时，数据包首先进入PREROUTING链，内核根据数据包目的IP判断是否需要转送出去</p>
</li>
<li><p>如果数据包是进入本机的，数据包就会沿着图向下移动，到达INPUT链。数据包到达INPUT链后，任何进程都会收到它。本机上运行的程序可以发送数据包，这些数据包经过OUTPUT链，然后到达POSTROUTING链输出</p>
</li>
<li><p>如果数据包是要转发出去的，且内核允许转发，数据包就会向右移动，经过FORWARD链，然后到达POSTROUTING链输出</p>
</li>
</ul>
<p>范例：查看表匹配哪些链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -vnL -t filter</span><br><span class="line">[root@centos8 ~]#iptables -vnL -t nat</span><br><span class="line">[root@centos8 ~]#iptables -vnL -t mangle</span><br><span class="line">[root@centos8 ~]#iptables -vnL -t raw</span><br><span class="line">[root@centos8 ~]#iptables -vnL -t security</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 6 nat表不支持INPUT链</span></span><br><span class="line">[root@centos6 ~]#iptables -vnL -t nat</span><br></pre></td></tr></table></figure>

<h1 id="2-iptables规则说明"><a href="#2-iptables规则说明" class="headerlink" title="2 iptables规则说明"></a>2 iptables规则说明</h1><h2 id="2-1-iptables规则组成"><a href="#2-1-iptables规则组成" class="headerlink" title="2.1 iptables规则组成"></a>2.1 iptables规则组成</h2><p>规则rule：根据规则的匹配条件尝试匹配报文，对匹配成功的报文根据规则定义的处理动作作出处理，规则在链接上的次序即为其检查时的生效次序</p>
<p>匹配条件：默认为与条件，同时满足</p>
<p>基本匹配：IP，端口，TCP的Flags（SYN,ACK等）</p>
<p>扩展匹配：通过复杂高级功能匹配</p>
<p>处理动作：称为target，跳转目标</p>
<ul>
<li><p>内建处理动作：ACCEPT,DROP,REJECT,SNAT,DNAT,MASQUERADE,MARK,LOG…</p>
</li>
<li><p>自定义处理动作：自定义chain，利用分类管理复杂情形</p>
</li>
</ul>
<p>规则要添加在链上，才生效；添加在自定义链上不会自动生效</p>
<p>白名单:只有指定的特定主机可以访问,其它全拒绝</p>
<p>黑名单:只有指定的特定主机拒绝访问,其它全允许，默认方式</p>
<h2 id="2-2-iptables规则添加时考量点"><a href="#2-2-iptables规则添加时考量点" class="headerlink" title="2.2 iptables规则添加时考量点"></a>2.2 iptables规则添加时考量点</h2><ul>
<li><p>要实现哪种功能：判断添加在哪张表上</p>
</li>
<li><p>报文流经的路径：判断添加在哪个链上</p>
</li>
<li><p>报文的流向：判断源和目的</p>
</li>
<li><p>匹配规则：业务需要</p>
</li>
</ul>
<h2 id="2-3-本章学习环境准备"><a href="#2-3-本章学习环境准备" class="headerlink" title="2.3 本章学习环境准备"></a>2.3 本章学习环境准备</h2><p>CentOS 7，8：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld. service</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">systemctl <span class="built_in">disable</span> --now firewalld. service</span><br></pre></td></tr></table></figure>

<p>CentOS 6：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service iptables stop</span><br><span class="line">chkconfig iptables off</span><br></pre></td></tr></table></figure>

<p>注意：如果不是最小化安装，在禁用 frewalld 之后，再次重启还是能看到防火墙规则，这是由KVM启动的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#卸载kvm功能</span></span><br><span class="line">[root@rocky86 ~]# yum remove qemu-kvm</span><br></pre></td></tr></table></figure>

<p>Ubuntu</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> --now ufw</span><br></pre></td></tr></table></figure>

<h2 id="2-4-规则说明"><a href="#2-4-规则说明" class="headerlink" title="2.4 规则说明"></a>2.4 规则说明</h2><p>iptables 防火墙中的规则，在生效时会按照顺序，从上往下生效，当前一条规则命中后，不再继续往下匹配。</p>
<p>如果多条规则里面，匹配条件中有交集，或者有包含关系，则这些规则，要注意前后顺序，范围小的，需要精确匹配的，要往前放，范围大的，往后放，负责兜底的，放在最后。</p>
<p>如果多条规则里面，匹配条件没有交集，彼此不会互相影响，则无所谓前后顺序，但是从效率上来讲，更容易命中，范围大的放在前面。</p>
<h1 id="3-iptables用法说明"><a href="#3-iptables用法说明" class="headerlink" title="3 iptables用法说明"></a>3 iptables用法说明</h1><p><img src="/Linux/firewall/iptables/1751382781417-0e108bfa-4c15-487f-8dc1-e4135654ca85.png" alt="img"></p>
<p><img src="/Linux/firewall/iptables/1751382793745-9e8b396e-dbad-48b4-815a-6aa11530f4f8.png" alt="img"></p>
<p><img src="/Linux/firewall/iptables/1751382806819-08d7d919-eae7-4861-a1f9-514dc2451a4a.png" alt="img"></p>
<p>格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table] &#123;-A|-C|-D&#125; chain rule-specification</span><br><span class="line">iptables [-t table] -I chain [rulenum] rule-specification</span><br><span class="line">iptables [-t table] -R chain rulenum rule-specification</span><br><span class="line">iptables [-t table] -D chain rulenum</span><br><span class="line">iptables [-t table] -S [chain [rulenum]]</span><br><span class="line">iptables [-t table] &#123;-F|-L|-Z&#125; [chain [rulenum]] [options...]</span><br><span class="line">iptables [-t table] -N chain</span><br><span class="line">iptables [-t table] -X [chain]</span><br><span class="line">iptables [-t table] -P chain target</span><br><span class="line">iptables [-t table] -E old-chain-name new-chain-name</span><br><span class="line"></span><br><span class="line">rule-specification = [matches...] [target]</span><br><span class="line">match = -m matchname [per-match-options]</span><br><span class="line">target = -j targetname [per-target-options]</span><br></pre></td></tr></table></figure>

<p>iptables命令格式详解</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table] SUBCOMMAND chain [-m matchname [per-match-options]] -j targetname [per-target-options]</span><br></pre></td></tr></table></figure>

<h2 id="3-1-table"><a href="#3-1-table" class="headerlink" title="3.1 table"></a>3.1 table</h2><p>指定表：raw, mangle, nat, [filter]默认</p>
<h2 id="3-2-COMMAND"><a href="#3-2-COMMAND" class="headerlink" title="3.2 COMMAND"></a>3.2 COMMAND</h2><h3 id="3-2-1-链管理类"><a href="#3-2-1-链管理类" class="headerlink" title="3.2.1 链管理类"></a>3.2.1 链管理类</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-N：new, 自定义一条新的规则链</span><br><span class="line">-E：重命名自定义链；引用计数不为0的自定义链不能够被重命名，也不能被删除</span><br><span class="line">-X：delete，删除自定义的空的规则链</span><br><span class="line">-P：Policy，设置默认策略；对filter表中的链而言，其默认策略有：ACCEPT：接受, DROP：丢弃</span><br><span class="line">-C：检查链上的规则是否正确</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-查看类"><a href="#3-2-2-查看类" class="headerlink" title="3.2.2 查看类"></a>3.2.2 查看类</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-L：list, 列出指定鏈上的所有规则，本选项须置后</span><br><span class="line">-n：numberic，以数字格式显示地址和端口号</span><br><span class="line">-v：verbose，详细信息</span><br><span class="line">-vv 更详细</span><br><span class="line">-x：exactly，显示计数器结果的精确值,而非单位转换后的易读值</span><br><span class="line">--line-numbers：显示规则的序号</span><br><span class="line">-S selected,以iptables-save命令格式显示链上规则</span><br><span class="line"></span><br><span class="line">常用组合</span><br><span class="line">-vnL</span><br><span class="line">-vvnxL --line-numbers</span><br></pre></td></tr></table></figure>

<p>范例：查看表匹配哪些链</p>
<p>在使用 -L 选项查看规则时，如果规则不为空，单独 -L 选项显示时有可能会很慢，这是因为需要对主机名和服务名进行反解导致的，可以加 -n 选项来规避</p>
<p>默认 filter 表，可以不指定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -vnL -t  filter</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>        destination</span><br><span class="line">   </span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>        destination</span><br><span class="line">   </span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>        destination</span><br><span class="line"></span><br><span class="line">pkts：在当前规则中，被命中的数据包数量</span><br><span class="line">bytes：在当前规则中，被命中的总流量大小</span><br><span class="line">target：动作，目标，DROP 表示丢弃</span><br><span class="line">prot：具体协议</span><br><span class="line">opt：选项</span><br><span class="line"><span class="keyword">in</span>：数据从哪个网络设备进来</span><br><span class="line">out：数据从哪个网络设备上出去</span><br><span class="line"><span class="built_in">source</span>：源，可以是主机IP，网段，anywhere 表示不受限 </span><br><span class="line">destination：目标，可以是主机IP，网段，anywherer 表示不受限</span><br></pre></td></tr></table></figure>

<p>范例：指定表和链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu ~]# iptables -t filter -vnL INPUT</span><br></pre></td></tr></table></figure>

<h3 id="3-2-3-规则管理类"><a href="#3-2-3-规则管理类" class="headerlink" title="3.2.3 规则管理类"></a>3.2.3 规则管理类</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-A：append，往链上追加规则</span><br><span class="line">-I：insert, 插入，要指明插入至的规则编号，默认为第一条</span><br><span class="line">-D：delete，删除</span><br><span class="line"> 	(1) 指明规则序号</span><br><span class="line"> 	(2) 指明规则本身</span><br><span class="line">-R：replace，替换指定链上的指定规则编号</span><br><span class="line">-F：flush，清空指定的规则链</span><br><span class="line">-Z：zero，置零</span><br><span class="line"> 	iptables的每条规则都有两个计数器</span><br><span class="line">    (1) 匹配到的报文的个数</span><br><span class="line">    (2) 匹配到的所有报文的大小之和</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这条命令指定了来自源地址为 10.0.0.1 的数据包将被接受（ACCEPT）。换句话说，它允许了从地址为 10.0.0.1 的主机发送到你的主机的数据包通过防火墙。</span></span><br><span class="line">iptables -t filter -A INPUT -s 10.0.0.1 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#这条命令指定了目标地址为 10.0.0.1 的数据包将被接受（ACCEPT）。换句话说，它允许了发送到地址为 10.0.0.1 的主机的数据包通过防火墙。</span></span><br><span class="line">iptables -t filter -A INPUT -d 10.0.0.1 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#因此，这两条命令的区别在于它们是针对数据包的不同方向进行匹配的。第一条命令是匹配从指定源地址发送到你的主机的数据包，而第二条命令是匹配发送到指定目标地址的数据包。</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在INPUT 链的 filter 表上设置过滤规则，将来自 10.0.0.150 的数据包丢弃掉</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -s 10.0.0.150 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#将来自10网段的数据包丢弃掉</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -s 10.0.0.0/24 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除第3条规则，根据规则编号删除</span></span><br><span class="line">[root@ubuntu ~] iptables -t filter -D INPUT 3</span><br><span class="line"></span><br><span class="line"><span class="comment">#在最前面插入 127.1 的ACCEPT 规则</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -I INPUT -s 127.0.0.1 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定入口设备是本地回环网卡</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -I INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#替换第一条规则</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -R INPUT 1 -s 127.0.0.1 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#清空INPUT链上的第一条规则统计数据 </span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -Z INPUT 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#清空表上的所有统计数据</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -Z</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改默认规则</span></span><br><span class="line">[root@ubuntu ~]# iptables -P FORWARD DROP</span><br></pre></td></tr></table></figure>

<p>范例：黑名单和白名单</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#只允许 10.0.0.1 连接</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -s 10.0.0.1 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment">#其它机器数据全部拒绝，不指定匹配条件，则全部拒绝</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -j REJECT</span><br><span class="line"></span><br><span class="line"><span class="comment">#这种情况下，ACCEPT规则一定要写在前面</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -nL INPUT --line-number</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num target   prot opt <span class="built_in">source</span>        destination    </span><br><span class="line">1  ACCEPT   all  --  10.0.0.1       0.0.0.0/0     </span><br><span class="line">2  REJECT   all  --  0.0.0.0/0       0.0.0.0/0      reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line"><span class="comment">#由于拒绝了10.0.0.1 之外的主机，本机也无法使用</span></span><br><span class="line">[root@ubuntu ~]# ping 127.1</span><br><span class="line">PING 127.1 (127.0.0.1) 56(84) bytes of data.</span><br></pre></td></tr></table></figure>

<h2 id="3-3-chain"><a href="#3-3-chain" class="headerlink" title="3.3 chain"></a>3.3 chain</h2><p>指定链：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</p>
<h2 id="3-4-parameter匹配条件"><a href="#3-4-parameter匹配条件" class="headerlink" title="3.4 parameter匹配条件"></a>3.4 parameter匹配条件</h2><ul>
<li><p>基本：通用的，PARAMETERS</p>
</li>
<li><p>扩展：需加载模块，MATCH EXTENTIONS</p>
</li>
</ul>
<h3 id="3-4-1-基本匹配条件"><a href="#3-4-1-基本匹配条件" class="headerlink" title="3.4.1 基本匹配条件"></a>3.4.1 基本匹配条件</h3><p>基本匹配条件：无需加载模块，由iptables&#x2F;netfilter自行提供</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[!] -s, --<span class="built_in">source</span> address[/mask][,...]：源IP地址或者不连续的IP地址</span><br><span class="line">[!] -d, --destination address[/mask][,...]：目标IP地址或者不连续的IP地址</span><br><span class="line">[!] -p, --protocol protocol：指定协议，可使用数字如0（all）</span><br><span class="line">    protocol: tcp, udp, icmp, icmpv6, udplite,esp, ah, sctp, mh or“all“ </span><br><span class="line">    参看：/etc/protocols</span><br><span class="line">[!] -i, --in-interface name：报文流入的接口；只能应用于数据报文流入环节，只应用于INPUT、FORWARD、PREROUTING链</span><br><span class="line">[!] -o, --out-interface name：报文流出的接口；只能应用于数据报文流出的环节，只应用于FORWARD、OUTPUT、POSTROUTING链</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6,10.0.0.10 -j REJECT</span><br><span class="line">[root@centos8 ~]#iptables -I INPUT -i lo -j ACCEPT</span><br><span class="line">[root@centos8 ~]#curl 127.0.0.1</span><br><span class="line">10.0.0.8</span><br><span class="line">[root@centos8 ~]#curl 10.0.0.8</span><br><span class="line">10.0.0.8</span><br></pre></td></tr></table></figure>

<p>范例：根据协议过滤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#接受10.0.0.6上的除icmp协议的其他协议</span></span><br><span class="line">[root@centos8 ~]#iptables -I INPUT 2 -s 10.0.0.6 ! -p icmp -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>范例：规则取反</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置取反规则，除了 10.0.0.150 来的数据，其它都拒绝</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -R INPUT 2 ! -s 10.0.0.150 -j REJECT</span><br></pre></td></tr></table></figure>

<p>范例：根据目标地址匹配（目标地址是机器上有多网卡或者一网卡有多个地址时才使用）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]#ip a a 10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">[root@rocky8 ~]#ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:d2:a3:ac brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.179/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.0.0.10/24 scope global secondary eth0:1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fed2:a3ac/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment">#现在能访问10</span></span><br><span class="line">[root@centos8 ~]#ping 10.0.0.10</span><br><span class="line">PING 10.0.0.10 (10.0.0.10) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.0.10: icmp_seq=1 ttl=64 <span class="keyword">time</span>=1.23 ms</span><br><span class="line">64 bytes from 10.0.0.10: icmp_seq=2 ttl=64 <span class="keyword">time</span>=10.8 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#任何来访问10的IP地址都拒绝，不管什么协议</span></span><br><span class="line">[root@rocky8 ~]#iptables -A INPUT -d 10.0.0.10 -j REJECT</span><br><span class="line">[root@rocky8 ~]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 REJECT     all  --  *      *       0.0.0.0/0            10.0.0.10            reject-with i</span><br><span class="line">  </span><br><span class="line"><span class="comment">#现在不能ping了</span></span><br><span class="line">[root@centos8 ~]#ping 10.0.0.10</span><br><span class="line">PING 10.0.0.10 (10.0.0.10) 56(84) bytes of data.</span><br><span class="line">From 10.0.0.10 icmp_seq=1 Destination Port Unreachable</span><br><span class="line">From 10.0.0.10 icmp_seq=2 Destination Port Unreachable</span><br><span class="line"></span><br><span class="line"><span class="comment">#远程也不能链接</span></span><br><span class="line">[root@centos8 ~]#ssh 10.0.0.10</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"><span class="comment">#来自icmp协议的拒绝。其他协议可以访问</span></span><br><span class="line">[root@rocky8 ~]#iptables -R INPUT 1 -d 10.0.0.10 -p icmp -j REJECT</span><br><span class="line"></span><br><span class="line"><span class="comment">#还是不能ping</span></span><br><span class="line">[root@centos8 ~]#ping 10.0.0.10</span><br><span class="line">[root@centos8 ~]#ping 10.0.0.10</span><br><span class="line">PING 10.0.0.10 (10.0.0.10) 56(84) bytes of data.</span><br><span class="line">From 10.0.0.10 icmp_seq=1 Destination Port Unreachable</span><br><span class="line">From 10.0.0.10 icmp_seq=2 Destination Port Unreachable</span><br><span class="line"></span><br><span class="line"><span class="comment">#可以远程连接</span></span><br><span class="line">[root@centos8 ~]#ssh 10.0.0.10</span><br><span class="line">The authenticity of host <span class="string">&#x27;10.0.0.10 (10.0.0.10)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:LjI4Fn8mPxXYJjqouGvxROkMgF9Nv5fDZpHKfzM8hRs.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no/[fingerprint])? </span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-2-扩展匹配条件"><a href="#3-4-2-扩展匹配条件" class="headerlink" title="3.4.2 扩展匹配条件"></a>3.4.2 扩展匹配条件</h3><p>扩展匹配条件：需要加载扩展模块（&#x2F;usr&#x2F;lib64&#x2F;xtables&#x2F;*.so），方可生效</p>
<p>扩展模块的查看帮助 ：man iptables-extensions</p>
<p>扩展匹配条件：</p>
<ul>
<li><p>隐式扩展</p>
</li>
<li><p>显式扩展</p>
</li>
</ul>
<h4 id="3-4-2-1-隐式扩展"><a href="#3-4-2-1-隐式扩展" class="headerlink" title="3.4.2.1 隐式扩展"></a>3.4.2.1 隐式扩展</h4><p>iptables 在使用 -p 选项指明了特定的协议时，无需再用 -m 选项指明扩展模块的扩展机制，不需要手动加载扩展模块</p>
<p>tcp，upd，icmp 这三个协议是可以用 -m 指定的模块，但同时，也可以在基本匹配里面用 -p 来指定这几个协议</p>
<h5 id="3-4-2-1-1-tcp协议"><a href="#3-4-2-1-1-tcp协议" class="headerlink" title="3.4.2.1.1 tcp协议"></a>3.4.2.1.1 tcp协议</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[!] --source-port, --sport port[:port]：匹配报文源端口,可为端口连续范围</span><br><span class="line">[!] --destination-port,--dport port[:port]：匹配报文目标端口,可为连续范围</span><br><span class="line">[!] --tcp-flags mask comp</span><br><span class="line">  	mask 需检查的标志位列表，用,分隔 , 例如 SYN,ACK,FIN,RST</span><br><span class="line">  	comp 在mask列表中必须为1的标志位列表，无指定则必须为0，用,分隔tcp协议的扩展选项</span><br><span class="line">--tcp-flags SYN,ACK,FIN,RST SYN 	<span class="comment">#检查SYN,ACK,FIN,RST四个标志位，其中SYN值为1，其它值为0，表示第一次握手</span></span><br><span class="line">--tcp-flags SYN,ACK,FIN,RST SYN,ACK <span class="comment">#第二次握手</span></span><br><span class="line">[!] --syn：用于匹配第一次握手, 相当于：--tcp-flags SYN,ACK,FIN,RST SYN</span><br><span class="line"><span class="comment">#错误包</span></span><br><span class="line">--tcp-flags ALL ALL </span><br><span class="line">--tcp_flags ALL NONE</span><br></pre></td></tr></table></figure>

<p>范例：用tcp 协议和目标端口拒绝ssh服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拒绝来自于150 的，其目标IP是110，目标端口是 21 到 23 的 tcp协议数据包</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -s 10.0.0.150 -d 10.0.0.110 -p tcp --dport 21:23 -j REJECT</span><br></pre></td></tr></table></figure>

<p>范例：拒绝ssh服务，接受http服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]#yum -y install nginx</span><br><span class="line">[root@rocky8 ~]#systemctl start nginx</span><br><span class="line">[root@rocky8 ~]#ss -ntl</span><br><span class="line">State      Recv-Q     Send-Q           Local Address:Port           Peer Address:Port     Process     </span><br><span class="line">LISTEN     0          128                    0.0.0.0:80                  0.0.0.0:*                    </span><br><span class="line">LISTEN     0          128                    0.0.0.0:22                  0.0.0.0:*                    </span><br><span class="line">LISTEN     0          128                       [::]:80                     [::]:*                    </span><br><span class="line">LISTEN     0          128                       [::]:22                     [::]:*</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]#iptables -A INPUT -s 10.0.0.1 -j ACCEPT</span><br><span class="line">[root@rocky8 ~]#iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">[root@rocky8 ~]#iptables -A INPUT -p tcp -d 10.0.0.179 -j REJECT(iptables -A INPUT -j REJECT)</span><br><span class="line">[root@rocky8 ~]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">  288 17760 ACCEPT     all  --  *      *       10.0.0.1             0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">    0     0 REJECT     tcp  --  *      *       0.0.0.0/0            10.0.0.179           reject-with icmp-port-unreachable</span><br><span class="line">(   0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable )</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#ssh 10.0.0.179</span><br><span class="line">ssh: connect to host 10.0.0.179 port 22: Connection refused</span><br><span class="line">[root@centos8 ~]#curl 10.0.0.179</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">&quot;-//W3C//DTD XHTML 1.1//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot;</span>&gt;</span><br><span class="line">..........</span><br></pre></td></tr></table></figure>

<p>范例：根据TCP标志位过滤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拒绝第一次握手</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -s 10.0.0.150 -d 10.0.0.110 -p tcp --tcp-flags SYN,ACK,FIN,RST SYN -j REJECT</span><br></pre></td></tr></table></figure>

<p>范例：TCP隐式扩展</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-1-2-udp协议"><a href="#3-4-2-1-2-udp协议" class="headerlink" title="3.4.2.1.2 udp协议"></a>3.4.2.1.2 udp协议</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[!] --source-port, --sport port[:port]：匹配报文的源端口或端口范围</span><br><span class="line">[!] --destination-port,--dport port[:port]：匹配报文的目标端口或端口范围</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-1-3-icmp协议"><a href="#3-4-2-1-3-icmp协议" class="headerlink" title="3.4.2.1.3 icmp协议"></a>3.4.2.1.3 icmp协议</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[!] --icmp-type &#123;<span class="built_in">type</span>[/code]|typename&#125; </span><br><span class="line">    <span class="built_in">type</span>/code</span><br><span class="line">    0/0  echo-reply   <span class="comment">#icmp应答</span></span><br><span class="line">    8/0  echo-request <span class="comment">#icmp请求</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6 -p tcp --dport 21:23 -j REJECT</span><br><span class="line">[root@centos8 ~]#iptables -A INPUT -p tcp --syn -j REJECT</span><br><span class="line">[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6 -p icmp --icmp-type 8 -j REJECT</span><br></pre></td></tr></table></figure>

<p>范例：我能ping对方，对方不能ping我</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 10.0.0.0/24  -j REJECT</span><br><span class="line">iptables -A INPUT -p icmp --icmp-type 0 -j ACCEP</span><br><span class="line"></span><br><span class="line"><span class="comment">#对方主机发出的 ICMP Echo Request 报文将被第一条规则拒绝，而你的本地主机发出的 ICMP Echo Reply 报文（响应对方的 ping 请求）将被第二条规则接受。</span></span><br></pre></td></tr></table></figure>

<p>范例：拒绝ICMP的请求包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -s 10.0.0.150 -p icmp --icmp-type 8 -j REJECT</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-2-显式扩展及相关模块"><a href="#3-4-2-2-显式扩展及相关模块" class="headerlink" title="3.4.2.2 显式扩展及相关模块"></a>3.4.2.2 显式扩展及相关模块</h4><p>显示扩展即必须使用-m选项指明要调用的扩展模块名称，需要手动加载扩展模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-m matchname [per-match-options]]</span><br></pre></td></tr></table></figure>

<p>扩展模块的使用帮助：</p>
<ul>
<li><p>CentOS 7,8: man iptables-extensions</p>
</li>
<li><p>CentOS 6: man iptables</p>
</li>
</ul>
<h5 id="3-4-2-2-1-multiport扩展"><a href="#3-4-2-2-1-multiport扩展" class="headerlink" title="3.4.2.2.1 multiport扩展"></a>3.4.2.2.1 multiport扩展</h5><p>以离散方式定义多端口匹配,最多指定15个端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定多个源端口</span></span><br><span class="line">[!] --source-ports,--sports port[,port|,port:port]...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定多个目标端口</span></span><br><span class="line">[!] --destination-ports,--dports port[,port|,port:port]...</span><br><span class="line"></span><br><span class="line"><span class="comment">#多个源或目标端</span></span><br><span class="line">[!] --ports port[,port|,port:port]...</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp -m multiport --dports 20:22,80 -j ACCEPT</span><br><span class="line">[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6 -p tcp -m multiport --dports 445,139 -j REJECT</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-2-2-iprange扩展"><a href="#3-4-2-2-2-iprange扩展" class="headerlink" title="3.4.2.2.2 iprange扩展"></a>3.4.2.2.2 iprange扩展</h5><p>指明连续的（但一般不是整个网络）ip地址范围</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[!] --src-range from[-to] 源IP地址范围</span><br><span class="line">[!] --dst-range from[-to] 目标IP地址范围</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -d 172.16.1.100 -p tcp --dport 80 -m iprange --src-range 172.16.1.5-172.16.1.10 -j DROP</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-2-3-mac扩展"><a href="#3-4-2-2-3-mac扩展" class="headerlink" title="3.4.2.2.3 mac扩展"></a>3.4.2.2.3 mac扩展</h5><p>mac 模块可以指明源MAC地址,，适用于：PREROUTING, FORWARD，INPUT chains</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[!] --mac-source XX:XX:XX:XX:XX:XX</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#仅有 mac 地址是 00:0c:29:f3:44:9a 的主机才能访问</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -d 10.0.0.110 -m mac --mac-source 00:0c:29:f3:44:9a -j ACCEPT</span><br><span class="line"><span class="comment">#其它主机拒绝</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -d 10.0.0.110 -j REJECT</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-2-4-string扩展"><a href="#3-4-2-2-4-string扩展" class="headerlink" title="3.4.2.2.4 string扩展"></a>3.4.2.2.4 string扩展</h5><p>对报文中的应用层数据做字符串模式匹配检测</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--algo &#123;bm|kmp&#125; 字符串匹配检测算法</span><br><span class="line">    bm：Boyer-Moore</span><br><span class="line">    kmp：Knuth-Pratt-Morris</span><br><span class="line">--from offset 开始偏移</span><br><span class="line">--to offset   结束偏移</span><br><span class="line">[!] --string pattern 要检测的字符串模式</span><br><span class="line">[!] --hex-string pattern 要检测字符串模式，16进制格式</span><br></pre></td></tr></table></figure>

<p>范例：数据报文结构中，前62位都是报文头(22位），IP（10位)和TCP(20位)，不会有敏感词汇，所以从第62位开始检查</p>
<p>请求报文中（INPUT）访问的形式是index.html，不会带有敏感词汇，是回来的报文带有（OUTPUT）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky ~]# curl 10.0.0.206/bd.html</span><br><span class="line">baidu</span><br><span class="line">[root@rocky ~]# curl 10.0.0.206/gg.html</span><br><span class="line">google</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置出口规则，在返回的数据包中，跳过前62字节的报文头，如果内容中出现 google，则拒绝返回</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A OUTPUT -m string --algo kmp --from 62 --string <span class="string">&quot;google&quot;</span> -j REJECT</span><br><span class="line"></span><br><span class="line"><span class="comment">#再次测试</span></span><br><span class="line">[root@rocky ~]# curl 10.0.0.110/bd.html</span><br><span class="line">baidu</span><br><span class="line"><span class="comment">#google 无法返回</span></span><br><span class="line">[root@rocky ~]# curl 10.0.0.110/gg.html</span><br><span class="line"><span class="comment">#区分大小写，大写不会被命中</span></span><br><span class="line">[root@rocky ~]# curl 10.0.0.110/GG.html</span><br><span class="line">GOOGLE</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-2-5-time扩展"><a href="#3-4-2-2-5-time扩展" class="headerlink" title="3.4.2.2.5 time扩展"></a>3.4.2.2.5 time扩展</h5><p>注意：CentOS 8 此模块有问题</p>
<p>根据将报文到达的时间与指定的时间范围进行匹配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]] 日期</span><br><span class="line">--datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</span><br><span class="line">--timestart hh:mm[:ss]     时间</span><br><span class="line">--timestop hh:mm[:ss]</span><br><span class="line">[!] --monthdays day[,day...]  每个月的几号</span><br><span class="line">[!] --weekdays day[,day...]  星期几，1 – 7 分别表示星期一到星期日</span><br><span class="line">--kerneltz：内核时区（当地时间），不建议使用，CentOS 7版本以上系统默认为 UTC</span><br><span class="line">注意： centos6 不支持kerneltz ，--localtz指定本地时区(默认)</span><br><span class="line">说明：UTC时间在原来时间上减8</span><br></pre></td></tr></table></figure>

<p>范例: CentOS 8 的 time模块问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#rpm -ql iptables |grep <span class="keyword">time</span></span><br><span class="line">/usr/lib64/xtables/libxt_time.so</span><br><span class="line">[root@centos8 ~]#iptables -A INPUT -m <span class="keyword">time</span> --timestart 12:30 --timestop 13:30 -j ACCEPT</span><br><span class="line">iptables v1.8.4 (nf_tables): Couldn<span class="string">&#x27;t load match `time&#x27;</span>:No such file or directory</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在ubuntu中设置</span></span><br><span class="line">[root@ubuntu ~]# iptables -t filter -A INPUT -m <span class="keyword">time</span> --timestart 01:00 --timestop 14:00 -s 10.0.0.150 -j REJECT</span><br><span class="line"></span><br><span class="line"><span class="comment">#在150上PING 主机，被拒绝</span></span><br><span class="line">[root@rocky ~]# ping 10.0.0.206 -c1</span><br><span class="line">PING 10.0.0.206 (10.0.0.206) 56(84) bytes of data.</span><br><span class="line">From 10.0.0.206 icmp_seq=1 Destination Port Unreachable</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改主机上的时间，让当前时间不在iptables 规则范围内</span></span><br><span class="line">[root@ubuntu ~]# <span class="built_in">date</span> +<span class="string">&quot;%F %T&quot;</span></span><br><span class="line">2023-06-10 21:02:46</span><br><span class="line">[root@ubuntu ~]# <span class="built_in">date</span> -s <span class="string">&quot;+1 hour&quot;</span></span><br><span class="line">Sat Jun 10 10:03:09 PM CST 2023</span><br><span class="line">[root@ubuntu ~]# <span class="built_in">date</span> +<span class="string">&quot;%F %T&quot;</span></span><br><span class="line">2023-06-10 22:03:11</span><br><span class="line">[root@rocky ~]# ping 10.0.0.206 -c1</span><br><span class="line">PING 10.0.0.206 (10.0.0.206) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.0.206: icmp_seq=1 ttl=64 <span class="keyword">time</span>=0.573 ms</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-2-6-connlimit扩展"><a href="#3-4-2-2-6-connlimit扩展" class="headerlink" title="3.4.2.2.6 connlimit扩展"></a>3.4.2.2.6 connlimit扩展</h5><p>根据每客户端IP做并发连接数数量匹配</p>
<p>可防止Dos(Denial of Service，拒绝服务)攻击</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--connlimit-upto N 	<span class="comment">#连接的数量小于等于N时匹配</span></span><br><span class="line">--connlimit-above N <span class="comment">#连接的数量大于N时匹配</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果并发连接数超过2个，则拒绝连接</span></span><br><span class="line">iptables -A INPUT -d 172.16.100.10 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-2-7-limit扩展"><a href="#3-4-2-2-7-limit扩展" class="headerlink" title="3.4.2.2.7 limit扩展"></a>3.4.2.2.7 limit扩展</h5><p>基于收发报文的速率做匹配 , 令牌桶过滤器（限制流量）</p>
<p>connlimit 扩展是限制单个客户端对服务器的并发连接数，limit 扩展是限制服务器上所有的连接数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--limit-burst number <span class="comment">#前多少个包不限制</span></span><br><span class="line">--<span class="built_in">limit</span> <span class="comment">#[/second|/minute|/hour|/day] #在一个时间区间内能接收的连接数#</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加 icmp 放行规则，前10个不处理，后面每分钟放行20个</span></span><br><span class="line">[root@centos8 ~]#iptables -A INPUT -p icmp -m <span class="built_in">limit</span> --limit-burst 10 --<span class="built_in">limit</span> 20/minute -j ACCEPT</span><br><span class="line"><span class="comment">#兜底的拒绝规则</span></span><br><span class="line">[root@centos8 ~]#iptables -A INPUT -p icmp -j REJECT</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]#ping 10.0.0.8</span><br><span class="line">PING 192.168.39.8 (192.168.39.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=1 ttl=64 <span class="keyword">time</span>=0.779 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=2 ttl=64 <span class="keyword">time</span>=0.436 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=3 ttl=64 <span class="keyword">time</span>=0.774 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=4 ttl=64 <span class="keyword">time</span>=0.391 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=5 ttl=64 <span class="keyword">time</span>=0.441 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=6 ttl=64 <span class="keyword">time</span>=0.356 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=7 ttl=64 <span class="keyword">time</span>=0.553 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=8 ttl=64 <span class="keyword">time</span>=0.458 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=9 ttl=64 <span class="keyword">time</span>=0.459 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=10 ttl=64 <span class="keyword">time</span>=0.479 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=11 ttl=64 <span class="keyword">time</span>=0.450 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=12 ttl=64 <span class="keyword">time</span>=0.471 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=13 ttl=64 <span class="keyword">time</span>=0.531 ms</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=14 ttl=64 <span class="keyword">time</span>=0.444 ms</span><br><span class="line">From 192.168.39.8 icmp_seq=15 Destination Port Unreachable</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=16 ttl=64 <span class="keyword">time</span>=0.668 ms</span><br><span class="line">From 192.168.39.8 icmp_seq=17 Destination Port Unreachable</span><br><span class="line">From 192.168.39.8 icmp_seq=18 Destination Port Unreachable</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=19 ttl=64 <span class="keyword">time</span>=0.692 ms</span><br><span class="line">From 192.168.39.8 icmp_seq=20 Destination Port Unreachable</span><br><span class="line">From 192.168.39.8 icmp_seq=21 Destination Port Unreachable</span><br><span class="line">64 bytes from 192.168.39.8: icmp_seq=22 ttl=64 <span class="keyword">time</span>=0.651 ms</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-2-8-state扩展"><a href="#3-4-2-2-8-state扩展" class="headerlink" title="3.4.2.2.8 state扩展"></a>3.4.2.2.8 state扩展</h5><p>state 扩展模块，可以根据”连接追踪机制“去检查连接的状态，较耗资源</p>
<p>conntrack机制：追踪本机上的请求和响应之间的关系</p>
<p>格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[!] --state state</span><br></pre></td></tr></table></figure>

<p>state状态类型：</p>
<ul>
<li><p>NEW：新发出请求；连接追踪信息库中不存在此连接的相关信息条目，因此，将其识别为第一次发出的请求</p>
</li>
<li><p>ESTABLISHED：NEW状态之后，连接追踪信息库中为其建立的条目失效之前期间内所进行的通信状态</p>
</li>
<li><p>RELATED：新发起的但与已有连接相关联的连接，如：ftp协议中的数据连接与命令连接之间的关系</p>
</li>
<li><p>INVALID：无效的连接，如flag标记不正确</p>
</li>
<li><p>UNTRACKED：未进行追踪的连接，如：raw表中关闭追踪</p>
</li>
</ul>
<p>查看是否启用了连接追踪机制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前还没有启用</span></span><br><span class="line">[root@rocky ~]# lsmod | grep nf_conntrack</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用连接跟踪机制后，会自动生成此文件，</span></span><br><span class="line">[root@rocky ~]# <span class="built_in">cat</span> /proc/net/nf_conntrack</span><br><span class="line"></span><br><span class="line"><span class="comment">#只要系统中某处要使用到连接追踪机制，连接追踪机制相关模块会自动加载</span></span><br></pre></td></tr></table></figure>

<p>已经追踪到的并记录下来的连接信息库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#<span class="built_in">cat</span> /proc/net/nf_conntrack</span><br><span class="line">ipv4   2 icmp   1 29 src=10.0.0.206 dst=10.0.0.150 <span class="built_in">type</span>=8 code=0 <span class="built_in">id</span>=1 src=10.0.0.150 dst=10.0.0.206 <span class="built_in">type</span>=0 code=0 <span class="built_in">id</span>=1 mark=0 zone=0 use=2</span><br><span class="line">ipv4   2 tcp    6 299 ESTABLISHED src=10.0.0.150 dst=10.0.0.1 sport=22 dport=51848 src=10.0.0.1 dst=10.0.0.150 sport=51848 dport=22 [ASSURED] mark=0 zone=0 use=2</span><br><span class="line"></span><br><span class="line">ipv4 		<span class="comment">#第一列 网络层协议名称</span></span><br><span class="line">2    		<span class="comment">#第二列 网络层协议号</span></span><br><span class="line">icmp 		<span class="comment">#第三列 传输层协议名称</span></span><br><span class="line">1    		<span class="comment">#第四列 传输层协议号</span></span><br><span class="line">29   		<span class="comment">#第五列 无后续包进入时无效的秒数，即老化时间</span></span><br><span class="line">ESTABLISHED <span class="comment">#第六列 该连接的连接状态，不是所有协议都有此列值</span></span><br><span class="line">            <span class="comment">#后续都是k=v 格式的连接参数和选项</span></span><br></pre></td></tr></table></figure>

<p>连接追踪功能所能够容纳的最大连接数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#两文件，不管修改哪个，没改的会随之改变</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">cat</span> /proc/sys/net/netfilter/nf_conntrack_max</span><br><span class="line">26624</span><br><span class="line">[root@centos8 ~]#<span class="built_in">cat</span> /proc/sys/net/nf_conntrack_max</span><br><span class="line">26624</span><br></pre></td></tr></table></figure>

<p>己追踪的连接数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#<span class="built_in">cat</span> /proc/sys/net/netfilter/nf_conntrack_count</span><br><span class="line">10</span><br></pre></td></tr></table></figure>

<p>不同的协议的连接追踪时长，单位为秒，超时后会踢出己监控的队列</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#ll /proc/sys/net/netfilter/*_timeout_*</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li><p>连接跟踪，需要加载模块： modprobe nf_conntrack_ipv4</p>
</li>
<li><p>当服务器连接多于最大连接数时dmesg 可以观察到 ：kernel: ip_conntrack: table full, dropping</p>
</li>
<li><p>packet错误,并且导致建立TCP连接很慢。</p>
</li>
<li><p>各种状态的超时后，链接会从表中删除</p>
</li>
</ul>
<p>范例: 不允许远程主机 10.0.0.7 访问本机,但本机可以访问10.0.0.7</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -S</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-A INPUT -s 10.0.0.1/32 -j ACCEPT</span><br><span class="line">-A INPUT -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT ! -s 10.0.0.7/32 -m state --state NEW -j ACCEPT</span><br><span class="line">-A INPUT -j REJECT --reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -d 172.16.1.10 -p tcp -m multiport --dports 22,80 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -s 172.16.1.10 -p tcp -m multiport --sports 22,80 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>范例：新用户不能连，老用户可以连</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#老用户（不能断开，断开就不是已经建立联机的用户了）</span></span><br><span class="line">[root@centos7 ~]#ping 10.0.0.176</span><br><span class="line">PING 10.0.0.176 (10.0.0.176) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.0.176: icmp_seq=1 ttl=64 <span class="keyword">time</span>=0.830 ms</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line">[root@centos8 ~]#iptables -A INPUT -m state --state NEW -j REJECT</span><br><span class="line"></span><br><span class="line"><span class="comment">#新用户</span></span><br><span class="line">[root@rocky8 ~]#ping 10.0.0.176</span><br><span class="line">PING 10.0.0.176 (10.0.0.176) 56(84) bytes of data.</span><br><span class="line">From 10.0.0.176 icmp_seq=1 Destination Port Unreachable</span><br></pre></td></tr></table></figure>

<p><strong>案例：开放被动模式的ftp服务</strong></p>
<p><strong>CentOS 8 此模块有bug</strong></p>
<p>(1) 装载ftp连接追踪的专用模块：</p>
<p>跟踪模块路径： &#x2F;lib&#x2F;modules&#x2F;kernelversion&#x2F;kernel&#x2F;net&#x2F;netfilter</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/iptables-config</span><br><span class="line">IPTABLES_MODULES=“nf_conntrack_ftp<span class="string">&quot;</span></span><br><span class="line"><span class="string">modprobe nf_conntrack_ftp</span></span><br></pre></td></tr></table></figure>

<p>(2) 放行请求报文：</p>
<p>命令连接：NEW, ESTABLISHED</p>
<p>数据连接：RELATED, ESTABLISHED</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -d LocalIP -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -d LocalIP -p tcp --dport 21 -m state --state NEW -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>(3) 放行响应报文：</p>
<p>范例：开放被动模式的ftp服务示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I OUTPUT -s LocalIP -p tcp -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>范例：开放被动模式的ftp服务示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install vsftpd</span><br><span class="line">systemctl start vsftpd</span><br><span class="line">modprobe nf_conntrack_ftp</span><br><span class="line">iptables -F</span><br><span class="line">iptables -A INPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 21 -m state --state NEW -j ACCEPT</span><br><span class="line">iptables -A OUTPUT  -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br><span class="line">iptables -vnL</span><br></pre></td></tr></table></figure>

<h2 id="3-5-Target处理动作"><a href="#3-5-Target处理动作" class="headerlink" title="3.5 Target处理动作"></a>3.5 Target处理动作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-j targetname [per-target-options]</span><br></pre></td></tr></table></figure>

<p>（1）简单动作</p>
<table>
<thead>
<tr>
<th>Target</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ACCEPT</td>
<td>接受，命中此规则后，不再对比当前链的其它规则，进入下一个链</td>
</tr>
<tr>
<td>DROP</td>
<td>抛弃，不回应，命中此规则后，该连接直接中断，发送方收不到任何回应</td>
</tr>
<tr>
<td>REJECT</td>
<td>拒绝，有回应，命中此规则后，该连接直接中断，发送方能收到拒绝回应</td>
</tr>
</tbody></table>
<p>（2）扩展动作</p>
<table>
<thead>
<tr>
<th>Target</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>REJECT</td>
<td><code>--reject-with</code>：icmp-port-unreachable默认</td>
</tr>
<tr>
<td>RETURN</td>
<td>返回调用链，在当前链中不再继续匹配，<strong>返回到主链</strong>，一般用于自定义规则链中，假如input链定义了第一条和第二条和第四条规则 第三条是自定义链 自定义链有三条规则 如果自定义链中第二条规则加了return 数据报文碰到return并满足 就不会执行自定义链的第三条规则 而是执行input链的第四条规则</td>
</tr>
<tr>
<td>REDIRECT</td>
<td>端口重定向</td>
</tr>
<tr>
<td>LOG</td>
<td>记录日志，dmesg，非中断target，本身不拒绝和允许，放在拒绝和允许规则前，将被命中的数据的日志记录在&#x2F;var&#x2F;log&#x2F;messages系统日志中<br><code>- --log-level level</code>：debug, info, notice, warning, error, crit, alert, emerg<br><code>- --log-prefix prefix</code>：日志前缀，用于区别不同的日志，最多29个字符</td>
</tr>
<tr>
<td>MARK</td>
<td>做防火墙标记</td>
</tr>
<tr>
<td>DNAT</td>
<td>目标IP地址转换</td>
</tr>
<tr>
<td>SNAT</td>
<td>源IP地址转换</td>
</tr>
<tr>
<td>MASQUERADE</td>
<td>地址伪装（源IP地址动态转换）</td>
</tr>
<tr>
<td>自定义链</td>
<td>见第4节</td>
</tr>
</tbody></table>
<p>制定规则时先把本机访问和自身访问开了，免得后续制定其他规则时本机不能访问和自己不能访问自己</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s windowsip -j ACCEPT</span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>范例：记录日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -I INPUT -s 10.0.0.0/24 -p tcp -m multiport --dports 80,21,22,23 -m state --state NEW -j LOG --log-prefix <span class="string">&quot;new connections: &quot;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">tail</span> -f /var/log/messages</span><br><span class="line">Mar 19 18:41:07 centos8 kernel: iptables tcp connection: IN=eth0 OUT=</span><br><span class="line">MAC=00:0c:29:f8:5d:b7:00:50:56:c0:00:08:08:00 SRC=10.0.0.1 DST=10.0.0.8 LEN=40 TOS=0x00 PREC=0x00 TTL=128 ID=43974 DF PROTO=TCP SPT=9844 DPT=22 WINDOW=4102 RES=0x00 ACK URGP=0</span><br><span class="line">Mar 19 18:41:07 centos8 kernel: new connections: IN=eth0 OUT=</span><br><span class="line">MAC=00:0c:29:f8:5d:b7:00:50:56:c0:00:08:08:00 SRC=10.0.0.1 DST=10.0.0.8 LEN=40 TOS=0x00 PREC=0x00 TTL=128 ID=43975 DF PROTO=TCP SPT=9844 DPT=22 WINDOW=4102 RES=0x00 ACK URGP=0</span><br></pre></td></tr></table></figure>

<p>范例：记录日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -R INPUT 2 -p tcp --dport 21 -m state --state NEW -j LOG --log-prefix <span class="string">&quot;ftp new link: &quot;</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">tail</span> -f /var/log/messages</span><br><span class="line">Dec 21 10:02:31 centos8 kernel: ftp new <span class="built_in">link</span>: IN=eth0 OUT=</span><br><span class="line">MAC=00:0c:29:f9:8d:90:00:0c:29:10:8a:b1:08:00 SRC=192.168.39.6 DST=192.168.39.8</span><br><span class="line">LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=15556 DF PROTO=TCP SPT=53706 DPT=21 WINDOW=14600 RES=0x00 SYN URGP=0</span><br></pre></td></tr></table></figure>

<h1 id="4-iptables自定义链"><a href="#4-iptables自定义链" class="headerlink" title="4 iptables自定义链"></a>4 iptables自定义链</h1><p>iptables 中除了系统自带的五个链之外，还可以自定义链，来实现将规则进行分组，重复调用的目的。自定义链添加规则之后，要作为系统链的 target 与之关联，才能起到作用</p>
<p>生产中频繁要改的规则可以放在自定义链中，不需要放在主链中，防止修改时出错误，修改时直接修改自定义链，不用修改主链</p>
<table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>作用</td>
<td>组织和复用规则，提高可读性和管理效率</td>
</tr>
<tr>
<td>创建</td>
<td><code>iptables -N &lt;chain-name&gt;</code></td>
</tr>
<tr>
<td>删除</td>
<td><code>iptables -X &lt;chain-name&gt;</code></td>
</tr>
<tr>
<td>调用</td>
<td>在内置链中使用 <code>-j &lt;chain-name&gt;</code> 跳转</td>
</tr>
<tr>
<td>RETURN 行为</td>
<td>在自定义链中遇到 <code>RETURN</code>，将<strong>返回主链的下一条规则</strong>，不再执行该自定义链后续规则</td>
</tr>
</tbody></table>
<p>范例：拒绝http和https服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -N WEB_CHAIN</span><br><span class="line">iptables -A WEB_CHAIN -s 10.0.0.6 -p tcp -m multiport --dports80,443 -j REJECT</span><br><span class="line">iptables -A INPUT -j WEB_CHAIN</span><br></pre></td></tr></table></figure>

<p>范例: 创建自定义链实现WEB的访问控制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -N web_chain</span><br><span class="line"><span class="comment">#改名</span></span><br><span class="line">[root@centos8 ~]#iptables -E web_chain WEB_CHAIN</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#iptables -A WEB_CHAIN -p tcp -m multiport --dports 80,443,8080 -j ACCEPT</span><br><span class="line">[root@centos8 ~]#iptables -I INPUT 3 -s 10.0.0.0/24 -j WEB_CHAIN</span><br><span class="line">[root@centos8 ~]#iptables -A WEB_CHAIN -p icmp -j ACCEPT</span><br><span class="line">[root@centos8 ~]#iptables -I WEB_CHAIN 2 -s 10.0.0.6 -j RETURN</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#iptables -vnL --line-numbers</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>   destination    </span><br><span class="line">1    10  867 ACCEPT   all  -- lo   *    0.0.0.0/0     0.0.0.0/0     </span><br><span class="line">2   5637 423K ACCEPT   all  -- *   *    10.0.0.1      0.0.0.0/0     </span><br><span class="line">3    248 20427 WEB_CHAIN all  -- *   *  10.0.0.0/24    0.0.0.0/0     </span><br><span class="line">4   4278 248K REJECT   all  -- *   *    0.0.0.0/0     0.0.0.0/0      reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>   destination    </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>   destination    </span><br><span class="line"></span><br><span class="line">Chain WEB_CHAIN (1 references)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>   destination    </span><br><span class="line">1    36  2619 ACCEPT   tcp  -- *   *    0.0.0.0/0     0.0.0.0/0      multiport dports 80,443,8080</span><br><span class="line">2    16  1344 RETURN   all  -- *   *    10.0.0.6      0.0.0.0/0     </span><br><span class="line">3    184 15456 ACCEPT   icmp -- *   *    0.0.0.0/0     0.0.0.0/0   </span><br><span class="line"> </span><br><span class="line">[root@centos6 ~]#curl 10.0.0.8</span><br><span class="line">centos8 website</span><br><span class="line">[root@centos6 ~]#curl 10.0.0.8</span><br><span class="line">centos8 website</span><br><span class="line">[root@centos6 ~]#ping -c1 10.0.0.8</span><br></pre></td></tr></table></figure>

<p>范例: 删除自定义链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#无法直接删除自定义链,删除自定义链和创建的顺序相反</span></span><br><span class="line">[root@centos8 ~]#iptables -X WEB_CHAIN</span><br><span class="line">iptables v1.8.4 (nf_tables): CHAIN_USER_DEL failed (Device or resource busy):chain WEB_CHAIN</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#iptables -D INPUT 3</span><br><span class="line">[root@centos8 ~]#iptables -X WEB_CHAIN</span><br><span class="line">iptables v1.8.4 (nf_tables): CHAIN_USER_DEL failed (Device or resource busy):chain WEB_CHAIN</span><br><span class="line"></span><br><span class="line"><span class="comment">#先清除规则再删</span></span><br><span class="line">[root@centos8 ~]#iptables -F WEB_CHAIN</span><br><span class="line">[root@centos8 ~]#iptables -L WEB_CHAIN</span><br><span class="line">Chain WEB_CHAIN (0 references)</span><br><span class="line">target   prot opt <span class="built_in">source</span>        destination </span><br><span class="line">[root@centos8 ~]#iptables -X WEB_CHAIN</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#iptables -vnL --line-numbers</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>   destination    </span><br><span class="line">1    10  867 ACCEPT   all  -- lo   *    0.0.0.0/0     0.0.0.0/0     </span><br><span class="line">2   5824 437K ACCEPT   all  -- *   *    10.0.0.1      0.0.0.0/0   </span><br><span class="line">3   4279 248K REJECT   all  -- *   *    0.0.0.0/0     0.0.0.0/0      reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>   destination    </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>   destination </span><br></pre></td></tr></table></figure>

<h1 id="5-规则优化最佳实践"><a href="#5-规则优化最佳实践" class="headerlink" title="5 规则优化最佳实践"></a>5 规则优化最佳实践</h1><ul>
<li><p>安全放行所有入站和出站的状态为ESTABLISHED状态连接,建议放在第一条，效率更高</p>
</li>
<li><p>谨慎放行入站的新请求</p>
</li>
<li><p>有特殊目的限制访问功能，要在放行规则之前加以拒绝</p>
</li>
<li><p>同类规则（访问同一应用，比如：http ），匹配范围小的放在前面，用于特殊处理</p>
</li>
<li><p>不同类的规则（访问不同应用，一个是http，另一个是mysql ），匹配范围大的放在前面，效率更高</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-s 10.0.0.6 -p tcp --dport 3306 -j REJECT</span><br><span class="line">-s 172.16.0.0/16 -p tcp --dport 80 -j REJECT</span><br></pre></td></tr></table></figure>

<ul>
<li><p>应该将那些可由一条规则能够描述的多个规则合并为一条,减少规则数量,提高检查效率</p>
</li>
<li><p>设置默认策略，建议白名单（只放行特定连接）iptables -P，不建议，容易出现“自杀现象”规则的最后定义规则做为默认策略，推荐使用，放在最后一条</p>
</li>
</ul>
<h1 id="6-iptables规则保存"><a href="#6-iptables规则保存" class="headerlink" title="6 iptables规则保存"></a>6 iptables规则保存</h1><p>使用iptables命令定义的规则，手动删除之前，其生效期限为kernel存活期限，当系统重启之后，定义的规则会消失。</p>
<h2 id="6-1-持久保存规则"><a href="#6-1-持久保存规则" class="headerlink" title="6.1 持久保存规则"></a>6.1 持久保存规则</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 iptables-save &gt; /PATH/TO/SOME_RULES_FILE</span><br><span class="line">2 rc.local</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -A INPUT -s 10.0.0.1 -j ACCEPT</span><br><span class="line">[root@centos8 ~]#iptables-save &gt; iptables.rule</span><br><span class="line">[root@centos8 ~]#<span class="built_in">cat</span> iptables.rule</span><br><span class="line"><span class="comment"># Generated by iptables-save v1.8.4 on Tue Nov 21 15:47:34 2023</span></span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">-A INPUT -s 10.0.0.1/32 -j ACCEPT</span><br><span class="line">COMMIT</span><br><span class="line"><span class="comment"># Completed on Tue Nov 21 15:47:34 2023</span></span><br></pre></td></tr></table></figure>

<h2 id="6-2-加载规则"><a href="#6-2-加载规则" class="headerlink" title="6.2 加载规则"></a>6.2 加载规则</h2><p>CentOS 7,8 重新载入预存规则文件中规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables-restore &lt; /PATH/FROM/SOME_RULES_FILE</span><br></pre></td></tr></table></figure>

<p>iptables-restore选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-n, --noflush：不清除原有规则</span><br><span class="line">-t, --<span class="built_in">test</span>：仅分析生成规则集，但不提交</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#iptables -F</span><br><span class="line">[root@centos8 ~]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination     </span><br><span class="line"> </span><br><span class="line">[root@centos8 ~]#iptables-restore &lt; iptables.rule </span><br><span class="line">[root@centos8 ~]#iptables -vnL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    6   364 ACCEPT     all  --  *      *       10.0.0.1             0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 4 packets, 416 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination  </span><br></pre></td></tr></table></figure>

<h2 id="6-3-开机自动重载规则"><a href="#6-3-开机自动重载规则" class="headerlink" title="6.3 开机自动重载规则"></a>6.3 开机自动重载规则</h2><ul>
<li><p>用脚本保存各个iptables命令；让此脚本开机后自动运行&#x2F;etc&#x2F;rc.d&#x2F;rc.local文件中添加脚本路径 &#x2F;PATH&#x2F;TO&#x2F;SOME_SCRIPT_FILE</p>
</li>
<li><p>用规则文件保存各个规则，开机时自动载入此规则文件中的规则在&#x2F;etc&#x2F;rc.d&#x2F;rc.local文件添加</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables-restore &lt; /PATH/FROM/IPTABLES_RULES_FILE</span><br><span class="line"></span><br><span class="line"><span class="comment">#ubuntu中没有该文件，要自行创建</span></span><br><span class="line">[root@ubuntu ~]# vim /etc/rc.local</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br></pre></td></tr></table></figure>

<p>定义Unit File, CentOS 7，8 可以安装 iptables-services 实现iptables.service</p>
<p>范例: CentOS 7，8 使用 iptables-services</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#yum -y install iptables-services</span><br><span class="line">[root@rocky ~]# systemctl start iptables</span><br><span class="line"></span><br><span class="line"><span class="comment">#这些规则是启动iptables 服务后加载的规则，其保存文件为 /etc/sysconfig/iptables</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">cp</span> /etc/sysconfig/iptables&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#保存现在的规则到文件中方法1</span></span><br><span class="line">[root@centos8 ~]#/usr/libexec/iptables/iptables.init save</span><br><span class="line"></span><br><span class="line"><span class="comment">#保存现在的规则到文件中方法2</span></span><br><span class="line">[root@centos8 ~]#iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"><span class="comment">#开机启动</span></span><br><span class="line">[root@centos8 ~]#systemctl <span class="built_in">enable</span> iptables.service  </span><br><span class="line">[root@centos8 ~]#systemctl mask firewalld.service nftables.service</span><br></pre></td></tr></table></figure>

<h1 id="7-网络防火墙"><a href="#7-网络防火墙" class="headerlink" title="7 网络防火墙"></a>7 网络防火墙</h1><p>iptables&#x2F;netfilter 利用filter表的FORWARD链,可以充当网络防火墙：</p>
<p>注意的问题：</p>
<p>(1) 请求-响应报文均会经由FORWARD链，要注意规则的方向性</p>
<p>(2) 如果要启用conntrack机制，建议将双方向的状态为ESTABLISHED的报文直接放行</p>
<h2 id="7-1-NAT表"><a href="#7-1-NAT表" class="headerlink" title="7.1 NAT表"></a>7.1 NAT表</h2><p>NAT: 网络地址转换，支持PREROUTING，INPUT，OUTPUT，POSTROUTING四个链</p>
<ul>
<li><p>局域网中的主机都是分配的私有IP地址，这些IP地址在互联网上是不可达的，局域网中的主机，在与互联网通讯时，要经过网络地址转换，去到互联网时，变成公网IP地址对外发送数据。服务器返回数据时，也是返回到这个公网地址，再经由网络地址转换返回给局域网中的主机</p>
</li>
<li><p>一个局域网中的主机，想要访问互联网，在出口处，应该有一个公网可达的IP地址，应该能将局域网中的IP地址通过NAT转换成公网IP</p>
</li>
</ul>
<p>NAT的实现分为下面类型：</p>
<ul>
<li><p>SNAT：source NAT ，支持POSTROUTING, INPUT，让本地网络中的主机通过某一特定地址访问外部网络，实现地址伪装（源地址转换，将请求报文中的源IP地址转换为公网地址）</p>
</li>
<li><p>DNAT：destination NAT ，支持PREROUTING , OUTPUT，把本地网络中的主机上的某服务开放给外部网络访问(发布服务和端口映射)，但隐藏真实IP（目标地址转换，将响应报文中的目标IP地址转换为私网地址）</p>
</li>
<li><p>PNAT: port nat，端口转换，IP地址和端口都进行转换</p>
</li>
</ul>
<p><strong>NAT 网络转换原理</strong></p>
<p>当我们从运营商接入宽带之后，经过路由器，防火墙，交换机等各种设备，后面再接入终端机，包括打印机，手机，电脑等，在大多数情况下，我们在接入运营商的宽带后，会在使用（公司，学校，工厂，家庭）范围内组建一个局域网。</p>
<p>以我现在的工作机为例。</p>
<p>物理机的IP地址是 192.168.1.101，在物理机上运行着两台虚拟机，它们的IP 分别是 10.0.0.150 和10.0.0.151。</p>
<p>但是这三台主机，在访问互联网时，互联网上得到的这三台主机的IP都是 219.143.130.7</p>
<p>我们知道，两台主机之间通讯，是需要经过路由表的，路由表中保存了去到下一个IP地址的路由记录，但是 192.168.0.101 和 10.0.0.150 这两个IP地址都是私有地址，在网路上是不可达的，也就是说，在互联网上，是没有一个去到 192.168.0.101 这个网段的路由记录的(10.0.0.150 同理)，那么，我的物理机和虚拟机，是怎么访问互联网的，互联网上的主机，又是怎么回传数据给我的物理机和虚拟机的呢</p>
<p>根据我们前面学过的识知，两台主机之间通讯，是客户端主机启一个随机端口，去连接服务器的IP地址和固定端口，连接成功后，客户端发送数据，服务端根据客户端发送的数据，做出响应，再返回给客户端。</p>
<p>思考题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在单位内部使用未经申请的公网地址,如:6.0.0.0/8网段,进行内部网络通讯,并利用SNAT连接Internet,是否可以?</span><br><span class="line">答：不可以，万一使用的恰好是公网中有的地址，就会连不上</span><br></pre></td></tr></table></figure>

<h2 id="7-2-SNAT"><a href="#7-2-SNAT" class="headerlink" title="7.2 SNAT"></a>7.2 SNAT</h2><p><strong>SNAT</strong>：源地址转换，基于nat表的target，适用于固定的公网IP，工作在 POSTROUTING 链上，支持专线</p>
<p>具体是指将经过当前主机转发的请求报文的源IP地址转换成根据防火墙规则指定的IP地址，解决私网访问公网的问题</p>
<p>局域网内所有设备要上外网，如果每个设备都分配一个公网ip成本太大，可以在路由器出口分配一个公网ip，局域网内的设备访问外网时统一走路由器出口，路由器此时需要做两件事：</p>
<ol>
<li><p>数据包从出口出去之前，将数据包的源地址和源端口改成公网ip和随机端口</p>
</li>
<li><p>同时将转换关系记录保存，响应数据包返回时根据记录转发给局域网内的设备</p>
</li>
</ol>
<p>SNAT选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--to-source [ipaddr[-ipaddr]][:port[-port]]		<span class="comment">#转换成指定IP，或指定范围内的IP，端口可选</span></span><br><span class="line">--random										<span class="comment">#端口映射基于hash算法随机化</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j SNAT --to-source ExtIP</span><br></pre></td></tr></table></figure>

<p>注意: 需要开启 ip_forward</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu ~]# sysctl -a | grep ip_forward</span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在防火墙主机上添加规则，如果源IP是 10.0.0.0/24网段的IP，则出去的时候，替换成192.168.10.123</span></span><br><span class="line">[root@ubuntu ~]# iptables -t nat -A POSTROUTING -s 10.0.0.0/24 ! -d 10.0.0.0/24 -j SNAT --to-source 192.168.10.123</span><br><span class="line"></span><br><span class="line"><span class="comment">#替换成172.18.1.6-172.18.1.9范围内的地址</span></span><br><span class="line">[root@ubuntu ~]#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 ! –d 10.0.0.0/24 -j SNAT --to-source 172.18.1.6-172.18.1.9</span><br><span class="line"></span><br><span class="line"><span class="comment">#只转换tcp协议 目标端口为80的报文，且通过12345 端口向外访问</span></span><br><span class="line">[root@ubuntu ~]# iptables -t nat -R POSTROUTING 1 -s 10.0.0.0/24 ! -d 10.0.0.0/24 -o ens37 -p tcp --dport 80 -j SNAT --to-source 192.168.10.123:12345</span><br></pre></td></tr></table></figure>

<p><strong>MASQUERADE</strong>：基于nat表的target，适用于动态的公网IP，既支持拨号网络，也支持专线</p>
<p>如果我们内网的出口设备上有固定IP，则直接指定 –to-source IP 没有任何问题，但是如果是使用拨号上网，出口网络设备上的IP地址会发生变化，这种情况下，我们的出口IP不能写成固定的。</p>
<p>这种场景下，我们需要使用 MASQUERADE 进行地址转换，MASOUERADE 可以从主机网卡上自动获取IP地址当作出口IP地址</p>
<p>MASQUERADE选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--to-ports port[-port]	<span class="comment">#指定端口</span></span><br><span class="line">--random				<span class="comment">#端口映射基于hash算法随机化</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从本地内网地址发出，只要不是到达本地地址的都转换为公网地址</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment">#从10网段发出，只要不是到达10网段的都转换为公网地址</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.0.0.0/24 ! -d 10.0.0.0/24 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<p>范例：查看本地主机访问公网时使用的IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#curl http://ip.sb</span><br><span class="line">111.199.191.204</span><br><span class="line"></span><br><span class="line"><span class="comment">#Windows10 支持curl</span></span><br><span class="line">C:\Users\Wang&gt;curl ip.sb</span><br><span class="line">111.199.184.218</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#curl http://ipinfo.io/ip/</span><br><span class="line">111.199.191.204</span><br><span class="line">[root@centos8 ~]#curl http://ifconfig.me</span><br><span class="line">111.199.191.204</span><br><span class="line">[root@centos8 ~]#curl -L http://tool.lu/ip</span><br><span class="line">当前IP: 111.199.191.204</span><br><span class="line">归属地: 中国 北京 北京</span><br><span class="line">[root@centos8 ~]#curl -sS --connect-timeout 10 -m 60</span><br><span class="line">https://www.bt.cn/Api/getIpAddress</span><br><span class="line">111.199.189.164</span><br><span class="line">[root@centos8 ~]#curl <span class="string">&quot;https://api.ipify.org?format=string&quot;</span></span><br><span class="line">111.199.184.218</span><br><span class="line"></span><br><span class="line">[root@firewall ~]#curl cip.cc</span><br><span class="line">IP : 39.164.140.134</span><br><span class="line">地址 : 中国 河南 鹤壁</span><br><span class="line">运营商 : 移动</span><br><span class="line">数据二 : 河南省郑州市 | 移动</span><br><span class="line">数据三 :</span><br><span class="line">URL : http://www.cip.cc/39.164.140.134</span><br></pre></td></tr></table></figure>

<p>范例: SNAT</p>
<p><img src="/Linux/firewall/iptables/1753757574958-5e456429-cdff-4699-acd7-0bec34c4824b.png" alt="null"></p>
<p>客户端端口随机，http的端口为80</p>
<p>由于10.0.0.8占用了12345端口，所以假如10.0.0.18同时向外网连接的话，端口号就要转换为192.168.10.7这个公网地址没人用的端口号</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>源地址</th>
<th>目的地址</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>10.0.0.8:12345</td>
<td>192.168.10.100:80</td>
</tr>
<tr>
<td>2</td>
<td>192.168.10.7:12345</td>
<td>192.168.0.100:80</td>
</tr>
<tr>
<td>3</td>
<td>192.168.0.100:80</td>
<td>192.168.10.7:12345</td>
</tr>
<tr>
<td>4</td>
<td>192.168.0.100:80</td>
<td>10.0.0.:12345</td>
</tr>
<tr>
<td>1</td>
<td>10.0.0.18:12345</td>
<td>192.168.10.100:80</td>
</tr>
<tr>
<td>2</td>
<td>192.168.10.7:12346</td>
<td>192.168.10.100:80</td>
</tr>
<tr>
<td>3</td>
<td>192.168.10.100:80</td>
<td>192.168.0.7:12346</td>
</tr>
<tr>
<td>4</td>
<td>192.168.10.100:80</td>
<td>10.0.0.1:12345</td>
</tr>
</tbody></table>
<p>实现内网两机器可以访问外网</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#做好测试服务，注意先做好再去配置地址和网关和网络模式</span></span><br><span class="line">[root@lanserver1 ~]#yum -y install httpd</span><br><span class="line">[root@lanserver2 ~]#yum -y install httpd</span><br><span class="line">[root@internet ~]#yum -y install httpd</span><br><span class="line">[root@lanserver1 ~]#hostname -I &gt; /var/www/html/index.html</span><br><span class="line">[root@lanserver2 ~]#hostname -I &gt; /var/www/html/index.html</span><br><span class="line">[root@Internet ~]#hostname -I &gt; /var/www/html/index.html</span><br><span class="line">[root@lanserver1 ~]#systemctl start httpd</span><br><span class="line">[root@lanserver2 ~]#systemctl start httpd</span><br><span class="line">[root@internet ~]#systemctl start httpd</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置地址和网关</span></span><br><span class="line"><span class="comment">#lanserver1</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">IPADDR=10.0.0.179</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.176</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#lanserver2</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">IPADDR=10.0.0.180</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.176</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">     </span><br><span class="line"><span class="comment">#firewall</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">IPADDR=10.0.0.176</span><br><span class="line">PREFIX=24</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">DEVICE=eth1</span><br><span class="line">NAME=eth1</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">IPADDR=192.168.10.8</span><br><span class="line">PREFIX=24</span><br><span class="line"></span><br><span class="line"><span class="comment">#internet</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">IPADDR=192.168.10.6</span><br><span class="line">PREFIX=24</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试连接状态</span></span><br><span class="line">[root@firewall ~]#curl 192.168.10.6</span><br><span class="line">192.168.10.6</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用路由转发（只要数据包经过forward链就要开启）</span></span><br><span class="line">[root@firewall ~]#vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">[root@firewall ~]#sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置规则（两种方法，因为现在192.168.10.8假设是专线IP）</span></span><br><span class="line">1 针对专线静态公共IP</span><br><span class="line"><span class="comment">#对于来自 10.0.0.0/24 子网的数据包，只有当它们不要访问 10.0.0.0/24 子网时才进行 SNAT 转换</span></span><br><span class="line">[root@firewall ~]#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 ! -d 10.0.0.0/24 -j SNAT --to-source 192.168.10.8</span><br><span class="line"></span><br><span class="line">2 针对拨号网络和专线静态公共IP</span><br><span class="line">[root@firewall ~]#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 ! -d 10.0.0.0/24 -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment">#10.0.0.179转换为192.168.10.8去ping192.168.10.6</span></span><br><span class="line">[root@lanserver1 ~]#ping 192.168.10.6</span><br><span class="line">PING 192.168.10.6 (192.168.10.6) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.10.6: icmp_seq=9 ttl=63 <span class="keyword">time</span>=6.18 ms</span><br><span class="line">64 bytes from 192.168.10.6: icmp_seq=10 ttl=63 <span class="keyword">time</span>=6.12 ms</span><br><span class="line"></span><br><span class="line">[root@internet ~]#tcpdump -i eth0 -nn icmp</span><br><span class="line">dropped privs to tcpdump</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">21:14:43.283872 IP 192.168.10.8 &gt; 192.168.10.6: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 3, <span class="built_in">seq</span> 28, length 64</span><br><span class="line">21:14:43.283948 IP 192.168.10.6 &gt; 192.168.10.8: ICMP <span class="built_in">echo</span> reply, <span class="built_in">id</span> 3, <span class="built_in">seq</span> 28, length 64</span><br><span class="line">21:14:44.294611 IP 192.168.10.8 &gt; 192.168.10.6: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 3, <span class="built_in">seq</span> 29, length 64</span><br><span class="line">21:14:44.294695 IP 192.168.10.6 &gt; 192.168.10.8: ICMP <span class="built_in">echo</span> reply, <span class="built_in">id</span> 3, <span class="built_in">seq</span> 29, length 64</span><br><span class="line"></span><br><span class="line"><span class="comment">#10.0.0.179转换为192.168.10.8去访问192.168.10.6</span></span><br><span class="line">[root@lanserver1 ~]#curl 192.168.10.6</span><br><span class="line">192.168.10.6 </span><br><span class="line">[root@internet ~]#<span class="built_in">tail</span> -f /var/log/httpd/access_log </span><br><span class="line">192.168.10.8 - - [21/Nov/2023:21:16:14 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 14 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看转换状态信息</span></span><br><span class="line">[root@firewall ~]#<span class="built_in">cat</span> /proc/net/nf_conntrack</span><br><span class="line">ipv4     2 tcp      6 117 TIME_WAIT src=10.0.0.179 dst=192.168.10.6 sport=47724 dport=80 src=192.168.10.6 dst=192.168.10.8 sport=80 dport=47724 [ASSURED] mark=0 zone=0 use=2</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看监听端口</span></span><br><span class="line">[root@firewall ~]#ss -ntl</span><br><span class="line">State      Recv-Q     Send-Q           Local Address:Port           Peer Address:Port     Process     </span><br><span class="line">LISTEN     0          128                    0.0.0.0:22                  0.0.0.0:*                    </span><br><span class="line">LISTEN     0          128                       [::]:22                     [::]:*  </span><br><span class="line"><span class="comment">#会发现监听不到80端口，原因是ss命令监听的是应用程序打开的端口，而iptables是属于内核参数的，内核不属于应用程序空间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#外网不可以访问内网</span></span><br><span class="line">[root@internet ~]#curl 10.0.0.179</span><br><span class="line">curl: (7) Couldn<span class="string">&#x27;t connect to server</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#解决办法是使用DNAT技术</span></span><br></pre></td></tr></table></figure>

<h2 id="7-3-DNAT"><a href="#7-3-DNAT" class="headerlink" title="7.3 DNAT"></a>7.3 DNAT</h2><p>DNAT：目标地址转换，nat表的target，适用于端口映射，即可重定向到本机，也可以支持重定向至不同主机的不同端口，但不支持多目标，即不支持负载均衡功能，工作在 PREROUTING 链上</p>
<p>在内网环境中，使用私有IP地址的设备要与互联网进行通讯时，需要借助出口设备将源内网IP地址转换成公网可达的IP地址再进行通讯。</p>
<p>在内网环境中，只有在出口设备上才有一个(或数个)公网可达的IP，所以在互联网上，是不能路由至内网主机的。如果要让内网主机上的服务在公网上可见，我们需要使用 DNAT 实现目标IP地址转换，解决公网访问私网的问题</p>
<p>修改端口号：重定向端口</p>
<p>DNAT选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--to-destination [ipaddr[-ipaddr]][:port[-port]]	<span class="comment">#转换成指定IP，或指定范围内的IP，端口可选</span></span><br><span class="line">-d ExtIP 											<span class="comment">#指公网可达的IP地址，必须是固定IP，不可以是拨号网络</span></span><br></pre></td></tr></table></figure>

<p>DNAT 格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -d ExtIP -p tcp|udp --dport PORT -j DNAT --to-destination InterSeverIP[:PORT]</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在防火墙主机上设置DNAT转发规则，在访问 192.168.10.123 的 web 服务时，转发到 10.0.0.150上</span></span><br><span class="line">[root@ubuntu ~]# iptables -t nat -A PREROUTING -d 192.168.10.123 -p tcp --dport 80 -j DNAT --to-destination 10.0.0.150:80</span><br><span class="line"></span><br><span class="line">[root@ubuntu ~]#iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 22 -j DNAT --to-destination 10.0.1.22</span><br><span class="line"></span><br><span class="line">[root@ubuntu ~]#iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 80 -j DNAT --to-destination 10.0.1.22:8080</span><br></pre></td></tr></table></figure>

<p>注意: 需要开启 ip_forward</p>
<p>范例: DNAT</p>
<p><img src="/Linux/firewall/iptables/1753757575034-6c34b0e2-ca00-423d-8052-ddbfcaf984db.png" alt="null"></p>
<table>
<thead>
<tr>
<th>序号</th>
<th>源地址</th>
<th>目的地址</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>192.168.10.100:12345</td>
<td>192.168.10.7:80</td>
</tr>
<tr>
<td>2</td>
<td>192.168.10.100:12345</td>
<td>10.0.0.8:80</td>
</tr>
<tr>
<td>3</td>
<td>10.0.0.8:80</td>
<td>192.168.10.100:12345</td>
</tr>
<tr>
<td>4</td>
<td>192.168.10.7:80</td>
<td>192.168.10.100:12345</td>
</tr>
</tbody></table>
<p>实现外网访问内网</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置规则</span></span><br><span class="line">[root@firewall ~]#iptables -t nat -A PREROUTING -d 192.168.10.8 -p tcp --dport 80 -j DNAT --to-destination 10.0.0.179:80</span><br><span class="line"></span><br><span class="line"><span class="comment">#外网通过将防火墙IP地址转换为内网地址去访问内网10.0.0.179</span></span><br><span class="line">[root@internet ~]#curl 192.168.10.8</span><br><span class="line">10.0.0.179 </span><br><span class="line"></span><br><span class="line">[root@lanserver1 ~]#<span class="built_in">tail</span> /var/log/httpd/access_log </span><br><span class="line">192.168.10.6 - - [21/Nov/2023:21:46:22 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 12 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line"></span><br><span class="line">[root@firewall ~]#<span class="built_in">cat</span> /proc/net/nf_conntrack</span><br><span class="line">ipv4     2 tcp      6 28 TIME_WAIT src=192.168.10.6 dst=192.168.10.8 sport=53096 dport=80 src=10.0.0.179 dst=192.168.10.6 sport=80 dport=53096 [ASSURED] mark=0 zone=0 use=2</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意不能直接访问内网地址，因为没有设置路由表</span></span><br><span class="line">[root@internet ~]#curl 10.0.0.179</span><br><span class="line">curl: (7) Couldn<span class="string">&#x27;t connect to server</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#外网不能通过将防火墙IP地址转换为内网地址去访问内网10.0.0.180</span></span><br><span class="line"><span class="string">[root@firewall ~]#iptables -t nat -A PREROUTING -d 192.168.10.8 -p tcp --dport 80 -j DNAT --to-destination 10.0.0.180:80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@firewall ~]#iptables -t nat -vnL</span></span><br><span class="line"><span class="string">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span></span><br><span class="line"><span class="string"> pkts bytes target     prot opt in     out     source               destination         </span></span><br><span class="line"><span class="string">    2   120 DNAT       tcp  --  *      *       0.0.0.0/0            192.168.10.8         tcp dpt:80 to:10.0.0.179:80</span></span><br><span class="line"><span class="string">    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            192.168.10.8         tcp dpt:80 to:10.0.0.180:80</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">[root@internet ~]#curl 192.168.10.8</span></span><br><span class="line"><span class="string">10.0.0.179 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#原因是iptables规则是有先后次序的，匹配了第一条，也就是访问192.168.10.8是去访问10.0.0.179:80的，就不会去匹配第二条，解决方法是重新指定端口，不能是80端口了，因为已经被10.0.0.179占了</span></span><br><span class="line"><span class="string">[root@firewall ~]#iptables -t nat -R PREROUTING 2 -d 192.168.10.8 -p tcp --dport 81 -j DNAT --to-destination 10.0.0.180:80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@internet ~]#curl 192.168.10.8:81</span></span><br><span class="line"><span class="string">10.0.0.180</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@internet ~]#curl 192.168.10.8:80</span></span><br><span class="line"><span class="string">10.0.0.179</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#修改内网httpd服务自身的端口号</span></span><br><span class="line"><span class="string">[root@lanserver2 ~]#vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="string">Listen 8080</span></span><br><span class="line"><span class="string">[root@lanserver2 ~]#systemctl restart httpd</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#现在拒绝连接了</span></span><br><span class="line"><span class="string">root@internet ~]#curl 192.168.10.8:81</span></span><br><span class="line"><span class="string">curl: (7) Failed to connect to 192.168.10.8 port 81: 拒绝连接</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#解决办法是使用REDIRECT来重定向端口</span></span><br></pre></td></tr></table></figure>

<h2 id="7-4-REDIRECT转发"><a href="#7-4-REDIRECT转发" class="headerlink" title="7.4 REDIRECT转发"></a>7.4 REDIRECT转发</h2><p>REDIRECT，是NAT表的 target，通过改变目标IP和端口，将接受的包转发至同一个主机的不同端口，可用于PREROUTING，OUTPUT链</p>
<p>REDIRECT 功能无需开启内核 ip_forward 转发</p>
<p>REDIRECT选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--to-ports port[-port]</span><br></pre></td></tr></table></figure>

<p>范例：继续根据上面案例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@lanserver2 ~]#ss -ntl</span><br><span class="line">State      Recv-Q     Send-Q           Local Address:Port           Peer Address:Port     Process     </span><br><span class="line">LISTEN     0          128                    0.0.0.0:22                  0.0.0.0:*                    </span><br><span class="line">LISTEN     0          128                          *:8080                      *:*                    </span><br><span class="line">LISTEN     0          128                       [::]:22                     [::]:*  </span><br><span class="line"></span><br><span class="line"><span class="comment">#当我本机（10.0.0.180）80端口收到请求后通过REDIRECT转发到我本机的8080端口</span></span><br><span class="line">[root@lanserver2 ~]#iptables -t nat -A PREROUTING -d 10.0.0.180 -p tcp --dport 80 -j REDIRECT --to-ports 8080</span><br><span class="line"></span><br><span class="line">[root@internet ~]#curl 192.168.10.8:81</span><br><span class="line">10.0.0.180</span><br></pre></td></tr></table></figure>

<h2 id="7-5-FORWARD链实现内外网络的流量控制"><a href="#7-5-FORWARD链实现内外网络的流量控制" class="headerlink" title="7.5 FORWARD链实现内外网络的流量控制"></a>7.5 FORWARD链实现内外网络的流量控制</h2><p>范例: 实现内网访问可以访问外网,反之禁止</p>
<p><img src="/Linux/firewall/iptables/1753757575100-d80056f6-c97b-44f8-8fb8-6f923e70a5a2.png" alt="null"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#环境准备</span></span><br><span class="line">[root@internet ~]#hostname -I</span><br><span class="line">192.168.0.6</span><br><span class="line">[root@internet ~]#route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination   Gateway     Genmask     Flags Metric Ref  Use Iface</span><br><span class="line">192.168.0.0   0.0.0.0     255.255.255.0  U   0    0     0 eth0</span><br><span class="line">169.254.0.0   0.0.0.0     255.255.0.0   U   1002  0     0 eth0</span><br><span class="line">0.0.0.0     192.168.0.8   0.0.0.0     UG   0    0     0 eth0</span><br><span class="line"></span><br><span class="line">[root@firewall ~]#hostname -I</span><br><span class="line">10.0.0.8 192.168.0.8</span><br><span class="line">[root@firewall ~]#vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">[root@firewall ~]#sysctl -p</span><br><span class="line"></span><br><span class="line">[root@lanserver1 ~]#hostname -I</span><br><span class="line">10.0.0.7</span><br><span class="line">[root@lanserver1 ~]#route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination   Gateway     Genmask     Flags Metric Ref  Use Iface</span><br><span class="line">0.0.0.0     10.0.0.8     0.0.0.0     UG   100   0     0 eth0</span><br><span class="line">10.0.0.0     0.0.0.0     255.255.255.0  U   100   0     0 eth0</span><br><span class="line"></span><br><span class="line">[root@lanserver2 ~]#hostname -I</span><br><span class="line">10.0.0.17</span><br><span class="line">[root@lanserver2 ~]#route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination   Gateway     Genmask     Flags Metric Ref  Use Iface</span><br><span class="line">0.0.0.0     10.0.0.8     0.0.0.0     UG   100   0     0 eth0</span><br><span class="line">10.0.0.0     0.0.0.0     255.255.255.0  U   100   0     0 eth0</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法1 通过标准模块实现内网访问外网特定服务http和icmp,反之禁止</span></span><br><span class="line">[root@firewall ~]#iptables -A FORWARD -j REJECT</span><br><span class="line">[root@firewall ~]#iptables -I FORWARD -s 10.0.0.0/24 -p tcp --dport 80 -j ACCEPT</span><br><span class="line">[root@firewall ~]#iptables -I FORWARD -d 10.0.0.0/24 -p tcp --sport 80 -j ACCEPT</span><br><span class="line">[root@firewall ~]#iptables -I FORWARD  -s 10.0.0.0/24 -p icmp --icmp-type 8 -j ACCEPT</span><br><span class="line">[root@firewall ~]#iptables -I FORWARD  -d 10.0.0.0/24 -p icmp --icmp-type 0 -j ACCEPT</span><br><span class="line"></span><br><span class="line">[root@firewall ~]#iptables -vnL --line-numbers</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       </span><br><span class="line">destination    </span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       destination    </span><br><span class="line">1    174 14616 ACCEPT   icmp -- *   *    0.0.0.0/0     10.0.0.0/24     icmptype 0</span><br><span class="line">2    218 18312 ACCEPT   icmp -- *   *    10.0.0.0/24    0.0.0.0/0      icmptype 8</span><br><span class="line">3    10  1084 ACCEPT   tcp  -- *   *    0.0.0.0/0     10.0.0.0/24     tcp spt:80</span><br><span class="line">4    31  1938 ACCEPT   tcp  -- *   *    10.0.0.0/24    0.0.0.0/0      tcp dpt:80</span><br><span class="line">5    312 25632 REJECT   all  -- *   *    0.0.0.0/0     0.0.0.0/0      reject-with icmp-port-unreachable</span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       destination    </span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2 利用state模块实现内网访问可以访问外网,反之禁止</span></span><br><span class="line">[root@firewall ~]#iptables -D FORWARD 1</span><br><span class="line">[root@firewall ~]#iptables -D FORWARD 2</span><br><span class="line">[root@firewall ~]#iptables -vnL --line-numbers</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       destination    </span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       destination    </span><br><span class="line">1    342 28728 ACCEPT   icmp -- *   *    10.0.0.0/24    </span><br><span class="line"> 0.0.0.0/0      icmptype 8</span><br><span class="line">2    47  2898 ACCEPT   tcp  -- *   *    10.0.0.0/24    </span><br><span class="line"> 0.0.0.0/0      tcp dpt:80</span><br><span class="line">3    462 37608 REJECT   all  -- *   *    0.0.0.0/0     </span><br><span class="line"> 0.0.0.0/0      reject-with icmp-port-unreachable</span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       destination </span><br><span class="line"></span><br><span class="line">[root@firewall ~]#iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">[root@firewall ~]#iptables -vnL --line-numbers</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       destination    </span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       destination    </span><br><span class="line">1    40  3429 ACCEPT   all  -- *   *    0.0.0.0/0     </span><br><span class="line"> 0.0.0.0/0      state RELATED,ESTABLISHED</span><br><span class="line">2    443 37212 ACCEPT   icmp -- *   *    10.0.0.0/24    </span><br><span class="line"> 0.0.0.0/0      icmptype 8</span><br><span class="line">3    49  3018 ACCEPT   tcp  -- *   *    10.0.0.0/24    </span><br><span class="line"> 0.0.0.0/0      tcp dpt:80</span><br><span class="line">4    563 46068 REJECT   all  -- *   *    0.0.0.0/0     </span><br><span class="line"> 0.0.0.0/0      reject-with icmp-port-unreachable</span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       destination </span><br><span class="line"></span><br><span class="line">[root@lanserver1 ~]#ping 192.168.0.6 -c1</span><br><span class="line">PING 192.168.0.6 (192.168.0.6) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.0.6: icmp_seq=1 ttl=63 <span class="keyword">time</span>=2.20 ms</span><br><span class="line"></span><br><span class="line">[root@lanserver2 ~]#curl 192.168.0.6</span><br><span class="line">internet</span><br><span class="line"></span><br><span class="line">[root@internet ~]#ping 10.0.0.7 -c1</span><br><span class="line">PING 10.0.0.7 (10.0.0.7) 56(84) bytes of data.</span><br><span class="line">From 192.168.0.8 icmp_seq=1 Destination Port Unreachable</span><br><span class="line"></span><br><span class="line">[root@internet ~]#curl 10.0.0.7</span><br><span class="line">curl: (7) couldn<span class="string">&#x27;t connect to host</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#利用state模块实现允许内网可以访问外网所有资源</span></span><br><span class="line"><span class="string">[root@firewall ~]#iptables -D FORWARD 2</span></span><br><span class="line"><span class="string">[root@firewall ~]#iptables -D FORWARD 2</span></span><br><span class="line"><span class="string">[root@firewall ~]#iptables -I FORWARD 2 -s 10.0.0.0/24 -m state --state NEW -j ACCEPT</span></span><br><span class="line"><span class="string">[root@firewall ~]#iptables -vnL --line-numbers</span></span><br><span class="line"><span class="string">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span></span><br><span class="line"><span class="string">num  pkts bytes target   prot opt in   out   source       destination    </span></span><br><span class="line"><span class="string">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span></span><br><span class="line"><span class="string">num  pkts bytes target   prot opt in   out   source       destination    </span></span><br><span class="line"><span class="string">1    134 15209 ACCEPT   all  -- *   *    0.0.0.0/0     </span></span><br><span class="line"><span class="string"> 0.0.0.0/0      state RELATED,ESTABLISHED</span></span><br><span class="line"><span class="string">2     3  204 ACCEPT   all  -- *   *    10.0.0.0/24    </span></span><br><span class="line"><span class="string"> 0.0.0.0/0      state NEW</span></span><br><span class="line"><span class="string"> 3    572 46680 REJECT   all  -- *   *    0.0.0.0/0     </span></span><br><span class="line"><span class="string"> 0.0.0.0/0      reject-with icmp-port-unreachable</span></span><br><span class="line"><span class="string">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span></span><br><span class="line"><span class="string">num  pkts bytes target   prot opt in   out   source       destination  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@lanserver1 ~]#ping 192.168.0.6 -c1</span></span><br><span class="line"><span class="string">PING 192.168.0.6 (192.168.0.6) 56(84) bytes of data.</span></span><br><span class="line"><span class="string">64 bytes from 192.168.0.6: icmp_seq=1 ttl=63 time=2.26 ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@lanserver2 ~]#curl 192.168.0.6</span></span><br><span class="line"><span class="string">internet</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@lanserver2 ~]#ssh 192.168.0.6</span></span><br><span class="line"><span class="string">The authenticity of host &#x27;</span>192.168.0.6 (192.168.0.6)<span class="string">&#x27; can&#x27;</span>t be established.</span><br><span class="line">RSA key fingerprint is SHA256:ldHMw3UFehPuE3bgtMHIX5IxRRTM7fwC4iZ0Qqglcys.</span><br><span class="line">RSA key fingerprint is MD5:8c:44:d9:3d:22:54:62:d8:27:77:d5:06:09:58:76:92.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span> connecting (<span class="built_in">yes</span>/no)?</span><br><span class="line"></span><br><span class="line">[root@internet ~]#curl 10.0.0.7</span><br><span class="line">curl: (7) couldn<span class="string">&#x27;t connect to host</span></span><br><span class="line"><span class="string">[root@internet ~]#ping 10.0.0.7 -c1</span></span><br><span class="line"><span class="string">PING 10.0.0.7 (10.0.0.7) 56(84) bytes of data.</span></span><br><span class="line"><span class="string">From 192.168.0.8 icmp_seq=1 Destination Port Unreachable</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@internet ~]#ssh 10.0.0.7</span></span><br><span class="line"><span class="string">ssh: connect to host 10.0.0.7 port 22: Connection refused</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#允许内网指定主机被外网访问</span></span><br><span class="line"><span class="string">[root@firewall ~]#iptables -I FORWARD 3 -d 10.0.0.7 -p tcp --dport 80 -j ACCEPT</span></span><br><span class="line"><span class="string">[root@firewall ~]#iptables -vnL --line-numbers</span></span><br><span class="line"><span class="string">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span></span><br><span class="line"><span class="string">num  pkts bytes target   prot opt in   out   source       destination    </span></span><br><span class="line"><span class="string">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span></span><br><span class="line"><span class="string">num  pkts bytes target   prot opt in   out   source       destination    </span></span><br><span class="line"><span class="string">1    63 12862 ACCEPT   all  -- *   *    0.0.0.0/0     </span></span><br><span class="line"><span class="string"> 0.0.0.0/0      state RELATED,ESTABLISHED</span></span><br><span class="line"><span class="string">2     9  612 ACCEPT   all  -- *   *    10.0.0.0/24    </span></span><br><span class="line"><span class="string"> 0.0.0.0/0      state NEW</span></span><br><span class="line"><span class="string">3     1   60 ACCEPT   tcp  -- *   *    0.0.0.0/0     </span></span><br><span class="line"><span class="string"> 10.0.0.7       tcp dpt:80</span></span><br><span class="line"><span class="string">4    586 47464 REJECT   all  -- *   *    0.0.0.0/0     </span></span><br><span class="line"><span class="string"> 0.0.0.0/0      reject-with icmp-port-unreachable</span></span><br><span class="line"><span class="string">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span></span><br><span class="line"><span class="string">num  pkts bytes target   prot opt in   out   source       destination </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@internet ~]#curl 10.0.0.7</span></span><br><span class="line"><span class="string">lanserver1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@internet ~]#ping 10.0.0.7 -c1</span></span><br><span class="line"><span class="string">PING 10.0.0.7 (10.0.0.7) 56(84) bytes of data.</span></span><br><span class="line"><span class="string">From 192.168.0.8 icmp_seq=1 Destination Port Unreachable</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@internet ~]#curl 10.0.0.17</span></span><br><span class="line"><span class="string">curl: (7) couldn&#x27;</span>t connect to host</span><br></pre></td></tr></table></figure>

<p>范例：内部可以访问外部，外部禁止访问内部</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@internet-host ~]#hostname -I</span><br><span class="line">10.0.0.6</span><br><span class="line">[root@internet-host ~]#route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination   Gateway     Genmask     Flags Metric Ref  Use Iface</span><br><span class="line">10.0.0.0     0.0.0.0     255.255.255.0  U   1    0     0 eth0</span><br><span class="line">0.0.0.0     10.0.0.8     0.0.0.0     UG   0    0     0 eth0</span><br><span class="line"></span><br><span class="line">[root@firewall-host ~]#hostname -I</span><br><span class="line">10.0.0.8 192.168.100.8</span><br><span class="line">[root@lan-host ~]#hostname -I</span><br><span class="line">192.168.100.7</span><br><span class="line">[root@lan-host ~]#route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination   Gateway     Genmask     Flags Metric Ref  Use Iface</span><br><span class="line">0.0.0.0     192.168.100.8  0.0.0.0     UG   100   0     0 eth0</span><br><span class="line">192.168.100.0  0.0.0.0     255.255.255.0  U   100   0     0 eth0</span><br><span class="line"></span><br><span class="line">[root@firewall-host ~]#vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">[root@firewall-host ~]#sysctl -p</span><br><span class="line">[root@firewall-host ~]#iptables -A FORWARD -d 192.168.100.0/24 -m state --state NEW -j REJECT</span><br></pre></td></tr></table></figure>

<p>范例：针对内部的特定服务可以允许外部访问，其它服务禁止访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@firewall-host ~]#iptables -I FORWARD -d 192.168.100.0/24 -p tcp --dport 80 -j ACCEPT</span><br><span class="line">[root@firewall-host ~]#iptables -vnL FORWARD --line-numbers</span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line">num  pkts bytes target   prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>       destination    </span><br><span class="line">1     6  486 ACCEPT   tcp  -- *   *    0.0.0.0/0     </span><br><span class="line"> 192.168.100.0/24   tcp dpt:80</span><br><span class="line">2     3  228 REJECT   all  -- *   *    0.0.0.0/0     </span><br><span class="line"> 192.168.100.0/24   state NEW reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>

<p>范例：针对内网不能访问外网的某一地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@internet ~]#ip a a 192.168.10.200 dev eth0 label eth0:1</span><br><span class="line">[root@internet ~]#ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:9c:0d:3c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.10.6/24 brd 192.168.10.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.10.200/32 scope global eth0:1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">           </span><br><span class="line">[root@firewall ~]#iptables -A FORWARD -s 10.0.0.0/24 -d 192.168.10.200 -j REJECT</span><br><span class="line"></span><br><span class="line">[root@lanserver1 ~]#curl 192.168.10.6</span><br><span class="line">192.168.10.6 </span><br><span class="line">[root@lanserver1 ~]#curl 192.168.10.200</span><br><span class="line">curl: (7) Failed to connect to 192.168.10.200 port 80: Connection refused</span><br></pre></td></tr></table></figure>

<h1 id="8-综合案例-两个私有网络的互相通迅"><a href="#8-综合案例-两个私有网络的互相通迅" class="headerlink" title="8 综合案例: 两个私有网络的互相通迅"></a>8 综合案例: 两个私有网络的互相通迅</h1><p><img src="/Linux/firewall/iptables/1753757575160-c80d1583-ea5c-46be-83cc-e5ea58892206.png" alt="null"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#192.168.10.6访问172.16.0.7</span></span><br><span class="line">192.168.10.6（SNAT）-10.0.0.18（DNAT）-172.16.0.7</span><br><span class="line"></span><br><span class="line"><span class="comment">#172.16.0.7访问192.168.10.6</span></span><br><span class="line">172.16.0.7（SNAT）-10.0.0.8（DNAT）-192.168.10.6</span><br></pre></td></tr></table></figure>

<h1 id="9-iptables常见操作"><a href="#9-iptables常见操作" class="headerlink" title="9 iptables常见操作"></a>9 iptables常见操作</h1><h2 id="替换系统防火墙"><a href="#替换系统防火墙" class="headerlink" title="替换系统防火墙"></a>替换系统防火墙</h2><p>在Centos7系统中默认防火墙管理工具不是iptables,当需要使用时则需要自己安装替换.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl stop firewalld</span><br><span class="line">[root@localhost ~]# systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# yum install -y iptables iptables-services</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# systemctl restart iptables</span><br><span class="line">[root@localhost ~]# systemctl <span class="built_in">enable</span> iptables</span><br></pre></td></tr></table></figure>

<h2 id="查询完整防火墙规则"><a href="#查询完整防火墙规则" class="headerlink" title="查询完整防火墙规则"></a>查询完整防火墙规则</h2><p>使用 -L -n –line-numbers 参数查看防火墙默认配置规则.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line">[root@localhost ~]# iptables -F                     <span class="comment"># 临时清空规则</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED</span><br><span class="line">2    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">3    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">4    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22</span><br><span class="line">5    REJECT     all  --  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    REJECT     all  --  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure>

<h2 id="设置防火墙默认拒绝"><a href="#设置防火墙默认拒绝" class="headerlink" title="设置防火墙默认拒绝"></a>设置防火墙默认拒绝</h2><p>设置默认拒绝规则，把 INPUT 链设置为默认拒绝,也就是拒绝所有连接请求.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -P INPUT DROP</span><br><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy DROP)       <span class="comment">#这里可以看出INPUT链已变成DROP</span></span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure>

<h2 id="开启防火墙ICMP回显"><a href="#开启防火墙ICMP回显" class="headerlink" title="开启防火墙ICMP回显"></a>开启防火墙ICMP回显</h2><p>在默认规则拒绝的情况下,设置开启ICMP测试,允许主机ping通.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -I INPUT -p icmp -j ACCEPT</span><br><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy DROP)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure>

<h2 id="允许客户SSH远程连接"><a href="#允许客户SSH远程连接" class="headerlink" title="允许客户SSH远程连接"></a>允许客户SSH远程连接</h2><p>在默认拒绝的情况下,设置开启22号端口,允许远程ssh连接到本机.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@localhost ~]# iptables -I OUTPUT -p tcp --sport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp spt:22</span><br></pre></td></tr></table></figure>

<h2 id="删除指定规则"><a href="#删除指定规则" class="headerlink" title="删除指定规则"></a>删除指定规则</h2><p>在默认拒绝的情况下,删除INPUT链,第2条数据,删除ICMP规则.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line">Chain INPUT (policy DROP)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">2    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# iptables -D INPUT 2</span><br><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line">Chain INPUT (policy DROP)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br></pre></td></tr></table></figure>

<h2 id="指定允许网段访问"><a href="#指定允许网段访问" class="headerlink" title="指定允许网段访问"></a>指定允许网段访问</h2><p>在默认拒绝的情况下,设置只允许192.168.1.0&#x2F;24网段的主机访问本机的22号端口.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -I INPUT -s 192.168.1.0/24 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@localhost ~]# iptables -I OUTPUT -s 192.168.1.0/24 -p tcp --sport 22 -j ACCEPT</span><br><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy DROP)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     tcp  --  192.168.1.0/24       0.0.0.0/0            tcp dpt:22</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     tcp  --  192.168.1.0/24       0.0.0.0/0            tcp spt:22</span><br></pre></td></tr></table></figure>

<h2 id="拒绝访问指定端口"><a href="#拒绝访问指定端口" class="headerlink" title="拒绝访问指定端口"></a>拒绝访问指定端口</h2><p>在INPUT规则链中,添加拒绝所有人访问本机的8888号端口.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --dport 8888 -j REJECT</span><br><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line">Chain INPUT (policy DROP)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    REJECT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:8888 reject-with icmp-port-unreachable</span><br><span class="line">2    ACCEPT     tcp  --  192.168.1.0/24       0.0.0.0/0            tcp dpt:22</span><br></pre></td></tr></table></figure>

<h2 id="拒绝访问指定主机网段的端口"><a href="#拒绝访问指定主机网段的端口" class="headerlink" title="拒绝访问指定主机网段的端口"></a>拒绝访问指定主机网段的端口</h2><p>在INPUT规则链中,添加拒绝192.168.1.20主机访问本机的80端口.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp -s 192.168.1.20 --dport 80 -j REJECT</span><br><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy DROP)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    REJECT     tcp  --  192.168.1.20         0.0.0.0/0            tcp dpt:80 reject-with icmp-port-unreachable</span><br><span class="line">2    REJECT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:8888 reject-with icmp-port-unreachable</span><br><span class="line">3    ACCEPT     tcp  --  192.168.1.0/24       0.0.0.0/0            tcp dpt:22</span><br></pre></td></tr></table></figure>

<h2 id="拒绝访问指定端口范围"><a href="#拒绝访问指定端口范围" class="headerlink" title="拒绝访问指定端口范围"></a>拒绝访问指定端口范围</h2><p>在INPUT规则链中,添加拒绝所有主机访问本机1000-2000端口.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -A INPUT -p tcp --dport 1000:2000 -j REJECT</span><br><span class="line">[root@localhost ~]# iptables -A INPUT -p udp --dport 1000:2000 -j REJECT</span><br><span class="line">[root@localhost ~]# iptables -L -n --line-numbers</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy DROP)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    REJECT     tcp  --  192.168.1.20         0.0.0.0/0            tcp dpt:80 reject-with icmp-port-unreachable</span><br><span class="line">2    REJECT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:8888 reject-with icmp-port-unreachable</span><br><span class="line">3    ACCEPT     tcp  --  192.168.1.0/24       0.0.0.0/0            tcp dpt:22</span><br><span class="line">4    REJECT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpts:1000:2000 reject-with icmp-port-unreachable</span><br><span class="line">5    REJECT     udp  --  0.0.0.0/0            0.0.0.0/0            udp dpts:1000:2000 reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>

<h2 id="SNAT-源地址转换"><a href="#SNAT-源地址转换" class="headerlink" title="SNAT-源地址转换&lt;内网映射到公网&gt;"></a>SNAT-源地址转换&lt;内网映射到公网&gt;</h2><p>从本地发出的数据包,经过SNAT后,会自动伪装成公网的IP,并以公网IP访问指定服务.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例：将本地 192.168.1.1 的请求自动伪装成外网地址 59.110.167.234</span></span><br><span class="line">[root@localhost ~]# iptables -t nat -A POSTROUTING -o ens32 -s 192.168.1.1 -j SNAT --to-source 59.110.167.234</span><br><span class="line"></span><br><span class="line">  -o                  <span class="comment">#指定外网接口,此处为ens32</span></span><br><span class="line">  -s                  <span class="comment">#指定内网口地址,此处为192.168.1.1</span></span><br><span class="line">  --to-source         <span class="comment">#外网口的地址</span></span><br></pre></td></tr></table></figure>

<h2 id="DNAT-目标地址转换"><a href="#DNAT-目标地址转换" class="headerlink" title="DNAT-目标地址转换&lt;公网映射到内网&gt;"></a>DNAT-目标地址转换&lt;公网映射到内网&gt;</h2><p>从公网接收的数据包,经过DNAT后,会自动将数据包转到指定的内网主机.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#例：将请求 59.110.167.234 且端口为 80 的数据包,自动映射到内网 192.168.1.10</span></span><br><span class="line">[root@localhost ~]# iptables -t nat -A PREROUTING -i ens32 -d 59.110.167.234 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10</span><br><span class="line"></span><br><span class="line">  --to-destination     <span class="comment">#内网口地址,此处为192.168.1.1</span></span><br><span class="line">  -i                   <span class="comment">#绑定外网接口,此处为ens32</span></span><br><span class="line">  -d                   <span class="comment">#外网地址,此处为8.8.8.8</span></span><br><span class="line">  -dport               <span class="comment">#内网端口,此处为80</span></span><br></pre></td></tr></table></figure>

<h2 id="限制物理请求连接数"><a href="#限制物理请求连接数" class="headerlink" title="限制物理请求连接数"></a>限制物理请求连接数</h2><p>iptables可以利用connlimit模块实现限制同一IP针对某个端口的连接数. 允许限制每个客户端IP的并发连接数,即每个IP同时连接到一个服务器个数,还可以限制内网用户的网络使用,对服务器而言则可以限制每个IP发起的连接数.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制同一IP同时最多100个http连接</span></span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --syn --dport 80 -m connlimit --connlimit-above 100 -j REJECT</span><br><span class="line">[root@localhost ~]# iptables -I INPUT -p tcp --syn --dport 80 -m connlimit ! --connlimit-above 100 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只允许每组C类IP同时100个http连接</span></span><br><span class="line">[root@localhost ~]# iptables -p tcp --syn --dport 80 -m connlimit --connlimit-above 100 --connlimit-mask 24 -j REJECT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只允许每个IP同时5个80端口转发,超过的丢弃</span></span><br><span class="line">[root@localhost ~]# iptables -I FORWARD -p tcp --syn --dport 80 -m connlimit --connlimit-above 5 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制某IP最多同时100个http连接</span></span><br><span class="line">[root@localhost ~]# iptables -A INPUT -s 192.168.1.100 -p tcp --syn --dport 80 -m connlimit --connlimit-above 100 -j REJECT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制每IP在一定的时间(比如60秒)内允许新建立最多100个http连接数</span></span><br><span class="line">[root@localhost ~]# iptables -A INPUT -p tcp --dport 80 -m recent --name BAD_HTTP_ACCESS --update --seconds 60 --hitcount 100 -j REJECT</span><br><span class="line">[root@localhost ~]# iptables -A INPUT -p tcp --dport 80 -m recent --name BAD_HTTP_ACCESS --<span class="built_in">set</span> -j ACCEPT</span><br></pre></td></tr></table></figure>

<h2 id="配置基本防火墙规则"><a href="#配置基本防火墙规则" class="headerlink" title="配置基本防火墙规则"></a>配置基本防火墙规则</h2><p>我们可以在新安装的系统中依次执行下方代码,来配置一个基本的防火墙规则.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除已有规则</span></span><br><span class="line">iptables --delete-chain</span><br><span class="line">iptables --flush</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认禁止进,允许出,允许回环网卡</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许已建立的或相关连接的通行</span></span><br><span class="line">iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制80端口443端口的单个IP的最大连接数为10</span></span><br><span class="line">iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 10 -j DROP</span><br><span class="line">iptables -I INPUT -p tcp --dport 443 -m connlimit --connlimit-above 10 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许80(HTTP)/873(RSYNC)/443(HTTPS)/20,21(FTP)/25(SMTP)端口的连接</span></span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 80 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 20 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 21 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 25 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 443 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 873 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许SSH端口的连接,放行SSH端口</span></span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许ping</span></span><br><span class="line">iptables -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT </span><br><span class="line">iptables -A INPUT -p icmp -m icmp --icmp-type 11 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 放行允许DNS解析端口</span></span><br><span class="line">iptables -A OUTPUT -p udp -m udp -d 8.8.8.8 --dport 53 -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -p udp -m udp -d 114.114.114.114 --dport 53 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存规则</span></span><br><span class="line">iptables-save</span><br></pre></td></tr></table></figure>

<h2 id="生产常用配置规则"><a href="#生产常用配置规则" class="headerlink" title="生产常用配置规则"></a>生产常用配置规则</h2><p>下面是收藏的一些生成环境下常用规则的配置,一般情况下配置这些规则足够使用.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -P INPUT DROP                           <span class="comment">#设置默认规则,拒绝所有</span></span><br><span class="line">iptables -t filter -A INPUT -p tcp --dport 80 -j ACCEPT    <span class="comment">#放行80口</span></span><br><span class="line">iptables -t filter -A INPUT -p tcp --dport 443 -j ACCEPT   <span class="comment">#放行22口</span></span><br><span class="line">iptables -t filter -A INPUT -p tcp --dport 22 -j ACCEPT    <span class="comment">#放行22口</span></span><br><span class="line"></span><br><span class="line">iptables -t filter -A INPUT -p tcp --dport 80 -j ACCEPT    <span class="comment">#放行80端口</span></span><br><span class="line">iptables -t filter -I INPUT -p tcp --dport 443-j ACCEPT    <span class="comment">#插入在顶端一条放行443端口的规则</span></span><br><span class="line">iptables -t filter -I INPUT 2 -p tcp --dport 443 -j ACCEPT <span class="comment">#在第二列插入一条443放行规则</span></span><br><span class="line">iptables -t filter -A INPUT -p tcp --dport 80 -j DROP      <span class="comment">#丢弃80端口的请求</span></span><br><span class="line">iptables -I INPUT 2 -p icmp -j DROP                        <span class="comment">#丢弃ICMP请求</span></span><br><span class="line">iptables -t filter -D INPUT 3                              <span class="comment">#删除第三条规则</span></span><br><span class="line"></span><br><span class="line">iptables -A FORWARD -s 192.168.1.10 -j REJECT              <span class="comment">#拒绝IP的转发请求</span></span><br><span class="line">iptables -I INPUT -s 10.20.30.0/24 -j DROP                 <span class="comment">#丢弃IP网段的入站请求</span></span><br><span class="line">iptables -A INPUT -i eth1 -s 192.168.0.0/16 -j DROP        <span class="comment">#丢弃从eth1网卡流入,且地址匹配的数据包</span></span><br><span class="line">iptables -A INPUT -o eth0 -s 192.168.1.0/24 -j DROP        <span class="comment">#丢弃从eth0网卡流出,且地址匹配的数据包</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 20:21 -j ACCEPT           <span class="comment">#放行20-21端口的数据包</span></span><br><span class="line"></span><br><span class="line">iptables -I INPUT -p tcp -m multiport --dport 80-90,85 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p tcp -m iprange --src-range 192.168.1.10-192.168.1.100 -j ACCEPT</span><br></pre></td></tr></table></figure>

<h2 id="防止常见网络攻击"><a href="#防止常见网络攻击" class="headerlink" title="防止常见网络攻击"></a>防止常见网络攻击</h2><p>什么是syn，ddos，ping</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SYN (Synchronize)：</span><br><span class="line">在 TCP（传输控制协议）中，SYN 是握手过程的一部分。当客户端尝试与服务器建立连接时，它发送一个带有 SYN 标志的数据包。服务器收到 SYN 数据包后，通常会回复一个带有 SYN 和 ACK（确认）标志的数据包，表示接受连接。最后，客户端再发送一个带有 ACK 标志的数据包，表示握手完成。这个过程通常称为三次握手。</span><br><span class="line"></span><br><span class="line">DDoS (Distributed Denial of Service)：</span><br><span class="line">DDoS 攻击是一种网络攻击，通过在短时间内向目标服务器发送大量的请求，使其超负荷，无法正常响应合法用户的请求。这些请求可以是来自多个分布式计算机的，使得攻击者能够利用分布式网络资源来发动攻击，使攻击更难以阻止。</span><br></pre></td></tr></table></figure>

<p>配置防火墙防止syn，ddos攻击</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysconfig/iptables</span></span><br><span class="line">在iptables中加入下面几行</span><br><span class="line"><span class="comment">#anti syn，ddos</span></span><br><span class="line">-A FORWARD -p tcp --syn -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s --limit-burst 5 -j ACCEPT</span><br><span class="line">-A FORWARD -p tcp --tcp-flags SYN,ACK,FIN,RST RST -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s -j ACCEPT</span><br><span class="line">-A FORWARD -p icmp --icmp-type echo-request -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>说明：第一行：每秒中最多允许5个新连接</p>
<p>第二行：防止各种端口扫描</p>
<p>第三行：Ping洪水攻击（Ping of Death），可以根据需要调整或关闭</p>
<p>重启防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/init.d/iptables restart</span></span><br></pre></td></tr></table></figure>

<p>屏蔽一个IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iptables -I INPUT -s 192.168.0.1 -j DROP</span></span><br></pre></td></tr></table></figure>

<p>怎么防止别人ping我</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iptables -A INPUT -p icmp -j DROP</span></span><br></pre></td></tr></table></figure>

<p>防止同步包洪水（Sync Flood）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iptables -A FORWARD -p tcp --syn -m limit --limit 1/s -j ACCEPT</span></span><br></pre></td></tr></table></figure>

<p>防止各种端口扫描</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iptables -A FORWARD -p tcp --tcp-flags SYN,ACK,FIN,RST RST -m limit --limit 1/s -j ACCEPT</span></span><br></pre></td></tr></table></figure>

<p>Ping洪水攻击（Ping of Death）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iptables -A FORWARD -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT</span></span><br><span class="line">NMAP FIN/URG/PSH</span><br><span class="line"><span class="comment"># iptables -A INPUT -i eth0 -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP</span></span><br><span class="line"></span><br><span class="line">Xmas Tree</span><br><span class="line"><span class="comment"># iptables -A INPUT -i eth0 -p tcp --tcp-flags ALL ALL -j DROP</span></span><br><span class="line"></span><br><span class="line">Another Xmas Tree</span><br><span class="line"><span class="comment"># iptables -A INPUT -i eth0 -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP</span></span><br><span class="line"></span><br><span class="line">Null Scan(possibly)</span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --tcp-flags ALL NONE -j DROP</span><br><span class="line"></span><br><span class="line">SYN/RST</span><br><span class="line"><span class="comment"># iptables -A INPUT -i eth0 -p tcp --tcp-flags SYN,RST SYN,RST -j DROP</span></span><br><span class="line"></span><br><span class="line">SYN/FIN -- Scan(possibly)</span><br><span class="line"><span class="comment"># iptables -A INPUT -i eth0 -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP</span></span><br></pre></td></tr></table></figure>

<p>限制对内部封包的发送速度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iptables -A INPUT -f -m limit --limit 100/s --limit-burst 100 -j ACCEPT  </span></span><br></pre></td></tr></table></figure>

<p>限制建立联机的转发</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iptables -A FORWARD -f -m limit --limit 100/s --limit-burst 100 -j ACCEPT</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://AquaPluto.github.io">Aquarius</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://aquapluto.github.io/Linux/firewall/iptables/">https://aquapluto.github.io/Linux/firewall/iptables/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://AquaPluto.github.io" target="_blank">代码推演录</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%98%B2%E7%81%AB%E5%A2%99/">防火墙</a></div><div class="post-share"><div class="social-share" data-image="/img/paper1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/Linux/firewall/firewalld/" title="firewalld"><img class="cover" src="/img/paper5.png" onerror="onerror=null;src='/img/error-page.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">firewalld</div></div><div class="info-2"><div class="info-item-1">1 firewalld介绍fire...</div></div></div></a><a class="pagination-related" href="/Linux/firewall/introduce/" title="安全技术和防火墙"><img class="cover" src="/img/paper6.png" onerror="onerror=null;src='/img/error-page.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">安全技术和防火墙</div></div><div class="info-2"><div class="info-item-1">1 安全技术和防火墙1.1 安全技...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/Linux/firewall/firewalld/" title="firewalld"><img class="cover" src="/img/paper5.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-21</div><div class="info-item-2">firewalld</div></div><div class="info-2"><div class="info-item-1">1 firewalld介绍fire...</div></div></div></a><a class="pagination-related" href="/Linux/firewall/introduce/" title="安全技术和防火墙"><img class="cover" src="/img/paper6.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-21</div><div class="info-item-2">安全技术和防火墙</div></div><div class="info-2"><div class="info-item-1">1 安全技术和防火墙1.1 安全技...</div></div></div></a><a class="pagination-related" href="/Linux/firewall/nft/" title="nft"><img class="cover" src="/img/paper3.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-21</div><div class="info-item-2">nft</div></div><div class="info-2"><div class="info-item-1">1 nft介绍nftables 是...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Aquarius</div><div class="author-info-description">分享运维开发相关技术</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/AquaPluto"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/AquaPluto" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://blog.csdn.net/m0_75233142" target="_blank" title="CSDN"><i class="fa-solid fa-code" style="color: #8a2be2;"></i></a><a class="social-icon" href="mailto:wujunlinq@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><p>持续更新文章中，有问题请添加wx</p>
<div>
  <img src="/img/wx.jpg" alt="wx" style="width: 100px">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-iptables%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-text">1 iptables的组成</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-iptables%E8%A7%84%E5%88%99%E8%AF%B4%E6%98%8E"><span class="toc-text">2 iptables规则说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-iptables%E8%A7%84%E5%88%99%E7%BB%84%E6%88%90"><span class="toc-text">2.1 iptables规则组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-iptables%E8%A7%84%E5%88%99%E6%B7%BB%E5%8A%A0%E6%97%B6%E8%80%83%E9%87%8F%E7%82%B9"><span class="toc-text">2.2 iptables规则添加时考量点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%9C%AC%E7%AB%A0%E5%AD%A6%E4%B9%A0%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">2.3 本章学习环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E8%A7%84%E5%88%99%E8%AF%B4%E6%98%8E"><span class="toc-text">2.4 规则说明</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-iptables%E7%94%A8%E6%B3%95%E8%AF%B4%E6%98%8E"><span class="toc-text">3 iptables用法说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-table"><span class="toc-text">3.1 table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-COMMAND"><span class="toc-text">3.2 COMMAND</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E9%93%BE%E7%AE%A1%E7%90%86%E7%B1%BB"><span class="toc-text">3.2.1 链管理类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-%E6%9F%A5%E7%9C%8B%E7%B1%BB"><span class="toc-text">3.2.2 查看类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E8%A7%84%E5%88%99%E7%AE%A1%E7%90%86%E7%B1%BB"><span class="toc-text">3.2.3 规则管理类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-chain"><span class="toc-text">3.3 chain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-parameter%E5%8C%B9%E9%85%8D%E6%9D%A1%E4%BB%B6"><span class="toc-text">3.4 parameter匹配条件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E5%9F%BA%E6%9C%AC%E5%8C%B9%E9%85%8D%E6%9D%A1%E4%BB%B6"><span class="toc-text">3.4.1 基本匹配条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E6%89%A9%E5%B1%95%E5%8C%B9%E9%85%8D%E6%9D%A1%E4%BB%B6"><span class="toc-text">3.4.2 扩展匹配条件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-2-1-%E9%9A%90%E5%BC%8F%E6%89%A9%E5%B1%95"><span class="toc-text">3.4.2.1 隐式扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-1-1-tcp%E5%8D%8F%E8%AE%AE"><span class="toc-text">3.4.2.1.1 tcp协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-1-2-udp%E5%8D%8F%E8%AE%AE"><span class="toc-text">3.4.2.1.2 udp协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-1-3-icmp%E5%8D%8F%E8%AE%AE"><span class="toc-text">3.4.2.1.3 icmp协议</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-2-2-%E6%98%BE%E5%BC%8F%E6%89%A9%E5%B1%95%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9D%97"><span class="toc-text">3.4.2.2 显式扩展及相关模块</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-2-1-multiport%E6%89%A9%E5%B1%95"><span class="toc-text">3.4.2.2.1 multiport扩展</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-2-2-iprange%E6%89%A9%E5%B1%95"><span class="toc-text">3.4.2.2.2 iprange扩展</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-2-3-mac%E6%89%A9%E5%B1%95"><span class="toc-text">3.4.2.2.3 mac扩展</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-2-4-string%E6%89%A9%E5%B1%95"><span class="toc-text">3.4.2.2.4 string扩展</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-2-5-time%E6%89%A9%E5%B1%95"><span class="toc-text">3.4.2.2.5 time扩展</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-2-6-connlimit%E6%89%A9%E5%B1%95"><span class="toc-text">3.4.2.2.6 connlimit扩展</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-2-7-limit%E6%89%A9%E5%B1%95"><span class="toc-text">3.4.2.2.7 limit扩展</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-2-8-state%E6%89%A9%E5%B1%95"><span class="toc-text">3.4.2.2.8 state扩展</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-Target%E5%A4%84%E7%90%86%E5%8A%A8%E4%BD%9C"><span class="toc-text">3.5 Target处理动作</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-iptables%E8%87%AA%E5%AE%9A%E4%B9%89%E9%93%BE"><span class="toc-text">4 iptables自定义链</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E8%A7%84%E5%88%99%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">5 规则优化最佳实践</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-iptables%E8%A7%84%E5%88%99%E4%BF%9D%E5%AD%98"><span class="toc-text">6 iptables规则保存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%8C%81%E4%B9%85%E4%BF%9D%E5%AD%98%E8%A7%84%E5%88%99"><span class="toc-text">6.1 持久保存规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%8A%A0%E8%BD%BD%E8%A7%84%E5%88%99"><span class="toc-text">6.2 加载规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E5%BC%80%E6%9C%BA%E8%87%AA%E5%8A%A8%E9%87%8D%E8%BD%BD%E8%A7%84%E5%88%99"><span class="toc-text">6.3 开机自动重载规则</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E7%BD%91%E7%BB%9C%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-text">7 网络防火墙</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-NAT%E8%A1%A8"><span class="toc-text">7.1 NAT表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-SNAT"><span class="toc-text">7.2 SNAT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-DNAT"><span class="toc-text">7.3 DNAT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-REDIRECT%E8%BD%AC%E5%8F%91"><span class="toc-text">7.4 REDIRECT转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-FORWARD%E9%93%BE%E5%AE%9E%E7%8E%B0%E5%86%85%E5%A4%96%E7%BD%91%E7%BB%9C%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-text">7.5 FORWARD链实现内外网络的流量控制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B-%E4%B8%A4%E4%B8%AA%E7%A7%81%E6%9C%89%E7%BD%91%E7%BB%9C%E7%9A%84%E4%BA%92%E7%9B%B8%E9%80%9A%E8%BF%85"><span class="toc-text">8 综合案例: 两个私有网络的互相通迅</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-iptables%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C"><span class="toc-text">9 iptables常见操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-text">替换系统防火墙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%AE%8C%E6%95%B4%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99"><span class="toc-text">查询完整防火墙规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E9%BB%98%E8%AE%A4%E6%8B%92%E7%BB%9D"><span class="toc-text">设置防火墙默认拒绝</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E9%98%B2%E7%81%AB%E5%A2%99ICMP%E5%9B%9E%E6%98%BE"><span class="toc-text">开启防火墙ICMP回显</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%81%E8%AE%B8%E5%AE%A2%E6%88%B7SSH%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5"><span class="toc-text">允许客户SSH远程连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%8C%87%E5%AE%9A%E8%A7%84%E5%88%99"><span class="toc-text">删除指定规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%85%81%E8%AE%B8%E7%BD%91%E6%AE%B5%E8%AE%BF%E9%97%AE"><span class="toc-text">指定允许网段访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%92%E7%BB%9D%E8%AE%BF%E9%97%AE%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3"><span class="toc-text">拒绝访问指定端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%92%E7%BB%9D%E8%AE%BF%E9%97%AE%E6%8C%87%E5%AE%9A%E4%B8%BB%E6%9C%BA%E7%BD%91%E6%AE%B5%E7%9A%84%E7%AB%AF%E5%8F%A3"><span class="toc-text">拒绝访问指定主机网段的端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%92%E7%BB%9D%E8%AE%BF%E9%97%AE%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3%E8%8C%83%E5%9B%B4"><span class="toc-text">拒绝访问指定端口范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SNAT-%E6%BA%90%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2"><span class="toc-text">SNAT-源地址转换&lt;内网映射到公网&gt;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNAT-%E7%9B%AE%E6%A0%87%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2"><span class="toc-text">DNAT-目标地址转换&lt;公网映射到内网&gt;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E7%89%A9%E7%90%86%E8%AF%B7%E6%B1%82%E8%BF%9E%E6%8E%A5%E6%95%B0"><span class="toc-text">限制物理请求连接数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%9F%BA%E6%9C%AC%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99"><span class="toc-text">配置基本防火墙规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99"><span class="toc-text">生产常用配置规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E6%AD%A2%E5%B8%B8%E8%A7%81%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB"><span class="toc-text">防止常见网络攻击</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/role/" title="role"><img src="/img/paper6.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="role"/></a><div class="content"><a class="title" href="/CICD/ansible/role/" title="role">role</a><time datetime="2025-08-27T10:49:36.000Z" title="发表于 2025-08-27 18:49">2025-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/playbook/" title="playbook"><img src="/img/paper3.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="playbook"/></a><div class="content"><a class="title" href="/CICD/ansible/playbook/" title="playbook">playbook</a><time datetime="2025-08-27T10:49:30.000Z" title="发表于 2025-08-27 18:49">2025-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/module/" title="module"><img src="/img/paper4.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="module"/></a><div class="content"><a class="title" href="/CICD/ansible/module/" title="module">module</a><time datetime="2025-08-27T10:49:25.000Z" title="发表于 2025-08-27 18:49">2025-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/command/" title="command"><img src="/img/paper1.jpg" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="command"/></a><div class="content"><a class="title" href="/CICD/ansible/command/" title="command">command</a><time datetime="2025-08-27T10:49:19.000Z" title="发表于 2025-08-27 18:49">2025-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/deploy/" title="deploy"><img src="/img/paper6.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="deploy"/></a><div class="content"><a class="title" href="/CICD/ansible/deploy/" title="deploy">deploy</a><time datetime="2025-08-27T10:49:09.000Z" title="发表于 2025-08-27 18:49">2025-08-27</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Aquarius</span></div><div class="footer_custom_text"><style>
div#runtime {
  font-size: 13px;
  font-weight: bold;
}

div#ghbdages_list {
  height: 1.5rem;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 10px
}

.github-badge {
  display: flex;
  align-items: center;
  margin-inline: 6px;
}
</style>
<div id="runtime"></div>
<div id="ghbdages"></div>
<script>
  function createtime() {
    const now = new Date();
    const grt = new Date("08/01/2025 00:00:00"); // 网站诞生时间

    // 计算天、小时、分钟和秒
    const days = Math.floor((now - grt) / (1000 * 60 * 60 * 24));
    const hours = Math.floor(((now - grt) / (1000 * 60 * 60)) % 24)
      .toString()
      .padStart(2, "0");
    const minutes = Math.floor(((now - grt) / (1000 * 60)) % 60)
      .toString()
      .padStart(2, "0");
    const seconds = Math.floor(((now - grt) / 1000) % 60)
      .toString()
      .padStart(2, "0");

    // HTML 输出
    const currentTimeHtml = `
          <div>
              本站已运行 ${days} 天 ${hours} 小时 ${minutes} 分 ${seconds} 秒 
          </div>`;

    const runtime = document.getElementById("runtime");
    if (runtime) runtime.innerHTML = currentTimeHtml;
  }

  // 设置每秒调用函数
  setInterval(createtime, 1000);

  function renderBadge() {
    const currentTimeHtml = `
      <div id="ghbdages_list">
          <a class="github-badge" target="_blank" href="https://hexo.io/" title="hexo:7.3.0">
              <img src="https://img.shields.io/badge/Frame-Hexo-blue?logo=hexo" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://github.com/" title="github">
              <img src="https://img.shields.io/badge/Code-GitHub-181717?logo=GitHub&color=%23FF7102" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://vercel.com/" title="vercel">
              <img src="https://img.shields.io/badge/Host-Vercel-%23F0D722?logo=Vercel" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://analytics.sysio.ai/" title="umami">
              <img src="https://img.shields.io/badge/Analytics-Umami-%237FB100?logo=umami&logoColor=%237FB100" alt="Static Badge">
          </a>
      </div>`;

    const ghbdages = document.getElementById("ghbdages");
    if (ghbdages) {
      ghbdages.innerHTML = currentTimeHtml;
    }
  }

  window.onload = renderBadge;
</script>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/instant.page/instantpage.js" type="module"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://unpkg.com/mathjax/es5/tex-mml-chtml.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><script src="https://cdn.jsdelivr.net/gh/xiabo2/CDN@latest/fishes.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://unpkg.com/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章..." type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>