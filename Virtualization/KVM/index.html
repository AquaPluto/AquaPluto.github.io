<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>KVM | 代码推演录</title><meta name="author" content="Aquarius"><meta name="copyright" content="Aquarius"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="1 虚拟化基础1.1 传统的物理机部署方案  IDC选择,如:联通,电信,世纪互联,鹏博士等 网络和存储规划 服务器选型及采购 服务器系统选择、系统安装、上架、配置网络 应用规划及部署 域名选择及注册,DNS配置名称解析 测试外网访问  传统数据中心面临的问题：  服务器和网络设备资源利用率过低，并且无法共享,导致资源浪费  据统计大部分数据中心中的服务器和网络设备的利用率仅在24%～30%之间，">
<meta property="og:type" content="article">
<meta property="og:title" content="KVM">
<meta property="og:url" content="https://aquapluto.github.io/Virtualization/KVM/">
<meta property="og:site_name" content="代码推演录">
<meta property="og:description" content="1 虚拟化基础1.1 传统的物理机部署方案  IDC选择,如:联通,电信,世纪互联,鹏博士等 网络和存储规划 服务器选型及采购 服务器系统选择、系统安装、上架、配置网络 应用规划及部署 域名选择及注册,DNS配置名称解析 测试外网访问  传统数据中心面临的问题：  服务器和网络设备资源利用率过低，并且无法共享,导致资源浪费  据统计大部分数据中心中的服务器和网络设备的利用率仅在24%～30%之间，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://aquapluto.github.io/img/paper5.png">
<meta property="article:published_time" content="2025-09-12T04:37:55.000Z">
<meta property="article:modified_time" content="2025-09-13T13:55:56.814Z">
<meta property="article:author" content="Aquarius">
<meta property="article:tag" content="linux,Python,Django,Docker,Kubernetes,Prometheus,Ansible">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aquapluto.github.io/img/paper5.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "KVM",
  "url": "https://aquapluto.github.io/Virtualization/KVM/",
  "image": "https://aquapluto.github.io/img/paper5.png",
  "datePublished": "2025-09-12T04:37:55.000Z",
  "dateModified": "2025-09-13T13:55:56.814Z",
  "author": [
    {
      "@type": "Person",
      "name": "Aquarius",
      "url": "https://AquaPluto.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://aquapluto.github.io/Virtualization/KVM/"><link rel="preconnect" href="//unpkg.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://unpkg.com/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'KVM',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/wave.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">138</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/software-manage/"><span>软件包管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/OOM/"><span>OOM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/swap/"><span>Swap分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/data-synchronization/"><span>数据的实时同步</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/mail/"><span>邮件服务</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/kernel-manage/"><span>内核和启动管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-lock/"><span>进程锁</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/queue/"><span>队列实现线程并发控制</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/MySQL/SQL/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/Redis/deploy/"><span>部署安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Tomcat/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>存储</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/conspect/"><span>存储概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/nfs/"><span>NFS</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/conspect/"><span>Docker概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/image/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/container/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/volume/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/network/"><span>网络管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/compose/"><span>Docker-Compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/conspect/"><span>镜像概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/dockerfile/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/build/"><span>构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/harbor/"><span>镜像仓库</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/management/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-cgroup/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-usage/"><span>监控容器真实的cpu使用率</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/containerd/"><span>Containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>K8s</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kubernetes概论</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/architecture/"><span>Kubernetes架构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/cri/"><span>容器运行时接口CRI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/list-watch/"><span>List-Watch机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/object/"><span>Kubernetes对象</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/namespace/"><span>Namespace</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/kubectl/"><span>kubectl命令</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>部署安装</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/explanation/"><span>部署说明</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/docker/"><span>基于docker部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/containerd/"><span>基于containerd部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/cluster/"><span>集群管理指南</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Pod</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/conspect/"><span>Pod概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/configuration/"><span>Pod的配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/schedule/"><span>Pod的调度</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/eviction/"><span>Pod的驱逐</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>控制器</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/introduce/"><span>控制器介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/deployment/"><span>Deployment</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/statefulset/"><span>StatefulSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/daemonset/"><span>DaemonSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/job-cronjob/"><span>Job和CronJob</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/HPA/"><span>HPA</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/operator/"><span>Operator</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务发现与负载均衡</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/service/"><span>Service</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/ingress/"><span>Ingress</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/coredns/"><span>CoreDNS</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/localdns/"><span>LocalDNS</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>数据存储持久化</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/csi/"><span>存储接口CSI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/pv-pvc/"><span>PV和PVC</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/storageclass/"><span>StorageClass</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/configmap-secret/"><span>ConfigMap和Secret</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>认证与鉴权体系</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/conspect/"><span>体系概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/kubeconfig/"><span>kubeconfig</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/user-account/"><span>User Account</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/service-account/"><span>Service Account</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/introduce/"><span>prometheus概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/query-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/indicators-remarked/"><span>指标重新打标</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/pushmanager/"><span>Pushmanager</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/cluster-ha/"><span>集群与高可用</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/ha/"><span>高可用架构</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/grafana/"><span>Grafana</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/streaming/"><span>基于流处理的可观测性架构</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/paper5.png);"><nav id="nav"><!-- 左侧博客信息区域--><span id="blog-info"><a class="nav-site-title" href="/"></a><a class="nav-page-title" href="/"><span class="site-name">KVM</span></a></span><!-- 新增的导航菜单容器（居中布局关键）--><div id="nav-menus-container"><!-- 菜单主体部分--><div id="menus"><!-- 菜单项--><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/software-manage/"><span>软件包管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/OOM/"><span>OOM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/swap/"><span>Swap分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/data-synchronization/"><span>数据的实时同步</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/mail/"><span>邮件服务</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/kernel-manage/"><span>内核和启动管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-lock/"><span>进程锁</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/queue/"><span>队列实现线程并发控制</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/MySQL/SQL/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/Redis/deploy/"><span>部署安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Tomcat/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>存储</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/conspect/"><span>存储概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/nfs/"><span>NFS</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/conspect/"><span>Docker概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/image/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/container/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/volume/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/network/"><span>网络管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/compose/"><span>Docker-Compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/conspect/"><span>镜像概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/dockerfile/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/build/"><span>构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/harbor/"><span>镜像仓库</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/management/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-cgroup/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-usage/"><span>监控容器真实的cpu使用率</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/containerd/"><span>Containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>K8s</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kubernetes概论</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/architecture/"><span>Kubernetes架构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/cri/"><span>容器运行时接口CRI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/list-watch/"><span>List-Watch机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/object/"><span>Kubernetes对象</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/namespace/"><span>Namespace</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/kubectl/"><span>kubectl命令</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>部署安装</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/explanation/"><span>部署说明</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/docker/"><span>基于docker部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/containerd/"><span>基于containerd部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/cluster/"><span>集群管理指南</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Pod</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/conspect/"><span>Pod概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/configuration/"><span>Pod的配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/schedule/"><span>Pod的调度</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/eviction/"><span>Pod的驱逐</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>控制器</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/introduce/"><span>控制器介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/deployment/"><span>Deployment</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/statefulset/"><span>StatefulSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/daemonset/"><span>DaemonSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/job-cronjob/"><span>Job和CronJob</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/HPA/"><span>HPA</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/operator/"><span>Operator</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务发现与负载均衡</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/service/"><span>Service</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/ingress/"><span>Ingress</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/coredns/"><span>CoreDNS</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/localdns/"><span>LocalDNS</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>数据存储持久化</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/csi/"><span>存储接口CSI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/pv-pvc/"><span>PV和PVC</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/storageclass/"><span>StorageClass</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/configmap-secret/"><span>ConfigMap和Secret</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>认证与鉴权体系</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/conspect/"><span>体系概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/kubeconfig/"><span>kubeconfig</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/user-account/"><span>User Account</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/service-account/"><span>Service Account</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/introduce/"><span>prometheus概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/query-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/indicators-remarked/"><span>指标重新打标</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/pushmanager/"><span>Pushmanager</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/cluster-ha/"><span>集群与高可用</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/ha/"><span>高可用架构</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/grafana/"><span>Grafana</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/streaming/"><span>基于流处理的可观测性架构</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><!-- 右侧功能区域（新增容器）--><div id="nav-right-container"><!-- 搜索按钮（移动到右侧）--><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></span></div><!-- 移动端汉堡菜单按钮--><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">KVM</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-12T04:37:55.000Z" title="发表于 2025-09-12 12:37">2025-09-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-13T13:55:56.814Z" title="更新于 2025-09-13 21:55">2025-09-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">22.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>97分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1-虚拟化基础"><a href="#1-虚拟化基础" class="headerlink" title="1 虚拟化基础"></a>1 虚拟化基础</h1><h2 id="1-1-传统的物理机部署方案"><a href="#1-1-传统的物理机部署方案" class="headerlink" title="1.1 传统的物理机部署方案"></a>1.1 传统的物理机部署方案</h2><p><img src="/Virtualization/KVM/image-20240330112823374.png" alt="image-20240330112823374"></p>
<ul>
<li>IDC选择,如:联通,电信,世纪互联,鹏博士等</li>
<li>网络和存储规划</li>
<li>服务器选型及采购</li>
<li>服务器系统选择、系统安装、上架、配置网络</li>
<li>应用规划及部署</li>
<li>域名选择及注册,DNS配置名称解析</li>
<li>测试外网访问</li>
</ul>
<p><strong>传统数据中心面临的问题：</strong></p>
<ul>
<li><p>服务器和网络设备资源利用率过低，并且无法共享,导致资源浪费</p>
</li>
<li><p>据统计大部分数据中心中的服务器和网络设备的利用率仅在24%～30%之间，有的CPU利用率、硬盘利用率都在10%以下</p>
</li>
<li><p>资源分配后进行调整困难</p>
</li>
<li><p>资源分配不合理也是传统网络架构存在的问题，因为资源不能动态调配，分配出去的资源是固定的，不能随意添加或删除。</p>
</li>
<li><p>难以实现自动化</p>
</li>
<li><p>初始化成本高,服务器迁移和升级很繁琐，无法实现自动化</p>
</li>
<li><p>成本高昂，集群环境需要大量的服务器主机,硬件投入和后期维护管理成本巨大</p>
</li>
</ul>
<h2 id="1-2-虚拟化"><a href="#1-2-虚拟化" class="headerlink" title="1.2 虚拟化"></a>1.2 虚拟化</h2><h3 id="1-2-1-什么是虚拟化"><a href="#1-2-1-什么是虚拟化" class="headerlink" title="1.2.1 什么是虚拟化"></a>1.2.1 什么是虚拟化</h3><p>虚拟化（Virtualization）是一种资源分配和管理技术，是将计算机的各种实体资源,比如CPU、内存、磁盘空间、网络适配器等，进行抽象转换后虚拟的设备,可以实现灵活地分割、组合为一个或多个计算机配置环境，并还支持重新分割、重新组合，以达到最大化合理利用物理资源的目的。</p>
<p>参考资料: <a href="https://www.vmware.com/cn/solutions/virtualization.html">https://www.vmware.com/cn/solutions/virtualization.html</a></p>
<h3 id="1-2-2-虚拟化优势"><a href="#1-2-2-虚拟化优势" class="headerlink" title="1.2.2 虚拟化优势"></a>1.2.2 虚拟化优势</h3><p>虚拟化可以提高 IT 敏捷性、灵活性和可扩展性，同时大幅节约成本。更高的工作负载移动性、更高的性能和资源可用性、自动化运维 - 这些都是虚拟化的优势，虚拟化技术可以使 IT 部门更轻松地进行管理以及降低拥有成本和运维成本。其优势包括：</p>
<ul>
<li>资源超分,如实际的物理内存只有128G,可以给虚拟机分配200G内存</li>
<li>降低资金成本和运维成本</li>
<li>最大限度减少或消除停机</li>
<li>提高 IT 部门的工作效率和响应能力</li>
<li>加快应用和资源的调配速度</li>
<li>提高业务连续性和灾难恢复能力</li>
<li>简化数据中心管理</li>
<li>减少资源,比如IP和端口的冲突</li>
<li>支持较旧的硬件和操作系统及应用</li>
</ul>
<h3 id="1-2-3-虚拟化类型"><a href="#1-2-3-虚拟化类型" class="headerlink" title="1.2.3 虚拟化类型"></a>1.2.3 虚拟化类型</h3><h4 id="1-2-3-1-服务器虚拟化"><a href="#1-2-3-1-服务器虚拟化" class="headerlink" title="1.2.3.1 服务器虚拟化"></a>1.2.3.1 服务器虚拟化</h4><p>服务器虚拟化支持在单个物理服务器上运行多个操作系统,每个操作系统作为虚拟机独立运行。</p>
<h4 id="1-2-3-2-网络虚拟化"><a href="#1-2-3-2-网络虚拟化" class="headerlink" title="1.2.3.2 网络虚拟化"></a>1.2.3.2 网络虚拟化</h4><p>通过软件定义网络(Software Defined Network，SDN)，即网络的创建不再依赖于物理设备，如公有云厂商支持用户自己通过配置界面创建新的网络，在 KVM、docker、kubernetes、openstack等虚拟化技术中都使用到了网络虚拟化</p>
<h4 id="1-2-3-3-桌面虚拟化"><a href="#1-2-3-3-桌面虚拟化" class="headerlink" title="1.2.3.3 桌面虚拟化"></a>1.2.3.3 桌面虚拟化</h4><p>将桌面部署为托管的服务,使 IT 组织能够更快地响应不断变化的工作场所需求和新出现的机会。还可以将虚拟化桌面和应用快速、轻松地交付给分支机构、外包和远程员工以及使用 iPad 和 Android 平板电脑的移动员工。</p>
<p>Citrix 思杰公司在云计算虚拟化、虚拟桌面和远程接入技术领域的处于优势地位</p>
<h4 id="1-2-3-4-应用虚拟化"><a href="#1-2-3-4-应用虚拟化" class="headerlink" title="1.2.3.4 应用虚拟化"></a>1.2.3.4 应用虚拟化</h4><p>将软件应用通过网络实现虚拟化，比如 office 365,钉钉,企业微信</p>
<h4 id="1-2-3-5-存储虚拟化"><a href="#1-2-3-5-存储虚拟化" class="headerlink" title="1.2.3.5 存储虚拟化"></a>1.2.3.5 存储虚拟化</h4><p>将存储用软件虚拟化实现, 如 SAN&#x2F;NAS(NFS&#x2F;Samba)&#x2F;GlusterFS&#x2F;ceph等</p>
<h4 id="1-2-3-6-库虚拟化"><a href="#1-2-3-6-库虚拟化" class="headerlink" title="1.2.3.6 库虚拟化"></a>1.2.3.6 库虚拟化</h4><p>在Linux上使用 wine来运行Windows 程序，在Mac系统使用CrossOver来运行Windows程序</p>
<h4 id="1-2-3-7-容器虚技术"><a href="#1-2-3-7-容器虚技术" class="headerlink" title="1.2.3.7 容器虚技术"></a>1.2.3.7 容器虚技术</h4><p>当前比较火的虚拟化技术，典型代表: Docker、Containerd、Podman、Linux Container(LXC)、Pouch</p>
<h2 id="1-3-虚拟机"><a href="#1-3-虚拟机" class="headerlink" title="1.3 虚拟机"></a>1.3 虚拟机</h2><h3 id="1-3-1-虚拟机"><a href="#1-3-1-虚拟机" class="headerlink" title="1.3.1 虚拟机"></a>1.3.1 虚拟机</h3><p>虚拟计算机称为“虚拟机”(VM,Virtual Machine)，它是一种严密隔离且内含操作系统和应用的软件容器。每个虚拟机都是完全独立的。通过将多台虚拟机放置在一台物理计算机上，可仅在一台物理服务器或“主机”上运行多个操作系统和应用，名为“hypervisor”的精简软件层可将虚拟机与主机分离开来，并根据需要为每个虚拟机动态分配计算资源。</p>
<h3 id="1-3-2-虚拟机的主要特性"><a href="#1-3-2-虚拟机的主要特性" class="headerlink" title="1.3.2 虚拟机的主要特性"></a>1.3.2 虚拟机的主要特性</h3><p>虚拟机具有以下特征，这些特征可提供多项优势</p>
<p><strong>分区</strong></p>
<ul>
<li>可在一台物理机上运行多个操作系统</li>
<li>可在虚拟机之间分配系统资源。</li>
</ul>
<p><strong>隔离</strong></p>
<ul>
<li>可在硬件级别进行故障和安全隔离。</li>
<li>可利用高级资源控制功能保持性能</li>
</ul>
<p><strong>封装</strong></p>
<ul>
<li>可将虚拟机的完整状态保存到文件中。</li>
<li>移动和复制虚拟机就像移动和复制文件一样轻松</li>
</ul>
<p><strong>独立于硬件</strong></p>
<ul>
<li>可将任意虚拟机调配或迁移到任意物理服务器上</li>
<li>安装系统不会受硬件兼容性的影响</li>
</ul>
<h2 id="1-4-Hypervisor类型"><a href="#1-4-Hypervisor类型" class="headerlink" title="1.4 Hypervisor类型"></a>1.4 Hypervisor类型</h2><h3 id="1-4-1-Hypervisor-介绍"><a href="#1-4-1-Hypervisor-介绍" class="headerlink" title="1.4.1 Hypervisor 介绍"></a>1.4.1 Hypervisor 介绍</h3><p><img src="/Virtualization/KVM/image-20240330113845954.png" alt="image-20240330113845954"></p>
<ul>
<li>Hypervisor是一种运行在基础物理服务器和操作系统之间的中间软件层，其可以允许多个操作系统和应用共享底层的内存、CPU、磁盘等物理硬件，也可叫做VMM（ virtual machine monitor），即虚拟机监视器。</li>
<li>Hypervisor是所有虚拟化技术的核心，非中断地支持多工作负载迁移的能力是Hypervisor的基本功能，当服务器启动并执行Hypervisor时，它会给每一台虚拟机分配适量的内存、CPU、网络和磁盘，并加载所有虚拟机的客户操作系统。</li>
<li>Hypervisor 允许多种操作系统在相同的物理系统中运行</li>
<li>Hypervisor 控制硬件并向来宾操作系统提供访问底层硬件的途径</li>
<li>Hypervisor 向来宾操作系统提供虚拟化的硬件</li>
</ul>
<p><strong>X86 CPU 的保护环</strong></p>
<p><img src="/Virtualization/KVM/image-20240330113913909.png" alt="image-20240330113913909"></p>
<p>注意：CPU为了保证程序代码执行的安全性、多用户的独立性、保护OS的正常运行，提出了CPU执行状态的概念。这样能够限制不同程序之间的访问能力，避免一个程序获取另一个程序的内存数据造成数据混乱，同时也避免了程序错误的操作物理硬件。一般CPU都会划分为 用户态 和内核态 ，x86的CPU架构更是细分为了Ring3~0四种状态。</p>
<p><img src="/Virtualization/KVM/image-20240330113926994.png" alt="image-20240330113926994"></p>
<p><strong>Ring3 用户态(User Mode)</strong>：运行在用户态的程序代码需要受到CPU的检查，用户态程序代码只能访问内存页表项中规定能被用户态程序代码访问的页面虚拟地址(受限的内存访问)，而且还只能访问任务描述符TSS中的I&#x2F;O Permission Bitmap中规定能被用户态程序代码访问的端口。甚至不能直接访问外围硬件设备、不能抢占CPU。所有的应用程序都运行在用户态上。当运行在用户态的Application需要调用只能被核心态代码直接访问的硬件设备时，CPU会通过特别的接口去调用核心态的代码，以此来实现Application对硬件设备的调用。如果用户态的Application直接调用硬件设备时，就会被Host OS捕捉到并触发异常，弹出警告窗口。</p>
<p><strong>Ring0 核心态(Kernel Mode)</strong>：是Host OS Kernel运行的模式，运行在核心态的代码可以无限制的对系统内存、设备驱动程序、网卡接口、显卡接口等外围硬件设备进行访问。只有Host OS能够无限制的访问磁盘、键盘等外围硬件设备的数据，但是首先需要在Host OS上安装驱动程序</p>
<h3 id="1-4-2-Hypervisor-分类"><a href="#1-4-2-Hypervisor-分类" class="headerlink" title="1.4.2 Hypervisor 分类"></a>1.4.2 Hypervisor 分类</h3><p>1974年Gerald J.Popek和Robert P.Goldberg的文章“Formal Requirements forVirtualizable ThirdGeneration Architectures” 将Hypervisor分为两类:</p>
<p><img src="/Virtualization/KVM/image-20240330113956400.png" alt="image-20240330113956400"></p>
<p><img src="/Virtualization/KVM/image-20240330114001330.png" alt="image-20240330114001330"></p>
<h4 id="1-4-2-1-类型-I-裸金属型"><a href="#1-4-2-1-类型-I-裸金属型" class="headerlink" title="1.4.2.1 类型 I : 裸金属型"></a>1.4.2.1 类型 I : 裸金属型</h4><p>直接运行到物理机的Hypervisor上，这种架构搭建的虚拟化环境称为裸机虚拟化环境(Bare-Metal Hardware</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">KVM</span><br><span class="line">XEN</span><br><span class="line">vmware esxi</span><br><span class="line">rhev hypervisor</span><br><span class="line">Hyper-v Server</span><br><span class="line"></span><br><span class="line"><span class="comment">#Redhat将KVM划分到类型I即裸机型：</span></span><br><span class="line">https://www.redhat.com/zh/topics/virtualization/what-is-KVM</span><br></pre></td></tr></table></figure>



<h4 id="1-4-2-2-类型-II-宿主型"><a href="#1-4-2-2-类型-II-宿主型" class="headerlink" title="1.4.2.2 类型 II : 宿主型"></a>1.4.2.2 类型 II : 宿主型</h4><p>即需要运行在具有虚拟化功能的操作系统上的Hypervisor，构建的是主机虚拟化环境(Hosted Virtualization)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vmware workstation</span><br><span class="line">Microsoft Hyper-V</span><br><span class="line">VirtualBox</span><br><span class="line">paralles desktop <span class="comment">#Mac系统最强虚拟机技术</span></span><br></pre></td></tr></table></figure>



<h2 id="1-5-虚拟化技术分类"><a href="#1-5-虚拟化技术分类" class="headerlink" title="1.5 虚拟化技术分类"></a>1.5 虚拟化技术分类</h2><h3 id="1-5-1-模拟器-软件仿真"><a href="#1-5-1-模拟器-软件仿真" class="headerlink" title="1.5.1 模拟器&#x2F;软件仿真"></a>1.5.1 模拟器&#x2F;软件仿真</h3><p><img src="/Virtualization/KVM/image-20240330114605212.png" alt="image-20240330114605212"></p>
<ul>
<li>通过软件模拟完整的硬件环境来虚拟化来宾平台。</li>
<li>可以模拟X86、ARM 、PowerPC等多种CPU</li>
<li>效率比较低</li>
<li>产品或方案:QEMU、Bochs、PearPC</li>
</ul>
<p>模拟器：<a href="https://yuzu-emu.org/">https://yuzu-emu.org/</a></p>
<h3 id="1-5-2-全虚拟机化-full-virtualization-本地虚拟化-native-virtualization"><a href="#1-5-2-全虚拟机化-full-virtualization-本地虚拟化-native-virtualization" class="headerlink" title="1.5.2 全虚拟机化 full virtualization &#x2F; 本地虚拟化 native virtualization"></a>1.5.2 全虚拟机化 full virtualization &#x2F; 本地虚拟化 native virtualization</h3><p><strong>不需要对GuestOS操作系统软件的源代码做任何的修改，就可以运行在这样的VMM中</strong></p>
<p>在全虚拟化的虚拟平台中，GuestOS并不知道自己是一台虚拟机，它会认为自己就是运行在计算机物理硬件设备上的HostOS。全虚拟化的GuestOS具有完全的物理机特性。因为全虚拟化的VMM会将一个OS所能够操作的CPU、内存、外设等物理设备逻辑抽象成为虚拟CPU、虚拟内存、虚拟外设等虚拟设备后，再交由GuestOS来操作使用。这样的GuestOS会将底层硬件平台视为自己所有的，但是实际上，这些都是VMM为GuestOS制造了这种假象。</p>
<p>全虚拟化&#x2F;本地虚拟化不做CPU和内存模拟，只对CPU和内存做相应的分配等操作</p>
<p>全虚拟化又分为：<strong>软件辅助的全虚拟化 &amp; 硬件辅助的全虚拟化</strong></p>
<h4 id="1-5-2-1-软件辅助的全虚拟化"><a href="#1-5-2-1-软件辅助的全虚拟化" class="headerlink" title="1.5.2.1 软件辅助的全虚拟化"></a>1.5.2.1 软件辅助的全虚拟化</h4><p><img src="/Virtualization/KVM/image-20240330114703846.png" alt="image-20240330114703846"></p>
<p>在Intel等CPU厂商还没有发布x86 CPU虚拟化技术之前，完全虚拟化都是通过软件辅助的方式来实现的。</p>
<p>代表技术: Vmware Workstation,QEMU,Virtual PC</p>
<p>当使用GuestOS的时候，不可避免的会调用GuestOS中的虚拟设备驱动程序 和核心调度程序来操作硬件设备。与HostOS的不同在于，HostOS运行在CPU的核心态中，这就表示HostOS可以直接对硬件设备进行操作。但GuestOS作为一个运行在CPU用户态中应用程序，不能够直接的操作硬件设备。</p>
<p>简而言之，软件辅助虚拟化能够成功的将所有在GuestOS中执行的系统内核特权指令进行捕获、翻译，使之成为只能对GuestOS生效的虚拟特权指令。之所以需要这么做的前提是因为CPU并不能准确的去判断一个特权指令到底是由GuestOS发出的还是由HostOS发出的，这样也就无法针对一个正确的OS去将这一个特权指令执行。</p>
<p>由于全虚拟化VMM会频繁的捕获这些核心态的和敏感的指令，将这些指令进行转换之后，再交给CPU执行。所以经过了转换，导致其效率低，但全虚拟化VMM应用程序的好处在于其不需要对GuestOS的核心源码做修改，所以全虚拟化的VMM可以安装绝大部分的OS(暂时来说只有已Linux、open soralis、BSD等几种OS开源了内核代码)。</p>
<p>直到后来CPU厂商们发布了能够判断特权指令归属的标准x86 CPU之后，迎来了硬件辅助全虚拟化。</p>
<h4 id="1-5-2-2-硬件辅助的全虚拟化-HVM-Hardware-Virtual-Machine"><a href="#1-5-2-2-硬件辅助的全虚拟化-HVM-Hardware-Virtual-Machine" class="headerlink" title="1.5.2.2 硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)"></a>1.5.2.2 硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)</h4><p><img src="/Virtualization/KVM/image-20240330114737542.png" alt="image-20240330114737542"></p>
<p>2005年Intel提出并开发了由CPU直接支持的虚拟化技术。这种虚拟化技术引入新的CPU运行模式和新的指令集，使得VMM和GuestOS运行于不同的模式下(VMM&#x3D;Root Mode;GuestOS&#x3D;Non-Root Mode)，GuestOS运行于受控模式，原来的一些敏感指令在受控模式下会全部陷入VMM，由VMM来实现模拟，这样就解决了部分非内核态敏感指令的陷入——模拟难题，而且模式切换时上下文的保存恢复由硬件来<br>完成，这样就大大提高了陷入——模拟时上下文切换的效率 。该技术的引入使x86 CPU可以很容易地实现完全虚拟化。故皆被几乎所有之前分歧的各大流派所采用，包括KVM-x86，VMWare ESX Server 3，Xen 3.0 。</p>
<p>虚拟化CPU形成了新的CPU执行状态 Non-Root Mode 和 Root Mode .GuestOS运行在Non-Root Mode的Ring 0核心态中，这意味着GuestOS能够直接执行特权指令,而不再需要特权解除和陷入模拟机制。并且在硬件层上面紧接的就是虚拟化层的VMM，而不需要HostOS。这是因为在硬件辅助全虚拟化的VMM会以一种更具协作性的方式来实现虚拟化 —— 将虚拟化模块加载到HostOS的内核中，例如：KVM，KVM通过在HostOS内核中加载<strong>KVM Kernel Module</strong>来将HostOS转换成为一个VMM。所以此时VMM可以看作是HostOS，反之亦然。</p>
<p>硬件辅助全虚拟化主要使用了支持虚拟化功能的CPU进行支撑，CPU可以明确的分辨出来自GuestOS的特权指令，并针对GuestOS进行特权操作，而不会影响到HostOS。</p>
<p>硬件辅助全虚拟化需要物理硬件的支持，比如需要CPU必须支持并且打开虚拟化功能，例如 	Intel 的 Intel VT-X&#x2F;EPT，AMD的AMD-V&#x2F;RVI，以在CPU 层面支持虚拟化功能和内存虚拟化技术</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">全虚拟化软件(硬件辅助全虚拟化)：</span><br><span class="line">vmware esxi</span><br><span class="line">Xen3.0</span><br><span class="line">KVM</span><br><span class="line">Microsoft Hyper-V</span><br><span class="line">vmware workstation #https://www.vmware.com/cn/products/workstation-pro.html</span><br><span class="line">VirtualBox</span><br><span class="line">paralles desktop</span><br></pre></td></tr></table></figure>

<p><strong>KVM 是硬件辅助的虚拟化技术</strong></p>
<p>主要负责比较繁琐的 CPU 和内存虚拟化，而 Qemu 则负责 I&#x2F;O 虚拟化，两者合作各自发挥自身的功能</p>
<h3 id="1-5-3-半虚拟化-para-virtualization"><a href="#1-5-3-半虚拟化-para-virtualization" class="headerlink" title="1.5.3 半虚拟化 para virtualization"></a>1.5.3 半虚拟化 para virtualization</h3><p><img src="/Virtualization/KVM/image-20240330114854432.png" alt="image-20240330114854432"></p>
<p>半虚拟化是需要GuestOS协助的虚拟化。因为在半虚拟化VMM中运行的GuestOS，都需要将其内核源码进行都进过了特别的修改。</p>
<p>通过修改客户操作系统代码，将原来在物理机上执行的一些特权指令(主要是修改GuestOS指令集中的敏感指令和核心态指令)，修改成可以和VMM直接交互的方式，实现操作系统的定制化。这样，就不会有捕获异常、翻译和模拟的过程，性能损耗比较少。</p>
<p>半虚拟化VMM在处理敏感指令和内核态指令的流程上相对更简单一些。让HostOS在捕抓到GuestOS内核态指令或敏感指令时，HostOS也能够准确的判断出该指令是否属于GuestOS(GuestOS知道自己是虚拟机)。这样就可以高效的避免了上述问题。典型的半虚拟化软件有——Xen、KVM-PowerPC(简易指令集)</p>
<p>半虚拟化除了修改内核外还有另外一种实现方法——在每一个GuestOS中安装半虚拟化软件，如:VMTools、RHEVTools。</p>
<p>注意：若使用KVM运行Windows时，一定要安装半虚拟化驱动Tools，否则无法工作。现在主流的半虚拟化驱动是由IBM和redhat联合开发一个通用半虚拟机驱动virtio 。</p>
<p>半虚拟化要求guest OS 的内核是知道自己运行在虚拟化环境当中的，因此guest OS的系统架构必须和宿主机的系统架构相同，并且要求对guest OS的内核做相应的修改，因此半虚拟化只支持开源内核的系统，不支持闭源的系统，比较常见的半虚拟化就是早期版本的XEN，但是Xen 从其3.0 版本开始，可以支持利用硬件辅助虚拟化技术</p>
<h1 id="2-KVM架构和部署"><a href="#2-KVM架构和部署" class="headerlink" title="2 KVM架构和部署"></a>2 KVM架构和部署</h1><h2 id="2-1-KVM-概述"><a href="#2-1-KVM-概述" class="headerlink" title="2.1 KVM 概述"></a>2.1 KVM 概述</h2><h3 id="2-1-1-KVM-介绍"><a href="#2-1-1-KVM-介绍" class="headerlink" title="2.1.1 KVM 介绍"></a>2.1.1 KVM 介绍</h3><p>KVM（ Kernel-based Virtual Machine）是一个完整的虚拟化解决方案，适用于包含虚拟化扩展（IntelVT或AMD-V）的x86硬件上的Linux。目前也支持ARM等其它硬件平台. 它由可加载的内核模块kvm.ko组成，它提供核心虚拟化基础架构和处理器特定模块，kvm-intel.ko或kvm-amd.ko，KVM的用户空间组件包含在QEMU1.3后续版本中,KVM目前已成为学术界的主流 VMM (virtual machine monitor，虚拟机监视器，也称为 hypervisor)之一</p>
<p>KVM是开源软件，可运行多个运行未修改的Linux或Windows映像的虚拟机</p>
<p>依赖于HVM；Intel VT-x, AMD AMD-V</p>
<p>官网： <a href="https://www.linux-kvm.org/">https://www.Linux-kvm.org</a></p>
<p><img src="/Virtualization/KVM/image-20240330114959223.png" alt="image-20240330114959223"></p>
<p>红帽 kvm 介绍：<a href="https://www.redhat.com/zh/topics/virtualization/what-is-KVM">https://www.redhat.com/zh/topics/virtualization/what-is-KVM</a></p>
<p>RedHat虚拟化指南：<a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_Linux/7/html/virtualization_getting_started_guide/index">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_Linux/7/html/virtualization_getting_started_guide/index</a></p>
<p>RedHat 创建虚拟机数量限制：<a href="https://access.redhat.com/articles/rhel-kvm-limits">https://access.redhat.com/articles/rhel-kvm-limits</a></p>
<h3 id="2-1-2-KVM架构"><a href="#2-1-2-KVM架构" class="headerlink" title="2.1.2 KVM架构"></a>2.1.2 KVM架构</h3><p>KVM 是基于虚拟化扩展（Intel VT 或者 AMD-V）的 X86 硬件的开源的 Linux 原生的全虚拟化解决方案。KVM 中，虚拟机被实现为常规的 Linux 进程，由标准 Linux 调度程序进行调度；虚机的每个虚拟CPU 被实现为一个常规的 Linux 进程。这使得 KVM 能够使用 Linux 内核的已有功能。</p>
<p>但是，KVM 本身不执行任何硬件模拟，需要客户空间程序通过 &#x2F;dev&#x2F;kvm 接口设置一个客户机虚拟服务器的地址空间，向它提供模拟的 I&#x2F;O，并将它的视频显示映射回宿主的显示屏。目前这个应用程序使用QEMU。</p>
<h4 id="2-1-2-1-KVM-体系结构"><a href="#2-1-2-1-KVM-体系结构" class="headerlink" title="2.1.2.1 KVM 体系结构"></a>2.1.2.1 KVM 体系结构</h4><p><img src="/Virtualization/KVM/image-20240330115315122.png" alt="image-20240330115315122"></p>
<ul>
<li>KVM： 初始化CPU硬件,打开虚拟机模式,负责CPU,内存,中断控制器,时钟. 由内核模块kvm_xxx.ko实现，工作于hypervisor，设备&#x2F;dev&#x2F;kvm，是一个字符设备，在用户空间可通过ioctl()系统调用来完成VM创建、启动，为VM分配内存、读写VCPU的寄存器、向VCPU注入中断、时钟等管理功能</li>
<li>QEMU进程：工作于用户空间，主要用于实现模拟IO设备,如显卡，网卡，硬盘等， qemu-kvm进程：工作于用户空间，用于实现一个虚拟机实例</li>
<li>Libvirt：提供统一API，守护进程libvirtd和相关工具，如:virsh，virt-manager等</li>
</ul>
<h4 id="2-1-2-2-KVM-模块载入后的系统的运行模式"><a href="#2-1-2-2-KVM-模块载入后的系统的运行模式" class="headerlink" title="2.1.2.2 KVM 模块载入后的系统的运行模式"></a>2.1.2.2 KVM 模块载入后的系统的运行模式</h4><p>内核模式：HostOS执行I&#x2F;O类操作，或其它的特殊指令的操作；称作内核模式</p>
<p>用户模式：GuestOS的I&#x2F;O类操作</p>
<p>来宾模式：GuestOS非I&#x2F;O类操作，称作虚拟机的用户模式更贴切</p>
<p><img src="/Virtualization/KVM/image-20240330115339832.png" alt="image-20240330115339832"></p>
<h3 id="2-1-3-KVM-集中管理与控制"><a href="#2-1-3-KVM-集中管理与控制" class="headerlink" title="2.1.3 KVM 集中管理与控制"></a>2.1.3 KVM 集中管理与控制</h3><p>KVM是运行在单机的系统，需要其它软件实现跨主机的统一的管理。常见的虚拟化管理平台如下：</p>
<p><a href="http://www.linux-kvm.org/page/Management_Tools">http://www.Linux-kvm.org/page/Management_Tools</a></p>
<ul>
<li><p>oVirt</p>
<p>  功能强大，是Redhat虚拟化管理平台RHEV的开源版本。</p>
<p>  <a href="http://www.ovirt.org/">http://www.ovirt.org/</a></p>
</li>
<li><p>WebVirtMgr</p>
<p>  <a href="https://www.webvirtmgr.net/">https://www.webvirtmgr.net</a></p>
<p>  virt-manager的Web模式的替代品</p>
</li>
<li><p>OpenStack</p>
<p>  最主流的开源虚拟化管理平台</p>
</li>
<li><p>Proxmox virtualization environment</p>
<p>  简称PVE，是一个开源免费的基于Linux的企业级虚拟化方案，功能不输专业收费的VMware。是一个完整的企业虚拟化开源平台。借助内置的Web界面，您可以轻松管理VM和容器，软件定义的存储和网络，高可用性集群以及单个解决方案上的多个开箱即用工具。</p>
</li>
</ul>
<h2 id="2-2-宿主机环境准备"><a href="#2-2-宿主机环境准备" class="headerlink" title="2.2 宿主机环境准备"></a>2.2 宿主机环境准备</h2><p>KVM需要宿主机CPU必须支持虚拟化功能，因此如果是在vmware workstation上使用虚拟机做宿主机，那么必须要在虚拟机配置界面的处理器选项中开启虚拟机化功能。</p>
<h3 id="2-2-1-CPU开启虚拟化"><a href="#2-2-1-CPU开启虚拟化" class="headerlink" title="2.2.1 CPU开启虚拟化"></a>2.2.1 CPU开启虚拟化</h3><p>注意： 给宿主机的CPU和内存分配足够多的配置</p>
<p><img src="/Virtualization/KVM/image-20240330115507189.png" alt="image-20240330115507189"></p>
<h3 id="2-2-2-验证开启虚拟化"><a href="#2-2-2-验证开启虚拟化" class="headerlink" title="2.2.2 验证开启虚拟化"></a>2.2.2 验证开启虚拟化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -Em 1  <span class="string">&quot;vmx|svm&quot;</span> /proc/cpuinfo</span><br><span class="line"></span><br><span class="line"><span class="comment">#Intel CPU 对应 vmx</span></span><br><span class="line"><span class="comment">#AMD   CPU 对应 svm</span></span><br></pre></td></tr></table></figure>

<p>范例: 查看AMD主机的内核模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#lsmod |grep kvm</span><br><span class="line">kvm_amd         110592  0</span><br><span class="line">ccp              98304  1 kvm_amd</span><br><span class="line">kvm             786432  1 kvm_amd</span><br><span class="line">irqbypass        16384  1 kvm</span><br></pre></td></tr></table></figure>



<h2 id="2-3-安装KVM工具包"><a href="#2-3-安装KVM工具包" class="headerlink" title="2.3 安装KVM工具包"></a>2.3 安装KVM工具包</h2><h3 id="2-3-1-KVM-相关工具包介绍"><a href="#2-3-1-KVM-相关工具包介绍" class="headerlink" title="2.3.1 KVM 相关工具包介绍"></a>2.3.1 KVM 相关工具包介绍</h3><ul>
<li><p>qemu-kvm: 为kvm提供底层仿真支持</p>
</li>
<li><p>libvirt-daemon: libvirtd守护进程，管理虚拟机</p>
</li>
<li><p>libvirt-client: 用户端软件，提供客户端管理命令</p>
</li>
<li><p>libvirt-daemon-driver-qemu: libvirtd连接qemu的驱动</p>
</li>
<li><p>libvirt: 使用最多的KVM虚拟化管理工具和应用程序接口，即通过libvirt调用KVM创建虚拟机</p>
<p>  libvirt是KVM通用的访问API，其不但能管理KVM，还能管理VMware、Xen、Hyper-V、</p>
<p>  virtualBox等虚拟化方案。</p>
</li>
<li><p>virt-manager: 图形界面管理工具,其底层也是调用libvirt API来完成对虚拟机的操作，包括虚拟机的创建、删除、启动、停止以及一些简单的监控功能等。</p>
</li>
<li><p>virt-install: 虚拟机命令行安装工具</p>
</li>
<li><p>virsh: 命令行工具是基于 libvirt API 创建的命令行工具，它可以作为图形化的 virt-manager 应用的备选工具。virsh 命令可以被用来创建虚拟化任务管理脚本，如安装、启动和停止虚拟机</p>
</li>
<li><p>virt-viewer: 通过 VNC 和 SPICE 协议显示虚拟机器图形控制台的最小工具。该工具在其同名软件包中：virtviewer</p>
</li>
<li><p>cockpit: CentOS8 专门提供的基于Web的虚拟机管理界面</p>
</li>
</ul>
<h3 id="2-3-2-libvirt-包功能"><a href="#2-3-2-libvirt-包功能" class="headerlink" title="2.3.2 libvirt 包功能"></a>2.3.2 libvirt 包功能</h3><h4 id="2-3-2-1-libvirt-介绍"><a href="#2-3-2-1-libvirt-介绍" class="headerlink" title="2.3.2.1 libvirt 介绍"></a>2.3.2.1 libvirt 介绍</h4><p>libvirt 程序包是一个与虚拟机监控程序相独立的虚拟化应用程序接口，它可以与操作系统的一系列虚拟化性能进行交互</p>
<p>libvirt 程序包提供：</p>
<ul>
<li>一个稳定的通用层来安全地管理主机上的虚拟机。</li>
<li>一个管理本地系统和连网主机的通用接口。</li>
</ul>
<p>在虚拟机监控程序支持的情况下，部署、创建、修改、监测、控制、迁移以及停止虚拟机操作都需要这些API。尽管 libvirt 可同时访问多个主机，但 API 只限于单节点操作</p>
<p>libvirt 程序包被设计为用来构建高级管理工具和应用程序，例如 virt-manager 与 virsh 命令行管理工具。libvirt 主要的功能是管理单节点主机，并提供 API 来列举、监测和使用管理节点上的可用资源，其中包括CPU、内存、储存、网络和非一致性内存访问（NUMA）分区。管理工具可以位于独立于主机的物理机上，并通过安全协议和主机进行交流</p>
<h4 id="2-3-2-2-libvirt-结构图"><a href="#2-3-2-2-libvirt-结构图" class="headerlink" title="2.3.2.2 libvirt 结构图"></a>2.3.2.2 libvirt 结构图</h4><p><img src="/Virtualization/KVM/image-20240330120012758.png" alt="image-20240330120012758"></p>
<h3 id="2-3-3-安装KVM相关包"><a href="#2-3-3-安装KVM相关包" class="headerlink" title="2.3.3 安装KVM相关包"></a>2.3.3 安装KVM相关包</h3><h4 id="2-3-3-1-Ubuntu-安装-KVM"><a href="#2-3-3-1-Ubuntu-安装-KVM" class="headerlink" title="2.3.3.1 Ubuntu 安装 KVM"></a>2.3.3.1 Ubuntu 安装 KVM</h4><p>Ubuntu 18.04：</p>
<p>官方文档: <a href="https://ubuntu.com/server/docs/virtualization-libvirt">https://ubuntu.com/server/docs/virtualization-libvirt</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]#apt -y install cpu-checker</span><br><span class="line">[root@ubuntu2004 ~]#apt -y install cpu-checker</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果CPU不支持会如下提示</span></span><br><span class="line">[root@ubuntu2004 ~]#kvm-ok</span><br><span class="line">INFO: Your CPU does not support KVM extensions KVM acceleration can NOT be used</span><br><span class="line"></span><br><span class="line"><span class="comment"># apt install qemu-kvm virt-manager libvirt-daemon-system</span></span><br><span class="line"><span class="comment"># kvm-ok #验证是否支持kvm,只有Ubuntu支持,CentOS 不支持</span></span><br><span class="line"><span class="comment">#如果CPU支持，如下提示</span></span><br><span class="line">INFO: /dev/kvm exists</span><br><span class="line">KVM acceleration can be used</span><br></pre></td></tr></table></figure>

<p>范例: ubuntu 安装KVM工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]#apt update</span><br><span class="line">[root@ubuntu2204 ~]#apt -y install qemu-kvm virt-manager libvirt-daemon-system</span><br><span class="line">[root@ubuntu2004 ~]#apt -y install qemu-kvm virt-manager libvirt-daemon-system</span><br><span class="line">[root@ubuntu1804 ~]#apt -y install qemu-kvm virt-manager libvirt-daemon-system</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]#ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line"> inet 127.0.0.1/8 scope host lo</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line"> inet6 ::1/128 scope host</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line"><span class="built_in">link</span>/ether 00:0c:29:40:27:06 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line"> inet6 fe80::20c:29ff:fe40:2706/64 scope <span class="built_in">link</span></span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr1</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr1-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr1 state DOWN group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> </span><br><span class="line">[root@ubuntu2204 ~]#apt -y install bridge-utils</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]#brctl show</span><br><span class="line">bridge name bridge <span class="built_in">id</span> STP enabled interfaces</span><br><span class="line">virbr1 8000.5254005655f6 <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果没有开启CPU虚拟化功能会提示以下信息</span></span><br><span class="line">[root@ubuntu1804 ~]#kvm-ok</span><br><span class="line">INFO: Your CPU does not support KVM extensions</span><br><span class="line">KVM acceleration can NOT be used</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加CPU的虚拟化支持再执行</span></span><br><span class="line">[root@ubuntu1804 ~]#kvm-ok</span><br><span class="line">INFO: /dev/kvm exists</span><br><span class="line">KVM acceleration can be used 	</span><br></pre></td></tr></table></figure>



<h4 id="2-3-3-2-CentOS-安装-KVM"><a href="#2-3-3-2-CentOS-安装-KVM" class="headerlink" title="2.3.3.2 CentOS 安装 KVM"></a>2.3.3.2 CentOS 安装 KVM</h4><p>使用虚拟化，需要至少 qemu-kvm 和 qemu-img(安装qemu-kvm会自动安装) 软件包</p>
<p>建议安装：yum install qemu-kvm libvirt virt-manager virt-install</p>
<p>范例: CentOS 8 安装 KVM相关工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#yum -y install qemu-kvm libvirt  virt-manager virt-install</span><br><span class="line">virt-viewer</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#systemctl start --now libvirtd</span><br></pre></td></tr></table></figure>

<p>范例: CentOS 8 还提供基于Web的虚拟机管理方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#yum -y install cockpit cockpit-machines</span><br><span class="line">[root@centos8 ~]#systemctl <span class="built_in">enable</span> --now cockpit.socket</span><br><span class="line">Created symlink /etc/systemd/system/sockets.target.wants/cockpit.socket → /usr/lib/systemd/system/cockpit.socket.</span><br><span class="line"></span><br><span class="line"><span class="comment">#打开浏览器，访问以下地址：</span></span><br><span class="line">https://centos8主机:9090</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330125556210.png" alt="image-20240330125556210"></p>
<p><img src="/Virtualization/KVM/image-20240330125600435.png" alt="image-20240330125600435"></p>
<h3 id="2-3-4-图形化工具-virt-manager"><a href="#2-3-4-图形化工具-virt-manager" class="headerlink" title="2.3.4 图形化工具 virt-manager"></a>2.3.4 图形化工具 virt-manager</h3><p>范例: CentOS 上管理工具 virt-manager</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#<span class="built_in">export</span> DISPLAY=10.0.0.1:0.0</span><br><span class="line">[root@centos8 ~]#virt-manager</span><br><span class="line">[root@centos8 ~]#libGL error: No matching fbConfigs or visuals found</span><br><span class="line">libGL error: failed to load driver: swrast</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330125630702.png" alt="image-20240330125630702"></p>
<p>范例: Ubuntu 上管理工具 virt-manager</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]#virt-manager</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果出现乱码，设置语言</span></span><br><span class="line">[root@ubuntu2204 ~]#localectl set-locale LANG=en_US.UTF-8;<span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330125647320.png" alt="image-20240330125647320"></p>
<p>范例：Ubuntu 安装 cockpit 工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]#apt install cockpit cockpit-machines</span><br><span class="line">[root@ubuntu2204 ~]#ss -ntl|grep 9090</span><br><span class="line">LISTEN 0    4096        *:9090      *:*  </span><br><span class="line"></span><br><span class="line"><span class="comment">#打开浏览器，访问以下地址：</span></span><br><span class="line">https://Ubuntu主机:9090</span><br></pre></td></tr></table></figure>



<h3 id="2-2-5-默认网络配置"><a href="#2-2-5-默认网络配置" class="headerlink" title="2.2.5 默认网络配置"></a>2.2.5 默认网络配置</h3><p>安装完虚拟工具后,会自动生成一个 virbr1 网卡,类似于Vmware workstation 生成的VMnet8 网卡,充当虚拟机的 NAT 网卡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line"> inet 127.0.0.1/8 scope host lo</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line"> inet6 ::1/128 scope host</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe8a:5121/64 scope <span class="built_in">link</span></span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/ether 52:54:00:97:eb:e3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr1</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr1-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr1 state DOWN group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/ether 52:54:00:97:eb:e3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> </span><br><span class="line">[root@centos8 ~]#grep -R 192.168.122.1 /etc/libvirt/*</span><br><span class="line">/etc/libvirt/qemu/networks/autostart/default.xml: &lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line">/etc/libvirt/qemu/networks/default.xml: &lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#ip a show virbr1</span><br><span class="line">3: virbr1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/ether 52:54:00:97:eb:e3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr1</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">   </span><br><span class="line">[root@centos8 ~]#<span class="built_in">cat</span> /etc/libvirt/qemu/networks/default.xml</span><br><span class="line">&lt;!--</span><br><span class="line">WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BEOVERWRITTEN AND LOST. Changes to this xml configuration should be made using:virsh net-edit default or other application using the libvirt API.</span><br><span class="line">--&gt;</span><br><span class="line">&lt;network&gt;</span><br><span class="line">&lt;name&gt;default&lt;/name&gt;</span><br><span class="line">&lt;uuid&gt;1ebc4504-5da9-4b7e-b367-90b8cb20029b&lt;/uuid&gt;</span><br><span class="line">&lt;forward mode=<span class="string">&#x27;nat&#x27;</span>/&gt;</span><br><span class="line">&lt;bridge name=<span class="string">&#x27;virbr1&#x27;</span> stp=<span class="string">&#x27;on&#x27;</span> delay=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line">&lt;mac address=<span class="string">&#x27;52:54:00:97:eb:e3&#x27;</span>/&gt;</span><br><span class="line">&lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line"> &lt;dhcp&gt;</span><br><span class="line">  &lt;range start=<span class="string">&#x27;192.168.122.2&#x27;</span> end=<span class="string">&#x27;192.168.122.254&#x27;</span>/&gt;</span><br><span class="line"> &lt;/dhcp&gt;</span><br><span class="line">&lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#nmcli connection show virbr1</span><br></pre></td></tr></table></figure>

<p>范例: Ubuntu 网络配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]#ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line"> inet 127.0.0.1/8 scope host lo</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line"> inet6 ::1/128 scope host</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/ether 00:0c:29:40:27:06 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line"> inet6 fe80::20c:29ff:fe40:2706/64 scope <span class="built_in">link</span></span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line"><span class="built_in">link</span>/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr1</span><br><span class="line">   valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr1-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr1 state DOWN group default qlen 1000</span><br><span class="line"> <span class="built_in">link</span>/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> </span><br><span class="line">[root@ubuntu1804 ~]#brctl show</span><br><span class="line">bridge name bridge <span class="built_in">id</span> STP enabled interfaces</span><br><span class="line">virbr1 8000.5254008da6fe <span class="built_in">yes</span> virbr1-nic</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]#<span class="built_in">cat</span> /etc/libvirt/qemu/networks/default.xml</span><br><span class="line">&lt;!--</span><br><span class="line">WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BEOVERWRITTEN AND LOST. Changes to this xml configuration should be made using:virsh net-edit default or other application using the libvirt API.</span><br><span class="line">--&gt;</span><br><span class="line">&lt;network&gt;</span><br><span class="line">&lt;name&gt;default&lt;/name&gt;</span><br><span class="line">&lt;uuid&gt;a3235b68-6dc0-4951-8a35-7a60a567f1a7&lt;/uuid&gt;</span><br><span class="line">&lt;forward mode=<span class="string">&#x27;nat&#x27;</span>/&gt;</span><br><span class="line">&lt;bridge name=<span class="string">&#x27;virbr1&#x27;</span> stp=<span class="string">&#x27;on&#x27;</span> delay=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line">&lt;mac address=<span class="string">&#x27;52:54:00:8d:a6:fe&#x27;</span>/&gt;</span><br><span class="line">&lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line"> &lt;dhcp&gt;</span><br><span class="line">  &lt;range start=<span class="string">&#x27;192.168.122.2&#x27;</span> end=<span class="string">&#x27;192.168.122.254&#x27;</span>/&gt;</span><br><span class="line"> &lt;/dhcp&gt;</span><br><span class="line">&lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br></pre></td></tr></table></figure>



<h2 id="2-4-准备安装系统的ISO相关文件"><a href="#2-4-准备安装系统的ISO相关文件" class="headerlink" title="2.4 准备安装系统的ISO相关文件"></a>2.4 准备安装系统的ISO相关文件</h2><p>将需要安装的系统的ISO文件上传到宿主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#<span class="built_in">mkdir</span> -pv /data/isos/</span><br><span class="line">[root@centos8 ~]#<span class="built_in">ls</span> /data/isos/</span><br><span class="line">CentOS-7-x86_64-Minimal-2009.iso</span><br><span class="line">CentOS-8.2.2004-x86_64-minimal.iso</span><br><span class="line">cn_Windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso</span><br></pre></td></tr></table></figure>



<h2 id="2-5-AMD-CPU-创建虚拟机时的故障排错"><a href="#2-5-AMD-CPU-创建虚拟机时的故障排错" class="headerlink" title="2.5 AMD CPU 创建虚拟机时的故障排错"></a>2.5 AMD CPU 创建虚拟机时的故障排错</h2><p>AMD CPU 使用virt-manager 或 virt-install 在创建虚拟机可能会出错,用下面方法解决</p>
<h3 id="2-5-1-AMD-CPU-使用virt-manager创建虚拟机出错提示"><a href="#2-5-1-AMD-CPU-使用virt-manager创建虚拟机出错提示" class="headerlink" title="2.5.1 AMD CPU 使用virt-manager创建虚拟机出错提示"></a>2.5.1 AMD CPU 使用virt-manager创建虚拟机出错提示</h3><p><img src="/Virtualization/KVM/image-20240330130042525.png" alt="image-20240330130042525"></p>
<h3 id="2-5-2-AMD-CPU-使用virt-install创建虚拟机出错提示"><a href="#2-5-2-AMD-CPU-使用virt-install创建虚拟机出错提示" class="headerlink" title="2.5.2 AMD CPU 使用virt-install创建虚拟机出错提示"></a>2.5.2 AMD CPU 使用virt-install创建虚拟机出错提示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus 2 --cdrom=/data/isos/CentOS-7-x86_64-Minimal-2009.iso --disk path=/var/lib/libvirt/images/centos7.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole </span><br><span class="line">WARNING No operating system detected, VM performance may suffer. Specify an OS with --os-variant <span class="keyword">for</span> optimal results.</span><br><span class="line"></span><br><span class="line">Starting install... ERROR  internal error: qemu unexpectedly closed the monitor: 2020-08-09T15:57:08.872365Z qemu-kvm: error: failed to <span class="built_in">set</span> MSR 0xe1 to 0x0 qemu-kvm: /builddir/build/BUILD/qemu-2.12.0/target/i386/kvm.c:2119: kvm_buf_set_msrs: Assertion `ret == cpu-&gt;kvm_msr_buf-&gt;nmsrs<span class="string">&#x27; failed.</span></span><br><span class="line"><span class="string">Domain installation does not appear to have been successful. </span></span><br><span class="line"><span class="string">If it was, you can restart your domain by running: virsh --connect qemu:///system start centos7 otherwise, please restart your installation.</span></span><br></pre></td></tr></table></figure>



<h3 id="2-5-3-AMD-CPU-创建虚拟机故障修复方法"><a href="#2-5-3-AMD-CPU-创建虚拟机故障修复方法" class="headerlink" title="2.5.3 AMD CPU 创建虚拟机故障修复方法"></a>2.5.3 AMD CPU 创建虚拟机故障修复方法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修复以上故障</span></span><br><span class="line">[root@centos8 ~]# <span class="built_in">tee</span> /etc/modprobe.d/qemu-system-x86.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&gt; options kvm ignore_msrs=1</span></span><br><span class="line"><span class="string">&gt; EOF</span></span><br><span class="line">options kvm ignore_msrs=1</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#reboot</span><br></pre></td></tr></table></figure>



<h1 id="3-创建虚拟机"><a href="#3-创建虚拟机" class="headerlink" title="3 创建虚拟机"></a>3 创建虚拟机</h1><h2 id="3-1-使用-virt-manager-创建虚拟机"><a href="#3-1-使用-virt-manager-创建虚拟机" class="headerlink" title="3.1 使用 virt-manager 创建虚拟机"></a>3.1 使用 virt-manager 创建虚拟机</h2><p>virt-manager 是一个图形化虚拟机管理工具,方便管理和查看虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要提前在Windows上安装X Server的相关软件,比如:Xmanager,xming等才能在Windows显示图形工具</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">export</span> DISPLAY=10.0.0.1:0.0</span><br><span class="line">[root@centos8 ~]#virt-manager</span><br><span class="line">[root@centos8 ~]#libGL error: No matching fbConfigs or visuals found</span><br><span class="line">libGL error: failed to load driver: swrast</span><br></pre></td></tr></table></figure>

<p>开启virt-manager图形界面的时候，如果当前的语言为zh_CN.UTF-8（中文），会导致乱码，要修改为英文</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前使用的语言</span></span><br><span class="line">[root@ubuntu2004 ~]#<span class="built_in">echo</span> <span class="variable">$LANG</span></span><br><span class="line">zh_CN.UTF-8	</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]#localectl </span><br><span class="line">   System Locale: LANG=zh_CN.UTF-8	</span><br><span class="line">       VC Keymap: n/a</span><br><span class="line">      X11 Layout: CN</span><br><span class="line">       X11 Model: pc105</span><br><span class="line">       </span><br><span class="line"><span class="comment">#修改</span></span><br><span class="line">[root@ubuntu2004 ~]#localectl set-locale LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure>

<p>使用virt-manager创建虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">选择安装方法</span><br><span class="line">Local install media (lSO image or CDROM)	<span class="comment">#本地安装</span></span><br><span class="line">Network install (HTTP, HTTPS, Or FTP)		<span class="comment">#网络						</span></span><br><span class="line">lmport existing disk image					<span class="comment">#导入现有的虚拟磁盘</span></span><br><span class="line">Manual install								<span class="comment">#手动安装</span></span><br><span class="line"></span><br><span class="line">选择iso光盘</span><br><span class="line">Browse：只有一个default空间，里面没有内容，实际上是系统默认的文件夹，所以需要在左下角的+号添加光盘</span><br><span class="line">Name：名字，随便起</span><br><span class="line">Type：类型，默认<span class="built_in">dir</span></span><br><span class="line">Target Path：；路径，写上存有iso光盘的路径</span><br><span class="line"></span><br><span class="line">Customize confiquration before install	<span class="comment">#安装是否需要定制，不需要不打勾，直接安装</span></span><br></pre></td></tr></table></figure>



<p><img src="/Virtualization/KVM/image-20240330130403434.png" alt="image-20240330130403434"></p>
<p><img src="/Virtualization/KVM/image-20240330130412811.png" alt="image-20240330130412811"></p>
<p><img src="/Virtualization/KVM/image-20240330130419112.png" alt="image-20240330130419112"></p>
<p><img src="/Virtualization/KVM/image-20240330130424589.png" alt="image-20240330130424589"></p>
<p><img src="/Virtualization/KVM/image-20240330130429896.png" alt="image-20240330130429896"></p>
<p><img src="/Virtualization/KVM/image-20240330130434965.png" alt="image-20240330130434965"></p>
<p><img src="/Virtualization/KVM/image-20240330130440300.png" alt="image-20240330130440300"></p>
<p><img src="/Virtualization/KVM/image-20240330130446009.png" alt="image-20240330130446009"></p>
<p><img src="/Virtualization/KVM/image-20240330130455759.png" alt="image-20240330130455759"></p>
<p>此处指定的磁盘会生成一个qcow2的稀疏格式文件,此处可以指定文件最大容量,但实际只占用实际的空间大小,使用du -sh 文件可以观察到实际大小,使用ls -l 命令看到是此处指定的大小</p>
<p><img src="/Virtualization/KVM/image-20240330130536842.png" alt="image-20240330130536842"></p>
<p><img src="/Virtualization/KVM/image-20240330130542181.png" alt="image-20240330130542181"></p>
<p><img src="/Virtualization/KVM/image-20240330130547314.png" alt="image-20240330130547314"></p>
<p>注意: 如果安装过程无法用键盘进行输入,修改Display Spice为VNC方式</p>
<p>范例: 生成的虚拟机相关文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#保存虚拟机磁盘</span></span><br><span class="line">[root@centos8 ~]#ll /var/lib/libvirt/images/centos8.qcow2 -h</span><br><span class="line">-rw------- 1 qemu qemu 21G Sep 13 20:08 /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#保存虚拟机配置</span></span><br><span class="line">[root@centos8 ~]#ll /etc/libvirt/qemu/centos8.xml</span><br></pre></td></tr></table></figure>

<p>删除虚拟机</p>
<p>不选中删除磁盘文件，数据还在，到时可以找回来，只是在列表中删除了虚拟机</p>
<p><img src="/Virtualization/KVM/image-20240214200329675.png" alt="image-20240214200329675"></p>
<h2 id="3-2-使用-virt-install-创建虚拟机"><a href="#3-2-使用-virt-install-创建虚拟机" class="headerlink" title="3.2 使用 virt-install 创建虚拟机"></a>3.2 使用 virt-install 创建虚拟机</h2><p>虽然使用virt-manager 可以方便的管理虚拟机,但如果需要批量进行虚拟机的创建管理,命令行工具virt-install 更加方便和适合</p>
<h3 id="3-2-1-virt-install-使用说明"><a href="#3-2-1-virt-install-使用说明" class="headerlink" title="3.2.1 virt-install 使用说明"></a>3.2.1 virt-install 使用说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># virt-install --help</span></span><br><span class="line">usage: virt-install --name NAME --ram RAM STORAGE INSTALL [options]</span><br><span class="line"></span><br><span class="line">使用 <span class="string">&#x27;--option=?&#x27;</span> 或者 <span class="string">&#x27;--option help&#x27;</span> 查看可用子选项</span><br><span class="line">有关示例及完整选项语法，请查看 man page。</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用指定安装介质新建虚拟机</span></span><br><span class="line">optional arguments:</span><br><span class="line">-h, --<span class="built_in">help</span> 			<span class="comment">#show this help message and exit</span></span><br><span class="line">--version 			<span class="comment">#show program&#x27;s version number and exit</span></span><br><span class="line">--connect URI 		<span class="comment">#use libvirt URI 连接到 hypervisor</span></span><br></pre></td></tr></table></figure>

<p><strong>通用选项:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-n NAME, --name NAME 	<span class="comment">#客户端虚拟机的名称</span></span><br><span class="line"></span><br><span class="line">--memory MEMORY 		<span class="comment">#配置虚拟机内存分配</span></span><br><span class="line">例如：</span><br><span class="line">--memory 1024 (<span class="keyword">in</span> MiB)</span><br><span class="line">--memory 512,maxmemory=1024</span><br><span class="line"></span><br><span class="line">--vcpus VCPUS 			<span class="comment">#为虚拟机配置的 vcpus 数。</span></span><br><span class="line">例如：</span><br><span class="line">--vcpus 5</span><br><span class="line">--vcpus 5,maxcpus=10,cpuset=1-4,6,8</span><br><span class="line">--vcpus sockets=2,cores=4,threads=2</span><br><span class="line"></span><br><span class="line">--cpu CPU 				<span class="comment">#CPU 型号及功能。</span></span><br><span class="line">例如：</span><br><span class="line">--cpu coreduo,+x2apic</span><br><span class="line">--cpu host</span><br><span class="line"></span><br><span class="line">--metadata METADATA 	<span class="comment">#配置虚拟机元数据</span></span><br><span class="line">例如：</span><br><span class="line">--metadata name=foo,title=<span class="string">&quot;My pretty title&quot;</span>,uuid=...</span><br><span class="line">--metadata description=<span class="string">&quot;My nice long description&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>安装方法选项:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">--cdrom CDROM 							<span class="comment">#光驱安装介质</span></span><br><span class="line"></span><br><span class="line">-l LOCATION, --location LOCATION 		<span class="comment">#安装源</span></span><br><span class="line">例如：</span><br><span class="line">nfs:host:/path</span><br><span class="line">http://host/path</span><br><span class="line">ftp://host/path</span><br><span class="line"></span><br><span class="line">--pxe 									<span class="comment">#使用 PXE 协议从网络引导</span></span><br><span class="line">--import 								<span class="comment">#在磁盘映像中构建虚拟机</span></span><br><span class="line">--livecd 								<span class="comment">#将光驱介质视为 Live CD</span></span><br><span class="line">-x EXTRA_ARGS, --extra-args EXTRA_ARGS 	<span class="comment">#附加到使用 --location 引导的内核的参数</span></span><br><span class="line">--initrd-inject INITRD_INJECT 			<span class="comment">#使用 --location 为 initrd 的 root 添加给定文件</span></span><br><span class="line">--os-variant DISTRO_VARIANT 			<span class="comment">#在其中安装 OS 变体的虚拟机,比如:&#x27;fedora18&#x27;、&#x27;rhel6&#x27;、&#x27;winxp&#x27; 等等</span></span><br><span class="line"></span><br><span class="line">--boot BOOT 							<span class="comment">#配置虚拟机引导设置。</span></span><br><span class="line">例如：</span><br><span class="line">--boot hd,cdrom,menu=on</span><br><span class="line">--boot init=/sbin/init (<span class="keyword">for</span> containers)</span><br><span class="line"></span><br><span class="line">--idmap IDMAP 							<span class="comment">#为 LXC 容器启用用户名称空间。</span></span><br><span class="line">例如：</span><br><span class="line">--idmap uid_start=0,uid_target=1000,uid_count=10</span><br></pre></td></tr></table></figure>

<p><strong>设备选项:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">--disk DISK 					<span class="comment">#使用不同选项指定存储。例如：</span></span><br><span class="line">--disk size=10 (new 10GiB image <span class="keyword">in</span> default location)</span><br><span class="line">--disk /my/existing/disk,cache=none</span><br><span class="line">--disk device=cdrom,bus=scsi</span><br><span class="line">--disk=?</span><br><span class="line"></span><br><span class="line">-w NETWORK, --network NETWORK 	<span class="comment">#配置虚拟机网络接口。</span></span><br><span class="line">例如：</span><br><span class="line">--network bridge=myvirbr1</span><br><span class="line">--network network=my_libvirt_virtual_net</span><br><span class="line">--network network=mynet,model=virtio,mac=00:11...</span><br><span class="line">--network none</span><br><span class="line">--network <span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">--graphics GRAPHICS 			<span class="comment">#配置虚拟机显示设置。</span></span><br><span class="line">例如：</span><br><span class="line">--graphics vnc</span><br><span class="line">--graphics spice,port=5901,tlsport=5902</span><br><span class="line">--graphics none</span><br><span class="line">--graphics vnc,password=foobar,port=5910,keymap=ja</span><br><span class="line"></span><br><span class="line">--controller CONTROLLER 		<span class="comment">#配置虚拟机控制程序设备。</span></span><br><span class="line">例如：</span><br><span class="line">--controller <span class="built_in">type</span>=usb,model=ich9-ehci1</span><br><span class="line"></span><br><span class="line">--input INPUT 					<span class="comment">#配置虚拟机输入设备。</span></span><br><span class="line">例如：</span><br><span class="line">--input tablet</span><br><span class="line">--input keyboard,bus=usb</span><br><span class="line"></span><br><span class="line">--serial SERIAL 				<span class="comment">#配置虚拟机串口设备</span></span><br><span class="line">--parallel PARALLEL 			<span class="comment">#配置虚拟机并口设备</span></span><br><span class="line">--channel CHANNEL 				<span class="comment">#配置虚拟机沟通频道</span></span><br><span class="line">--console CONSOLE 				<span class="comment">#配置虚拟机与主机之间的文本控制台连接</span></span><br><span class="line">--hostdev HOSTDEV 				<span class="comment">#将物理 USB/PCI/etc 主机设备配置为与虚拟机共享</span></span><br><span class="line"></span><br><span class="line">--filesystem FILESYSTEM 		<span class="comment">#将主机目录传递给虚拟机。</span></span><br><span class="line">例如：</span><br><span class="line">--filesystem /my/source/dir,/dir/in/guest</span><br><span class="line">--filesystem template_name,/,<span class="built_in">type</span>=template</span><br><span class="line"></span><br><span class="line">--sound [SOUND] 				<span class="comment">#配置虚拟机声音设备模拟</span></span><br><span class="line">--watchdog WATCHDOG 			<span class="comment">#配置虚拟机 watchdog 设备</span></span><br><span class="line">--video VIDEO 					<span class="comment">#配置虚拟机视频硬件。</span></span><br><span class="line">--smartcard SMARTCARD 			<span class="comment">#配置虚拟机智能卡设备。例如：--smartcard mode=passthrough</span></span><br><span class="line">--redirdev REDIRDEV 			<span class="comment">#配置虚拟机重定向设备。例如：--redirdevusb,type=tcp,server=192.168.1.1:4000</span></span><br><span class="line">--memballoon MEMBALLOON 		<span class="comment">#配置虚拟机 memballoon 设备。例如：--memballoon model=virtio</span></span><br><span class="line">--tpm TPM 						<span class="comment">#配置虚拟机 TPM 设备。例如：--tpm /dev/tpm</span></span><br><span class="line">--rng RNG 						<span class="comment">#配置虚拟机 RNG 设备。例如：--rng /dev/random</span></span><br><span class="line">--panic PANIC 					<span class="comment">#配置虚拟机 panic 设备。例如：--panic default</span></span><br></pre></td></tr></table></figure>

<p><strong>虚拟机配置选项:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">--security SECURITY 			<span class="comment">#设定域安全驱动器配置。</span></span><br><span class="line">--numatune NUMATUNE 			<span class="comment">#为域进程调整 NUMA 策略。</span></span><br><span class="line">--memtune MEMTUNE 				<span class="comment">#为域进程调整内粗策略。</span></span><br><span class="line">--blkiotune BLKIOTUNE			<span class="comment">#为域进程调整 blkio 策略。</span></span><br><span class="line">--memorybacking MEMORYBACKING 	<span class="comment">#为域进程设置内存后备策略。例如：--memorybacking hugepages=on</span></span><br><span class="line"></span><br><span class="line">--features FEATURES 			<span class="comment">#设置域 &lt;features&gt; XML。</span></span><br><span class="line">例如：</span><br><span class="line">--features acpi=off</span><br><span class="line">--features apic=on,eoi=on</span><br><span class="line"></span><br><span class="line">--clock CLOCK 					<span class="comment">#设置域 &lt;clock&gt; XML。例如：--clockoffset=localtime,rtc_tickpolicy=catchup</span></span><br><span class="line">--pm PM 						<span class="comment">#配置 VM 电源管理功能</span></span><br><span class="line">--events EVENTS 				<span class="comment">#配置 VM 生命周期管理策略</span></span><br><span class="line">--resource RESOURCE 			<span class="comment">#配置 VM 资源分区（cgroups）</span></span><br></pre></td></tr></table></figure>

<p><strong>虚拟化平台选项:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-v, --hvm 				<span class="comment">#客户端应该是一个全虚拟客户端</span></span><br><span class="line">-p, --paravirt 			<span class="comment">#这个客户端一个是一个半虚拟客户端</span></span><br><span class="line">--container 			<span class="comment">#这台虚拟机需要一个容器客户端</span></span><br><span class="line">--virt-type HV_TYPE 	<span class="comment">#要使用的管理程序名称(kvm、qemu、xen等等)</span></span><br><span class="line">--<span class="built_in">arch</span> ARCH 			<span class="comment">#模拟的 CPU 构架</span></span><br><span class="line">--machine MACHINE 		<span class="comment">#要模拟的机器类型</span></span><br></pre></td></tr></table></figure>

<p><strong>其它选项:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--autostart 			<span class="comment">#引导主机时自动启动域。</span></span><br><span class="line">--<span class="built_in">wait</span> WAIT 			<span class="comment">#等待安装完成的分钟数。</span></span><br><span class="line">--noautoconsole 		<span class="comment">#不要自动尝试连接到客户端控制台</span></span><br><span class="line">--noreboot 				<span class="comment">#完成安装后不要引导虚拟机。</span></span><br><span class="line">--print-xml [XMLONLY] 	<span class="comment">#输出所生成域 XML，而不是创建虚拟机。</span></span><br><span class="line">--dry-run 				<span class="comment">#完成安装步骤，但不要创建设备或者定义虚拟机。</span></span><br><span class="line">--check CHECK 			<span class="comment">#启用或禁用验证检查。例如：--check path_in_use=off，--check all=off</span></span><br><span class="line">-q, --quiet 			<span class="comment">#禁止无错误输出</span></span><br><span class="line">-d, --debug 			<span class="comment">#输入故障排除信息</span></span><br></pre></td></tr></table></figure>



<h3 id="3-2-2-virt-install-命令创建虚拟机"><a href="#3-2-2-virt-install-命令创建虚拟机" class="headerlink" title="3.2.2 virt-install 命令创建虚拟机"></a>3.2.2 virt-install 命令创建虚拟机</h3><h4 id="3-2-2-1-利用-qemu-img-命令创建虚拟磁盘-可选"><a href="#3-2-2-1-利用-qemu-img-命令创建虚拟磁盘-可选" class="headerlink" title="3.2.2.1 利用 qemu-img 命令创建虚拟磁盘(可选)"></a>3.2.2.1 利用 qemu-img 命令创建虚拟磁盘(可选)</h4><p><strong>注意: qemu-img create 一定要确认对应路径下没有此文件,如果存在将覆盖原文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/centos7.qcow2 20G</span><br><span class="line">Formatting <span class="string">&#x27;/var/lib/libvirt/images/centos7.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=21474836480</span><br><span class="line">cluster_size=65536 lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line"><span class="comment">#观察文件虚拟磁盘大小,比较用virt-manager创建的虚拟机磁盘文件大小</span></span><br><span class="line">[root@centos8 ~]#ll -h /var/lib/libvirt/images/centos7.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 193K Sep 13 21:25 /var/lib/libvirt/images/centos7.qcow2</span><br></pre></td></tr></table></figure>



<h4 id="3-2-2-2-利用-osinfo-query命令查看支持的OS版本"><a href="#3-2-2-2-利用-osinfo-query命令查看支持的OS版本" class="headerlink" title="3.2.2.2 利用 osinfo-query命令查看支持的OS版本"></a>3.2.2.2 利用 osinfo-query命令查看支持的OS版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出支持OS系统名称</span></span><br><span class="line"><span class="comment">#方法1</span></span><br><span class="line">[root@ubuntu2204 ~]#virt-install --osinfo list</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">[root@ubuntu2004 ~]#apt install libosinfo-bin</span><br><span class="line">[root@ubuntu2004 ~]#osinfo-query os |grep -i rhel</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看支持的OS</span></span><br><span class="line">[root@centos8 ~]#osinfo-query os| grep centos</span><br></pre></td></tr></table></figure>



<h4 id="3-2-2-3-创建虚拟机使用光盘启动并手动安装"><a href="#3-2-2-3-创建虚拟机使用光盘启动并手动安装" class="headerlink" title="3.2.2.3 创建虚拟机使用光盘启动并手动安装"></a>3.2.2.3 创建虚拟机使用光盘启动并手动安装</h4><p>范例：无需事先创建磁盘文件，直接创建虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]#virt-install --virt-type kvm --os-variant=centos7.0 --name centos7 --ram 1024 --vcpus 2 --cdrom=/data/isos/CentOS-7-x86_64-Minimal-2009.iso --disk path=/var/lib/libvirt/images/centos7.qcow2,size=10,format=qcow2,bus=virtio --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br></pre></td></tr></table></figure>

<p>范例: 事先手动创建磁盘文件，再创建虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/rocky8.qcow2 10G</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]#virt-install --virt-type kvm --os-variant=rocky8.5 --name rocky8 --memory 1024 --vcpus 2 --cdrom=/data/isos/Rocky-8.5-x86_64-minimal.iso --disk path=/var/lib/libvirt/images/rocky8.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建默认NAT模式的虚拟机,并不自动打开virt-viewer连接console,需要手动打开virt-manager 连接,并手动安装系统</span></span><br><span class="line">[root@centos8 ~]#virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus 2 --cdrom=/data/isos/CentOS-7-x86_64-Minimal-2009.iso --disk path=/var/lib/libvirt/images/centos7.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole --os-variant=centos7.0</span><br><span class="line">Starting install...</span><br><span class="line">Domain installation still <span class="keyword">in</span> progress. You can reconnect to</span><br><span class="line">the console to complete the installation process</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">export</span> DISPLAY=10.0.0.1:0.0</span><br><span class="line">[root@centos8 ~]#virt-manager</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看虚拟硬盘大小,注意到只要正在运行的虚拟对应的硬盘文件所有者和组为qemu,而虚拟机关机的为root</span></span><br><span class="line">[root@centos8 ~]#ll /var/lib/libvirt/images/ -h</span><br><span class="line">total 22G</span><br><span class="line">-rw-r--r-- 1 qemu qemu 1.6G Sep 13 22:05 centos7.qcow2</span><br><span class="line">-rw------- 1 root root 21G Sep 13 22:05 centos8.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装过程略</span></span><br><span class="line"><span class="comment">#示例：使用桥接网络</span></span><br><span class="line">[root@centos8 ~]#virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus 2 --cdrom=/data/isos/CentOS-7-x86_64-Minimal-2009.iso --disk path=/var/lib/libvirt/images/centos7.qcow2 --network --network=bridge:virbr1,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --os-variant=centos7.0</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/rocky8.qcow2 20G</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]#virt-install --virt-type kvm --name rocky8 --ram 2048 --vcpus 2 --cdrom=/data/isos/Rocky-8.5-x86_64-minimal.iso --disk path=/var/lib/libvirt/images/rocky8.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole --os-variant=rocky8.5</span><br></pre></td></tr></table></figure>



<h4 id="3-2-2-4-验证宿主机进程"><a href="#3-2-2-4-验证宿主机进程" class="headerlink" title="3.2.2.4 验证宿主机进程"></a>3.2.2.4 验证宿主机进程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#ps aux|grep qemu-kvm</span><br><span class="line">[root@centos8 ~]#pstree -p |grep kvm</span><br></pre></td></tr></table></figure>



<h2 id="3-3-基于现有虚拟机磁盘为模版创建新的虚拟机"><a href="#3-3-基于现有虚拟机磁盘为模版创建新的虚拟机" class="headerlink" title="3.3 基于现有虚拟机磁盘为模版创建新的虚拟机"></a>3.3 基于现有虚拟机磁盘为模版创建新的虚拟机</h2><h3 id="3-3-1-利用virt-manager实现"><a href="#3-3-1-利用virt-manager实现" class="headerlink" title="3.3.1 利用virt-manager实现"></a>3.3.1 利用virt-manager实现</h3><h4 id="3-3-1-1-导入镜盘文件实现"><a href="#3-3-1-1-导入镜盘文件实现" class="headerlink" title="3.3.1.1 导入镜盘文件实现"></a>3.3.1.1 导入镜盘文件实现</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于已经安装好虚拟机磁盘文件,创建新的磁盘文件</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">cp</span> -a /var/lib/libvirt/images/centos7.qcow2 /var/lib/libvirt/images/centos7-2.qcow2</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330133030309.png" alt="image-20240330133030309"></p>
<p><img src="/Virtualization/KVM/image-20240330133034147.png" alt="image-20240330133034147"></p>
<h4 id="3-3-1-2-Clone"><a href="#3-3-1-2-Clone" class="headerlink" title="3.3.1.2 Clone"></a>3.3.1.2 Clone</h4><p><img src="/Virtualization/KVM/image-20240330133047554.png" alt="image-20240330133047554"></p>
<p><img src="/Virtualization/KVM/image-20240330133055659.png" alt="image-20240330133055659"></p>
<p><img src="/Virtualization/KVM/image-20240330133106148.png" alt="image-20240330133106148"></p>
<h3 id="3-3-2-利用virt-install实现"><a href="#3-3-2-利用virt-install实现" class="headerlink" title="3.3.2 利用virt-install实现"></a>3.3.2 利用virt-install实现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 images]#<span class="built_in">pwd</span></span><br><span class="line">/var/lib/libvirt/images</span><br><span class="line"></span><br><span class="line">[root@centos8 images]#<span class="built_in">cp</span> centos8.qcow2 centos8-2.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#Ubuntu 必须使用--os-variant 选项指定OS版本</span></span><br><span class="line">[root@ubuntu2204 images]#virt-install --virt-type kvm --os-variant=centos7.0 --name centos7-3 --ram 1024 --vcpus 1 --disk bus=virtio,path=/var/lib/libvirt/images/centos7.3.qcow2 --network network=default,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 可以不使用--os-variant 选项指定OS版本</span></span><br><span class="line">[root@centos8 images]#virt-install --virt-type kvm --name centos8-2 --ram 2048 --vcpus 2 --disk bus=virtio,path=/var/lib/libvirt/images/centos8-2.qcow2 --network network=default,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br><span class="line">WARNING No operating system detected, VM performance may suffer. Specify an OS</span><br><span class="line">with --os-variant <span class="keyword">for</span> optimal results.</span><br><span class="line">Starting install...</span><br><span class="line">Domain creation completed.</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行工具,可以看到下面出现新的虚拟机</span></span><br><span class="line">[root@centos8 images]#virt-manager</span><br></pre></td></tr></table></figure>



<h3 id="3-3-3-利用virt-clone克隆实现"><a href="#3-3-3-利用virt-clone克隆实现" class="headerlink" title="3.3.3 利用virt-clone克隆实现"></a>3.3.3 利用virt-clone克隆实现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于已有的虚拟机克隆生成新的虚拟机</span></span><br><span class="line">[root@ubuntu2004 ~]#virt-clone -o rocky8 -n rocky8-3 -f /var/lib/libvirt/images/rocky8-3.qcow2</span><br><span class="line"></span><br><span class="line">-o rocky8 									<span class="comment">#指已存在的虚拟机的名称</span></span><br><span class="line">-n rocky8-3 								<span class="comment">#新虚拟机的名称</span></span><br><span class="line">-f /var/lib/libvirt/images/rocky8-3.qcow2 	<span class="comment">#新虚拟机磁盘文件路径，此文件自动生成，不需要事先创建</span></span><br></pre></td></tr></table></figure>



<h2 id="3-4-总结自动化构建虚拟机命令"><a href="#3-4-总结自动化构建虚拟机命令" class="headerlink" title="3.4 总结自动化构建虚拟机命令"></a>3.4 总结自动化构建虚拟机命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm --os-variant=rocky8.5 --name rocky8 --memory 1024 --vcpus 2 --cdrom=/data/isos/Rocky-8.5-x86_64-minimal.iso --disk path=/var/lib/libvirt/images/rocky8.qcow2 --network network=default  --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm --name centos7-2 --ram 1024 --vcpus 2 --cdrom=/data/isos/CentOS-7-x86_64-Minimal-2009.iso --disk path=/var/lib/libvirt/images/centos7-2.qcow2,size=10,format=qcow2,bus=virtio --network network=default  --graphics vnc,listen=0.0.0.0 --noautoconsole --os-variant=centos7.0</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> centos7.qcow2 centos7-2.qcow2</span><br><span class="line">virt-install --virt-type kvm --os-variant=centos7.0  --name centos7-2 --ram 1024 --vcpus 1  --disk bus=virtio,path=/var/lib/libvirt/images/centos7-2.qcow2 --network network=default,model=virtio  --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">virt-install \</span><br><span class="line"> --virt-type=kvm \</span><br><span class="line"> --name win2016 \</span><br><span class="line"> --ram 4096 \</span><br><span class="line"> --vcpus=4 \</span><br><span class="line"> --os-variant=win2k16  \</span><br><span class="line"> --cdrom=/data/isos/cn_windows_server_2016_x64_dvd_9718765.iso \</span><br><span class="line"> --network=bridge=virbr0,model=virtio \</span><br><span class="line"> --graphics vnc,listen=0.0.0.0 --noautoconsole \</span><br><span class="line"> --disk path=/var/lib/libvirt/images/win2016.qcow2,size=10,bus=virtio,format=qcow2 \</span><br><span class="line"> --disk path=/data/isos/virtio-win-0.1.189.iso,device=cdrom</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm --os-variant=rocky8.6  --name rocky8-2 --ram 1024 --vcpus 1  --disk bus=virtio,path=/var/lib/libvirt/images/rocky8-2.qcow2 --network network=default,model=virtio  --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-clone -o rocky8 -n rocky8-1 -f /var/lib/libvirt/images/rocky8-1.qcow2 </span><br></pre></td></tr></table></figure>



<h1 id="4-管理虚拟机"><a href="#4-管理虚拟机" class="headerlink" title="4 管理虚拟机"></a>4 管理虚拟机</h1><h2 id="4-1-使用半虚拟化驱动-virtio"><a href="#4-1-使用半虚拟化驱动-virtio" class="headerlink" title="4.1 使用半虚拟化驱动 virtio"></a>4.1 使用半虚拟化驱动 virtio</h2><h3 id="4-1-1-半虚拟化驱动virtio的工作原理"><a href="#4-1-1-半虚拟化驱动virtio的工作原理" class="headerlink" title="4.1.1 半虚拟化驱动virtio的工作原理"></a>4.1.1 半虚拟化驱动virtio的工作原理</h3><p>为了提高内存、硬盘、网络的性能，需要支持半虚拟化</p>
<p><img src="/Virtualization/KVM/image-20240330133438240.png" alt="image-20240330133438240"></p>
<p><img src="/Virtualization/KVM/image-20240330133607349.png" alt="image-20240330133607349"></p>
<p>virtio 是一种 I&#x2F;O 半虚拟化解决方案，是一套通用 I&#x2F;O 设备虚拟化的程序，是对半虚拟化 Hypervisor 中的一组通用 I&#x2F;O 设备的抽象，提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware等）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率，Windows 系统需要单独安装virtio驱 动，Linux系统自带virtio驱动。</p>
<p><img src="/Virtualization/KVM/image-20240330133630097.png" alt="image-20240330133630097"></p>
<p>实现IO虚拟化主要有三种方式：全虚拟化、半虚拟化和透传，全虚拟化Guest OS不会感知到自己是虚拟机，也无需修改Guest OS，但是它的效率比较低，半虚拟化Guest OS知道自己是虚拟机，通过Frontend&#x2F;Backend驱动模拟实现IO虚拟化，透传就是直接分配物理设备给VM用，但是需要解决单个硬件在多个虚拟机共享使用的问题。</p>
<p><strong>性能比较：</strong></p>
<p><a href="https://www.ilsistemista.net/index.php/virtualization/42-kvm-virtio-paravirtualized-drivers-why-they-matter.html?start=2">https://www.ilsistemista.net/index.php/virtualization/42-kvm-virtio-paravirtualized-drivers-why-they-matter.html?start=2</a></p>
<h3 id="4-1-2-半虚拟化设备统一接口virtio"><a href="#4-1-2-半虚拟化设备统一接口virtio" class="headerlink" title="4.1.2 半虚拟化设备统一接口virtio"></a>4.1.2 半虚拟化设备统一接口virtio</h3><p><img src="/Virtualization/KVM/image-20240330133712072.png" alt="image-20240330133712072"></p>
<p>通过统一的接口virtio以支持的多种硬件设备</p>
<ul>
<li>不同的虚拟设备和不同的虚拟机可以有不同的前端驱动</li>
<li>不同的硬件设备可以有不同的后端驱动</li>
<li>两者之间的交互遵循virtio的标准</li>
</ul>
<h3 id="4-1-3-驱动获取"><a href="#4-1-3-驱动获取" class="headerlink" title="4.1.3 驱动获取"></a>4.1.3 驱动获取</h3><h4 id="4-1-3-1-Linux-的-VirtIO-驱动"><a href="#4-1-3-1-Linux-的-VirtIO-驱动" class="headerlink" title="4.1.3.1 Linux 的 VirtIO 驱动"></a>4.1.3.1 Linux 的 VirtIO 驱动</h4><p>红帽RHEL 4.8之后的虚拟机会自动加载和安装virtio驱动</p>
<p><img src="/Virtualization/KVM/image-20240330133730433.png" alt="image-20240330133730433"></p>
<h4 id="4-1-3-2-Windows-操作系统需要额外安装-virtio-的驱动"><a href="#4-1-3-2-Windows-操作系统需要额外安装-virtio-的驱动" class="headerlink" title="4.1.3.2 Windows 操作系统需要额外安装 virtio 的驱动"></a>4.1.3.2 Windows 操作系统需要额外安装 virtio 的驱动</h4><p>方法1∶如果有红帽的RHN订阅，可以从以下位置下载virtio-win包:</p>
<p><a href="https://rhn.redhat.com/rhn/software/packages/details/Overview.do?pid=868414">https://rhn.redhat.com/rhn/software/packages/details/Overview.do?pid=868414</a></p>
<p>方法2∶从社区获得</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://www.Linux-kvm.org/page/Downloads</span><br><span class="line">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/</span><br><span class="line">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/</span><br><span class="line">https://docs.fedoraproject.org/en-US/quick-docs/creating-Windows-virtual-machines-using-virtio-drivers/index.html</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330133807062.png" alt="image-20240330133807062"></p>
<p><img src="/Virtualization/KVM/image-20240330133811969.png" alt="image-20240330133811969"></p>
<p><img src="/Virtualization/KVM/image-20240330133816057.png" alt="image-20240330133816057"></p>
<p><img src="/Virtualization/KVM/image-20240330133822221.png" alt="image-20240330133822221"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330133834322.png" alt="image-20240330133834322"></p>
<h3 id="4-1-4-Linux-测试安装virtio驱动前后的虚拟机性能变化"><a href="#4-1-4-Linux-测试安装virtio驱动前后的虚拟机性能变化" class="headerlink" title="4.1.4 Linux 测试安装virtio驱动前后的虚拟机性能变化"></a>4.1.4 Linux 测试安装virtio驱动前后的虚拟机性能变化</h3><p>默认虚拟机使用的是全虚拟化IDE磁盘,以下测试性能</p>
<p>使用dd 或 hdparm测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]# <span class="built_in">dd</span> | hdparm -t /dev/vda</span><br></pre></td></tr></table></figure>

<p>将硬盘默认的总线IDE修改为VirtIO</p>
<p><img src="/Virtualization/KVM/image-20240330133912562.png" alt="image-20240330133912562"></p>
<p>重新启动后,执行相同的操作,比较性能</p>
<p><img src="/Virtualization/KVM/image-20240330133921742.png" alt="image-20240330133921742"></p>
<p>默认网卡为e1000,将之修改网卡驱动为virtIO</p>
<p><img src="/Virtualization/KVM/image-20240330133930854.png" alt="image-20240330133930854"></p>
<h3 id="4-1-5-安装-Windows-Server-虚拟机"><a href="#4-1-5-安装-Windows-Server-虚拟机" class="headerlink" title="4.1.5 安装 Windows Server 虚拟机"></a>4.1.5 安装 Windows Server 虚拟机</h3><h4 id="4-1-5-1-下载并准备相关文件"><a href="#4-1-5-1-下载并准备相关文件" class="headerlink" title="4.1.5.1 下载并准备相关文件"></a>4.1.5.1 下载并准备相关文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># virtio下载地址：</span></span><br><span class="line">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtio 历史版本下载地址：</span></span><br><span class="line">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意:建议下载virtio-win-0.1.141版本，其它版本可能有问题，比如189版本会蓝屏死机,185安装后显示黄色，工作不正常</span></span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330133952760.png" alt="image-20240330133952760"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#ll /data/isos/</span><br><span class="line">total 6031060</span><br><span class="line">-rw-r--r-- 1 qemu qemu 1085276160 Aug  9 16:38 CentOS-7-x86_64-Minimal-2009.iso</span><br><span class="line">-rw-r--r-- 1 qemu qemu 1718616064 Aug  9 16:31 CentOS-8.2.2004-x86_64-minimal.iso</span><br><span class="line">-rw-r--r-- 1 root root 3368962048 Aug 11 12:00</span><br><span class="line">cn_Windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso</span><br><span class="line">-rw-r--r-- 1 root root   2949120 Aug 11 12:01 virtio-win-0.1.141_amd64.vfd</span><br><span class="line">-rw-r--r-- 1 root root  316628992 Apr  3 12:22 virtio-win-0.1.141.iso</span><br></pre></td></tr></table></figure>



<h4 id="4-1-5-2-创建-Windows-Server-虚拟机"><a href="#4-1-5-2-创建-Windows-Server-虚拟机" class="headerlink" title="4.1.5.2 创建 Windows Server 虚拟机"></a>4.1.5.2 创建 Windows Server 虚拟机</h4><p>范例: 创建 Window 2016 KVM 虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#无需事事创建磁盘文件，注意：Window 2016 磁盘大小不能低于10G</span></span><br><span class="line">[root@ubuntu2204 ~]#virt-install --osinfo list |grep win</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]#virt-install \</span><br><span class="line">  --virt-type=kvm \</span><br><span class="line">  --name win2016 \</span><br><span class="line">  --ram 4096 \</span><br><span class="line">  --vcpus=4 \</span><br><span class="line">  --os-variant=win2k16 \</span><br><span class="line">  --cdrom=/data/isos/cn_windows_server_2016_x64_dvd_9718765.iso \</span><br><span class="line">  --network=bridge=virbr0,model=virtio \</span><br><span class="line">  --graphics vnc,listen=0.0.0.0 --noautoconsole \</span><br><span class="line">  --disk path=/var/lib/libvirt/images/win2016.qcow2,size=20,bus=virtio,format=qcow2 \</span><br><span class="line">  --disk path=/data/isos/virtio-win-0.1.189.iso,device=cdrom</span><br></pre></td></tr></table></figure>

<p>范例: 创建 Window 2008-R2 KVM 虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建磁盘文件（可选）</span></span><br><span class="line">[root@centos8 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2 20G</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看支持的Windows版本</span></span><br><span class="line">[root@centos8 ~]#osinfo-query os| grep win</span><br><span class="line"></span><br><span class="line"><span class="comment">#下面版本成功</span></span><br><span class="line">[root@ubuntu2004 ~]#virt-install --virt-type kvm --name Win2008 --memory 3072 --vcpus=2 --os-variant=win2k8r2 --cdrom=/data/isos/cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1.iso --disk path=/var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2,format=qcow2,bus=virtio --disk path=/data/isos/virtio-win-0.1.141_amd64.vfd,device=floppy --network bridge=virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart</span><br><span class="line"></span><br><span class="line"><span class="comment">#无需事先创建磁盘文件</span></span><br><span class="line">[root@ubuntu2004 ~]#virt-install --virt-type kvm --name Win2008 --memory 3072 --vcpus=2 --os-variant=win2k8r2 --cdrom=/data/isos/cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1.iso --disk path=/var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2,size=10,format=qcow2,bus=virtio --disk path=/data/isos/virtio-win-0.1.141_amd64.vfd,device=floppy --network bridge=virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建 Windows 虚拟机,新版不支持下面格式,可以通过virt-manager进行安装</span></span><br><span class="line">[root@cetos8 ~]#virt-install --virt-type kvm --name Win2008 --memory 3072 --vcpus=2 --os-variant=win2k8r2 --cdrom=/data/isos/cn_Windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso --disk path=/var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2,format=qcow2,bus=virtio --disk path=/data/isos/virtio-win-0.1.141_amd64.vfd,device=floppy --network bridge=virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart</span><br><span class="line">Starting install...</span><br><span class="line">Domain installation still <span class="keyword">in</span> progress. You can reconnect to</span><br><span class="line">the console to complete the installation process.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virt-manager</span><br></pre></td></tr></table></figure>



<h4 id="4-1-5-3-安装-Windows-Server"><a href="#4-1-5-3-安装-Windows-Server" class="headerlink" title="4.1.5.3 安装 Windows Server"></a>4.1.5.3 安装 Windows Server</h4><p><img src="/Virtualization/KVM/image-20240330134222498.png" alt="image-20240330134222498"></p>
<p><img src="/Virtualization/KVM/image-20240330134227903.png" alt="image-20240330134227903"></p>
<p><img src="/Virtualization/KVM/image-20240330134232781.png" alt="image-20240330134232781"></p>
<p><img src="/Virtualization/KVM/image-20240330134238493.png" alt="image-20240330134238493"></p>
<p><img src="/Virtualization/KVM/image-20240330134401077.png" alt="image-20240330134401077"></p>
<p><img src="/Virtualization/KVM/image-20240330134406058.png" alt="image-20240330134406058"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可以临时加载光盘ISO镜像</span></span><br><span class="line">virsh attach-disk win2016 /data/isos/virtio-win-0.1.189.iso hda --<span class="built_in">type</span> cdrom --mode <span class="built_in">readonly</span></span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330134419822.png" alt="image-20240330134419822"></p>
<p><img src="/Virtualization/KVM/image-20240330134424428.png" alt="image-20240330134424428"></p>
<p>Window2016 安装硬盘驱动</p>
<p><img src="/Virtualization/KVM/image-20240330134433008.png" alt="image-20240330134433008"></p>
<p><img src="/Virtualization/KVM/image-20240330134438269.png" alt="image-20240330134438269"></p>
<p><img src="/Virtualization/KVM/image-20240330134442191.png" alt="image-20240330134442191"></p>
<p><img src="/Virtualization/KVM/image-20240330134446840.png" alt="image-20240330134446840"></p>
<p>Window2008-R2 安装硬盘驱动</p>
<p><img src="/Virtualization/KVM/image-20240330134455649.png" alt="image-20240330134455649"></p>
<p><strong>注意: 不要选中 GPU</strong></p>
<p><img src="/Virtualization/KVM/image-20240330134506943.png" alt="image-20240330134506943"></p>
<p><img src="/Virtualization/KVM/image-20240330134512330.png" alt="image-20240330134512330"></p>
<p><img src="/Virtualization/KVM/image-20240330134518053.png" alt="image-20240330134518053"></p>
<p><img src="/Virtualization/KVM/image-20240330134522577.png" alt="image-20240330134522577"></p>
<p>密码有长度和复杂度要求</p>
<p><img src="/Virtualization/KVM/image-20240330134537481.png" alt="image-20240330134537481"></p>
<h4 id="4-1-5-4-验证-Windows-virtio-驱动"><a href="#4-1-5-4-验证-Windows-virtio-驱动" class="headerlink" title="4.1.5.4 验证 Windows virtio 驱动"></a>4.1.5.4 验证 Windows virtio 驱动</h4><p><img src="/Virtualization/KVM/image-20240330134618356.png" alt="image-20240330134618356"></p>
<h4 id="4-1-5-5-安装网卡驱动"><a href="#4-1-5-5-安装网卡驱动" class="headerlink" title="4.1.5.5 安装网卡驱动"></a>4.1.5.5 安装网卡驱动</h4><p><strong>Windows 2016 网卡默认不支持，需要手动安装网卡驱动</strong></p>
<p><img src="/Virtualization/KVM/image-20240330134635372.png" alt="image-20240330134635372"></p>
<h4 id="4-1-5-6-安装PCI-内存管理驱动"><a href="#4-1-5-6-安装PCI-内存管理驱动" class="headerlink" title="4.1.5.6 安装PCI 内存管理驱动"></a>4.1.5.6 安装PCI 内存管理驱动</h4><p>windows 2016 安装驱动</p>
<p><img src="/Virtualization/KVM/image-20240330134648543.png" alt="image-20240330134648543"></p>
<p>Windows 2008-R2</p>
<p>挂载virtio-win的141的ISO光盘文件virtio-win-0.1.141.iso进行安装驱动</p>
<p>注意:不要安装其它版本,比如189版本会蓝屏死机,185安装后显示黄色，工作不正常</p>
<p><img src="/Virtualization/KVM/image-20240330134658918.png" alt="image-20240330134658918"></p>
<p><img src="/Virtualization/KVM/image-20240330134703452.png" alt="image-20240330134703452"></p>
<p><img src="/Virtualization/KVM/image-20240330134707192.png" alt="image-20240330134707192"></p>
<p><img src="/Virtualization/KVM/image-20240330134711740.png" alt="image-20240330134711740"></p>
<p><img src="/Virtualization/KVM/image-20240330134716129.png" alt="image-20240330134716129"></p>
<p><img src="/Virtualization/KVM/image-20240330134720033.png" alt="image-20240330134720033"></p>
<h4 id="4-1-5-7-生成Windows-Server-镜像模版"><a href="#4-1-5-7-生成Windows-Server-镜像模版" class="headerlink" title="4.1.5.7 生成Windows Server 镜像模版"></a>4.1.5.7 生成Windows Server 镜像模版</h4><p>利用sysprep工具,清除个性信息,下次Windows开机时, 会自动生成初始化个性信息</p>
<p><img src="/Virtualization/KVM/image-20240330134730640.png" alt="image-20240330134730640"></p>
<p><strong>下次开机需要重新初始化</strong></p>
<p><img src="/Virtualization/KVM/image-20240330134741574.png" alt="image-20240330134741574"></p>
<h4 id="4-1-5-8-基于模版创建新的Windows的虚拟机"><a href="#4-1-5-8-基于模版创建新的Windows的虚拟机" class="headerlink" title="4.1.5.8 基于模版创建新的Windows的虚拟机"></a>4.1.5.8 基于模版创建新的Windows的虚拟机</h4><p>范例：Windows 2016</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]#virt-clone -o win2016 -f /var/lib/libvirt/images/win2016-1.qcow2 -n win2016-1</span><br><span class="line">Allocating <span class="string">&#x27;win2016-1.qcow2&#x27;</span>                          </span><br><span class="line">                                  | 9.7 GB</span><br><span class="line"> 00:00:16 ...</span><br><span class="line">Clone <span class="string">&#x27;win2016-1&#x27;</span> created successfully.</span><br></pre></td></tr></table></figure>

<p>范例: Windows 2008-R2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 images]#<span class="built_in">pwd</span></span><br><span class="line">/var/lib/libvirt/images</span><br><span class="line"></span><br><span class="line">[root@centos7 images]#<span class="built_in">cp</span> windows2008.qcow2 windows2008-2.qcow2</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]#virt-install --virt-type kvm --name Win2008-2 --memory 3072 --vcpus=2 --os-variant=win2k8r2 --disk path=/var/lib/libvirt/images/windows2008-2.qcow2,format=qcow2,bus=virtio --network bridge=virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br><span class="line"></span><br><span class="line"><span class="comment">#克隆方法有问题</span></span><br><span class="line">[root@ubuntu2204 ~]#virt-clone -o Win2008-template -f /var/lib/libvirt/images/Win2008-1.qcow2 -n Win2008-1</span><br><span class="line">ERROR  expected str, bytes or os.PathLike object, not NoneType</span><br></pre></td></tr></table></figure>



<h2 id="4-2-libvirt-架构"><a href="#4-2-libvirt-架构" class="headerlink" title="4.2 libvirt 架构"></a>4.2 libvirt 架构</h2><p><img src="/Virtualization/KVM/image-20240330134834751.png" alt="image-20240330134834751"></p>
<p><strong>注意: 如果libvirtd服务意外关闭,将导致相关工具,如:virt-manager等无法和虚拟机连接,但虚拟机仍会正常运行</strong></p>
<p>范例: libvirtd 服务功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh list</span><br><span class="line">Id  Name                State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2   centos8              running</span><br><span class="line">3   Win_2008_r2-x86_64   running</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]#systemctl stop libvirtd libvirtd.socket libvirtd-admin.socket libvirtd-ro.socket</span><br><span class="line">[root@centos8 ~]#systemctl stop libvirtd</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh list</span><br><span class="line">error: failed to connect to the hypervisor</span><br><span class="line">error: Failed to connect socket to <span class="string">&#x27;/var/run/libvirt/libvirt-sock&#x27;</span>: No such file or directory</span><br><span class="line"></span><br><span class="line"><span class="comment">#virt-manager工具也无法连接虚拟机</span></span><br><span class="line"><span class="comment">#如果再次重新运行virt-manage，会自动激活libvirtd服务</span></span><br><span class="line"><span class="comment">#但是systemctl stop libvirtd.socket libvirtd-admin.socket libvirtd-ro.socket libvirtd.service，将无法自动激活libvirtd.service</span></span><br><span class="line">[root@ubuntu2204 ~]#systemctl stop libvirtd.socket libvirtd-admin.socket libvirtd-ro.socket libvirtd.service</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]#virsh list</span><br><span class="line">error: failed to connect to the hypervisor</span><br><span class="line">error: Failed to connect socket to <span class="string">&#x27;/var/run/libvirt/libvirt-sock&#x27;</span>: Connection refused</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]#systemctl start libvirtd.socket</span><br><span class="line">[root@ubuntu2204 ~]#systemctl status  libvirtd.socket</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]#virsh list</span><br><span class="line">Id  Name       State</span><br><span class="line">---------------------------</span><br><span class="line">20  win2016-1  running</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330134913215.png" alt="image-20240330134913215"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#systemctl start libvirtd</span><br><span class="line">[root@centos8 ~]#virsh list</span><br><span class="line">Id  Name                State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2   centos8             running</span><br><span class="line">3   Win_2008_r2-x86_64  running</span><br><span class="line"></span><br><span class="line"><span class="comment">#virt-manager工具也恢复连接虚拟机</span></span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330135022573.png" alt="image-20240330135022573"></p>
<h2 id="4-3-virt-manager-管理虚拟机"><a href="#4-3-virt-manager-管理虚拟机" class="headerlink" title="4.3 virt-manager 管理虚拟机"></a>4.3 virt-manager 管理虚拟机</h2><p>virt-manager是一个图形化工具,主要功能:</p>
<ul>
<li><p>定义和创建虚拟机</p>
</li>
<li><p>硬件管理</p>
</li>
<li><p>性能监视</p>
</li>
<li><p>控制台</p>
</li>
<li><p>在线和离线迁移</p>
</li>
<li><p>虚拟机的保存和恢复、暂停和继续、关闭和启动</p>
<p>​</p>
</li>
</ul>
<h3 id="4-3-1-启动菜单"><a href="#4-3-1-启动菜单" class="headerlink" title="4.3.1 启动菜单"></a>4.3.1 启动菜单</h3><p><img src="/Virtualization/KVM/image-20240330135056261.png" alt="image-20240330135056261"></p>
<p>开机后,按提示按ESC键,会出下面启动菜单</p>
<p><img src="/Virtualization/KVM/image-20240330135106693.png" alt="image-20240330135106693"></p>
<h3 id="4-3-2-远程管理KVM宿主机"><a href="#4-3-2-远程管理KVM宿主机" class="headerlink" title="4.3.2 远程管理KVM宿主机"></a>4.3.2 远程管理KVM宿主机</h3><p>Ubuntu20.04和Rocky8相互支持远程连接</p>
<p>可以连接到远程的宿主机进行虚拟机的管理</p>
<p><img src="/Virtualization/KVM/image-20240330135118486.png" alt="image-20240330135118486"></p>
<p><img src="/Virtualization/KVM/image-20240330135122599.png" alt="image-20240330135122599"></p>
<p><img src="/Virtualization/KVM/image-20240330135126429.png" alt="image-20240330135126429"></p>
<p>解决上面问题的方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法1:在本机安装openssh-askpass包</span></span><br><span class="line">[root@ubuntu2004 ~]#apt install -y ssh-askpass</span><br><span class="line">[root@centos8 ~]#yum -y install openssh-askpass</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2:实现基于本机到远程主机的key验证</span></span><br><span class="line">[root@centos8 ~]#ssh-copy-id 10.0.0.18</span><br></pre></td></tr></table></figure>

<p>再次连接成功</p>
<p><img src="/Virtualization/KVM/image-20240330135200729.png" alt="image-20240330135200729"></p>
<p><img src="/Virtualization/KVM/image-20240330135206709.png" alt="image-20240330135206709"></p>
<p><img src="/Virtualization/KVM/image-20240330135212409.png" alt="image-20240330135212409"></p>
<h3 id="4-3-3-虚拟机的性能监控"><a href="#4-3-3-虚拟机的性能监控" class="headerlink" title="4.3.3 虚拟机的性能监控"></a>4.3.3 虚拟机的性能监控</h3><p>先选择需要监控的项目</p>
<p><img src="/Virtualization/KVM/image-20240330135221043.png" alt="image-20240330135221043"></p>
<p>根据上面的项目,选择对应显示的项目(可选项由前一页的项目决定)</p>
<p><img src="/Virtualization/KVM/image-20240330135229192.png" alt="image-20240330135229192"></p>
<h3 id="4-3-4-管理快照"><a href="#4-3-4-管理快照" class="headerlink" title="4.3.4 管理快照"></a>4.3.4 管理快照</h3><p><img src="/Virtualization/KVM/image-20240330135239134.png" alt="image-20240330135239134"></p>
<p><img src="/Virtualization/KVM/image-20240330135244895.png" alt="image-20240330135244895"></p>
<p><img src="/Virtualization/KVM/image-20240330135250038.png" alt="image-20240330135250038"></p>
<h2 id="4-4-virsh-命令行工具"><a href="#4-4-virsh-命令行工具" class="headerlink" title="4.4 virsh 命令行工具"></a>4.4 virsh 命令行工具</h2><h3 id="4-4-1-virsh-命令说明"><a href="#4-4-1-virsh-命令说明" class="headerlink" title="4.4.1 virsh 命令说明"></a>4.4.1 virsh 命令说明</h3><p>virsh是使用libvirt managementAPI构建的管理工具,相比virt-manager可以提高效率</p>
<p>virsh的名称的含义是virtualization shell</p>
<h4 id="4-4-1-1-两种工作模式"><a href="#4-4-1-1-两种工作模式" class="headerlink" title="4.4.1.1 两种工作模式"></a>4.4.1.1 两种工作模式</h4><p>交互模式</p>
<p>非交互模式</p>
<p><img src="/Virtualization/KVM/image-20240330135320676.png" alt="image-20240330135320676"></p>
<p><img src="/Virtualization/KVM/image-20240330135324581.png" alt="image-20240330135324581"></p>
<h4 id="4-4-1-2-virsh-主要功能"><a href="#4-4-1-2-virsh-主要功能" class="headerlink" title="4.4.1.2 virsh 主要功能"></a>4.4.1.2 virsh 主要功能</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh <span class="built_in">help</span></span><br><span class="line">Domain Management (<span class="built_in">help</span> keyword <span class="string">&#x27;domain&#x27;</span>):		<span class="comment">#域管理（帮助关键字“域”）：</span></span><br><span class="line">Domain Monitoring (<span class="built_in">help</span> keyword <span class="string">&#x27;monitor&#x27;</span>):		<span class="comment">#域监控（帮助关键字“monitor”）：</span></span><br><span class="line">Host and Hypervisor (<span class="built_in">help</span> keyword <span class="string">&#x27;host&#x27;</span>):		<span class="comment">#主机和虚拟机管理程序（帮助关键字“host”）：</span></span><br><span class="line">Interface (<span class="built_in">help</span> keyword <span class="string">&#x27;interface&#x27;</span>):			<span class="comment">#接口（帮助关键字“interface”）：</span></span><br><span class="line">Network Filter (<span class="built_in">help</span> keyword <span class="string">&#x27;filter&#x27;</span>):			<span class="comment">#网络过滤器（帮助关键字“过滤器”）：</span></span><br><span class="line">Networking (<span class="built_in">help</span> keyword <span class="string">&#x27;network&#x27;</span>):			<span class="comment">#网络（帮助关键字“网络”）：</span></span><br><span class="line">Node Device (<span class="built_in">help</span> keyword <span class="string">&#x27;nodedev&#x27;</span>):			<span class="comment">#节点设备（帮助关键字“nodedev”）：</span></span><br><span class="line">Secret (<span class="built_in">help</span> keyword <span class="string">&#x27;secret&#x27;</span>):					</span><br><span class="line">Snapshot (<span class="built_in">help</span> keyword <span class="string">&#x27;snapshot&#x27;</span>):				<span class="comment">#快照（帮助关键字“快照”）：</span></span><br><span class="line">Storage Pool (<span class="built_in">help</span> keyword <span class="string">&#x27;pool&#x27;</span>):				<span class="comment">#存储池（帮助关键字“pool”）：</span></span><br><span class="line">Storage Volume (<span class="built_in">help</span> keyword <span class="string">&#x27;volume&#x27;</span>):			<span class="comment">#存储卷（帮助关键字“卷”）：</span></span><br><span class="line">Virsh itself (<span class="built_in">help</span> keyword <span class="string">&#x27;virsh&#x27;</span>):			<span class="comment">#Virsh 本身（帮助关键字“virsh”）：</span></span><br></pre></td></tr></table></figure>



<h4 id="4-4-1-3-virsh-命令格式"><a href="#4-4-1-3-virsh-命令格式" class="headerlink" title="4.4.1.3 virsh 命令格式"></a>4.4.1.3 virsh 命令格式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh --<span class="built_in">help</span></span><br><span class="line">virsh [options]... [&lt;command_string&gt;]</span><br><span class="line">virsh [options]... &lt;<span class="built_in">command</span>&gt; [args...]</span><br><span class="line"></span><br><span class="line">options:</span><br><span class="line">  -c | --connect=URI   				<span class="comment">#虚拟机监控程序连接 URI</span></span><br><span class="line">  -d | --debug=NUM    				<span class="comment">#调试级别 [0-4]</span></span><br><span class="line">  -e | --escape &lt;char&gt;   			<span class="comment">#设置控制台的转义序列</span></span><br><span class="line">  -h | --<span class="built_in">help</span>       				<span class="comment">#帮助</span></span><br><span class="line">  -k | --keepalive-interval=NUM		<span class="comment">#保持活动间隔（以秒为单位），0 表示禁用</span></span><br><span class="line">  -K | --keepalive-count=NUM		<span class="comment">#可能错过的 keepalive 消息数</span></span><br><span class="line">  -l | --<span class="built_in">log</span>=FILE     				<span class="comment">#将日志记录输出到文件</span></span><br><span class="line">  -q | --quiet      				<span class="comment">#静音模式</span></span><br><span class="line">  -r | --<span class="built_in">readonly</span>     				<span class="comment">#连接只读</span></span><br><span class="line">  -t | --timing      				<span class="comment">#打印时序信息</span></span><br><span class="line">  -v           						<span class="comment">#short version</span></span><br><span class="line">  -V           						<span class="comment">#long version</span></span><br><span class="line">  --version[=TYPE]  				<span class="comment">#version, TYPE is short or long (default short)</span></span><br></pre></td></tr></table></figure>



<h4 id="4-4-1-4-virsh-子命令说明"><a href="#4-4-1-4-virsh-子命令说明" class="headerlink" title="4.4.1.4 virsh 子命令说明"></a>4.4.1.4 virsh 子命令说明</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>           		<span class="comment">#打印基本帮助信息</span></span><br><span class="line">attach-device       <span class="comment">#使用XML文件中的设备定义在虚拟机中添加设备</span></span><br><span class="line">attach-disk 		<span class="comment">#在虚拟机中附加新磁盘设备</span></span><br><span class="line">attach-interface 	<span class="comment">#在虚拟机中附加新网络接口</span></span><br><span class="line">create           	<span class="comment">#从 XML 配置文件生成虚拟机并启动新虚拟机</span></span><br><span class="line">define           	<span class="comment">#为虚拟机输出XML配置文件</span></span><br><span class="line">destroy 			<span class="comment">#强制虚拟机停止</span></span><br><span class="line">detach-device       <span class="comment">#从虚拟机中分离设备，使用同样的XML 描述作为命令</span></span><br><span class="line">attach-device</span><br><span class="line">detach-disk         <span class="comment">#从虚拟机中分离磁盘设备</span></span><br><span class="line">detach-interface    <span class="comment">#从虚拟机中分离网络接口</span></span><br><span class="line">domblkstat          <span class="comment">#显示正在运行的虚拟机的块设备统计</span></span><br><span class="line">domid           	<span class="comment">#显示虚拟机ID</span></span><br><span class="line">domifstat           <span class="comment">#显示正在运行的虚拟机的网络接口统计</span></span><br><span class="line">dominfo           	<span class="comment">#显示虚拟机信息</span></span><br><span class="line">domname           	<span class="comment">#显示虚拟机名称</span></span><br><span class="line">domstate           	<span class="comment">#显示虚以机状态</span></span><br><span class="line">domuuid           	<span class="comment">#显示虚拟机UUID</span></span><br><span class="line">dumpxml           	<span class="comment">#输出虚拟机 XML配置文件</span></span><br><span class="line">list           		<span class="comment">#列出所有虚拟机</span></span><br><span class="line">migrate           	<span class="comment">#将虚拟机迁移到另一台主机中</span></span><br><span class="line">nodeinfo           	<span class="comment">#有关管理程序的输出信息</span></span><br><span class="line">quit           		<span class="comment">#退出这个互动终端</span></span><br><span class="line">reboot           	<span class="comment">#重新启动虚拟机</span></span><br><span class="line">restore           	<span class="comment">#恢复以前保存在文件中的虚拟机</span></span><br><span class="line">resume           	<span class="comment">#恢复暂停的虚拟机</span></span><br><span class="line">save           		<span class="comment">#将虚拟机当前状态保存到某个文件中</span></span><br><span class="line">setmaxmem           <span class="comment">#为管理程序设定内存上限</span></span><br><span class="line">setmem           	<span class="comment">#为虚拟机设定分配的内存</span></span><br><span class="line">setvcpus 			<span class="comment">#修改为虚拟机分配的虚拟CPU数目</span></span><br><span class="line">shutdown 			<span class="comment">#关闭某个虚拟机</span></span><br><span class="line">start           	<span class="comment">#启动未激活的虚拟机</span></span><br><span class="line"><span class="built_in">suspend</span>           	<span class="comment">#暂停虚拟机</span></span><br><span class="line">undefine           	<span class="comment">#删除与虚拟机关联的所有文件</span></span><br><span class="line">vepuinfo           	<span class="comment">#显示虚以机的虚拟CPU信息</span></span><br><span class="line">vcpupin           	<span class="comment">#控制虚拟机的虚拟CPU亲和性</span></span><br><span class="line">version           	<span class="comment">#显示virsh版本</span></span><br></pre></td></tr></table></figure>



<h4 id="4-4-1-5-查看子命令帮助"><a href="#4-4-1-5-查看子命令帮助" class="headerlink" title="4.4.1.5 查看子命令帮助"></a>4.4.1.5 查看子命令帮助</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh <span class="built_in">help</span> COMMAND</span><br></pre></td></tr></table></figure>

<p>范例: 查看子命令 list 命令用法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh <span class="built_in">help</span> list</span><br><span class="line">NAME</span><br><span class="line"> 	list - list domains</span><br><span class="line">SYNOPSIS</span><br><span class="line"> 	list [--inactive] [--all] [--transient] [--persistent] [--with-snapshot] [--without-snapshot] [--state-running] [--state-paused] [--state-shutoff] [--state-other] [--autostart] [--no-autostart] [--with-managed-save] [--without-managed-save] [--uuid] [--name] [--table] [--managed-save] [--title] DESCRIPTION</span><br><span class="line">	Returns list of domains.</span><br><span class="line"> </span><br><span class="line">OPTIONS</span><br><span class="line">  --inactive    			<span class="comment">#list inactive domains</span></span><br><span class="line">  --all      				<span class="comment">#list inactive &amp; active domains</span></span><br><span class="line">  --transient   			<span class="comment">#list transient domains</span></span><br><span class="line">  --persistent   			<span class="comment">#list persistent domains</span></span><br><span class="line">  --with-snapshot 			<span class="comment">#list domains with existing snapshot</span></span><br><span class="line">  --without-snapshot 		<span class="comment">#list domains without a snapshot</span></span><br><span class="line">  --state-running 			<span class="comment">#list domains in running state</span></span><br><span class="line">  --state-paused  			<span class="comment">#list domains in paused state</span></span><br><span class="line">  --state-shutoff 			<span class="comment">#list domains in shutoff state</span></span><br><span class="line">  --state-other  			<span class="comment">#list domains in other states</span></span><br><span class="line">  --autostart   			<span class="comment">#list domains with autostart enabled</span></span><br><span class="line">  --no-autostart  			<span class="comment">#list domains with autostart disabled</span></span><br><span class="line">  --with-managed-save 		<span class="comment">#list domains with managed save state</span></span><br><span class="line">  --without-managed-save 	<span class="comment">#list domains without managed save</span></span><br><span class="line">  --uuid      				<span class="comment">#list uuid&#x27;s only</span></span><br><span class="line">  --name      				<span class="comment">#list domain names only</span></span><br><span class="line">  --table     				<span class="comment">#list table (default)</span></span><br><span class="line">  --managed-save  			<span class="comment">#mark inactive domains with managed save state</span></span><br><span class="line">  --title     				<span class="comment">#show domain title</span></span><br></pre></td></tr></table></figure>



<h3 id="4-4-2-启动和关闭虚拟机"><a href="#4-4-2-启动和关闭虚拟机" class="headerlink" title="4.4.2 启动和关闭虚拟机"></a>4.4.2 启动和关闭虚拟机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前启动的虚拟机</span></span><br><span class="line">[root@centos8 ~]#virsh list</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有虚拟机</span></span><br><span class="line">[root@centos8 ~]#virsh list --all</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">[root@centos8 ~]#virsh start centos8</span><br><span class="line"></span><br><span class="line"><span class="comment">#正常关机</span></span><br><span class="line">[root@centos8 ~]#virsh shutdown 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#强制关机,慎重使用</span></span><br><span class="line">[root@centos8 ~]#virsh destroy 1</span><br><span class="line">[root@centos8 ~]#virsh shutdown 2</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出开机状态虚拟机的UUID和名称</span></span><br><span class="line">[root@centos8 ~]#virsh list --uuid --name</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出所有虚拟机的UUID和name</span></span><br><span class="line">[root@ubuntu2004 ~]#virsh list --uuid --all --name</span><br></pre></td></tr></table></figure>

<p>在virt-manager 中可以看到关机状态</p>
<p><img src="/Virtualization/KVM/image-20240330144234490.png" alt="image-20240330144234490"></p>
<p><img src="/Virtualization/KVM/image-20240330144239979.png" alt="image-20240330144239979"></p>
<p>查看虚拟机UUID,通过UUID启动关闭虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看虚拟机的UUID</span></span><br><span class="line">[root@centos8 ~]#virsh domuuid 1</span><br><span class="line">99765478-cfb1-4164-b038-f62004ccab9e</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh destroy 99765478-cfb1-4164-b038-f62004ccab9e</span><br><span class="line">Domain 99765478-cfb1-4164-b038-f62004ccab9e destroyed</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh domuuid centos8</span><br><span class="line">99765478-cfb1-4164-b038-f62004ccab9e</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh start 99765478-cfb1-4164-b038-f62004ccab9e</span><br><span class="line">Domain centos8 started</span><br></pre></td></tr></table></figure>



<h3 id="4-4-3-暂停和恢复虚拟机"><a href="#4-4-3-暂停和恢复虚拟机" class="headerlink" title="4.4.3 暂停和恢复虚拟机"></a>4.4.3 暂停和恢复虚拟机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh <span class="built_in">suspend</span> centos8</span><br><span class="line">Domain centos8 suspended</span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟机暂停后,宿主机中还存有相关的进程</span></span><br><span class="line">[root@centos8 ~]#ps aux|grep kvm</span><br><span class="line">qemu     1699 36.9 16.0 4439296 1309300 ?   Sl  10:10  5:28 /usr/libexec/qemu-kvm -name guest=centos8,debug-threads=on -S -objectsecret,<span class="built_in">id</span>=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh resume 1</span><br><span class="line">Domain 1 resumed</span><br></pre></td></tr></table></figure>



<h3 id="4-4-4-配置虚拟机开机自动启动"><a href="#4-4-4-配置虚拟机开机自动启动" class="headerlink" title="4.4.4 配置虚拟机开机自动启动"></a>4.4.4 配置虚拟机开机自动启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh autostart centos8</span><br><span class="line">Domain centos8 marked as autostarted</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置虚拟机随宿主机启动而自动启动,本质就是在下面目录生成软链接</span></span><br><span class="line">[root@centos8 ~]#ll /etc/libvirt/qemu/autostart/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt;/etc/libvirt/qemu/centos8.xml</span><br><span class="line">lrwxrwxrwx 1 root root 40 Sep 17 09:18 Win_2008_r2-x86_64.xml -&gt;/etc/libvirt/qemu/Win_2008_r2-x86_64.xml</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh autostart 1 --<span class="built_in">disable</span></span><br><span class="line">Domain 1 unmarked as autostarted</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#ll /etc/libvirt/qemu/autostart/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt;/etc/libvirt/qemu/centos8.xml</span><br></pre></td></tr></table></figure>

<p>在virt-manager工具中也可以配置开机自启动</p>
<p><img src="/Virtualization/KVM/image-20240330144522022.png" alt="image-20240330144522022"></p>
<h3 id="4-4-5-查看虚拟机配置"><a href="#4-4-5-查看虚拟机配置" class="headerlink" title="4.4.5 查看虚拟机配置"></a>4.4.5 查看虚拟机配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#每个虚拟机配置都存放在/etc/libvirt/qemu目录下的xml文件中</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">ls</span> /etc/libvirt/qemu/ -l</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看指定虚拟机的配置,以下命令相当于查看 /etc/libvirt/qemu/centos8.xml</span></span><br><span class="line">[root@centos8 ~]#virsh dumpxml centos8</span><br></pre></td></tr></table></figure>



<h3 id="4-4-6-删除虚拟机配置"><a href="#4-4-6-删除虚拟机配置" class="headerlink" title="4.4.6 删除虚拟机配置"></a>4.4.6 删除虚拟机配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除虚拟机配置,但不删除磁盘文件</span></span><br><span class="line">[root@centos8 ~]#virsh undefine centos8-vm4</span><br><span class="line">Domain centos8-vm4 has been undefined</span><br><span class="line"></span><br><span class="line"><span class="comment">#对应虚拟机xml的配置文件被删除</span></span><br><span class="line">[root@centos8 ~]#ll /etc/libvirt/qemu/</span><br><span class="line"></span><br><span class="line"><span class="comment">#对应的磁盘文件并没有删除</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">ls</span> /var/lib/libvirt/images/</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除虚拟机包括磁盘文件</span></span><br><span class="line">[root@ubuntu2004 ~]#virsh undefine k8s-node-05 --remove-all-storage</span><br><span class="line">Domain k8s-node-05 has been undefined</span><br><span class="line">Volume <span class="string">&#x27;vda&#x27;</span>(/var/lib/libvirt/images/k8s-node-05.qcow2) removed.</span><br></pre></td></tr></table></figure>



<h3 id="4-4-7-冷迁移虚拟机"><a href="#4-4-7-冷迁移虚拟机" class="headerlink" title="4.4.7 冷迁移虚拟机"></a>4.4.7 冷迁移虚拟机</h3><p>将一个宿主机的处于关机状态的虚拟机迁移到另一台宿主机，注意: 不支持Ubuntu和Rocky8宿主机之间迁移</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在一台目标宿主机安装相关虚拟化软件</span></span><br><span class="line">[root@ubuntu2004 ~]#apt update</span><br><span class="line">[root@ubuntu2004 ~]#apt -y install qemu-kvm virt-manager libvirt-daemon-system</span><br><span class="line"></span><br><span class="line"><span class="comment">#在源宿主机查看虚拟机的相关文件</span></span><br><span class="line">[root@ubuntu2004 ~]#virsh dumpxml --domain rocky8-template</span><br><span class="line">......</span><br><span class="line"> &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">  &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span><br><span class="line">  &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/var/lib/libvirt/images/rocky8-template.qcow2&#x27;</span>/&gt;</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者#查看块设备</span></span><br><span class="line">[root@ubuntu2004 ~]#virsh domblklist rocky8-template</span><br><span class="line">Target   Source</span><br><span class="line">------------------------------------------------</span><br><span class="line">vda      /var/lib/libvirt/images/rocky8-template.qcow2</span><br><span class="line">vdb      -</span><br><span class="line"></span><br><span class="line"><span class="comment">#复制源宿主机上的虚拟机的两个文件到目标宿主机</span></span><br><span class="line">[root@ubuntu2004 ~]#scp /etc/libvirt/qemu/rocky8-template.xml 10.0.0.101:/etc/libvirt/qemu/</span><br><span class="line">[root@ubuntu2004 ~]#scp /var/lib/libvirt/images/rocky8-template.qcow2 10.0.0.101:/var/lib/libvirt/images</span><br><span class="line"></span><br><span class="line"><span class="comment">#在目标宿主机不重启服务无法看到新的虚拟机</span></span><br><span class="line">[root@ubuntu2004 ~]#virsh list --all</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]#systemctl restart libvirtd</span><br><span class="line"></span><br><span class="line"><span class="comment">#在目标宿主机重启服务后看到新的虚拟机</span></span><br><span class="line">[root@ubuntu2004 ~]#virsh list --all</span><br><span class="line">Id  Name             State</span><br><span class="line">----------------------------------</span><br><span class="line">    rocky8-template  shut off</span><br></pre></td></tr></table></figure>



<h3 id="4-4-8-热迁移虚拟机"><a href="#4-4-8-热迁移虚拟机" class="headerlink" title="4.4.8 热迁移虚拟机"></a>4.4.8 热迁移虚拟机</h3><p>将KVM主机上的数据都利用NFS共享存储，不存储在自身主机硬盘上</p>
<h2 id="4-5-virt-what"><a href="#4-5-virt-what" class="headerlink" title="4.5 virt-what"></a>4.5 virt-what</h2><p>virt-what 可以判断当前系统是虚拟机还是物理机</p>
<p>如果系统运行在一个物理机上，virt-what 命令将不会返回任何结果(一般是物理机，也可能是不能识别的虚拟化技术)</p>
<p>相反，如果是运行在虚拟机上，将会输出虚拟机的一些信息，例如kvm、vmware等</p>
<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CenOS安装</span></span><br><span class="line">[root@centos7 ~]#yum install -y virt-what</span><br><span class="line"></span><br><span class="line"><span class="comment">#Ubuntu安装</span></span><br><span class="line">[root@ubuntu2004 ~]#apt install -y virt-what</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看系统</span></span><br><span class="line"><span class="comment">#vmware虚拟机执行结果</span></span><br><span class="line">[root@ubuntu2004 ~]#virt-what</span><br><span class="line">vmware</span><br><span class="line"></span><br><span class="line"><span class="comment">#阿里云ECS执行结果</span></span><br><span class="line">[root@centos7-liyun-pc ~]# virt-what</span><br><span class="line">kvm</span><br><span class="line"></span><br><span class="line"><span class="comment">#物理机执行结果</span></span><br><span class="line">root@user:~# virt-what</span><br><span class="line">root@user:~#</span><br></pre></td></tr></table></figure>



<h1 id="5-存储管理"><a href="#5-存储管理" class="headerlink" title="5 存储管理"></a>5 存储管理</h1><h2 id="5-1-KVM存储模式"><a href="#5-1-KVM存储模式" class="headerlink" title="5.1 KVM存储模式"></a>5.1 KVM存储模式</h2><p><strong>基于文件系统的存储</strong></p>
<ul>
<li>dir: Filesystem Directory 需要有挂载点的文件系统</li>
<li>fs: Pre-Formatted Block Device 无需挂载的文件系统,如:位于SAN存储的文件系统,可支持多个主机同时访问,而本地文件系统不支持</li>
<li>netfs: Network Exported Directory 网络文件系统,比如:NFS,SAMBA等</li>
</ul>
<p><strong>基于设备的存储</strong></p>
<p>无需文件系统,性能更好,但可管理性差,无法实现快照</p>
<ul>
<li>Disk: Physical Disk Device</li>
<li>Iscsi: isCSI Target</li>
<li>logical:LVM Volume Group</li>
</ul>
<h2 id="5-2-虚拟磁盘类型"><a href="#5-2-虚拟磁盘类型" class="headerlink" title="5.2 虚拟磁盘类型"></a>5.2 虚拟磁盘类型</h2><ul>
<li><p>固定Fixed</p>
<p>  在配置时，指定磁盘大小</p>
<p>  不管在虚拟磁盘上实际存储多少数据，都将占用相同大小宿主机的磁盘空间动态Dynamic</p>
</li>
<li><p>初始空间占用小</p>
<p>  随着空间的使用逐渐增长到最大容量，但是只根据需求使用更多的空间</p>
</li>
<li><p>差异Differencing</p>
<p>  因为创建是差异磁盘，所以只保存变更的数据</p>
<p>  例如，将操作系统安装在父盘，然后创建差异化磁盘来执行进一步配置</p>
</li>
</ul>
<h2 id="5-3-虚拟镜像文件格式"><a href="#5-3-虚拟镜像文件格式" class="headerlink" title="5.3 虚拟镜像文件格式"></a>5.3 虚拟镜像文件格式</h2><p>镜像文件储存在主机文件系统中。它可以储存在本地文件系统中，如 ext4 或 xfs；或网络文件系统中，如 NFS 。例如 libguestfs 这样的工具，能管理、备份及监控文件。KVM 上的磁盘镜像格式包括：</p>
<ul>
<li><p>raw</p>
<p>  此为默认磁盘格式,但并是一种真正的磁盘格式，而是代表虚拟机所使用的原始镜像,它并不存储元数据，因此可作为保证虚拟机兼容性的候选方案。然而，也正因为它不存储元数据，因此不支持某些高级特往，比如快照和压缩等格式简单，容易转换为其他的格式。</p>
<p>  如果主机文件系统允许，raw 文件可以是预分配（pre-allocated）或 稀疏（sparse）。稀疏文件根据需求分配主机磁盘空间，因此它是一种精简配置形式（thin provisioning）。预分配文件的所有空间需要被预先分配，但它比稀疏文件性能好。当对磁盘 I&#x2F;O 性能要求非常高，而且通常不需要通过网络传输镜像文件时，可以使用 raw文件</p>
<p>  优点 : 性能好</p>
<p>  缺点 : 空间占用大,功能较少,生产不推荐使用</p>
</li>
<li><p>cow : copy-on-write格式，昙花一现</p>
</li>
<li><p>qcow : QEMU早期的copy-on-write格式，过渡性方案</p>
</li>
<li><p>qcow2</p>
<p>  qcow2 镜像文件提供许多高级磁盘镜像特征，如快照、压缩及加密。它们可以用来代表通过模板镜像创建的虚拟机。因为只有虚拟机写入的扇区部分才会分配在镜像中，所以 qcow2 文件的网络传输效率较高。RHEL 7.0 及更新版本支持 qcow2 v3 镜像文件格式</p>
<p>  按需进行分配磁盘空间，不管文件系统是否支持</p>
<p>  支持快照</p>
<p>  支持zlib的磁盘压缩</p>
<p>  支持AES的加密</p>
<p>  优点 : 空间节约,功能丰富</p>
<p>  缺点 : 性能较差,生产推荐使用</p>
</li>
<li><p>vmdk( Virtual Machine Disk ): VMware环境当中默认使用的磁盘格式</p>
</li>
<li><p>vhd \ vhdx ( Virtual Hard Disk ):微软默认采用的文件格式</p>
</li>
<li><p>vdi : VirtualBox 采用的文件格式</p>
</li>
</ul>
<p><strong>查看支持格式</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<p>范例: 查看KVM支持的磁盘格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#qemu-img --<span class="built_in">help</span>|grep Support</span><br><span class="line">Supported formats: blkdebug blkreplay blkverify copy-on-read file ftp ftps gluster host_cdrom host_device http https iscsi iser luks nbd null-aio null-convme qcow2 quorum raw rbd ssh throttle vhdx vmdk vpc</span><br></pre></td></tr></table></figure>



<h2 id="5-4-使用-qemu-img-管理虚拟磁盘文件"><a href="#5-4-使用-qemu-img-管理虚拟磁盘文件" class="headerlink" title="5.4 使用 qemu-img 管理虚拟磁盘文件"></a>5.4 使用 qemu-img 管理虚拟磁盘文件</h2><h3 id="5-4-1-qemu-img-概述"><a href="#5-4-1-qemu-img-概述" class="headerlink" title="5.4.1 qemu-img 概述"></a>5.4.1 qemu-img 概述</h3><p>qemu-img 是一个功能强大的磁盘镜像管理工具</p>
<p>查看帮助: qemu-img –help</p>
<p>qemu-img 包括以下子命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">check 		<span class="comment">#检查完整性</span></span><br><span class="line">create 		<span class="comment">#创建镜像</span></span><br><span class="line">commit 		<span class="comment">#提交更改</span></span><br><span class="line">compare 	<span class="comment">#比较</span></span><br><span class="line">convert 	<span class="comment">#转换</span></span><br><span class="line">info 		<span class="comment">#获得信息</span></span><br><span class="line">map 		<span class="comment">#映射</span></span><br><span class="line">snapshot 	<span class="comment">#快照管理</span></span><br><span class="line">rebase 		<span class="comment">#在已有的镜像的基础上创建新的镜像</span></span><br><span class="line">resize 		<span class="comment">#调整大小</span></span><br><span class="line">amend 		<span class="comment">#修订镜像格式选项</span></span><br></pre></td></tr></table></figure>



<h3 id="5-4-2-创建虚拟磁盘文件"><a href="#5-4-2-创建虚拟磁盘文件" class="headerlink" title="5.4.2 创建虚拟磁盘文件"></a>5.4.2 创建虚拟磁盘文件</h3><h4 id="5-4-2-1-创建默认稀疏格式的磁盘"><a href="#5-4-2-1-创建默认稀疏格式的磁盘" class="headerlink" title="5.4.2.1 创建默认稀疏格式的磁盘"></a>5.4.2.1 创建默认稀疏格式的磁盘</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认为raw格式稀疏文件</span></span><br><span class="line">[root@centos8 ~]#qemu-img create vm1.img 1g</span><br><span class="line">Formatting <span class="string">&#x27;vm1.img&#x27;</span>, <span class="built_in">fmt</span>=raw size=1073741824</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#file vm1.img</span><br><span class="line">vm1.img: data</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示文件大小</span></span><br><span class="line">[root@centos8 ~]#ll -h vm1.img</span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:17 vm1.img</span><br><span class="line"></span><br><span class="line"><span class="comment">#实际文件只占4k空间</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">du</span> -h vm1.img</span><br><span class="line">4.0K vm1.img</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示文件信息</span></span><br><span class="line">[root@centos8 ~]#qemu-img info vm1.img</span><br><span class="line">image: vm1.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 4.0K</span><br></pre></td></tr></table></figure>



<h4 id="5-4-2-2-查看不同磁盘文件格式支持选项"><a href="#5-4-2-2-查看不同磁盘文件格式支持选项" class="headerlink" title="5.4.2.2 查看不同磁盘文件格式支持选项"></a>5.4.2.2 查看不同磁盘文件格式支持选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#qemu-img create -f raw -o ?</span><br><span class="line">Supported options:</span><br><span class="line">size       Virtual disk size</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img create -f qcow2 -o ?</span><br><span class="line">Supported options:</span><br><span class="line">size       Virtual disk size</span><br><span class="line">compat      Compatibility level (0.10 or 1.1)</span><br><span class="line">backing_file   File name of a base image</span><br><span class="line">backing_fmt   Image format of the base image</span><br><span class="line">encryption    Encrypt the image with format <span class="string">&#x27;aes&#x27;</span>. (Deprecated <span class="keyword">in</span> favor of encrypt.format=aes)</span><br><span class="line">encrypt.format  Encrypt the image, format choices: <span class="string">&#x27;aes&#x27;</span>, <span class="string">&#x27;luks&#x27;</span></span><br><span class="line">encrypt.key-secret ID of secret providing qcow AES key or LUKS passphrase</span><br><span class="line">encrypt.cipher-alg Name of encryption cipher algorithm</span><br><span class="line">encrypt.cipher-mode Name of encryption cipher mode</span><br><span class="line">encrypt.ivgen-alg Name of IV generator algorithm</span><br><span class="line">encrypt.ivgen-hash-alg Name of IV generator <span class="built_in">hash</span> algorithm</span><br><span class="line">encrypt.hash-alg Name of encryption <span class="built_in">hash</span> algorithm</span><br><span class="line">encrypt.iter-time Time to spend <span class="keyword">in</span> PBKDF <span class="keyword">in</span> milliseconds</span><br><span class="line">cluster_size   qcow2 cluster size</span><br><span class="line">preallocation  Preallocation mode (allowed values: off, metadata, falloc,full)</span><br><span class="line">lazy_refcounts  Postpone refcount updates</span><br><span class="line">refcount_bits  Width of a reference count entry <span class="keyword">in</span> bits</span><br></pre></td></tr></table></figure>



<h4 id="5-4-2-3-qcow2-格式选项"><a href="#5-4-2-3-qcow2-格式选项" class="headerlink" title="5.4.2.3 qcow2 格式选项"></a>5.4.2.3 qcow2 格式选项</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">backing_file 	<span class="comment">#指定后端镜像文件</span></span><br><span class="line">backing_fmt 	<span class="comment">#设置后端镜像的镜像格式</span></span><br><span class="line">cluster_size 	<span class="comment">#设置镜像中的簇大小，取值在512到2M之间，默认值为64K</span></span><br><span class="line">preallocation 	<span class="comment">#设置镜像文件空间的预分配模式</span></span><br><span class="line">encryption 		<span class="comment">#用于设置加密</span></span><br></pre></td></tr></table></figure>



<h4 id="5-4-2-4-创建raw格式非稀疏文件"><a href="#5-4-2-4-创建raw格式非稀疏文件" class="headerlink" title="5.4.2.4 创建raw格式非稀疏文件"></a>5.4.2.4 创建raw格式非稀疏文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#<span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=vm2.img bs=1M count=1024</span><br><span class="line">1024+0 records <span class="keyword">in</span></span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB, 1.0 GiB) copied, 3.20332 s, 335 MB/s</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info vm2.img</span><br><span class="line">image: vm2.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">ls</span> -hl vm2.img</span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:31 vm2.img</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">du</span> -h vm2.img</span><br><span class="line">1.0G vm2.img</span><br></pre></td></tr></table></figure>



<h4 id="5-4-2-5-创建raw格式稀疏文件"><a href="#5-4-2-5-创建raw格式稀疏文件" class="headerlink" title="5.4.2.5 创建raw格式稀疏文件"></a>5.4.2.5 创建raw格式稀疏文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#<span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=vm3.img bs=1M count=0 seek=1024</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 9.2173e-05 s, 0.0 kB/s</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info vm3.img</span><br><span class="line">image: vm3.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 0</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#ll -h vm3.img</span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:34 vm3.img</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">du</span> -h vm3.img</span><br><span class="line">0 vm3.img</span><br></pre></td></tr></table></figure>



<h4 id="5-4-2-6-raw文件复制的格式控制"><a href="#5-4-2-6-raw文件复制的格式控制" class="headerlink" title="5.4.2.6 raw文件复制的格式控制"></a>5.4.2.6 raw文件复制的格式控制</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制非稀疏文件,默认也为非稀疏文件</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">cp</span> vm2.img vm2.img.bak</span><br><span class="line">[root@centos8 ~]#<span class="built_in">du</span> -h vm2.img.bak</span><br><span class="line">1.0G vm2.img.bak</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#ll -h vm2.img.bak</span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:38 vm2.img.bak</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info vm2.img.bak</span><br><span class="line">image: vm2.img.bak</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line"></span><br><span class="line"><span class="comment">#复制稀疏文件,默认仍为稀疏文件</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">cp</span> vm3.img vm3.img.bak</span><br><span class="line">[root@centos8 ~]#ll -h vm3.img.bak</span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:36 vm3.img.bak</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">du</span> -h vm3.img.bak</span><br><span class="line">0 vm3.img.bak</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info vm3.img.bak</span><br><span class="line">image: vm3.img.bak</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定将非稀疏文件复制为稀疏格式格式</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">cp</span> --sparse=always vm2.img vm2.img.bak2</span><br><span class="line">[root@centos8 ~]#qemu-img info vm2.img</span><br><span class="line">image: vm2.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info vm2.img.bak2</span><br><span class="line">image: vm2.img.bak2</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定将稀疏文件复制为非稀疏格式格式</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">cp</span> --sparse=never vm3.img vm3.img.bak2</span><br><span class="line">[root@centos8 ~]#qemu-img info vm3.img</span><br><span class="line">image: vm3.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 0</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info vm3.img.bak2</span><br><span class="line">image: vm3.img.bak2</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br></pre></td></tr></table></figure>



<h3 id="5-4-3-检查虚拟磁盘"><a href="#5-4-3-检查虚拟磁盘" class="headerlink" title="5.4.3 检查虚拟磁盘"></a>5.4.3 检查虚拟磁盘</h3><p>对于关机状态的虚拟机磁盘,可以检查文件错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh list</span><br><span class="line">Id  Name               State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2   centos8            running</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img check /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line">qemu-img: Could not open <span class="string">&#x27;/var/lib/libvirt/images/centos8.qcow2&#x27;</span>: Failed to get shared <span class="string">&quot;write&quot;</span> lock</span><br><span class="line">Is another process using the image [/var/lib/libvirt/images/centos8.qcow2]?</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh <span class="built_in">suspend</span> centos8</span><br><span class="line">Domain centos8 suspended</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh list</span><br><span class="line">Id  Name               State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2   centos8            paused</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img check /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line">qemu-img: Could not open <span class="string">&#x27;/var/lib/libvirt/images/centos8.qcow2&#x27;</span>: Failed to get shared <span class="string">&quot;write&quot;</span> lock</span><br><span class="line">Is another process using the image [/var/lib/libvirt/images/centos8.qcow2]?</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img check /var/lib/libvirt/images/centos7.qcow2</span><br><span class="line">No errors were found on the image.</span><br><span class="line">25572/327680 = 7.80% allocated, 1.44% fragmented, 0.00% compressed clusters</span><br><span class="line">Image end offset: 1676869632</span><br></pre></td></tr></table></figure>



<h3 id="5-4-4-磁盘预分配策略"><a href="#5-4-4-磁盘预分配策略" class="headerlink" title="5.4.4 磁盘预分配策略"></a>5.4.4 磁盘预分配策略</h3><p>raw 文件的预分配策略和文件系统是否支持有关,而qcow2则无关</p>
<p>预分配策略</p>
<ul>
<li><p>off</p>
<p>  此为缺省策略，即不使用预分配策略,预分配后的虚拟磁盘占用空间很小,不属于稀疏映像类型</p>
<p>  生成的磁盘文件占用空间很小</p>
<p>  相当于房地产开发商拆迁，只圈地但不禁止旧房的使用</p>
</li>
<li><p>metadata</p>
<p>  只预分配元数据(metadata)，预分配后的磁盘文件属于稀疏映像类型,相当于vmware中的磁盘置备选项: Thin Provision(精简配置)</p>
<p>  生成的磁盘文件为稀疏格式,实际占用的空间比off策略稍大一些</p>
<p>  相当于房地产开发商拆迁，只圈地但不禁止旧房的使用，占一小块地建了售楼处</p>
</li>
<li><p>falloc</p>
<p>  分配文件的块并标识它们的状态为未初始化，即只分配空间,但不置零. 预分配后的虚拟磁盘属于非稀疏映像类型,相对full模式来说，创建虚拟磁盘的速度要快很多,相当于vmware中的磁盘置备选项:厚置备延迟置零</p>
<p>  生成的磁盘文件实际占用的空间和分配的空间相同大小</p>
<p>  相当于房地产开发商拆迁，只圈地且禁止旧房的使用，但旧房还存在</p>
</li>
<li><p>full</p>
<p>  分配所有磁盘空间并置零，预分配后的虚拟磁盘属于非稀疏映像类型,创建最慢,相当于vmware中的磁盘置备选项: 厚置备置零</p>
<p>  生成的磁盘文件实际占用的空间和分配的空间相同大小</p>
<p>  相当于房地产开发商拆迁，只圈地且完全清除旧房</p>
</li>
</ul>
<p>总结：</p>
<ul>
<li><p>追求创建速度，节约磁盘空间</p>
<p>  off</p>
<p>  metadata</p>
</li>
<li><p>追求使用速度，立即分配空间，虽然存在一点磁盘空间浪费，即磁盘空间没那么多，但是还是分那么多，这样的话磁盘空间占用比较大，但是他的磁盘空间是连续的，不是碎片化的，性能好</p>
<p>  falloc</p>
<p>  full</p>
</li>
</ul>
<p>范例: 创建预分配置策略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#qemu-img create -f qcow2 test1.qcow2 1g</span><br><span class="line">Formatting <span class="string">&#x27;test1.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536 lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info test1.qcow2</span><br><span class="line">image: test1.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line"> compat: 1.1</span><br><span class="line"> lazy refcounts: <span class="literal">false</span></span><br><span class="line"> refcount bits: 16</span><br><span class="line"> corrupt: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#指定关闭预分配</span></span><br><span class="line">[root@centos8 ~]#qemu-img create -f qcow2 test2.qcow2 1g -o preallocation=off</span><br><span class="line">Formatting <span class="string">&#x27;test2.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536 preallocation=off lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info test2.qcow2</span><br><span class="line">image: test2.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line"> compat: 1.1</span><br><span class="line"> lazy refcounts: <span class="literal">false</span></span><br><span class="line"> refcount bits: 16</span><br><span class="line"> corrupt: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#指定预分配metadata</span></span><br><span class="line">[root@centos8 ~]#qemu-img create -f qcow2 test3.qcow2 1g -o preallocation=metadata</span><br><span class="line">Formatting <span class="string">&#x27;test3.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536 preallocation=metadata lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info test3.qcow2</span><br><span class="line">image: test3.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 836K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line"> compat: 1.1</span><br><span class="line"> lazy refcounts: <span class="literal">false</span></span><br><span class="line"> refcount bits: 16</span><br><span class="line"> corrupt: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#指定预分配falloc</span></span><br><span class="line">[root@centos8 ~]#qemu-img create -f qcow2 test4.qcow2 1g -o preallocation=falloc</span><br><span class="line">Formatting <span class="string">&#x27;test4.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536 preallocation=falloc lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info test4.qcow2</span><br><span class="line">image: test4.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line"> compat: 1.1</span><br><span class="line"> lazy refcounts: <span class="literal">false</span></span><br><span class="line"> refcount bits: 16</span><br><span class="line"> corrupt: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#指定预分配full</span></span><br><span class="line">[root@centos8 ~]#qemu-img create -f qcow2 test5.qcow2 1g -o preallocation=full</span><br><span class="line">Formatting <span class="string">&#x27;test5.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536 preallocation=full lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info test5.qcow2</span><br><span class="line">image: test5.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line"> compat: 1.1</span><br><span class="line"> lazy refcounts: <span class="literal">false</span></span><br><span class="line"> refcount bits: 16</span><br><span class="line"> corrupt: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#文件系统显示大小</span></span><br><span class="line">[root@centos8 ~]#ll -h <span class="built_in">test</span>*.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 193K Sep 20 13:31 test1.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 193K Sep 20 13:32 test2.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.1G Sep 20 13:35 test3.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.1G Sep 20 13:36 test4.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.1G Sep 20 13:37 test5.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看真实大小</span></span><br><span class="line">[root@centos8 ~]#<span class="built_in">du</span> -h <span class="built_in">test</span>*.qcow2</span><br><span class="line">196K test1.qcow2</span><br><span class="line">196K test2.qcow2</span><br><span class="line">836K test3.qcow2</span><br><span class="line">1.1G test4.qcow2</span><br><span class="line">1.1G test5.qcow2</span><br></pre></td></tr></table></figure>



<h3 id="5-4-5-虚拟磁盘格式转换"><a href="#5-4-5-虚拟磁盘格式转换" class="headerlink" title="5.4.5 虚拟磁盘格式转换"></a>5.4.5 虚拟磁盘格式转换</h3><p>qemu-img 可以将不同格式的虚拟磁盘文件进行格式转化</p>
<p>语法格式</p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert [--object objectdef] [--image-opts] [--target-image-opts] [-U] [-C] [-c] [-p] [-q] [-n] [-f fmt] [-t cache] [-T src_cache] [-O output_fmt] [-B backing_file] [-o options] [-s snapshot_id_or_name] [-l snapshot_param] [-S sparse_size] [-m num_coroutines] [-W] filename [filename2 [...]] output_filename</span><br></pre></td></tr></table></figure>

<p>范例: 将vmdk转化为raw 和qcow2格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#qemu-img info CentOS8.2.vmdk</span><br><span class="line">image: CentOS8.2.vmdk</span><br><span class="line">file format: vmdk</span><br><span class="line">virtual size: 200G (214748364800 bytes)</span><br><span class="line">disk size: 1.6G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line"> cid: 2898578192</span><br><span class="line"> parent cid: 4294967295</span><br><span class="line"> create <span class="built_in">type</span>: monolithicSparse</span><br><span class="line"> extents:</span><br><span class="line">   [0]:</span><br><span class="line">     virtual size: 214748364800</span><br><span class="line">     filename: CentOS8.2.vmdk</span><br><span class="line">     cluster size: 65536</span><br><span class="line">     format:</span><br><span class="line">     </span><br><span class="line"><span class="comment">#默认转化为raw格式</span></span><br><span class="line">[root@centos8 ~]#qemu-img convert CentOS8.2.vmdk CentOS8.2.img</span><br><span class="line"></span><br><span class="line"><span class="comment">#比较大小</span></span><br><span class="line">[root@centos8 ~]#ll -h CentOS8.2.vmdk CentOS8.2.img</span><br><span class="line">-rw-r--r-- 1 root root 1.6G Sep 20 16:00 CentOS8.2.vmdk</span><br><span class="line">-rw-r--r-- 1 root root 200G Sep 20 16:10 CentOS8.2.img</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">du</span> -h CentOS8.2.vmdk CentOS8.2.img</span><br><span class="line">1.6G CentOS8.2.vmdk</span><br><span class="line">1.5G CentOS8.2.img</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info CentOS8.2.img</span><br><span class="line">image: CentOS8.2.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 200G (214748364800 bytes)</span><br><span class="line">disk size: 1.4G</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">mv</span> CentOS8.2.img /var/lib/libvirt/images/</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virt-install --import --name=centos8-test2 --vcpus=1 --ram=2048 --disk bus=scsi,path=/var/lib/libvirt/images/CentOS8.2.img --network network=default --graphics vnc,listen=0.0.0.0 --os-type=Linux --os-variant=centos8 --noautoconsole --boot hd</span><br><span class="line"></span><br><span class="line"><span class="comment">#转化为qcow2格式</span></span><br><span class="line">[root@centos8 ~]#qemu-img convert -f vmdk -O qcow2 CentOS8.2.vmdk CentOS8.2.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#比较大小</span></span><br><span class="line">[root@centos8 ~]#ll -h CentOS8.2.vmdk CentOS8.2.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.6G Sep 20 16:00 CentOS8.2.vmdk</span><br><span class="line">-rw-r--r-- 1 root root 1.6G Sep 20 16:12 CentOS8.2.qcow2</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">du</span> -h CentOS8.2.vmdk CentOS8.2.qcow2</span><br><span class="line">1.6G CentOS8.2.vmdk</span><br><span class="line">1.6G CentOS8.2.qcow2</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info CentOS8.2.qcow2</span><br><span class="line">image: CentOS8.2.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 200G (214748364800 bytes)</span><br><span class="line">disk size: 1.5G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line"> compat: 1.1</span><br><span class="line"> lazy refcounts: <span class="literal">false</span></span><br><span class="line"> refcount bits: 16</span><br><span class="line"> corrupt: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line">[root@centos8 ~]#<span class="built_in">mv</span> CentOS8.2.qcow2 /var/lib/libvirt/images/</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virt-install --import --name=centos8-test3 --vcpus=1 --ram=2048 --disk bus=scsi,path=/var/lib/libvirt/images/CentOS8.2.qcow2 --network network=default --graphics vnc,listen=0.0.0.0 --os-type=Linux --os-variant=centos8 --noautoconsole --boot hd</span><br></pre></td></tr></table></figure>



<h3 id="5-4-6-调整虚拟磁盘大小"><a href="#5-4-6-调整虚拟磁盘大小" class="headerlink" title="5.4.6 调整虚拟磁盘大小"></a>5.4.6 调整虚拟磁盘大小</h3><p>虚拟磁盘文件创建后,还可以调整虚拟磁盘大小</p>
<p>语法格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img resize [--shrink] filename [+l -]size</span><br></pre></td></tr></table></figure>

<ul>
<li>操作之前，一定要做好数据备份</li>
<li>增加文件大小后，需要在客户机中使用fdisk、parted等分区工具进行相应的操作才能真正让客户机使用到增加后的镜像空间。</li>
<li>缩小镜像之前，要在客户机中保证里面的文件系统有空余空间，否则会数据丢失。另外xfs文件系统不支持缩减</li>
<li>qcow2不支持缩小镜像的操作</li>
</ul>
<p>范例: 扩展虚拟磁盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#qemu-img info /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line">image: /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 20G (21474836480 bytes)</span><br><span class="line">disk size: 20G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line"> 	compat: 1.1</span><br><span class="line"> 	lazy refcounts: <span class="literal">true</span></span><br><span class="line"> 	refcount bits: 16</span><br><span class="line"> 	corrupt: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#增加10G空间</span></span><br><span class="line">[root@centos8 ~]#qemu-img resize /var/lib/libvirt/images/centos8.qcow2 +10G</span><br><span class="line">Image resized.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#qemu-img info /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line">image: /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 30G (32212254720 bytes)</span><br><span class="line">disk size: 20G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">	 compat: 1.1</span><br><span class="line"> 	lazy refcounts: <span class="literal">true</span></span><br><span class="line"> 	refcount bits: 16</span><br><span class="line"> 	corrupt: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#启动虚拟机后,还需要使用fdisk等工具进行空间的继续管理才能使用</span></span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330160740330.png" alt="image-20240330160740330"></p>
<p>范例: 缩减虚拟磁盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 images]#qemu-img resize --shrink /var/lib/libvirt/images/centos7.qcow2 -2G</span><br><span class="line">Image resized.</span><br></pre></td></tr></table></figure>

<p>范例：qemu-img resize 扩展空间后，在虚拟机内还需执行如下操作才能最终扩容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#利用前面qemu-img resize扩容的空间来扩容分区</span></span><br><span class="line">fdisk /dev/vda</span><br><span class="line">d 删除旧的20G的/dev/vda2</span><br><span class="line">n 重新创建/dev/vda2,容量使用所有空间，/dev/vda2扩容到30G</span><br><span class="line">t 指定8e 类型</span><br><span class="line">w 保存退出</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果是逻辑卷，执行下面操作</span></span><br><span class="line"><span class="comment">#当前物理卷空间并没有扩容，需要执行下面操作扩容PV</span></span><br><span class="line">pvresize  --setphysicalvolumesize 29G /dev/vda2</span><br><span class="line"></span><br><span class="line"><span class="comment">#扩容逻辑卷和文件系统</span></span><br><span class="line">lvextend -r -l  +100%free /dev/rl/root</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果是分区不是逻辑卷，则执行如下操作</span></span><br><span class="line"><span class="comment">#如果是xfs文件系统</span></span><br><span class="line">xfs_growfs /</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果是ext</span></span><br><span class="line">resize2fs /dev/vda2</span><br></pre></td></tr></table></figure>



<h2 id="5-5-磁盘快照管理"><a href="#5-5-磁盘快照管理" class="headerlink" title="5.5 磁盘快照管理"></a>5.5 磁盘快照管理</h2><h3 id="5-5-1-快照Snapshot介绍"><a href="#5-5-1-快照Snapshot介绍" class="headerlink" title="5.5.1 快照Snapshot介绍"></a>5.5.1 快照Snapshot介绍</h3><p>磁盘快照,对磁盘数据进行快照,主要用于虚拟机备份等场合</p>
<p>磁盘快照分类</p>
<ul>
<li><p>按快照信息保存分为:</p>
<p>  内置快照∶快照数据和base磁盘数据放在同一个qcow2文件中</p>
<p>  外置快照︰快照数据单独的另一个qcow2文件存放</p>
</li>
<li><p>按虚拟机状态可以分为:</p>
<p>  关机态快照︰数据可以保证一致性</p>
<p>  运行态快照∶数据无法保证一致性，类似与系统crash后的磁盘数据。使用是可能需要fsck等操作。</p>
</li>
<li><p>按磁盘数量可以分为:</p>
<p>  单盘:单盘快照不涉及原子性</p>
<p>  多盘:涉及原子性。主要分两个方面:1.是所有盘快照点相同2.所有盘要么都快照成功，要么都快照失败。主要依赖于qemu的transaction实现</p>
</li>
</ul>
<h3 id="5-5-2-qemu-img-管理磁盘快照"><a href="#5-5-2-qemu-img-管理磁盘快照" class="headerlink" title="5.5.2 qemu-img 管理磁盘快照"></a>5.5.2 qemu-img 管理磁盘快照</h3><p>命令格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">qemu-img snapshot [--object objectdef] [--image-opts] [-U] [-q] [-l | -a snapshot | -c snapshot | -d snapshot] filename </span><br><span class="line"></span><br><span class="line">snapshot is the name of the snapshot to create, apply or delete</span><br><span class="line">	-a applies a snapshot (revert disk to saved state)</span><br><span class="line">	-c creates a snapshot</span><br><span class="line">	-d deletes a snapshot</span><br><span class="line">	-l lists all snapshots <span class="keyword">in</span> the given image</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看块设备</span></span><br><span class="line">[root@centos8 ~]#virsh domblklist centos7</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看快照,如果没有快照,则无显示信息</span></span><br><span class="line">[root@centos8 ~]#qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#关机才能创建快照</span></span><br><span class="line">[root@centos8 ~]#qemu-img snapshot -c centos7-s1 /var/lib/libvirt/images/centos7.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看快照</span></span><br><span class="line">[root@centos8 ~]#qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看快照信息</span></span><br><span class="line">[root@centos8 ~]#qemu-img info /var/lib/libvirt/images/centos7.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除文件,模拟破坏</span></span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330161038823.png" alt="image-20240330161038823"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关机后才能还原快照修复故障</span></span><br><span class="line">[root@centos8 ~]#qemu-img snapshot -a centos7-s1 /var/lib/libvirt/images/centos7.qcow2</span><br></pre></td></tr></table></figure>

<p>查看文件恢复</p>
<p><img src="/Virtualization/KVM/image-20240330161100578.png" alt="image-20240330161100578"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关机后才能删除快照</span></span><br><span class="line">[root@centos8 ~]#qemu-img snapshot -d centos7-s1 /var/lib/libvirt/images/centos7.qcow2</span><br><span class="line">[root@centos8 ~]#qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2</span><br></pre></td></tr></table></figure>



<h3 id="5-5-3-virsh-管理虚拟机快照"><a href="#5-5-3-virsh-管理虚拟机快照" class="headerlink" title="5.5.3 virsh 管理虚拟机快照"></a>5.5.3 virsh 管理虚拟机快照</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh snapshot-list centos8</span><br><span class="line">Name         Creation Time       State</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">#开机状态可以创建虚拟机快照</span></span><br><span class="line">[root@centos8 ~]#virsh snapshot-create centos8</span><br><span class="line">Domain snapshot 1600593611 created</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh snapshot-list centos8</span><br><span class="line">Name            Creation Time              State</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">1600593611      2020-09-20 17:20:11 +0800  shutoff</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330161314705.png" alt="image-20240330161314705"></p>
<p>使用 virsh 命令还原快照</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh list</span><br><span class="line">Id  Name              State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">#无需关机，即可还原快照</span></span><br><span class="line">[root@centos8 ~]#virsh snapshot-revert centos8 --snapshotname 1600593611 --running</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh list</span><br><span class="line">Id  Name               State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">23  centos7            running</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330161338608.png" alt="image-20240330161338608"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除快照</span></span><br><span class="line">[root@centos8 ~]#virsh snapshot-delete centos8 --snapshotname 1600593611</span><br><span class="line">Domain snapshot 1600593611 deleted</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh snapshot-list centos8</span><br><span class="line">Name         Creation Time       State</span><br><span class="line">------------------------------------------------------------</span><br></pre></td></tr></table></figure>



<h1 id="6-网络管理"><a href="#6-网络管理" class="headerlink" title="6 网络管理"></a>6 网络管理</h1><p>官方文档:<a href="https://wiki.libvirt.org/page/VirtualNetworking">https://wiki.libvirt.org/page/VirtualNetworking</a></p>
<h2 id="6-1-Linux-网桥实现"><a href="#6-1-Linux-网桥实现" class="headerlink" title="6.1 Linux 网桥实现"></a>6.1 Linux 网桥实现</h2><p>范例: Ubuntu 配置网桥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu1804:~# apt install -y bridge-utils</span><br><span class="line">root@ubuntu1804:~# dpkg -L bridge-utils</span><br><span class="line">/sbin/brctl</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">#三个网卡配置使用一个配置文件</span></span><br><span class="line">root@ubuntu1804:~# <span class="built_in">cat</span> /etc/netplan/01-netcfg.yaml</span><br><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># For more information, see netplan(5).</span></span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    eth0:</span><br><span class="line">      dhcp4: <span class="built_in">yes</span></span><br><span class="line">    eth1:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      dhcp6: no</span><br><span class="line">    eth2:</span><br><span class="line">      dhcp4: no  </span><br><span class="line">  bridges:</span><br><span class="line">    virbr1:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      dhcp6: no</span><br><span class="line">      addresses: [10.0.0.18/16]</span><br><span class="line">      gateway4: 10.0.0.2</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [223.6.6.6]</span><br><span class="line">      interfaces:</span><br><span class="line">        - eth1</span><br><span class="line">        - eth2</span><br><span class="line">        </span><br><span class="line"><span class="comment">#桥接配置单独一个文件</span></span><br><span class="line">[root@ubuntu1804 netplan]#<span class="built_in">cat</span> virbr1.yaml</span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    eth1:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      dhcp6: no</span><br><span class="line">    eth2:</span><br><span class="line">      dhcp4: no  </span><br><span class="line">  bridges:</span><br><span class="line">    virbr1:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      dhcp6: no</span><br><span class="line">      addresses: [10.0.0.10/16]</span><br><span class="line">      gateway4: 10.0.0.2</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [223.6.6.6]</span><br><span class="line">      interfaces:</span><br><span class="line">        - eth1</span><br><span class="line">        - eth2</span><br><span class="line">  </span><br><span class="line">root@ubuntu1804:~# netplan apply</span><br><span class="line"></span><br><span class="line">root@ubuntu1804:~# ifconfig virbr1</span><br><span class="line">virbr1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500</span><br><span class="line">   inet 10.0.0.18 netmask 255.255.0.0 broadcast 10.0.255.255</span><br><span class="line">   inet6 fe80::9cbe:1dff:fe85:6601 prefixlen 64 scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">   ether 9e:be:1d:85:66:01 txqueuelen 1000 (Ethernet)</span><br><span class="line">   RX packets 158 bytes 19534 (19.5 KB)</span><br><span class="line">   RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">   TX packets 10 bytes 796 (796.0 B)</span><br><span class="line">   TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">   </span><br><span class="line">root@ubuntu1804:~# brctl show</span><br><span class="line">bridge name  bridge <span class="built_in">id</span>           STP   enabled    interfaces</span><br><span class="line">virbr1       8000.9ebe1d856601   no    eth1       eth2</span><br></pre></td></tr></table></figure>

<p>范例: CentOS 配置网桥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建网桥</span></span><br><span class="line">nmcli con add <span class="built_in">type</span> bridge con-name virbr1 ifname virbr1</span><br><span class="line">nmcli connection modify virbr1 ipv4.addresses 10.0.0.100/24 ipv4.method manual</span><br><span class="line">nmcli con up virbr1</span><br><span class="line"></span><br><span class="line"><span class="comment">#加入物理网卡</span></span><br><span class="line">nmcli con add <span class="built_in">type</span> bridge-slave con-name virbr1-port0 ifname eth0 master virbr1</span><br><span class="line">nmcli con add <span class="built_in">type</span> bridge-slave con-name virbr1-port1 ifname eth1 master virbr1</span><br><span class="line">nmcli con up virbr1-port0</span><br><span class="line">nmcli con up virbr1-port1</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看网桥配置文件</span></span><br><span class="line"><span class="built_in">cat</span> /etc/sysconfig/network-scripts/ifcfg-virbr1</span><br><span class="line">DEVICE=virbr1</span><br><span class="line">NAME=virbr1</span><br><span class="line">STP=<span class="built_in">yes</span></span><br><span class="line">TYPE=Bridge</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.100</span><br><span class="line">PREFIX=24</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /etc/sysconfig/network-scripts/ifcfg-virbr1-port0</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">NAME=virbr1-port0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">BRIDGE=virbr1</span><br><span class="line">UUID=23f41d3b-b57c-4e26-9b17-d5f02dafd12d</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装管理软件包,注意:CentOS8取消了此包</span></span><br><span class="line">yum install bridge-utils</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看网桥</span></span><br><span class="line">brctl show</span><br><span class="line">ip <span class="built_in">link</span> show master virbr1</span><br><span class="line">bridge <span class="built_in">link</span> show</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除virbr1</span></span><br><span class="line">nmcli con down virbr1</span><br><span class="line"><span class="built_in">rm</span> /etc/sysconfig/network-scripts/ifcfg-virbr1*</span><br><span class="line">nmcli con reload</span><br></pre></td></tr></table></figure>



<h2 id="6-2-qemu-kvm支持的网络"><a href="#6-2-qemu-kvm支持的网络" class="headerlink" title="6.2 qemu-kvm支持的网络"></a>6.2 qemu-kvm支持的网络</h2><p>虚拟机的网络模式:</p>
<ul>
<li>基于NAT ( Network Addresss Translation)的虚拟网络,此为virt-install的默认模式，相当于Vmware中的NAT模式</li>
<li>基于自定义网桥（Bridge ）的虚拟网络，支持虚拟机和宿主机的网卡桥接在一个网桥，从而实现外部网络访问虚拟机</li>
<li>用户自定义的隔离的虚拟网络，相当于Vmware中的仅主机模式</li>
<li>直接分配物理网络设备（包括VT-d和SR-IOV)，即桥接到宿主机的网卡，类似于Vmware中的桥接模式,性能最好</li>
</ul>
<p>虚拟机的网卡设备:</p>
<ul>
<li>RTL8139、e1000、….</li>
<li>virtio 生产建议使用</li>
</ul>
<p>注意: 桥接物理网卡,会自动生成macvtap网卡,并且会导致本宿主机无法访问虚拟机,但其它物理机可以访问当前宿主机上面的虚拟机</p>
<p>范例: 查看qemu-kvm支持的网卡型号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Ubuntu20.04没有此命令</span></span><br><span class="line">[root@centos8 ~]#/usr/libexec/qemu-kvm -net nic,model=?</span><br><span class="line">qemu: Supported NIC models: e1000,e1000-82540em,e1000e,rtl8139,virtio-net-pci</span><br></pre></td></tr></table></figure>



<h2 id="6-3-默认的网络配置NAT模式"><a href="#6-3-默认的网络配置NAT模式" class="headerlink" title="6.3 默认的网络配置NAT模式"></a>6.3 默认的网络配置NAT模式</h2><h3 id="6-3-1-默认网络连接的架构图"><a href="#6-3-1-默认网络连接的架构图" class="headerlink" title="6.3.1 默认网络连接的架构图"></a>6.3.1 默认网络连接的架构图</h3><p>默认虚拟机网络配置为NAT模式,相当于vmware的NAT模式的Vmnet8</p>
<p><img src="/Virtualization/KVM/image-20240330162154819.png" alt="image-20240330162154819"></p>
<h3 id="6-3-2-宿主机默认网络相关服务和信息"><a href="#6-3-2-宿主机默认网络相关服务和信息" class="headerlink" title="6.3.2 宿主机默认网络相关服务和信息"></a>6.3.2 宿主机默认网络相关服务和信息</h3><p>范例：修改默认的网段信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认网面是192.168.122.0/24，可以修改为其它网段</span></span><br><span class="line">[root@ubuntu2204 ~]#vim /etc/libvirt/qemu/networks/default.xml</span><br><span class="line">&lt;!--</span><br><span class="line">WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:virsh net-edit default or other application using the libvirt API.</span><br><span class="line">--&gt;</span><br><span class="line">&lt;network&gt;</span><br><span class="line">&lt;name&gt;default&lt;/name&gt;</span><br><span class="line">&lt;uuid&gt;b19f0f76-a1b7-4b6a-b940-b62cd8c59bf0&lt;/uuid&gt;</span><br><span class="line">&lt;forward mode=<span class="string">&#x27;nat&#x27;</span>/&gt;</span><br><span class="line">&lt;bridge name=<span class="string">&#x27;virbr0&#x27;</span> stp=<span class="string">&#x27;on&#x27;</span> delay=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line">&lt;mac address=<span class="string">&#x27;52:54:00:1c:f2:eb&#x27;</span>/&gt;</span><br><span class="line">&lt;ip address=<span class="string">&#x27;192.168.12.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;  	<span class="comment">#修改网段信息</span></span><br><span class="line"> &lt;dhcp&gt;</span><br><span class="line">  &lt;range start=<span class="string">&#x27;192.168.12.2&#x27;</span> end=<span class="string">&#x27;192.168.12.254&#x27;</span>/&gt;</span><br><span class="line"> &lt;/dhcp&gt;</span><br><span class="line">&lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]#reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">#自动更新DNSMASQ的相关文件</span></span><br><span class="line">[root@ubuntu2204 ~]#<span class="built_in">cat</span> /var/lib/libvirt/dnsmasq/default.conf</span><br><span class="line">strict-order</span><br><span class="line">user=libvirt-dnsmasq</span><br><span class="line">pid-file=/run/libvirt/network/default.pid</span><br><span class="line">except-interface=lo</span><br><span class="line">bind-dynamic</span><br><span class="line">interface=virbr0</span><br><span class="line">dhcp-range=192.168.12.2,192.168.12.254,255.255.255.0</span><br><span class="line">dhcp-no-override</span><br><span class="line">dhcp-authoritative</span><br><span class="line">dhcp-lease-max=253</span><br><span class="line">dhcp-hostsfile=/var/lib/libvirt/dnsmasq/default.hostsfile</span><br><span class="line">addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts</span><br></pre></td></tr></table></figure>

<p>默认宿主机安装dnsmasq包指供DHCP服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Ubuntu20.04</span></span><br><span class="line">[root@ubuntu2004 ~]#dpkg -l dnsmasq-base</span><br><span class="line">Desired=Unknown/Install/Remove/Purge/Hold</span><br><span class="line">| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend</span><br><span class="line">|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)</span><br><span class="line">||/ Name      Version      Architecture Description</span><br><span class="line">+++-==============-=================-============-</span><br><span class="line">============================================</span><br><span class="line">ii dnsmasq-base  2.80-1.1ubuntu1.5 amd64    Small caching DNS proxy and DHCP/TFTP server</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]#<span class="built_in">cat</span> /var/lib/libvirt/dnsmasq/default.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS</span></span><br><span class="line">[root@centos8 ~]#rpm -q dnsmasq</span><br><span class="line">dnsmasq-2.79-11.el8.x86_64</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#<span class="built_in">cat</span> /var/lib/libvirt/dnsmasq/default.conf</span><br></pre></td></tr></table></figure>

<p>范例：查看宿主机的网桥信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]#virsh list</span><br><span class="line">[root@ubuntu2004 ~]#ip a</span><br><span class="line">[root@ubuntu2004 ~]#apt -y install bridge-utils</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看桥接信息</span></span><br><span class="line">[root@ubuntu2004 ~]#brctl show</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看virbr1网络的情况</span></span><br><span class="line">[root@ubuntu2004 ~]#ip <span class="built_in">link</span> show master virbr1</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有桥接网卡信息及对应网桥</span></span><br><span class="line">[root@ubuntu2004 ~]#bridge <span class="built_in">link</span> show</span><br></pre></td></tr></table></figure>

<p>范例: 查看宿主机的网桥信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh list --all</span><br><span class="line">[root@centos8 ~]#ip a</span><br><span class="line">[root@centos8 ~]#virsh list</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh start centos7</span><br><span class="line">Domain centos7 started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh start centos8</span><br><span class="line">Domain centos8 started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#ip a</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看virbr1网络的情况</span></span><br><span class="line">[root@centos8 ~]#ip <span class="built_in">link</span> show master virbr1</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有桥接网卡信息及对应网桥</span></span><br><span class="line">[root@centos8 ~]#bridge <span class="built_in">link</span> show</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#nmtui</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330162534307.png" alt="image-20240330162534307"></p>
<p><img src="/Virtualization/KVM/image-20240330162538966.png" alt="image-20240330162538966"></p>
<p><img src="/Virtualization/KVM/image-20240330162543465.png" alt="image-20240330162543465"></p>
<p><img src="/Virtualization/KVM/image-20240330162547712.png" alt="image-20240330162547712"></p>
<p><img src="/Virtualization/KVM/image-20240330162558283.png" alt="image-20240330162558283"></p>
<p><img src="/Virtualization/KVM/image-20240330162603110.png" alt="image-20240330162603110"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh net-list</span><br><span class="line">[root@centos8 ~]#<span class="built_in">cat</span> /etc/libvirt/qemu/networks/default.xml</span><br><span class="line">[root@centos8 ~]#virsh net-dumpxml default</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看NAT策略实现从虚拟机可以访问外部网络,反之不通,此策略由libvirtd服务启动时自动加载到NAT表</span></span><br><span class="line">[root@centos8 ~]#iptables -vnL -t nat</span><br></pre></td></tr></table></figure>



<h3 id="6-3-3-虚拟机网卡默认设置"><a href="#6-3-3-虚拟机网卡默认设置" class="headerlink" title="6.3.3 虚拟机网卡默认设置"></a>6.3.3 虚拟机网卡默认设置</h3><p>Ubutun20.04的虚拟机默认网卡设置</p>
<p><img src="/Virtualization/KVM/image-20240330162654205.png" alt="image-20240330162654205"></p>
<p>Rocky8的虚拟机默认网卡设置</p>
<p><img src="/Virtualization/KVM/image-20240330162702768.png" alt="image-20240330162702768"></p>
<p><img src="/Virtualization/KVM/image-20240330162707030.png" alt="image-20240330162707030"></p>
<p><img src="/Virtualization/KVM/image-20240330162711428.png" alt="image-20240330162711428"></p>
<p><img src="/Virtualization/KVM/image-20240330162721314.png" alt="image-20240330162721314"></p>
<p><img src="/Virtualization/KVM/image-20240330162725984.png" alt="image-20240330162725984"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh dumpxml centos7 |sed -n <span class="string">&#x27;/interface/,/interface/p&#x27;</span></span><br><span class="line"> &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span><br><span class="line">  &lt;mac address=<span class="string">&#x27;52:54:00:95:25:fb&#x27;</span>/&gt;</span><br><span class="line">  &lt;<span class="built_in">source</span> network=<span class="string">&#x27;default&#x27;</span> bridge=<span class="string">&#x27;virbr1&#x27;</span>/&gt;</span><br><span class="line">  &lt;target dev=<span class="string">&#x27;vnet0&#x27;</span>/&gt;</span><br><span class="line">  &lt;model <span class="built_in">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">  &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;net0&#x27;</span>/&gt;</span><br><span class="line">  &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x03&#x27;</span></span><br><span class="line"><span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line"> &lt;/interface&gt;</span><br></pre></td></tr></table></figure>



<h3 id="6-3-4-virsh-查看虚拟机网络配置"><a href="#6-3-4-virsh-查看虚拟机网络配置" class="headerlink" title="6.3.4 virsh 查看虚拟机网络配置"></a>6.3.4 virsh 查看虚拟机网络配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看虚拟机的网卡配置</span></span><br><span class="line">[root@centos8 ~]#virsh domiflist centos8</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看虚拟机的网卡地址信息</span></span><br><span class="line">[root@centos8 ~]#virsh domifaddr centos8</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看虚拟机的指定网卡的状态</span></span><br><span class="line">[root@centos8 ~]#virsh domifstat centos8 vnet0</span><br></pre></td></tr></table></figure>



<h2 id="6-4-配置虚拟机网卡桥接到宿主机的物理网卡"><a href="#6-4-配置虚拟机网卡桥接到宿主机的物理网卡" class="headerlink" title="6.4 配置虚拟机网卡桥接到宿主机的物理网卡"></a>6.4 配置虚拟机网卡桥接到宿主机的物理网卡</h2><p>相当于vmware的桥接模式的Vmnet0</p>
<p>此方式让宿主机网络的主机可以直接访问虚拟机,性能更优</p>
<p><strong>Ubuntu22.04 宿主机的虚拟机界面如下</strong></p>
<p><img src="/Virtualization/KVM/image-20240330163008627.png" alt="image-20240330163008627"></p>
<p><strong>Ubuntu20.04 宿主机的虚拟机界面如下</strong></p>
<p>选择Network source 为 Host deivce eth0: macvtap</p>
<p><img src="/Virtualization/KVM/image-20240330163021431.png" alt="image-20240330163021431"></p>
<p><strong>Rocky8 宿主机的虚拟机界面如下</strong></p>
<p>需要手动输入device name 为 eth0</p>
<p><img src="/Virtualization/KVM/image-20240330163033071.png" alt="image-20240330163033071"></p>
<p><strong>CentOS 7 界面如下</strong></p>
<p><img src="/Virtualization/KVM/image-20240330163043906.png" alt="image-20240330163043906"></p>
<p><img src="/Virtualization/KVM/image-20240330163048584.png" alt="image-20240330163048584"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#virsh domiflist centos7</span><br><span class="line">Interface  Type     Source   Model     MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">macvtap0   direct   eth0     virtio    52:54:00:95:25:fb</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#virsh domifaddr centos7</span><br><span class="line">Name    MAC address     Protocol   Address</span><br><span class="line">-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330163113829.png" alt="image-20240330163113829"></p>
<p>在宿主机上自动生成虚拟网卡macvtap0@eth0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#ip a</span><br><span class="line">6: macvtap0@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel</span><br><span class="line">state UP group default qlen 500</span><br><span class="line"> <span class="built_in">link</span>/ether 52:54:00:0d:8a:0e brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> inet6 fe80::5054:ff:fe0d:8a0e/64 scope <span class="built_in">link</span></span><br><span class="line">   valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>



<h2 id="6-5-基于自定义网桥的虚拟网络"><a href="#6-5-基于自定义网桥的虚拟网络" class="headerlink" title="6.5 基于自定义网桥的虚拟网络"></a>6.5 基于自定义网桥的虚拟网络</h2><h3 id="6-5-1-自定义网桥架构"><a href="#6-5-1-自定义网桥架构" class="headerlink" title="6.5.1 自定义网桥架构"></a>6.5.1 自定义网桥架构</h3><p>桥接网络可以让运行在宿主机上的虚拟机使用和宿主机相同网段的IP，并且可以从外部直接访问到虚拟机，目前企业中大部分场景都使用桥接网络。</p>
<p><img src="/Virtualization/KVM/image-20240330163235256.png" alt="image-20240330163235256"></p>
<h3 id="6-5-2-在宿主机创建网桥"><a href="#6-5-2-在宿主机创建网桥" class="headerlink" title="6.5.2 在宿主机创建网桥"></a>6.5.2 在宿主机创建网桥</h3><h4 id="6-5-2-1-CentOS-创建桥接网卡"><a href="#6-5-2-1-CentOS-创建桥接网卡" class="headerlink" title="6.5.2.1 CentOS 创建桥接网卡"></a>6.5.2.1 CentOS 创建桥接网卡</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 network-scripts]#<span class="built_in">pwd</span></span><br><span class="line">/etc/sysconfig/network-scripts</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建网桥配置文件</span></span><br><span class="line">[root@centos8 network-scripts]#<span class="built_in">cat</span> ifcfg-virbr1</span><br><span class="line">TYPE=Bridge</span><br><span class="line">NAME=virbr1</span><br><span class="line">DEVICE=virbr1</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.8</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=10.0.0.2</span><br><span class="line">DNS1=180.76.76.76</span><br><span class="line">DNS2=223.6.6.6</span><br><span class="line"></span><br><span class="line"><span class="comment">#将物理网卡eth0加入网桥</span></span><br><span class="line">[root@centos8 network-scripts]#<span class="built_in">cat</span> ifcfg-eth0</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">NAME=eth0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">BRIDGE=virbr1</span><br><span class="line"></span><br><span class="line">[root@centos8 network-scripts]#nmcli connection reload</span><br><span class="line">[root@centos8 network-scripts]#nmcli connection up eth0 virbr1</span><br><span class="line">  </span><br><span class="line">[root@centos8 ~]#ip a</span><br><span class="line"></span><br><span class="line">[root@centos8 network-scripts]#<span class="built_in">pwd</span></span><br><span class="line">/etc/sysconfig/network-scripts</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建网桥配置文件</span></span><br><span class="line">[root@centos8 network-scripts]#<span class="built_in">cat</span> ifcfg-virbr1</span><br><span class="line">TYPE=Bridge</span><br><span class="line">NAME=virbr1</span><br><span class="line">DEVICE=virbr1</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.8</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=10.0.0.2</span><br><span class="line">DNS1=180.76.76.76</span><br><span class="line">DNS2=223.6.6.6</span><br><span class="line"></span><br><span class="line"><span class="comment">#将物理网卡eth0加入网桥</span></span><br><span class="line">[root@centos8 network-scripts]#<span class="built_in">cat</span> ifcfg-eth0</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">NAME=eth0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">BRIDGE=virbr1</span><br><span class="line"></span><br><span class="line">[root@centos8 network-scripts]#nmcli connection reload</span><br><span class="line">[root@centos8 network-scripts]#nmcli connection up eth0 virbr1</span><br><span class="line">  </span><br><span class="line">[root@centos8 ~]#ip a</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#bridge <span class="built_in">link</span> show</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]#ip <span class="built_in">link</span> show master virbr1</span><br></pre></td></tr></table></figure>



<h4 id="6-5-2-2-Ubuntu-创建桥接网卡"><a href="#6-5-2-2-Ubuntu-创建桥接网卡" class="headerlink" title="6.5.2.2 Ubuntu 创建桥接网卡"></a>6.5.2.2 Ubuntu 创建桥接网卡</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@ubuntu2004</span> <span class="string">~</span>]<span class="comment"># cat /etc/netplan/01-netcfg.yaml</span></span><br><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># For more information, see netplan(5).</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">networkd</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">eth0:</span></span><br><span class="line">      <span class="attr">addresses:</span> [<span class="number">10.0</span><span class="number">.0</span><span class="number">.100</span><span class="string">/16</span>]</span><br><span class="line">      <span class="attr">gateway4:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span> [<span class="number">223.6</span><span class="number">.6</span><span class="number">.6</span>]</span><br><span class="line">    <span class="attr">eth1:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">dhcp6:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">bridges:</span></span><br><span class="line">    <span class="attr">virbr1:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">dhcp6:</span> <span class="literal">no</span></span><br><span class="line">      <span class="comment">#addresses: [10.0.0.100/16]</span></span><br><span class="line">      <span class="comment">#gateway4: 10.0.0.2</span></span><br><span class="line">      <span class="comment">#nameservers:</span></span><br><span class="line">         <span class="comment"># addresses: [223.6.6.6]</span></span><br><span class="line">      <span class="attr">interfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">eth1</span></span><br></pre></td></tr></table></figure>



<h3 id="6-5-3-基于现有虚拟机镜像批量创建新虚拟机"><a href="#6-5-3-基于现有虚拟机镜像批量创建新虚拟机" class="headerlink" title="6.5.3 基于现有虚拟机镜像批量创建新虚拟机"></a>6.5.3 基于现有虚拟机镜像批量创建新虚拟机</h3><p>将前面生成的虚拟机做为模版,生成新的虚拟机</p>
<p><strong>注意:先在前面的模版虚拟机修改配置,如:关闭firewalld和SELinux,禁用NetworkManager(CentOS 7)等,安装常用包等</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 images]#<span class="built_in">pwd</span></span><br><span class="line">/var/lib/libvirt/images</span><br><span class="line"></span><br><span class="line">[root@centos8 images]#<span class="built_in">cp</span> centos8.qcow2 centos8-2.qcow2</span><br><span class="line"></span><br><span class="line">[root@centos8 images]#virt-install --virt-type kvm --os-variant centos8 --name centos8-2 --ram 2048 --vcpus 2 --disk bus=virtio,path=/var/lib/libvirt/images/centos8-2.qcow2 --network bridge=virbr1,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br><span class="line">WARNING No operating system detected, VM performance may suffer. Specify an OS</span><br><span class="line">with --os-variant <span class="keyword">for</span> optimal results.</span><br><span class="line">Starting install...</span><br><span class="line">Domain creation completed.</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行工具,可以看到下面出现新的虚拟机</span></span><br><span class="line">[root@centos8 images]#virt-manager</span><br><span class="line"></span><br><span class="line"><span class="comment">#开启的虚拟机磁盘文件所有者为qemu,关闭后为root</span></span><br><span class="line">[root@centos8 ~]#ll /var/lib/libvirt/images</span><br><span class="line">total 9977352</span><br><span class="line">-rw-r--r-- 1 qemu qemu 2029518848 Sep 21 23:37 centos8-2.qcow2</span><br><span class="line">-rw------- 1 root root 1929183232 Sep 21 23:33 centos8-clone.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 2004221952 Sep 21 23:32 centos8.qcow2</span><br></pre></td></tr></table></figure>

<p><img src="/Virtualization/KVM/image-20240330163511662.png" alt="image-20240330163511662"></p>
<h3 id="6-5-4-查看新虚拟机设置"><a href="#6-5-4-查看新虚拟机设置" class="headerlink" title="6.5.4 查看新虚拟机设置"></a>6.5.4 查看新虚拟机设置</h3><p><img src="/Virtualization/KVM/image-20240330163540312.png" alt="image-20240330163540312"></p>
<p><img src="/Virtualization/KVM/image-20240330163545664.png" alt="image-20240330163545664"></p>
<p><img src="/Virtualization/KVM/image-20240330163550079.png" alt="image-20240330163550079"></p>
<p><img src="/Virtualization/KVM/image-20240330163558615.png" alt="image-20240330163558615"></p>
<h2 id="6-6-内外网络隔离综合案例"><a href="#6-6-内外网络隔离综合案例" class="headerlink" title="6.6 内外网络隔离综合案例"></a>6.6 内外网络隔离综合案例</h2><p><strong>注意：vm2和vm3的虚拟机的IP需要静态配置，用 ip a a 添加的IP不稳定可能会丢失</strong></p>
<p>实现一个外网的web服务和内网的数据库相互隔离的环境</p>
<p>两台宿主机host1和host2</p>
<p>每个宿主机上面各有两个虚拟机,分别连接外网和内网交换机</p>
<p><img src="/Virtualization/KVM/image-20240330163627127.png" alt="image-20240330163627127"></p>
<p>范例: 多网卡绑定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu1804:~# vim /etc/netplan/01-netcfg.yaml</span><br><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># For more information, see netplan(5).</span></span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    eth0:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      dhcp6: no</span><br><span class="line"> 	eth1:</span><br><span class="line">  	  dhcp4: no</span><br><span class="line">  	  dhcp6: no</span><br><span class="line">	bonds:</span><br><span class="line"> 	  bond0:</span><br><span class="line">  		interfaces:</span><br><span class="line">    	  - eth0</span><br><span class="line">    	  - eth1</span><br><span class="line">  		addresses: [10.0.0.18/16]</span><br><span class="line">  		gateway4: 10.0.0.1</span><br><span class="line">  		nameservers:</span><br><span class="line">   		  addresses: [223.6.6.6,223.5.5.5]</span><br><span class="line">  		parameters:</span><br><span class="line">   		  mode: active-backup</span><br><span class="line">   		  mii-monitor-interval: 100</span><br><span class="line">   		  fail-over-mac-policy: active</span><br><span class="line">   		  </span><br><span class="line">root@ubuntu1804:~# netplan apply</span><br><span class="line"></span><br><span class="line">root@ubuntu1804:~# ifconfig bond0</span><br><span class="line">bond0: flags=5187&lt;UP,BROADCAST,RUNNING,MASTER,MULTICAST&gt; mtu 1500</span><br><span class="line">   inet 10.0.0.18 netmask 255.255.0.0 broadcast 10.0.255.255</span><br><span class="line">   inet6 fe80::2820:b7ff:fea8:5837 prefixlen 64 scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">   ether 2a:20:b7:a8:58:37 txqueuelen 1000 (Ethernet)</span><br><span class="line">   RX packets 296 bytes 25327 (25.3 KB)</span><br><span class="line">   RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">   TX packets 295 bytes 34876 (34.8 KB)</span><br><span class="line">   TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">   </span><br><span class="line">root@ubuntu1804:~# ifconfig eth0</span><br><span class="line">eth0: flags=6211&lt;UP,BROADCAST,RUNNING,SLAVE,MULTICAST&gt; mtu 1500</span><br><span class="line">   ether 2a:20:b7:a8:58:37 txqueuelen 1000 (Ethernet)</span><br><span class="line">   RX packets 3 bytes 180 (180.0 B)</span><br><span class="line">   RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">   TX packets 0 bytes 0 (0.0 B)</span><br><span class="line">   TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">   </span><br><span class="line">root@ubuntu1804:~# ifconfig eth1</span><br><span class="line">eth1: flags=6211&lt;UP,BROADCAST,RUNNING,SLAVE,MULTICAST&gt; mtu 1500</span><br><span class="line">   ether 2a:20:b7:a8:58:37 txqueuelen 1000 (Ethernet)</span><br><span class="line">   RX packets 340 bytes 28893 (28.8 KB)</span><br><span class="line">   RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">   TX packets 336 bytes 39940 (39.9 KB)</span><br><span class="line">   TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">   </span><br><span class="line">root@ubuntu1804:~# <span class="built_in">cat</span> /proc/net/bonding/bond0</span><br><span class="line">Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)</span><br><span class="line">Bonding Mode: fault-tolerance (active-backup)</span><br><span class="line">Primary Slave: None</span><br><span class="line">Currently Active Slave: eth1</span><br><span class="line">MII Status: up</span><br><span class="line">MII Polling Interval (ms): 100</span><br><span class="line">Up Delay (ms): 0</span><br><span class="line">Down Delay (ms): 0</span><br><span class="line">Slave Interface: eth1</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 1000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:34:<span class="built_in">df</span>:9b</span><br><span class="line">Slave queue ID: 0</span><br><span class="line">Slave Interface: eth0</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 1000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:34:<span class="built_in">df</span>:91</span><br><span class="line">Slave queue ID: 0</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://AquaPluto.github.io">Aquarius</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://aquapluto.github.io/Virtualization/KVM/">https://aquapluto.github.io/Virtualization/KVM/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://AquaPluto.github.io" target="_blank">代码推演录</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/paper5.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/Kubernetes/service-loadbalancer/service/" title="Service"><img class="cover" src="/img/paper3.png" onerror="onerror=null;src='/img/error-page.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Service</div></div><div class="info-2"><div class="info-item-1">1 Service资源概念Serv...</div></div></div></a><a class="pagination-related" href="/Kubernetes/controller/operator/" title="Operator"><img class="cover" src="/img/paper1.jpg" onerror="onerror=null;src='/img/error-page.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Operator</div></div><div class="info-2"><div class="info-item-1">1 Operator 简介比如我们...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Aquarius</div><div class="author-info-description">分享运维开发相关技术</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">138</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" href="https://github.com/AquaPluto"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/AquaPluto" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://blog.csdn.net/m0_75233142" target="_blank" title="CSDN"><i class="fa-solid fa-code" style="color: #8a2be2;"></i></a><a class="social-icon" href="mailto:wujunlinq@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><p>持续更新文章中，有问题请添加wx</p>
<div>
  <img src="/img/wx.jpg" alt="wx" style="width: 100px">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E8%99%9A%E6%8B%9F%E5%8C%96%E5%9F%BA%E7%A1%80"><span class="toc-text">1 虚拟化基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%BC%A0%E7%BB%9F%E7%9A%84%E7%89%A9%E7%90%86%E6%9C%BA%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88"><span class="toc-text">1.1 传统的物理机部署方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">1.2 虚拟化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">1.2.1 什么是虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-%E8%99%9A%E6%8B%9F%E5%8C%96%E4%BC%98%E5%8A%BF"><span class="toc-text">1.2.2 虚拟化优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-%E8%99%9A%E6%8B%9F%E5%8C%96%E7%B1%BB%E5%9E%8B"><span class="toc-text">1.2.3 虚拟化类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">1.2.3.1 服务器虚拟化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-2-%E7%BD%91%E7%BB%9C%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">1.2.3.2 网络虚拟化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-3-%E6%A1%8C%E9%9D%A2%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">1.2.3.3 桌面虚拟化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-4-%E5%BA%94%E7%94%A8%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">1.2.3.4 应用虚拟化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-5-%E5%AD%98%E5%82%A8%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">1.2.3.5 存储虚拟化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-6-%E5%BA%93%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">1.2.3.6 库虚拟化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-7-%E5%AE%B9%E5%99%A8%E8%99%9A%E6%8A%80%E6%9C%AF"><span class="toc-text">1.2.3.7 容器虚技术</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">1.3 虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">1.3.1 虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E4%B8%BB%E8%A6%81%E7%89%B9%E6%80%A7"><span class="toc-text">1.3.2 虚拟机的主要特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-Hypervisor%E7%B1%BB%E5%9E%8B"><span class="toc-text">1.4 Hypervisor类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-Hypervisor-%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.4.1 Hypervisor 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-Hypervisor-%E5%88%86%E7%B1%BB"><span class="toc-text">1.4.2 Hypervisor 分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-1-%E7%B1%BB%E5%9E%8B-I-%E8%A3%B8%E9%87%91%E5%B1%9E%E5%9E%8B"><span class="toc-text">1.4.2.1 类型 I : 裸金属型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-2-%E7%B1%BB%E5%9E%8B-II-%E5%AE%BF%E4%B8%BB%E5%9E%8B"><span class="toc-text">1.4.2.2 类型 II : 宿主型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF%E5%88%86%E7%B1%BB"><span class="toc-text">1.5 虚拟化技术分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-1-%E6%A8%A1%E6%8B%9F%E5%99%A8-%E8%BD%AF%E4%BB%B6%E4%BB%BF%E7%9C%9F"><span class="toc-text">1.5.1 模拟器&#x2F;软件仿真</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-2-%E5%85%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%8C%96-full-virtualization-%E6%9C%AC%E5%9C%B0%E8%99%9A%E6%8B%9F%E5%8C%96-native-virtualization"><span class="toc-text">1.5.2 全虚拟机化 full virtualization &#x2F; 本地虚拟化 native virtualization</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-1-%E8%BD%AF%E4%BB%B6%E8%BE%85%E5%8A%A9%E7%9A%84%E5%85%A8%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">1.5.2.1 软件辅助的全虚拟化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-2-%E7%A1%AC%E4%BB%B6%E8%BE%85%E5%8A%A9%E7%9A%84%E5%85%A8%E8%99%9A%E6%8B%9F%E5%8C%96-HVM-Hardware-Virtual-Machine"><span class="toc-text">1.5.2.2 硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-3-%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96-para-virtualization"><span class="toc-text">1.5.3 半虚拟化 para virtualization</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-KVM%E6%9E%B6%E6%9E%84%E5%92%8C%E9%83%A8%E7%BD%B2"><span class="toc-text">2 KVM架构和部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-KVM-%E6%A6%82%E8%BF%B0"><span class="toc-text">2.1 KVM 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-KVM-%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.1.1 KVM 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-KVM%E6%9E%B6%E6%9E%84"><span class="toc-text">2.1.2 KVM架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-1-KVM-%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-text">2.1.2.1 KVM 体系结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-2-KVM-%E6%A8%A1%E5%9D%97%E8%BD%BD%E5%85%A5%E5%90%8E%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F"><span class="toc-text">2.1.2.2 KVM 模块载入后的系统的运行模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-KVM-%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E4%B8%8E%E6%8E%A7%E5%88%B6"><span class="toc-text">2.1.3 KVM 集中管理与控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">2.2 宿主机环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-CPU%E5%BC%80%E5%90%AF%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">2.2.1 CPU开启虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E9%AA%8C%E8%AF%81%E5%BC%80%E5%90%AF%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">2.2.2 验证开启虚拟化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E5%AE%89%E8%A3%85KVM%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="toc-text">2.3 安装KVM工具包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-KVM-%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E5%8C%85%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.3.1 KVM 相关工具包介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-libvirt-%E5%8C%85%E5%8A%9F%E8%83%BD"><span class="toc-text">2.3.2 libvirt 包功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-1-libvirt-%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.3.2.1 libvirt 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-2-libvirt-%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="toc-text">2.3.2.2 libvirt 结构图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E5%AE%89%E8%A3%85KVM%E7%9B%B8%E5%85%B3%E5%8C%85"><span class="toc-text">2.3.3 安装KVM相关包</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-1-Ubuntu-%E5%AE%89%E8%A3%85-KVM"><span class="toc-text">2.3.3.1 Ubuntu 安装 KVM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-2-CentOS-%E5%AE%89%E8%A3%85-KVM"><span class="toc-text">2.3.3.2 CentOS 安装 KVM</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E5%9B%BE%E5%BD%A2%E5%8C%96%E5%B7%A5%E5%85%B7-virt-manager"><span class="toc-text">2.3.4 图形化工具 virt-manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5-%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2.5 默认网络配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%87%86%E5%A4%87%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F%E7%9A%84ISO%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-text">2.4 准备安装系统的ISO相关文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-AMD-CPU-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%97%B6%E7%9A%84%E6%95%85%E9%9A%9C%E6%8E%92%E9%94%99"><span class="toc-text">2.5 AMD CPU 创建虚拟机时的故障排错</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-AMD-CPU-%E4%BD%BF%E7%94%A8virt-manager%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%87%BA%E9%94%99%E6%8F%90%E7%A4%BA"><span class="toc-text">2.5.1 AMD CPU 使用virt-manager创建虚拟机出错提示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-2-AMD-CPU-%E4%BD%BF%E7%94%A8virt-install%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%87%BA%E9%94%99%E6%8F%90%E7%A4%BA"><span class="toc-text">2.5.2 AMD CPU 使用virt-install创建虚拟机出错提示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-3-AMD-CPU-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%95%85%E9%9A%9C%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%B3%95"><span class="toc-text">2.5.3 AMD CPU 创建虚拟机故障修复方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">3 创建虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E4%BD%BF%E7%94%A8-virt-manager-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">3.1 使用 virt-manager 创建虚拟机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%BD%BF%E7%94%A8-virt-install-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">3.2 使用 virt-install 创建虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-virt-install-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="toc-text">3.2.1 virt-install 使用说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-virt-install-%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">3.2.2 virt-install 命令创建虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-1-%E5%88%A9%E7%94%A8-qemu-img-%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98-%E5%8F%AF%E9%80%89"><span class="toc-text">3.2.2.1 利用 qemu-img 命令创建虚拟磁盘(可选)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-2-%E5%88%A9%E7%94%A8-osinfo-query%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E6%94%AF%E6%8C%81%E7%9A%84OS%E7%89%88%E6%9C%AC"><span class="toc-text">3.2.2.2 利用 osinfo-query命令查看支持的OS版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-3-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BD%BF%E7%94%A8%E5%85%89%E7%9B%98%E5%90%AF%E5%8A%A8%E5%B9%B6%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85"><span class="toc-text">3.2.2.3 创建虚拟机使用光盘启动并手动安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-4-%E9%AA%8C%E8%AF%81%E5%AE%BF%E4%B8%BB%E6%9C%BA%E8%BF%9B%E7%A8%8B"><span class="toc-text">3.2.2.4 验证宿主机进程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%9F%BA%E4%BA%8E%E7%8E%B0%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%A3%81%E7%9B%98%E4%B8%BA%E6%A8%A1%E7%89%88%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">3.3 基于现有虚拟机磁盘为模版创建新的虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E5%88%A9%E7%94%A8virt-manager%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.3.1 利用virt-manager实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-1-%E5%AF%BC%E5%85%A5%E9%95%9C%E7%9B%98%E6%96%87%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.3.1.1 导入镜盘文件实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-2-Clone"><span class="toc-text">3.3.1.2 Clone</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E5%88%A9%E7%94%A8virt-install%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.3.2 利用virt-install实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-%E5%88%A9%E7%94%A8virt-clone%E5%85%8B%E9%9A%86%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.3.3 利用virt-clone克隆实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E6%80%BB%E7%BB%93%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%91%BD%E4%BB%A4"><span class="toc-text">3.4 总结自动化构建虚拟机命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">4 管理虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E4%BD%BF%E7%94%A8%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96%E9%A9%B1%E5%8A%A8-virtio"><span class="toc-text">4.1 使用半虚拟化驱动 virtio</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96%E9%A9%B1%E5%8A%A8virtio%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">4.1.1 半虚拟化驱动virtio的工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96%E8%AE%BE%E5%A4%87%E7%BB%9F%E4%B8%80%E6%8E%A5%E5%8F%A3virtio"><span class="toc-text">4.1.2 半虚拟化设备统一接口virtio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E9%A9%B1%E5%8A%A8%E8%8E%B7%E5%8F%96"><span class="toc-text">4.1.3 驱动获取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-1-Linux-%E7%9A%84-VirtIO-%E9%A9%B1%E5%8A%A8"><span class="toc-text">4.1.3.1 Linux 的 VirtIO 驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-2-Windows-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%9C%80%E8%A6%81%E9%A2%9D%E5%A4%96%E5%AE%89%E8%A3%85-virtio-%E7%9A%84%E9%A9%B1%E5%8A%A8"><span class="toc-text">4.1.3.2 Windows 操作系统需要额外安装 virtio 的驱动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4-Linux-%E6%B5%8B%E8%AF%95%E5%AE%89%E8%A3%85virtio%E9%A9%B1%E5%8A%A8%E5%89%8D%E5%90%8E%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%80%A7%E8%83%BD%E5%8F%98%E5%8C%96"><span class="toc-text">4.1.4 Linux 测试安装virtio驱动前后的虚拟机性能变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-5-%E5%AE%89%E8%A3%85-Windows-Server-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">4.1.5 安装 Windows Server 虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5-1-%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%87%86%E5%A4%87%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-text">4.1.5.1 下载并准备相关文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5-2-%E5%88%9B%E5%BB%BA-Windows-Server-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">4.1.5.2 创建 Windows Server 虚拟机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5-3-%E5%AE%89%E8%A3%85-Windows-Server"><span class="toc-text">4.1.5.3 安装 Windows Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5-4-%E9%AA%8C%E8%AF%81-Windows-virtio-%E9%A9%B1%E5%8A%A8"><span class="toc-text">4.1.5.4 验证 Windows virtio 驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5-5-%E5%AE%89%E8%A3%85%E7%BD%91%E5%8D%A1%E9%A9%B1%E5%8A%A8"><span class="toc-text">4.1.5.5 安装网卡驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5-6-%E5%AE%89%E8%A3%85PCI-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E9%A9%B1%E5%8A%A8"><span class="toc-text">4.1.5.6 安装PCI 内存管理驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5-7-%E7%94%9F%E6%88%90Windows-Server-%E9%95%9C%E5%83%8F%E6%A8%A1%E7%89%88"><span class="toc-text">4.1.5.7 生成Windows Server 镜像模版</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-5-8-%E5%9F%BA%E4%BA%8E%E6%A8%A1%E7%89%88%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84Windows%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">4.1.5.8 基于模版创建新的Windows的虚拟机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-libvirt-%E6%9E%B6%E6%9E%84"><span class="toc-text">4.2 libvirt 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-virt-manager-%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">4.3 virt-manager 管理虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E5%90%AF%E5%8A%A8%E8%8F%9C%E5%8D%95"><span class="toc-text">4.3.1 启动菜单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86KVM%E5%AE%BF%E4%B8%BB%E6%9C%BA"><span class="toc-text">4.3.2 远程管理KVM宿主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="toc-text">4.3.3 虚拟机的性能监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-4-%E7%AE%A1%E7%90%86%E5%BF%AB%E7%85%A7"><span class="toc-text">4.3.4 管理快照</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-virsh-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-text">4.4 virsh 命令行工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-virsh-%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E"><span class="toc-text">4.4.1 virsh 命令说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-1-%E4%B8%A4%E7%A7%8D%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-text">4.4.1.1 两种工作模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-2-virsh-%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-text">4.4.1.2 virsh 主要功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-3-virsh-%E5%91%BD%E4%BB%A4%E6%A0%BC%E5%BC%8F"><span class="toc-text">4.4.1.3 virsh 命令格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-4-virsh-%E5%AD%90%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E"><span class="toc-text">4.4.1.4 virsh 子命令说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-5-%E6%9F%A5%E7%9C%8B%E5%AD%90%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9"><span class="toc-text">4.4.1.5 查看子命令帮助</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E5%90%AF%E5%8A%A8%E5%92%8C%E5%85%B3%E9%97%AD%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">4.4.2 启动和关闭虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E6%9A%82%E5%81%9C%E5%92%8C%E6%81%A2%E5%A4%8D%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">4.4.3 暂停和恢复虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-4-%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BC%80%E6%9C%BA%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8"><span class="toc-text">4.4.4 配置虚拟机开机自动启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-5-%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="toc-text">4.4.5 查看虚拟机配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-6-%E5%88%A0%E9%99%A4%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="toc-text">4.4.6 删除虚拟机配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-7-%E5%86%B7%E8%BF%81%E7%A7%BB%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">4.4.7 冷迁移虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-8-%E7%83%AD%E8%BF%81%E7%A7%BB%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">4.4.8 热迁移虚拟机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-virt-what"><span class="toc-text">4.5 virt-what</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86"><span class="toc-text">5 存储管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-KVM%E5%AD%98%E5%82%A8%E6%A8%A1%E5%BC%8F"><span class="toc-text">5.1 KVM存储模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E7%B1%BB%E5%9E%8B"><span class="toc-text">5.2 虚拟磁盘类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E8%99%9A%E6%8B%9F%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-text">5.3 虚拟镜像文件格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E4%BD%BF%E7%94%A8-qemu-img-%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6"><span class="toc-text">5.4 使用 qemu-img 管理虚拟磁盘文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1-qemu-img-%E6%A6%82%E8%BF%B0"><span class="toc-text">5.4.1 qemu-img 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6"><span class="toc-text">5.4.2 创建虚拟磁盘文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-1-%E5%88%9B%E5%BB%BA%E9%BB%98%E8%AE%A4%E7%A8%80%E7%96%8F%E6%A0%BC%E5%BC%8F%E7%9A%84%E7%A3%81%E7%9B%98"><span class="toc-text">5.4.2.1 创建默认稀疏格式的磁盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-2-%E6%9F%A5%E7%9C%8B%E4%B8%8D%E5%90%8C%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%94%AF%E6%8C%81%E9%80%89%E9%A1%B9"><span class="toc-text">5.4.2.2 查看不同磁盘文件格式支持选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-3-qcow2-%E6%A0%BC%E5%BC%8F%E9%80%89%E9%A1%B9"><span class="toc-text">5.4.2.3 qcow2 格式选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-4-%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E9%9D%9E%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6"><span class="toc-text">5.4.2.4 创建raw格式非稀疏文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-5-%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6"><span class="toc-text">5.4.2.5 创建raw格式稀疏文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-6-raw%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E7%9A%84%E6%A0%BC%E5%BC%8F%E6%8E%A7%E5%88%B6"><span class="toc-text">5.4.2.6 raw文件复制的格式控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-3-%E6%A3%80%E6%9F%A5%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98"><span class="toc-text">5.4.3 检查虚拟磁盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-4-%E7%A3%81%E7%9B%98%E9%A2%84%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-text">5.4.4 磁盘预分配策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-5-%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2"><span class="toc-text">5.4.5 虚拟磁盘格式转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-6-%E8%B0%83%E6%95%B4%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E5%A4%A7%E5%B0%8F"><span class="toc-text">5.4.6 调整虚拟磁盘大小</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E7%A3%81%E7%9B%98%E5%BF%AB%E7%85%A7%E7%AE%A1%E7%90%86"><span class="toc-text">5.5 磁盘快照管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-1-%E5%BF%AB%E7%85%A7Snapshot%E4%BB%8B%E7%BB%8D"><span class="toc-text">5.5.1 快照Snapshot介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-2-qemu-img-%E7%AE%A1%E7%90%86%E7%A3%81%E7%9B%98%E5%BF%AB%E7%85%A7"><span class="toc-text">5.5.2 qemu-img 管理磁盘快照</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-3-virsh-%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BF%AB%E7%85%A7"><span class="toc-text">5.5.3 virsh 管理虚拟机快照</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86"><span class="toc-text">6 网络管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-Linux-%E7%BD%91%E6%A1%A5%E5%AE%9E%E7%8E%B0"><span class="toc-text">6.1 Linux 网桥实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-qemu-kvm%E6%94%AF%E6%8C%81%E7%9A%84%E7%BD%91%E7%BB%9C"><span class="toc-text">6.2 qemu-kvm支持的网络</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E9%BB%98%E8%AE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AENAT%E6%A8%A1%E5%BC%8F"><span class="toc-text">6.3 默认的网络配置NAT模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1-%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">6.3.1 默认网络连接的架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2-%E5%AE%BF%E4%B8%BB%E6%9C%BA%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%92%8C%E4%BF%A1%E6%81%AF"><span class="toc-text">6.3.2 宿主机默认网络相关服务和信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-3-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E5%8D%A1%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE"><span class="toc-text">6.3.3 虚拟机网卡默认设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-4-virsh-%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-text">6.3.4 virsh 查看虚拟机网络配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E5%8D%A1%E6%A1%A5%E6%8E%A5%E5%88%B0%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9A%84%E7%89%A9%E7%90%86%E7%BD%91%E5%8D%A1"><span class="toc-text">6.4 配置虚拟机网卡桥接到宿主机的物理网卡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E6%A1%A5%E7%9A%84%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C"><span class="toc-text">6.5 基于自定义网桥的虚拟网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-1-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E6%A1%A5%E6%9E%B6%E6%9E%84"><span class="toc-text">6.5.1 自定义网桥架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-2-%E5%9C%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E5%88%9B%E5%BB%BA%E7%BD%91%E6%A1%A5"><span class="toc-text">6.5.2 在宿主机创建网桥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-2-1-CentOS-%E5%88%9B%E5%BB%BA%E6%A1%A5%E6%8E%A5%E7%BD%91%E5%8D%A1"><span class="toc-text">6.5.2.1 CentOS 创建桥接网卡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-2-2-Ubuntu-%E5%88%9B%E5%BB%BA%E6%A1%A5%E6%8E%A5%E7%BD%91%E5%8D%A1"><span class="toc-text">6.5.2.2 Ubuntu 创建桥接网卡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-3-%E5%9F%BA%E4%BA%8E%E7%8E%B0%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F%E6%89%B9%E9%87%8F%E5%88%9B%E5%BB%BA%E6%96%B0%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">6.5.3 基于现有虚拟机镜像批量创建新虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-4-%E6%9F%A5%E7%9C%8B%E6%96%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AE%BE%E7%BD%AE"><span class="toc-text">6.5.4 查看新虚拟机设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-%E5%86%85%E5%A4%96%E7%BD%91%E7%BB%9C%E9%9A%94%E7%A6%BB%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B"><span class="toc-text">6.6 内外网络隔离综合案例</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/role/" title="Role角色"><img src="/img/paper4.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="Role角色"/></a><div class="content"><a class="title" href="/CICD/ansible/role/" title="Role角色">Role角色</a><time datetime="2025-09-13T10:07:53.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/playbook/" title="PlayBook"><img src="/img/paper5.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="PlayBook"/></a><div class="content"><a class="title" href="/CICD/ansible/playbook/" title="PlayBook">PlayBook</a><time datetime="2025-09-13T10:07:48.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/module/" title="常用模块"><img src="/img/paper1.jpg" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="常用模块"/></a><div class="content"><a class="title" href="/CICD/ansible/module/" title="常用模块">常用模块</a><time datetime="2025-09-13T10:07:42.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/command/" title="相关命令"><img src="/img/paper3.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="相关命令"/></a><div class="content"><a class="title" href="/CICD/ansible/command/" title="相关命令">相关命令</a><time datetime="2025-09-13T10:07:38.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/deploy/" title="部署与配置"><img src="/img/paper2.jpg" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="部署与配置"/></a><div class="content"><a class="title" href="/CICD/ansible/deploy/" title="部署与配置">部署与配置</a><time datetime="2025-09-13T10:07:29.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Aquarius</span></div><div class="footer_custom_text"><style>
div#runtime {
  font-size: 13px;
  font-weight: bold;
}

div#ghbdages_list {
  height: 1.5rem;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 10px
}

.github-badge {
  display: flex;
  align-items: center;
  margin-inline: 6px;
}
</style>
<div id="runtime"></div>
<div id="ghbdages"></div>
<script>
  function createtime() {
    const now = new Date();
    const grt = new Date("08/01/2025 00:00:00"); // 网站诞生时间

    // 计算天、小时、分钟和秒
    const days = Math.floor((now - grt) / (1000 * 60 * 60 * 24));
    const hours = Math.floor(((now - grt) / (1000 * 60 * 60)) % 24)
      .toString()
      .padStart(2, "0");
    const minutes = Math.floor(((now - grt) / (1000 * 60)) % 60)
      .toString()
      .padStart(2, "0");
    const seconds = Math.floor(((now - grt) / 1000) % 60)
      .toString()
      .padStart(2, "0");

    // HTML 输出
    const currentTimeHtml = `
          <div>
              本站已运行 ${days} 天 ${hours} 小时 ${minutes} 分 ${seconds} 秒 
          </div>`;

    const runtime = document.getElementById("runtime");
    if (runtime) runtime.innerHTML = currentTimeHtml;
  }

  // 设置每秒调用函数
  setInterval(createtime, 1000);

  function renderBadge() {
    const currentTimeHtml = `
      <div id="ghbdages_list">
          <a class="github-badge" target="_blank" href="https://hexo.io/" title="hexo:7.3.0">
              <img src="https://img.shields.io/badge/Frame-Hexo-blue?logo=hexo" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://github.com/" title="github">
              <img src="https://img.shields.io/badge/Code-GitHub-181717?logo=GitHub&color=%23FF7102" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://vercel.com/" title="vercel">
              <img src="https://img.shields.io/badge/Host-Vercel-%23F0D722?logo=Vercel" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://analytics.sysio.ai/" title="umami">
              <img src="https://img.shields.io/badge/Analytics-Umami-%237FB100?logo=umami&logoColor=%237FB100" alt="Static Badge">
          </a>
      </div>`;

    const ghbdages = document.getElementById("ghbdages");
    if (ghbdages) {
      ghbdages.innerHTML = currentTimeHtml;
    }
  }

  window.onload = renderBadge;
</script>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/instant.page/instantpage.js" type="module"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://unpkg.com/mathjax/es5/tex-mml-chtml.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://unpkg.com/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://cdn.jsdelivr.net/gh/xiabo2/CDN@latest/fishes.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://unpkg.com/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章..." type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>