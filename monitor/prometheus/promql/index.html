<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>PromQL | 代码推演录</title><meta name="author" content="Aquarius"><meta name="copyright" content="Aquarius"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="1 时间序列数据时间序列数据是在一段时间内重复测量而获得的观测值的集合，即按照相同时序(相同的名字和标签)，以时间维度存储连续的数据的集合。然后将这些观测值绘制在图形中，它会有一个时间轴和数据轴。可以就是一个变量在不同时间点上的取值序列。 每一个观测值，即数据称为样本。时间序列的核心在于它记录的是随时间变化的数据点，每个数据点包含一个时间戳和对应的值。序列也称为向量，当多个序列数据放在同一个坐标系">
<meta property="og:type" content="article">
<meta property="og:title" content="PromQL">
<meta property="og:url" content="https://aquapluto.github.io/Monitor/prometheus/promql/">
<meta property="og:site_name" content="代码推演录">
<meta property="og:description" content="1 时间序列数据时间序列数据是在一段时间内重复测量而获得的观测值的集合，即按照相同时序(相同的名字和标签)，以时间维度存储连续的数据的集合。然后将这些观测值绘制在图形中，它会有一个时间轴和数据轴。可以就是一个变量在不同时间点上的取值序列。 每一个观测值，即数据称为样本。时间序列的核心在于它记录的是随时间变化的数据点，每个数据点包含一个时间戳和对应的值。序列也称为向量，当多个序列数据放在同一个坐标系">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://aquapluto.github.io/img/paper1.jpg">
<meta property="article:published_time" content="2025-08-27T10:16:50.000Z">
<meta property="article:modified_time" content="2025-09-12T09:32:17.572Z">
<meta property="article:author" content="Aquarius">
<meta property="article:tag" content="Prometheus">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aquapluto.github.io/img/paper1.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "PromQL",
  "url": "https://aquapluto.github.io/Monitor/prometheus/promql/",
  "image": "https://aquapluto.github.io/img/paper1.jpg",
  "datePublished": "2025-08-27T10:16:50.000Z",
  "dateModified": "2025-09-12T09:32:17.572Z",
  "author": [
    {
      "@type": "Person",
      "name": "Aquarius",
      "url": "https://AquaPluto.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://aquapluto.github.io/Monitor/prometheus/promql/"><link rel="preconnect" href="//unpkg.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://unpkg.com/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PromQL',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/wave.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">138</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/software-manage/"><span>软件包管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/OOM/"><span>OOM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/swap/"><span>Swap分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/data-synchronization/"><span>数据的实时同步</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/mail/"><span>邮件服务</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/kernel-manage/"><span>内核和启动管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-lock/"><span>进程锁</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/queue/"><span>队列实现线程并发控制</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/MySQL/SQL/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/Redis/deploy/"><span>部署安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Tomcat/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>存储</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/conspect/"><span>存储概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/nfs/"><span>NFS</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/conspect/"><span>Docker概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/image/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/container/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/volume/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/network/"><span>网络管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/compose/"><span>Docker-Compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/conspect/"><span>镜像概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/dockerfile/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/build/"><span>构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/harbor/"><span>镜像仓库</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/management/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-cgroup/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-usage/"><span>监控容器真实的cpu使用率</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/containerd/"><span>Containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>K8s</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kubernetes概论</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/architecture/"><span>Kubernetes架构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/cri/"><span>容器运行时接口CRI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/list-watch/"><span>List-Watch机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/object/"><span>Kubernetes对象</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/namespace/"><span>Namespace</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/kubectl/"><span>kubectl命令</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>部署安装</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/explanation/"><span>部署说明</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/docker/"><span>基于docker部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/containerd/"><span>基于containerd部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/cluster/"><span>集群管理指南</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Pod</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/conspect/"><span>Pod概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/configuration/"><span>Pod的配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/schedule/"><span>Pod的调度</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/eviction/"><span>Pod的驱逐</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>控制器</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/introduce/"><span>控制器介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/deployment/"><span>Deployment</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/statefulset/"><span>StatefulSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/daemonset/"><span>DaemonSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/job-cronjob/"><span>Job和CronJob</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/HPA/"><span>HPA</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/operator/"><span>Operator</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务发现与负载均衡</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/service/"><span>Service</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/ingress/"><span>Ingress</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/coredns/"><span>CoreDNS</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/localdns/"><span>LocalDNS</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>数据存储持久化</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/csi/"><span>存储接口CSI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/pv-pvc/"><span>PV和PVC</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/storageclass/"><span>StorageClass</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/configmap-secret/"><span>ConfigMap和Secret</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>认证与鉴权体系</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/conspect/"><span>体系概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/kubeconfig/"><span>kubeconfig</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/user-account/"><span>User Account</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/service-account/"><span>Service Account</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/introduce/"><span>prometheus概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/query-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/indicators-remarked/"><span>指标重新打标</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/pushmanager/"><span>Pushmanager</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/cluster-ha/"><span>集群与高可用</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/ha/"><span>高可用架构</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/grafana/"><span>Grafana</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/streaming/"><span>基于流处理的可观测性架构</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/paper1.jpg);"><nav id="nav"><!-- 左侧博客信息区域--><span id="blog-info"><a class="nav-site-title" href="/"></a><a class="nav-page-title" href="/"><span class="site-name">PromQL</span></a></span><!-- 新增的导航菜单容器（居中布局关键）--><div id="nav-menus-container"><!-- 菜单主体部分--><div id="menus"><!-- 菜单项--><div class="menus_items"><!-- 一级菜单项（非目录）--><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>计算机基础</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>计算机组成原理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hardware-composition/"><span>计算机硬件组成</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/CPU/"><span>CPU</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/memory/"><span>内存</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/computer-composition/hard-disk/"><span>硬盘</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>操作系统</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/concept/"><span>操作系统的概念</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/processes-threads/"><span>进程与线程</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/ComputerBasic/operating-system/IO-model/"><span>IO模型</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Linux</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>linux基础</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/introduce/"><span>linux介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-structure-and-IO-redirects/"><span>文件结构与IO重定向</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/file-command/"><span>文件管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/text-command/"><span>文本管理工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/GSA/"><span>文本处理三剑客</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/user-permission/"><span>用户和权限管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/basics/regular-expression/"><span>正则表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/software-manage/"><span>软件包管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>进程管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/command/"><span>进程相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/signal/"><span>信号发送</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/job-parallel/"><span>作业管理与并行运行</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/process-manage/OOM/"><span>OOM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>磁盘管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/disk-partition/"><span>磁盘分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/file-system/"><span>文件系统</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/swap/"><span>Swap分区</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/disk-manage/LVM/"><span>逻辑卷管理器LVM</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>网络管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/configuration/"><span>网络配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/test-diagnostic/"><span>网络测试诊断工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/bridge/"><span>网桥配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/network-manage/troubleshoot/"><span>网络问题排查</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务管理</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/DNS/"><span>域名DNS解析服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/time-synchronization/"><span>时间同步服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/plan-tasks/"><span>计划任务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/log/"><span>日志服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/data-synchronization/"><span>数据的实时同步</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/ssh/"><span>ssh远程连接服务</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/service-manage/mail/"><span>邮件服务</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/kernel-manage/"><span>内核和启动管理</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>防火墙</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/introduce/"><span>安全技术和防火墙</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/iptables/"><span>iptables</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/firewalld/"><span>firewalld</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/firewall/nft/"><span>nft</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>加密和安全</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/security-mechanisms/"><span>安全机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/OpenSSL/"><span>OpenSSL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/sudo/"><span>sudo实现授权</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/encryption-security/PAM/"><span>PAM认证机制</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>shell编程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/introduce/"><span>shell脚本介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/variable/"><span>变量</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/operations-conditional/"><span>运算和条件测试</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-control/"><span>流程控制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/function/"><span>函数</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/array/"><span>数组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/string/"><span>字符串</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/script-tools/"><span>脚本相关工具</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/process-lock/"><span>进程锁</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Linux/shell/queue/"><span>队列实现线程并发控制</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Linux/system-optimization/"><span>系统优化</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>数据库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>MySQL</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/MySQL/SQL/"><span>SQL语句</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Redis</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/DataBase/Redis/deploy/"><span>部署安装</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>中间件</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Nginx</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Nginx/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>HAProxy</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/HAProxy/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Keepalived</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Keepalived/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kafka</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Kafka/111/"><span>111</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Tomcat</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Middleware/Tomcat/111/"><span>111</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>日志</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>存储</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/conspect/"><span>存储概论</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Storage/nfs/"><span>NFS</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>容器</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/basics/"><span>容器基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Docker</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/conspect/"><span>Docker概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/image/"><span>镜像管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/container/"><span>容器管理命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/volume/"><span>数据卷</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/network/"><span>网络管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/docker/compose/"><span>Docker-Compose</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>镜像</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/conspect/"><span>镜像概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/dockerfile/"><span>dockerfile</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/build/"><span>构建镜像</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/mirror/harbor/"><span>镜像仓库</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>容器进程</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/management/"><span>容器里的进程管理</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-cgroup/"><span>cpu cgroup使用</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Container/process/cpu-usage/"><span>监控容器真实的cpu使用率</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/memory/"><span>容器内存</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/storage/"><span>容器存储</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/network/"><span>容器网络</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/safe/"><span>容器安全</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Container/containerd/"><span>Containerd</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>K8s</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Kubernetes概论</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/architecture/"><span>Kubernetes架构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/cri/"><span>容器运行时接口CRI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/list-watch/"><span>List-Watch机制</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/object/"><span>Kubernetes对象</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/namespace/"><span>Namespace</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/conspect/kubectl/"><span>kubectl命令</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>部署安装</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/explanation/"><span>部署说明</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/docker/"><span>基于docker部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/containerd/"><span>基于containerd部署k8s-v1.30</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/deploy/cluster/"><span>集群管理指南</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Pod</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/conspect/"><span>Pod概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/configuration/"><span>Pod的配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/schedule/"><span>Pod的调度</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/pod/eviction/"><span>Pod的驱逐</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>控制器</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/introduce/"><span>控制器介绍</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/deployment/"><span>Deployment</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/statefulset/"><span>StatefulSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/daemonset/"><span>DaemonSet</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/job-cronjob/"><span>Job和CronJob</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/HPA/"><span>HPA</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/controller/operator/"><span>Operator</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>服务发现与负载均衡</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/service/"><span>Service</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/ingress/"><span>Ingress</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/coredns/"><span>CoreDNS</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/service-loadbalancer/localdns/"><span>LocalDNS</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>数据存储持久化</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/csi/"><span>存储接口CSI</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/pv-pvc/"><span>PV和PVC</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/storageclass/"><span>StorageClass</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/data-storage/configmap-secret/"><span>ConfigMap和Secret</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>认证与鉴权体系</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/conspect/"><span>体系概论</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/kubeconfig/"><span>kubeconfig</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/user-account/"><span>User Account</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Kubernetes/certification-authentication/service-account/"><span>Service Account</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>监控</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/conspect/"><span>监控概论</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Prometheus</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/introduce/"><span>prometheus概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/exporter/"><span>Exporter</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/promql/"><span>PromQL</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/query-persist/"><span>查询结果持久化</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/service-discovery/"><span>服务发现</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/indicators-remarked/"><span>指标重新打标</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/pushmanager/"><span>Pushmanager</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/prometheus/cluster-ha/"><span>集群与高可用</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Alertmanager</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/introduce/"><span>告警功能概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/alarm/"><span>实现告警功能</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/Monitor/alertmanager/ha/"><span>高可用架构</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/grafana/"><span>Grafana</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/Monitor/streaming/"><span>基于流处理的可观测性架构</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>CICD</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>Ansible</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/introduce/"><span>架构概述</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/deploy/"><span>部署与配置</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/command/"><span>相关命令</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/module/"><span>常用模块</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/CICD/ansible/playbook/"><span>PlayBook</span></a></li></ul></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>SRE</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/SRE/111/"><span>111</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Python</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>python基础</span></a></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>线性表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>列表</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>元组</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字符串</span></a></li></ul></li><!-- 二级目录（包含三级菜单）--><li class="menus_item_second"><span class="site-page group second"><span>哈希表</span><i class="fas fa-chevron-right"></i></span><ul class="menus_item_child_second"><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>封装与解构</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>集合</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>字典</span></a></li><!-- 三级菜单项--><li><a class="site-page third" href="/python/111/"><span>解析式与生成器表达式</span></a></li></ul></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>函数</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>IO操作</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>面向对象编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>并发编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>网络编程</span></a></li><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/python/111/"><span>数据库编程</span></a></li></ul></div><!-- 一级目录（包含二级菜单）--><div class="menus_item"><span class="site-page group"><span>Django</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><!-- 二级菜单项（非目录）--><li><a class="site-page child" href="/ELK/111/"><span>111</span></a></li></ul></div></div></div></div><!-- 右侧功能区域（新增容器）--><div id="nav-right-container"><!-- 搜索按钮（移动到右侧）--><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></span></div><!-- 移动端汉堡菜单按钮--><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">PromQL</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-27T10:16:50.000Z" title="发表于 2025-08-27 18:16">2025-08-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-12T09:32:17.572Z" title="更新于 2025-09-12 17:32">2025-09-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/monitor/">监控</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">56k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>3:24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1-时间序列数据"><a href="#1-时间序列数据" class="headerlink" title="1 时间序列数据"></a>1 时间序列数据</h1><p>时间序列数据是在一段时间内重复测量而获得的观测值的集合，即按照相同时序(相同的名字和标签)，以时间维度存储连续的数据的集合。然后将这些观测值绘制在图形中，它会有一个时间轴和数据轴。可以就是一个变量在不同时间点上的取值序列。</p>
<p>每一个观测值，即数据称为样本。时间序列的核心在于它记录的是随时间变化的数据点，每个数据点包含一个时间戳和对应的值。序列也称为向量，当多个序列数据放在同一个坐标系内时，就会形成一个由数据点组成的矩阵。</p>
<p><img src="/Monitor/prometheus/promql/18fbb41679dd4a978428db490cebeb44.png" alt="null"></p>
<h2 id="1-1-采集样本的数据格式"><a href="#1-1-采集样本的数据格式" class="headerlink" title="1.1 采集样本的数据格式"></a>1.1 采集样本的数据格式</h2><p>上游采集的指标样本数据，他们由两部分构成</p>
<ul>
<li>指标：指标名+标签</li>
<li>指标值</li>
</ul>
<p>指标名称：代表着监控目标上某类可测量属性的基本特征标识，支持使用字母、数字、下划线和冒号，且必须能匹配RE2规范的正则表达式；</p>
<p>标签：键值型数据，附加在指标名称之上，同一指标可能会适配到多个目标或设备，因而给指标再次细分的多个可测量维度，用于对同类 metric 进行分类，可选项</p>
<ul>
<li>可使用字母、数字和下划线，且必须能匹配RE2规范的正则表达式</li>
<li>以 <code>“__”</code> 为前缀的名称为Prometheus系统预留使用，是不会显示在 <code>/metrics</code> 页面里面的；<br>  <img src="/Monitor/prometheus/promql/0bf57e5454d5454a8de90f254588d672.png" alt="null"></li>
</ul>
<h2 id="1-2-时间序列模型"><a href="#1-2-时间序列模型" class="headerlink" title="1.2 时间序列模型"></a>1.2 时间序列模型</h2><p>Prometheus将这些指标样本数据以时间序列的方式保存在TSDB时序数据库，并且定时保存到硬盘上，这些样本在TSDB中是按照时间序列组成的，所以一个完整的样本的构成中必然需要挟带时间，他们由三部分构成</p>
<ul>
<li>指标：指标名+标签</li>
<li>时间戳(timestamp)：一个精确到毫秒的时间戳</li>
<li>样本值：一个 float64 的浮点型数据表示当前样本的值</li>
</ul>
<p><img src="/Monitor/prometheus/promql/1753422227977-c33f8bf0-2297-4496-b6d5-e5ace66ba2f8.png" alt="null"></p>
<p>所有这些指标都是 Prometheus 定期从 <code>/metrics</code> 接口那里采集过来的。采集的间隔时间的设置由prometheus.yaml 配置中的 scrape_interval 指定，如果<code>scrape_interval: 15s</code>，则意味着每 15 秒就会有一个带有新时间戳记录的新数据点</p>
<p>也就说对于同一个指标来说，prometheus会按照时间顺序存好它的一个个的值，因此我们可以将某一个指标按时间顺序存放的多个值称之为该指标的时间序列值，或者简称为时间序列，也称之为向量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">^</span><br><span class="line">│  . . . . . . . . . . . . . . . . . . node_cpu_seconds_total&#123;cpu=<span class="string">&quot;cpu0&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;</span><br><span class="line">│  . . . . . . . . . . . . . . . . . . node_cpu_seconds_total&#123;cpu=<span class="string">&quot;cpu0&quot;</span>,mode=<span class="string">&quot;system&quot;</span>&#125;</span><br><span class="line">│  . . . . . . . . . . . . . . . . . . node_load1&#123;&#125;</span><br><span class="line">│  . . . . . . . . . . . . . . . . . .</span><br><span class="line">v &lt;------------------ 时间 ----------------&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>横向的X轴是时间，纵向的Y轴是对应的值，这种按时间序列存放的值也称之为向量(vector)</li>
<li>选取X轴上的同一个时间点（精确到毫秒的时间戳），如上图所示你会发现同一时间节点，纵向的Y轴会有很多值，这些值分别对应不同的指标。</li>
</ul>
<h2 id="1-3-指标名称及标签使用注意事项"><a href="#1-3-指标名称及标签使用注意事项" class="headerlink" title="1.3 指标名称及标签使用注意事项"></a>1.3 指标名称及标签使用注意事项</h2><p>指标名称和标签的特定组合代表着一个时间序列；</p>
<ul>
<li>指标名称相同，但标签不同的组合分别代表着不同的时间序列；</li>
<li>不同的指标名称自然更是代表着不同的时间序列；</li>
</ul>
<p>PromQL支持<strong>基于定义的指标维度进行过滤和聚合</strong></p>
<ul>
<li>更改任何标签值，包括添加或删除标签，都会创建一个新的时间序列</li>
<li>应该尽可能地保持标签的稳定性，否则，则很可能创建新的时间序列，更甚者会生成一个动态的数据环境，并使得监控的数据源难以跟踪，从而导致建立在该指标之上的图形、告警及记录规则变得无效</li>
</ul>
<h1 id="2-PromQL概念"><a href="#2-PromQL概念" class="headerlink" title="2 PromQL概念"></a>2 PromQL概念</h1><p>PromQL (Prometheus Query Language)是Prometheus Server内置数据查询语言，基于PromQL表达式，用户可以针对指定的特征及其细分的纬度进行过滤、聚合、统计等运算从而产生期望的计算结果，进行实时的数据查询及聚合操作</p>
<ul>
<li>PromQL使用表达式（expression）来表述查询需求</li>
<li>根据其使用的指标和标签，以及时间范围，表达式的查询请求可灵活地覆盖在一个或多个时间序列的一定范围内的样本之上，甚至是只包含单个时间序列的单个样本</li>
</ul>
<p>PromQL支持处理两种向量，并内置提供了一组用于数据处理的函数</p>
<ul>
<li>即时向量：最近一次的时间戳上跟踪的数据指标；</li>
<li>时间范围向量：指定时间范围内的所有时间戳上的数据指标；</li>
</ul>
<h2 id="2-1-数据类型"><a href="#2-1-数据类型" class="headerlink" title="2.1 数据类型"></a>2.1 数据类型</h2><p>PromQL的表达式中支持4种数据类型</p>
<ul>
<li><p>即时向量（Instant Vector）：特定或全部的时间序列集合上，<strong>具有相同时间戳</strong>的一组样本值称为即时向量；表达式的返回值中只会包含该时间序列中的最新的一个样本值。简单来说，一个时间点的数据性能。</p>
<ul>
<li>查出的是一组&#x2F;多个时间序列值，但每一个时间序列值中只包含最新的一个样本值</li>
<li>实时查询：用于获取某个时间点的监控数据，这通常用于手动调试或故障排查</li>
<li>即时分析：用于实时的统计分析，如计算当前时刻各指标的平均值、最大值、最小值等</li>
<li>数据呈现：系统仪表板中展示当前的系统状态或最新的指标值</li>
</ul>
</li>
<li><p>范围向量（Range Vector）：特定或全部的时间序列集合上，在<strong>指定的同一时间范围内</strong>的所有样本值。简单来说，一段时间的数据性能值</p>
<ul>
<li><p>查出的也是一组&#x2F;多个时间序列值，但每一个时间序列包含的是一段时间范围内的样本数据</p>
</li>
<li><p>时间序列分析：用于计算一段时间内的性能指标，如速率、增量或者百分比变化，这对于趋势分析和历史数据分析非常有用</p>
</li>
<li><p>趋势监控：绘制一段时间内的指标变化曲线，帮助识别潜在问题或验证优化效果</p>
</li>
<li><p>聚合计算：对一段时间内的数据进行聚合操作，如计算总和、平均值等</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum_over_time(container_cpu_usage_seconds_total[1h]) <span class="comment"># 该查询表示每个容器在过去1小时内累计消耗的CPU时间总量</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>标量（Scalar）：一个浮点型的数据值，只有一个数字，没有时序。</p>
<ul>
<li>阈值对比：用于设置报警阈值，某个指标是否超过或低于某个值<ul>
<li><code>node_load1 &gt; 1</code></li>
</ul>
</li>
<li>数值计算：与瞬时向量、区间向量结合进行数值运算<ul>
<li><code>(node_memory_MemFree_bytes / node_memory_MemTotal_bytes) * 100</code></li>
</ul>
</li>
<li>聚合结果转换：使用 <code>scalar()</code> 函数可以将瞬时向量转换为标量<ul>
<li>确保返回单一数值，防止多值返回</li>
</ul>
</li>
</ul>
</li>
<li><p>字符串（String）：支持使用单引号、双引号或反引号进行引用，但反引号中不会对转义字符进行转义</p>
</li>
</ul>
<p><img src="/Monitor/prometheus/promql/c3ca69672a184db08307fd4ca4651908.png" alt="null"></p>
<p><code>scalar()</code>用法示例及解释</p>
<p>需求：将过去5分钟内，每个kubelet_http_requests_total 的速率与所有这些速率的平均值进行比较，留下超过平均值的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、没有使用scalar转换，查出结果为空</span></span><br><span class="line"><span class="comment"># 分析：因为rate(kubelet_http_requests_total[5m]) 和avg(rate(kubelet_http_requests_total[5m]))返回的类型不匹配。</span></span><br><span class="line">rate(kubelet_http_requests_total[5m]) &gt; avg(rate(kubelet_http_requests_total[5m]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2、使用scalar转换，可以正常查询</span></span><br><span class="line"><span class="comment"># 分析：在这个查询中，使用scalar将 avg(rate(kubelet_http_requests_total[5m]))强制转换为标量，确保类型匹配，因此能顺利执行。</span></span><br><span class="line">rate(kubelet_http_requests_total[5m]) &gt; scalar(avg(rate(kubelet_http_requests_total[5m])))</span><br></pre></td></tr></table></figure>

<h2 id="2-2-时间序列选择器"><a href="#2-2-时间序列选择器" class="headerlink" title="2.2 时间序列选择器"></a>2.2 时间序列选择器</h2><p>PromQL的查询操作需要针对有限个时间序列上的样本数据进行，挑选出目标时间序列是构建表达式时最为关键的一步</p>
<p>用户可使用向量选择器表达式来挑选出给定指标名称下的所有时间序列或部分时间序列的即时（当前）样本值或现在至过去某个时间范围内的样本值，前者称为即时向量选择器，后者称为范围向量选择器</p>
<h3 id="2-2-1-向量选择器表达式使用要点"><a href="#2-2-1-向量选择器表达式使用要点" class="headerlink" title="2.2.1 向量选择器表达式使用要点"></a>2.2.1 向量选择器表达式使用要点</h3><p>表达式的返回值类型亦是即时向量、范围向量、标题或字符串4种数据类型其中之一，但是，有些使用场景要求表达式返回值必须满足特定的条件，例如</p>
<ul>
<li>需要将返回值绘制成图形时，仅支持即时向量类型的数据；</li>
<li>对于诸如rate一类的速率函数来说，其要求使用的却又必须是范围向量型的数据；</li>
</ul>
<p>由于范围向量选择器的返回的是范围向量型数据，它不能用于表达式浏览器中图形绘制功能，否则，表达式浏览器会返回以下错误：<code>Error executing query: invalid expression type &quot;range vector&quot; for range query, must be Scalar or instant Vector</code> 。事实上，范围向量选择几乎总是结合速率类的函数rate一同使用</p>
<h3 id="2-2-2-即时向量选择器"><a href="#2-2-2-即时向量选择器" class="headerlink" title="2.2.2 即时向量选择器"></a>2.2.2 即时向量选择器</h3><h4 id="2-2-2-1-即时向量"><a href="#2-2-2-1-即时向量" class="headerlink" title="2.2.2.1 即时向量"></a>2.2.2.1 即时向量</h4><p>即时向量选择器（Instant Vector Selectors）：返回0个、1个或多个时间序列上在给定时间戳（instant）上的各自的一个样本，该样本也可称为即时样本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total</span><br><span class="line">http_requests_total&#123;job=<span class="string">&quot;prometheus&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>即时向量选择器由两部分组成；</p>
<ul>
<li>指标名称：用于限定特定指标下的时间序列，即负责过滤指标；可选；</li>
<li>匹配器（Matcher）：或称为标签选择器，用于过滤时间序列上的标签；定义在<code>&#123;&#125;</code>之中；可选；</li>
</ul>
<p>显然，定义即时向量选择器时，以上两个部分应该至少给出一个；于是，这将存在以下三种组合；</p>
<ul>
<li>仅给定指标名称，或在标签名称上使用了空值的匹配器：返回给定的指标下的所有时间序列各自的即时样本；<ul>
<li>例如 http_requests_total 和 <code>http_requests_total&#123;&#125;</code> 的功能相同，都是用于返回 http_requests_total 指标下各时间序列的即时样本；</li>
</ul>
</li>
<li>仅给定匹配器：返回所有符合给定的匹配器的所有时间序列上的即时样本；<ul>
<li>注意：这些时间序列可能会有着不同的指标名称；</li>
<li>例如， <code>&#123;job=&quot;.*&quot;, method=&quot;get&quot;&#125;</code></li>
</ul>
</li>
<li>指标名称和匹配器的组合：返回给定的指定下的，且符合给定的标签过滤器的所有时间序列上的即时样本；<ul>
<li>例如， <code>http_requests_total&#123;method=&quot;get&quot;&#125;</code></li>
</ul>
</li>
</ul>
<p>Prometheus会周期性的对Exporter的target进行Pull。我们查询最新的Metric信息，会返回距离服务器当前时间最近的采样点的Metric信息。</p>
<p><img src="/Monitor/prometheus/promql/1753692940473-fdd02f84-a335-42fa-b7bf-243c243180bc.png" alt="img"></p>
<h4 id="2-2-2-2-匹配器（Matcher）"><a href="#2-2-2-2-匹配器（Matcher）" class="headerlink" title="2.2.2.2 匹配器（Matcher）"></a>2.2.2.2 匹配器（Matcher）</h4><p>匹配器用于定义标签过滤条件，目前支持如下4种匹配操作符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">=	  <span class="comment">#选择与提供的字符串完全相等的标签。</span></span><br><span class="line">!=	<span class="comment">#选择不等于所提供字符串的标签</span></span><br><span class="line">=~	<span class="comment">#选择与提供的字符串正则表达式匹配的标签。</span></span><br><span class="line">!~	<span class="comment">#选择与提供的字符串不正则匹配的标签。</span></span><br></pre></td></tr></table></figure>

<p>注意事项</p>
<ul>
<li>匹配到空标签值的匹配器时，所有未定义该标签的时间序列同样符合条件；<ul>
<li>例如，<code>http_requests_total&#123;env= &quot;&quot;&#125;</code> ，则该指标名称上所有未使用该标签（env）的时间序列也符合条件，比如时间序列<code>http_requests_total&#123;method =&quot;get&quot;&#125;</code></li>
</ul>
</li>
<li>正则表达式将执行完全锚定机制，它需要匹配指定的标签的整个值；</li>
<li>向量选择器至少要包含一个指标名称，或者至少有一个不会匹配到空字符串的匹配器；<ul>
<li>例如，<code>&#123;job=&quot;&quot;&#125;</code> 为非法的选择器；</li>
</ul>
</li>
<li>使用 <code>“__name__”</code> 做为标签名称，还能够对指标名称进行过滤；<ul>
<li>例如，<code>&#123;__name__=~&quot;http_requests_.*&quot;&#125;</code> 能够匹配所有以 <code>“ http_requests_ ”</code> 为前缀的所有指标</li>
</ul>
</li>
</ul>
<h3 id="2-2-3-范围向量选择器"><a href="#2-2-3-范围向量选择器" class="headerlink" title="2.2.3 范围向量选择器"></a>2.2.3 范围向量选择器</h3><h4 id="2-2-3-1-范围向量"><a href="#2-2-3-1-范围向量" class="headerlink" title="2.2.3.1 范围向量"></a>2.2.3.1 范围向量</h4><p>范围向量选择器（Range Vector Selectors）：返回0个、1个或多个时间序列上在给定时间范围内的各自的一组样本；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total[5m]</span><br></pre></td></tr></table></figure>

<p>同即时向量选择器的唯一不同之处在于，范围向量选择器需要在表达式后紧跟一个方括号 [ ] 来表达需在时间时序上返回的样本所处的时间范围；</p>
<ul>
<li>时间范围：以当前时间为基准时间点，指向过去一个特定的时间长度；例如 [5m] 便是指过去5分钟之内；</li>
</ul>
<p>时间格式：一个整数后紧跟一个时间单位，例如“5m”中的“m”即是时间单位；</p>
<ul>
<li>可用的时间单位有ms（毫秒）、s（秒）、m（分钟）、h（小时）、d（天）、w（周）和y（年）;</li>
<li>必须使用整数时间，且能够将多个不同级别的单位进行串联组合，以时间单位由大到小为顺序，例如1h30m，但不能使用1.5h；</li>
</ul>
<p>需要注意的是，不管是即时向量还是范围向量，虽然不同时间序列的数据抓取时间点相同，但它们的时间戳并不会严格对齐</p>
<ul>
<li>Prometheus在同一轮查询中去同时拉取多个Target上的数据，但是为了以均衡Prometheus Server的负载，多个Target上的数据抓取需要分散在抓取时间点前后一定的时间范围内，那么就会导致不同时间序列的实际数据抓取时间点可能不会严格对齐；</li>
<li>例如，一个时间序列可能在某秒的第一毫秒采集了数据，而另一个时间序列则在同秒的最后毫秒采集了数据；</li>
<li>因而，Prometheus在趋势上准确，但并非绝对精准；</li>
</ul>
<p><img src="/Monitor/prometheus/promql/1753692953099-93b8432a-a8ff-4a08-b1b7-b470b0698e0e.png" alt="img"></p>
<h4 id="2-2-3-2-偏移量修改器"><a href="#2-2-3-2-偏移量修改器" class="headerlink" title="2.2.3.2 偏移量修改器"></a>2.2.3.2 偏移量修改器</h4><p>默认情况下，即时向量选择器和范围向量选择器都以当前时间为基准时间点，而偏移量修改器能够修改该基准；</p>
<p>偏移量修改器的使用方法是紧跟在选择器表达式之后使用“offset”关键字指定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#表示获取以http_requests_total为指标名称的所有时间序列在过去5分钟之时的即时样本</span></span><br><span class="line">http_requests_total offset 5m</span><br><span class="line"></span><br><span class="line"><span class="comment">#表示获取距此刻1天时间之前的5分钟之内的所有样本</span></span><br><span class="line">http_requests_total[5m] offset 1d</span><br></pre></td></tr></table></figure>

<h1 id="3-指标类型"><a href="#3-指标类型" class="headerlink" title="3 指标类型"></a>3 指标类型</h1><h2 id="3-1-Counter型指标及常用函数"><a href="#3-1-Counter型指标及常用函数" class="headerlink" title="3.1 Counter型指标及常用函数"></a>3.1 Counter型指标及常用函数</h2><p>计数器，单调递增，除非重置（例如服务器或进程重启）</p>
<ul>
<li>用于保存单调递增型的数据，例如站点访问次数等；不能为负值，也不支持减少，但可以重置回0；</li>
<li>需要做的是速率计算。比如网卡每秒发送包的速率，上一个时间点发送了9000字节，过了30秒，发送了9900字节，那么速率就是<code>(9900-9000)/30 = 30b/s</code></li>
</ul>
<p>通常，Counter的总数并没有直接作用，而是需要借助于rate、increase和irate等函数来生成样本数据的变化状况（增长率）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(nginx_http_requests_total[1m])</span><br></pre></td></tr></table></figure>

<ul>
<li>获取1分钟内，该指标各相关时间序列上的http总请求数的<strong>平均增长速率</strong>；</li>
<li>指定时间范围内的样本的<strong>最后一个样本值减去第一个样本值</strong>，而后除以这两个样本之间的间隔时长</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irate(nginx_http_requests_total[1m])</span><br></pre></td></tr></table></figure>

<ul>
<li>高灵敏度函数，用于计算指标的<strong>瞬时速率</strong></li>
<li>基于样本范围内的<strong>最后两个样本</strong>计算增长的速率，即最后一个样本减去其前面的一个样本，并除以间隔的时长</li>
<li>相较于rate函数来说，irate更适用于短期时间范围内的变化速率分析</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icrease(nginx_http_requests_total[1m])</span><br></pre></td></tr></table></figure>

<ul>
<li>计算指定时间范围内样本值的<strong>增加量</strong></li>
<li>可能会引用时间范围边界之前的样本值，以便于整个计算能覆盖指定的整个时间范围</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(3, kubelet_http_requests_total)</span><br></pre></td></tr></table></figure>

<ul>
<li>统计访问排名前3的http请求</li>
</ul>
<p><img src="/Monitor/prometheus/promql/d0564ae6196a4d0ead3aa804c544cc70.png" alt="null"></p>
<p>用Prometheus客户端库在Python中创建和增加一个计数器指标</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Counter</span><br><span class="line"></span><br><span class="line">api_requests_counter = Counter(</span><br><span class="line">    <span class="string">&#x27;http_requests_total&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Total number of http api requests&#x27;</span>,</span><br><span class="line">    [<span class="string">&#x27;api&#x27;</span>]</span><br><span class="line">)</span><br><span class="line">api_requests_counter.labels(api=<span class="string">&#x27;add_product&#x27;</span>).inc()</span><br></pre></td></tr></table></figure>

<h2 id="3-2-Gauge型指标及常用函数"><a href="#3-2-Gauge型指标及常用函数" class="headerlink" title="3.2 Gauge型指标及常用函数"></a>3.2 Gauge型指标及常用函数</h2><p>仪表盘，可增可减的数据（上下波动），用于表示瞬时值</p>
<ul>
<li>用于存储有着起伏特征的指标数据，例如当前内存使用量或 CPU 利用率等</li>
<li>Gauge是Counter的超集，但存在指标数据丢失的可能性，Counter能让用户确切了解指标随时间的变化状态，而Gauge则可能随时间流逝而精准度越来越低；</li>
</ul>
<p>所以经常用于进行求和、取平均值、最小值、最大值等聚合计算；也会经常结合PromQL的 predict_linear 和 delta 函数使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predict_linear(v range-vector, t, scalar)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>预测时间序列 v 在 t 秒后的值，它通过线性回归的方式来预测样本数据的Gauge变化趋势</p>
</li>
<li><p><code>predict_linear(node_filesystem_free_bytes[1h], 4 * 3600)</code></p>
</li>
<li><ul>
<li>基于过去 1 小时node_filesystem_free_bytes 指标的线性预测值，预测 4 小时后的磁盘可用空间</li>
</ul>
</li>
<li><p><code>predict_linear(node_filesystem_free_bytes&#123;kubernetes_io_hostname=&quot;master01&quot;, device=&quot;/dev/sda3&quot;&#125;[24h], 5 * 86400)</code></p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delta(v range-vector)</span><br></pre></td></tr></table></figure>

<ul>
<li>计算范围向量中每个时间序列上的第一个样本值与最后一个样本值之差</li>
<li>其计算结果与increase函数相同</li>
<li>返回具有给定增量和等效标签的即时向量</li>
<li>可以获取样本在一段时间范围内的变化情况</li>
<li><code>delta(http_requests_total[1h])</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idelta(v range-vector)</span><br></pre></td></tr></table></figure>

<ul>
<li>计算范围向量中每个时间序列上最后两个样本之差，返回具有给定增量和等效标签的即时向量</li>
</ul>
<p>范例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于2小时的样本数据，来预测主机可用磁盘空间在4个小时之后的剩余情况</span></span><br><span class="line">predict_linear(node_filesystem_free&#123;job=<span class="string">&quot;node&quot;</span>&#125;[2h], 4 * 3600) </span><br><span class="line"></span><br><span class="line"><span class="comment">#返回该服务器上的CPU温度与2小时之前的差异</span></span><br><span class="line">delta(cpu_temp_celsius&#123;host=<span class="string">&quot;server01.wu.com&quot;</span>&#125;[2h])</span><br><span class="line"></span><br><span class="line"><span class="comment">#JVM堆内存用量排名前三的时间序列</span></span><br><span class="line">topk(3, jvm_memory_bytes_used&#123;area=<span class="string">&quot;heap&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>使用Prometheus客户端库在Python中创建一个Gauge指标</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Gauge</span><br><span class="line"></span><br><span class="line">memory_used = Gauge(</span><br><span class="line">    <span class="string">&#x27;node_memory_used_bytes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Total memory used in the node in bytes&#x27;</span>,</span><br><span class="line">    [<span class="string">&#x27;hostname&#x27;</span>]</span><br><span class="line">)</span><br><span class="line">memory_used.labels(hostname=<span class="string">&#x27;host1.domain.com&#x27;</span>).<span class="built_in">set</span>(<span class="number">943348382</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3-3-Histogram直方数据与summary摘要"><a href="#3-3-Histogram直方数据与summary摘要" class="headerlink" title="3.3 Histogram直方数据与summary摘要"></a>3.3 Histogram直方数据与summary摘要</h2><h3 id="3-3-1-长尾问题"><a href="#3-3-1-长尾问题" class="headerlink" title="3.3.1 长尾问题"></a>3.3.1 长尾问题</h3><p>长尾问题：指的是大部分数据集中在某个较小范围内，但仍有一部分数据分布在远离中心的尾部。这些尾部的数据虽然数量少，但可能对整体分析产生重要影响，特别是在性能分析中。</p>
<p>例如，以系统的API调用的平均响应时间为例，如果大部分 API 请求的响应时间都在 100ms 左右，但有个别请求的响应时间达到了 5秒，这些极慢的请求会显著影响平均响应时间的统计结果，使得平均值不能真实反映大部分请求的体验。这种现象被称为长尾问题。</p>
<p>为了规避长尾问题的影响，单纯用平均值必然不行，为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组，例如，统计延迟在 0 ~ 10 ms 之间的请求数有多少，而 10 ~ 20 ms 之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因，所以prometheus引入了 Histogram 和 Summary 类型的指标来处理和分析长尾问题</p>
<h3 id="3-3-2-Histogram"><a href="#3-3-2-Histogram" class="headerlink" title="3.3.2 Histogram"></a>3.3.2 Histogram</h3><p>直方图，将指定时间范围内的样本数据值切分成不同时间的数据段，并评估出整体的样本个数及所有样本值之和，以便按需计算分位数，是一种对数据分布情况的图形表示。</p>
<ul>
<li>计算样本平均值：以值的总和除以值的数量；</li>
<li>计算样本分位值：分位数有助于了解符合特定标准的数据个数；例如评估响应时长超过1秒钟的请求比例，若超过20%即发送告警等；</li>
</ul>
<p>直方图将整个测量范围划分为一组区间，称为bucket(桶)，在一段时间范围内对数据进行采样，并将其计入可配置的bucket之中，由一系列高度不等的长条图（bar）或线段表示，用于展示单个测度的值的分布。所以直方图会存储包括样本值分布在每个bucket（bucket自身的可配置）中的数量、所有样本值之和以及总的样本数量。</p>
<ul>
<li>它一般用横轴表示某个指标维度的数据取值区间，用纵轴表示样本统计的频率或频数，从而能够以二维图的形式展现数值的分布状况</li>
<li>为了构建Histogram，首先需要将值的范围进行分段，即将所有值的整个可用范围分成一系列连续、相邻（相邻处可以是等同值）但不重叠的间隔，而后统计每个间隔中有多少值</li>
<li>捕捉长尾：通过设置更细的桶，你可以捕捉到那些延迟较长的请求，从而分析长尾问题。</li>
<li>从统计学的角度看，分位数不能被聚合，也不能进行算术运算</li>
</ul>
<p><img src="/Monitor/prometheus/promql/4b28db5042ba442f992b876028c5ec72.png" alt="null"></p>
<p>与常规方式略有不同的是，Prometheus取值间隔的划分采用的是累积（Cumulative）区间间隔机制，即每个bucket中的样本均包含了其前面所有bucket中的样本，因而也称为累积直方图，如下图，只有绿色部分才是每个区间真实的样本数据总数<br><img src="/Monitor/prometheus/promql/d8f09e22df8242c3a53c8ec4e9522212.png" alt="null"></p>
<p>Histogram类型的每个指标有一个基础指标名称 <code>&lt;basename&gt;</code> ，它会提供多个时间序列</p>
<ul>
<li><code>_bucket&#123;le=“&lt;上边界&gt;”&#125;</code> ：观测桶的上边界，即样本统计区间，表示样本值小于等于上边界的所有样本数量</li>
<li><code>_bucket&#123;le=“+Inf”&#125;</code> ：最大区间（包含所有样本）的样本数量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#观测桶的上边界（upper inclusive bound），即样本统计区间</span></span><br><span class="line"><span class="comment">#最大区间（包含所有样本）的名称为&lt;basename&gt;_bucket&#123;le=&quot;+Inf&quot;&#125;</span></span><br><span class="line">&lt;<span class="built_in">basename</span>&gt;_bucket&#123;le=<span class="string">&quot;&lt;upper inclusive bound&gt;&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#所有样本观测值的总和</span></span><br><span class="line">&lt;<span class="built_in">basename</span>&gt;_sum</span><br><span class="line"></span><br><span class="line"><span class="comment">#总的观测次数，它自身本质上是一个Counter类型的指标</span></span><br><span class="line">&lt;<span class="built_in">basename</span>&gt;_count</span><br></pre></td></tr></table></figure>

<p>如下直方图通过将观测值分组到不同的“桶”中来记录分布情况，每个桶有一个上限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http 请求响应时间 &lt;= 0.005 秒的请求次数为 10</span></span><br><span class="line">prometheus_http_request_duration_seconds_bucket&#123;handler=<span class="string">&quot;/metrics&quot;</span>,le=<span class="string">&quot;0.005&quot;</span>&#125; 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># http 请求响应时间 &lt;= 0.01 秒的请求次数为 15</span></span><br><span class="line">prometheus_http_request_duration_seconds_bucket&#123;handler=<span class="string">&quot;/metrics&quot;</span>,le=<span class="string">&quot;0.01&quot;</span>&#125; 15</span><br><span class="line"></span><br><span class="line"><span class="comment"># http 请求响应时间 &lt;= 0.025 秒的请求次数为 18</span></span><br><span class="line">prometheus_http_request_duration_seconds_bucket&#123;handler=<span class="string">&quot;/metrics&quot;</span>,le=<span class="string">&quot;0.025&quot;</span>&#125; 18</span><br><span class="line"></span><br><span class="line"><span class="comment"># http 请求响应时间 &lt;= 0.05 秒的请求次数为 18</span></span><br><span class="line">prometheus_http_request_duration_seconds_bucket&#123;handler=<span class="string">&quot;/metrics&quot;</span>,le=<span class="string">&quot;0.05&quot;</span>&#125; 18</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有请求的响应时间的总和，命名为 _sum</span></span><br><span class="line">prometheus_http_request_duration_seconds_sum&#123;handler=<span class="string">&quot;/metrics&quot;</span>&#125; 10.107670803000001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求总数，命名为 _count ，效果与 _bucket&#123;le=“+Inf”&#125; 相同</span></span><br><span class="line">prometheus_http_request_duration_seconds_count&#123;handler=<span class="string">&quot;/metrics&quot;</span>&#125; 20</span><br></pre></td></tr></table></figure>

<ul>
<li>从上述信息可以推断，在0.01秒到0.025秒之间的桶有3个额外的请求被计数（即18 - 15 &#x3D; 3），而在0.025秒到0.05秒之间没有新的请求被添加（因为两个桶的计数值都是18）。这表明最长的响应时间不超过0.025秒。</li>
<li>从服务启动以来的累计平均 HTTP 请求响应时间：<code>总时间/总数 = 10.107670803000001/20 = 0.50538354015s</code></li>
</ul>
<p>范例：基于单个时间序列（即特定的 <code>api</code> 和 <code>instance</code>），计算过去5分钟的HTTP请求平均响应时间（适合分析某个具体服务或实例的性能表现）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(http_request_duration_seconds_sum&#123;api=<span class="string">&quot;add_product&quot;</span>, instance=<span class="string">&quot;host1.domain.com&quot;</span>&#125;[5m]) / rate(http_request_duration_seconds_count&#123;api=<span class="string">&quot;add_product&quot;</span>, instance=<span class="string">&quot;host1.domain.com&quot;</span>&#125;[5m])</span><br></pre></td></tr></table></figure>

<p>范例：基于所有时间序列（即所有API和实例），计算过去5分钟的HTTP请求平均响应时间（适合分析整个系统的整体性能表现）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>(rate(http_request_duration_seconds_sum[5m])) / <span class="built_in">sum</span>(rate(http_request_duration_seconds_count[5m]))</span><br></pre></td></tr></table></figure>

<p>累积间隔机制生成的样本数据需要额外使用内置的 <code>histogram_quantile()</code> 函数，即可根据Histogram指标来计算相应的分位数（quantile），即根据某个分位数去求某个bucket的样本数在所有样本数中占据的该分位数的比例（某个bucket的样本数在所有样本数中占据的比例）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">histogram_quantile(φ scalar, b instant-vector)</span><br></pre></td></tr></table></figure>

<ul>
<li>基于histogram类型的样本数据计算 φ 分位数 (0 ≤ φ ≤ 1)</li>
<li>φ 为期望计算的分位数，例如0.9，或者0.99等</li>
<li>b 是histogram类型的时间序列，其指标名称通常为原指标名称后跟一个“_bucket”后缀</li>
<li>histogram_quantile() 函数在计算分位数时会假定每个区间内的样本满足线性分布状态，因而它的结果仅是一个预估值，并不完全准确</li>
<li>预估的准确度取决于bucket区间划分的粒度；粒度越大，准确度越低</li>
</ul>
<p>范例：这个值表示 99% 的 HTTP 请求的响应时间不超过 4.95 毫秒。换句话说，只有最慢的 1% 请求的响应时间超过了这个值，即这1%的请求是长尾，应该忽略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">histogram_quantile(</span><br><span class="line"> 0.99,</span><br><span class="line"> <span class="built_in">sum</span>(rate(kubelet_http_requests_duration_seconds_bucket[5m])) </span><br><span class="line"> by (le)</span><br><span class="line">) <span class="comment"># 假设结果为4.95毫秒</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>rate(kubelet_http_requests_duration_seconds_bucket[5m])</code>: 计算过去5分钟内每个桶的每秒请求增长的数量</li>
<li><code>sum(rate(...)) by (le)</code>：对所有实例的桶按 le 标签进行求和，得到每个桶的总请求速率，这里有很多请求速率，到底哪一个才是符合大多数情况的指标呢？往下看</li>
<li><code>histogram_quantile(0.99, ...)</code>：计算99%分位数，即99%请求的响应时间不超过的值，最终得到一个合理的请求速率</li>
<li>这个查询的目的是计算在过去 5 分钟内，99% 的 HTTP 请求的响应时间不超过的最大值。通过汇总所有实例的请求数据，并计算 99% 分位数，你可以了解绝大多数请求的响应时间性能，而不受极端值的影响。</li>
</ul>
<p>总结：Histogram 通过将样本数据分段（buckets），统计每个段内的样本数量，使得可以清楚地看到各个范围内的请求分布。这样可以精确地了解不同延迟范围的请求数量，从而判断出是否存在长尾问题</p>
<p>使用Prometheus的Python客户端库创建一个带有自定义桶的直方图指标</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Histogram</span><br><span class="line"></span><br><span class="line">api_request_duration = Histogram(</span><br><span class="line">    name=<span class="string">&#x27;http_request_duration_seconds&#x27;</span>,</span><br><span class="line">    documentation=<span class="string">&#x27;Api requests response time in seconds&#x27;</span>,</span><br><span class="line">    labelnames=[<span class="string">&#x27;api&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>],</span><br><span class="line">    buckets=(<span class="number">0.01</span>, <span class="number">0.025</span>, <span class="number">0.05</span>, <span class="number">0.1</span>, <span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">1</span>, <span class="number">2.5</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">25</span>)</span><br><span class="line">)</span><br><span class="line">api_request_duration.labels(</span><br><span class="line">    api=<span class="string">&#x27;add_product&#x27;</span>,</span><br><span class="line">    instance=<span class="string">&#x27;host1.domain.com&#x27;</span></span><br><span class="line">).observe(<span class="number">0.3672</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-3-3-Summary"><a href="#3-3-3-Summary" class="headerlink" title="3.3.3 Summary"></a>3.3.3 Summary</h3><p>摘要，Histogram的扩展类型，但它是直接由被监控端自行聚合计算出分位数，即客户端会直接计算并上报分位数，并将计算结果响应给Prometheus Server的样本采集请求，所以Summary统计的不是区间的个数而是统计分位数；不支持sum或avg一类的聚合运算，而且其分位数由客户端计算并生成，Server端无法获取客户端未定义的分位数。</p>
<p>对于每个指标，Summary以指标名称 <code>&lt;basename&gt;</code> 为前缀，生成如下几个个指标序列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;basename&gt;&#123;quantile=&quot;&lt;φ&gt;&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>其中φ是分位点，其取值范围是(<code>0 ≤ φ ≤ 1</code>)；计数器类型指标；如下是几种典型的常用分位点；</p>
<ul>
<li>0、0.25、0.5、0.75和1几个分位点</li>
<li>0.5、0.9和0.99几个分位点</li>
<li>0.01、0.05、0.5、0.9和0.99几个分位点</li>
</ul>
<p>也提供了 _sum 和 _count 指标，像直方图一样，可用于计算随时间的平均值以及不同时间序列的平均值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#抓取到的所有样本值之和</span></span><br><span class="line">&lt;<span class="built_in">basename</span>&gt;_sum</span><br><span class="line"></span><br><span class="line"><span class="comment">#抓取到的所有样本总数</span></span><br><span class="line">&lt;<span class="built_in">basename</span>&gt;_count</span><br></pre></td></tr></table></figure>

<p>范例：测量在host1.domain.com上运行的add_productAPI端点实例的响应时间的Summary指标</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http_request_duration_seconds_sum&#123;api=<span class="string">&quot;add_product&quot;</span> instance=<span class="string">&quot;host1.domain.com&quot;</span>&#125; 8953.332</span><br><span class="line">http_request_duration_seconds_count&#123;api=<span class="string">&quot;add_product&quot;</span> instance=<span class="string">&quot;host1.domain.com&quot;</span>&#125; 27892</span><br><span class="line">http_request_duration_seconds&#123;api=<span class="string">&quot;add_product&quot;</span> instance=<span class="string">&quot;host1.domain.com&quot;</span> quantile=<span class="string">&quot;0&quot;</span>&#125;</span><br><span class="line">http_request_duration_seconds&#123;api=<span class="string">&quot;add_product&quot;</span> instance=<span class="string">&quot;host1.domain.com&quot;</span> quantile=<span class="string">&quot;0.5&quot;</span>&#125; 0.232227334</span><br><span class="line">http_request_duration_seconds&#123;api=<span class="string">&quot;add_product&quot;</span> instance=<span class="string">&quot;host1.domain.com&quot;</span> quantile=<span class="string">&quot;0.90&quot;</span>&#125; 0.821139321</span><br><span class="line">http_request_duration_seconds&#123;api=<span class="string">&quot;add_product&quot;</span> instance=<span class="string">&quot;host1.domain.com&quot;</span> quantile=<span class="string">&quot;0.95&quot;</span>&#125; 1.528948804</span><br><span class="line">http_request_duration_seconds&#123;api=<span class="string">&quot;add_product&quot;</span> instance=<span class="string">&quot;host1.domain.com&quot;</span> quantile=<span class="string">&quot;0.99&quot;</span>&#125; 2.829188272</span><br><span class="line">http_request_duration_seconds&#123;api=<span class="string">&quot;add_product&quot;</span> instance=<span class="string">&quot;host1.domain.com&quot;</span> quantile=<span class="string">&quot;1&quot;</span>&#125; 34.283829292</span><br></pre></td></tr></table></figure>

<p>上面这个例子包括 sum 和 count 以及五个分位数。分位数0相当于最小值，分位数1相当于最大值。分位数0.5是中位数，分位数0.90、0.95和0.99相当于在 host1.domain.com 上运行的 add_product API 端点响应时间的第90、95和99个百分位。</p>
<p>在分布式系统中使用Summary不合适。假设有 10 台服务器提供 <code>add_product</code> 接口服务，每台服务器独立收集请求延迟数据，并使用Summary指标计算百分位数（如 P99），Prometheus 分别采集每台机器的指标。问题就在于分位数不能合并，因为它是非线性统计量，每台机器的 P99 是独立计算的，直接对他们平均没有意义，因为不知道每台机器实际处理了多少请求、请求分布是怎样的，最终是无法知道整个系统的实际P99延迟，只能看到局部的情况</p>
<p>总结：Summary预先计算和暴露请求的百分位值（如 50%, 90%, 99% 百分位），提供实时的延迟分布情况，从而快速指示长尾现象。</p>
<h3 id="3-3-4-Histogram-与-Summary-的比较"><a href="#3-3-4-Histogram-与-Summary-的比较" class="headerlink" title="3.3.4 Histogram 与 Summary 的比较"></a>3.3.4 Histogram 与 Summary 的比较</h3><p>Histgram由于是在服务端集成的所有数据，所以可以对所有数据进行计算，也就可以对所有实例的数据进行聚合，最终得出分位数，反映出整体系统的情况；而Summary是在客户端计算的分位数，然后上报给Prometheus并保存在数据库，所以服务端只有每个实例的分位数数据，直接对不同实例上报的分位数取平均值并不能得到整体系统的实际分位数，因为忽略了每台实例的实际请求分布情况</p>
<table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>Histogram（直方图）</strong></th>
<th><strong>Summary（摘要）</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>采集方式</strong></td>
<td>客户端记录原始观测值，服务端统计分位数</td>
<td>客户端直接计算分位数并上报</td>
</tr>
<tr>
<td><strong>数据结构</strong></td>
<td>记录观测值落入不同 bucket 的计数</td>
<td>直接保存 count、sum、quantile 数据</td>
</tr>
<tr>
<td><strong>聚合能力</strong></td>
<td>✅ 可以对多个实例进行聚合后计算整体分位数</td>
<td>❌ 不能跨实例聚合</td>
</tr>
<tr>
<td><strong>计算位置</strong></td>
<td>Prometheus 服务端计算分位数</td>
<td>客户端自己计算分位数</td>
</tr>
<tr>
<td><strong>延迟 vs 精度</strong></td>
<td>延迟略高，但精度可控</td>
<td>实时快，但无法准确聚合</td>
</tr>
</tbody></table>
<h1 id="4-PromQL表达式"><a href="#4-PromQL表达式" class="headerlink" title="4 PromQL表达式"></a>4 PromQL表达式</h1><h2 id="4-1-聚合函数和聚合表达式"><a href="#4-1-聚合函数和聚合表达式" class="headerlink" title="4.1 聚合函数和聚合表达式"></a>4.1 聚合函数和聚合表达式</h2><p>一般说来，单个指标的价值不大，监控场景中往往需要联合并可视化一组指标，这种联合机制即是指“聚合”操作，例如，将计数、求和、平均值、分位数、标准差及方差等统计函数应用于时间序列的样本之上生成具有统计学意义的结果等；</p>
<p>对查询结果事先按照某种分类机制进行分组（groupby）并将查询结果按组进行聚合计算也是较为常见的需求，例如分组统计、分组求平均值、分组求和等；</p>
<p>聚合操作由聚合函数针对一组值进行计算并返回单个值或少量几值作为结果</p>
<ul>
<li>Prometheus内置提供的11个聚合函数也称为聚合运算符</li>
<li>这些运算符仅支持应用于<strong>单个即时向量</strong>的元素，其返回值也是具有少量元素的新向量或标量</li>
<li>这些聚合运行符既可以基于向量表达式返回结果中的时间序列的所有标签维度进行分组聚合，也可以仅基于指定的标签维度分组后再进行分组聚合</li>
</ul>
<h3 id="4-1-1-聚合表达式"><a href="#4-1-1-聚合表达式" class="headerlink" title="4.1.1 聚合表达式"></a>4.1.1 聚合表达式</h3><p>PromQL中的聚合操作语法格式可采用如下面两种格式之一</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label <span class="built_in">list</span>&gt;)]</span><br><span class="line">&lt;aggr-op&gt; [without|by (&lt;label <span class="built_in">list</span>&gt;)] ([parameter,] &lt;vector expression&gt;)</span><br></pre></td></tr></table></figure>

<p>分组聚合：先分组、后聚合</p>
<ul>
<li>without：从结果向量中删除由without子句指定的标签，未指定的那部分标签则用作分组标准；</li>
<li>by：功能与without刚好相反，它仅使用by子句中指定的标签进行聚合，结果向量中出现但未被by子句指定的标签则会被忽略；</li>
</ul>
<p>为了保留上下文信息，使用by子句时需要显式指定其结果中原本出现的 job、instance等一类的标签，事实上，各函数工作机制的不同之处也仅在于计算操作本身，PromQL对于它们的执行逻辑相似</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每台主机CPU在最近5分钟内的平均使用率  avg(...) by (instance)</span></span><br><span class="line">(1 - avg(rate(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[5m])) by (instance)) * 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个实例的1分钟平均负载是否超过了动态生成的阈值（2 * CPU核心数）</span></span><br><span class="line">node_load1 &gt; on (instance) 2 * count (node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;) by (instance)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算主机内存使用率，可用内存空间：空闲内存、buffer、cache 指标之和</span></span><br><span class="line">(node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算K8s所有node节点的所有容器内存使用量（以 GB 为单位）  KB -&gt; MB -&gt; GB</span></span><br><span class="line"><span class="built_in">sum</span> by (instance) (container_memory_usage_bytes&#123;instance=~<span class="string">&quot;node*&quot;</span>&#125;) / 1024 / 1024 / 1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算最近 1m 所有容器 cpu 使用率</span></span><br><span class="line"><span class="built_in">sum</span> by (<span class="built_in">id</span>) (rate(container_cpu_usage_seconds_total&#123;<span class="built_in">id</span>!=<span class="string">&quot;/&quot;</span>&#125;[1m]))</span><br></pre></td></tr></table></figure>

<h3 id="4-1-2-11个聚合函数"><a href="#4-1-2-11个聚合函数" class="headerlink" title="4.1.2 11个聚合函数"></a>4.1.2 11个聚合函数</h3><p>其他更多内置函数参考官网：<a href="https://prometheus.io/docs/prometheus/latest/querying/functions/">Prometheus_Function</a></p>
<table>
<thead>
<tr>
<th>聚合函数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>sum()</td>
<td>对样本值求和</td>
</tr>
<tr>
<td>avg()</td>
<td>对样本值求平均值，这是进行指标数据分析的标准方法</td>
</tr>
<tr>
<td>count()</td>
<td>对分组内的时间序列进行数量统计</td>
</tr>
<tr>
<td>stddev()</td>
<td>对样本值求标准差，以帮助用户了解数据的波动大小（或称之为波动程度）</td>
</tr>
<tr>
<td>stdvar()</td>
<td>对样本值求方差，它是求取标准差过程中的中间状态</td>
</tr>
<tr>
<td>min()</td>
<td>求取样本值中的最小者</td>
</tr>
<tr>
<td>max()</td>
<td>求取样本值中的最大者</td>
</tr>
<tr>
<td>topk()</td>
<td>逆序返回分组内的样本值最大的前k个时间序列及其值</td>
</tr>
<tr>
<td>bottomk ( )</td>
<td>顺序返回分组内的样本值最小的前k个时间序列及其值</td>
</tr>
<tr>
<td>quantile ( )</td>
<td>分位数用于评估数据的分布状态，该函数会返回分组内指定的分位数的值，即数值落在小于 等于指定的分位区间的比例</td>
</tr>
<tr>
<td>count_values ( )</td>
<td>对分组内的时间序列的样本值进行数量统计</td>
</tr>
</tbody></table>
<h2 id="4-2-二元运算符"><a href="#4-2-二元运算符" class="headerlink" title="4.2 二元运算符"></a>4.2 二元运算符</h2><p>PromQL支持基本的算术运算和逻辑运算，这类运算支持使用操作符连接两个操作数，因而也称为二元运算符或二元操作符；</p>
<ul>
<li>支持的运算<ul>
<li>两个标量间运算；</li>
<li>即时向量和标量间的运算：将运算符应用于向量上的每个样本；</li>
<li>两个即时向量间的运算：遵循向量匹配机制；</li>
</ul>
</li>
<li>将运算符用于两个即时向量间的运算时，可基于向量匹配模式（Vector Matching）定义其运算机制；</li>
</ul>
<h3 id="4-2-1-算术运算符"><a href="#4-2-1-算术运算符" class="headerlink" title="4.2.1 算术运算符"></a>4.2.1 算术运算符</h3><p>+（加）、-（减）、*（乘）、&#x2F;（除）、%（取模）和 ^（幂运算）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看Prometheus的HTTP响应字节总和（以MB为单位）</span></span><br><span class="line">prometheus_http_response_size_bytes_sum/8/1024</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取内存可用率</span></span><br><span class="line">node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100</span><br></pre></td></tr></table></figure>

<h3 id="4-2-2-比较运算符"><a href="#4-2-2-比较运算符" class="headerlink" title="4.2.2 比较运算符"></a>4.2.2 比较运算符</h3><p>&#x3D;&#x3D;（等值比较）、!&#x3D;（不等）、&gt;、&lt;、&gt;&#x3D; 和 &lt;&#x3D;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询每个接口的请求次数超过20次的，value为1。不符合条件的数据，value为0</span></span><br><span class="line">prometheus_http_requests_total &gt; bool 20</span><br><span class="line"></span><br><span class="line"><span class="comment">#待监测域名的监测code比200小，或者code大于等于400，返回1</span></span><br><span class="line">probe_http_status_code &lt;= bool 199 or probe_http_status_code &gt;= bool 400</span><br></pre></td></tr></table></figure>

<h3 id="4-2-3-逻辑运算符"><a href="#4-2-3-逻辑运算符" class="headerlink" title="4.2.3 逻辑运算符"></a>4.2.3 逻辑运算符</h3><p>and（并且）、or（或者）和unless（除了）</p>
<p>目前，该运算仅允许在两个即时向量间进行，尚不支持标量参与运算</p>
<p>举例说明</p>
<ul>
<li>and（并且）：vector1 and vector2 进行一个与操作，会产生一个新的集合。该集合中的元素同时在 vector1 和 vector2 中都存在。例如：我们有 vector1 为 A B C，vector2 为 B C D，那么 vector1 and vector2 的结果为：B C</li>
<li>or（或者）：vector1 and vector2 进行一个或操作，会产生一个新的集合。该集合中包含 vector1 和 vector2 中的所有元素。例如：我们有 vector1 为 A B C，vector2 为 B C D，那么 vector1 or vector2 的结果为：A B C D</li>
<li>unless（除了）：vector1 and vector2 进行一个或操作，会产生一个新的集合。该集合首先取 vector1 集合的所有元素，然后排除掉所有在 vector2 中存在的元素。例如：我们有 vector1 为 A B C，vector2 为 B C D，那么 vector1 unless vector2 的结果为：A</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#仅显示user和system的node节点CPU使用率结果</span></span><br><span class="line">node_cpu_seconds_total&#123;mode=~<span class="string">&quot;idle|user|system&quot;</span>&#125; and node_cpu_seconds_total&#123;mode=~<span class="string">&quot;user|system|iowait&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示四种mode的node节点CPU使用率</span></span><br><span class="line">node_cpu_seconds_total&#123;mode=~<span class="string">&quot;idle|user|system&quot;</span>&#125; or node_cpu_seconds_total&#123;mode=~<span class="string">&quot;user|system|iowait&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#仅显示idle的性能检测数据</span></span><br><span class="line">node_cpu_seconds_total&#123;mode=~<span class="string">&quot;idle|user|system&quot;</span>&#125; unless node_cpu_seconds_total&#123;mode=~<span class="string">&quot;user|system|iowait&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-向量匹配"><a href="#4-3-向量匹配" class="headerlink" title="4.3 向量匹配"></a>4.3 向量匹配</h2><p>在标量和即时向量之间使用运算符可以满足很多需求，但是在两个即时向量之间使用运算符时，哪些样本应该适用于哪些其他样本？这种瞬时向量的匹配称为向量匹配。即时向量间运算时，PromQL为会左侧向量中的每个元素在右侧向量中找到匹配的元素，其匹配行为有两种基本类型</p>
<ul>
<li>一对一 （One-to-One）</li>
<li>一对多或多对一 （Many-to-One, One-to-Many）</li>
</ul>
<p>向量与向量之间的运算，意味着两个向量必须具有“相同的标签”，且对应的“标签值也必须完全相同”</p>
<h3 id="4-3-1-向量一对一匹配"><a href="#4-3-1-向量一对一匹配" class="headerlink" title="4.3.1 向量一对一匹配"></a>4.3.1 向量一对一匹配</h3><p>即时向量的一对一匹配</p>
<ul>
<li>从运算符的两边表达式所获取的即时向量间依次比较，并找到唯一匹配（标签完全一致）的样本值</li>
<li>找不到匹配项的值则不会出现在结果中</li>
<li>在操作符两边表达式标签不一致的情况下，可以使用 <code>on(labe1 list)</code> 或者 <code>ignoring(label list)</code> 来修改便签的匹配行为</li>
</ul>
<p>匹配表达式语法：<code>&lt;vector expr&gt; &lt;bin-op&gt; on|ignoring(&lt;label list&gt;) &lt;vector expr&gt;</code></p>
<ul>
<li>ignoring：定义匹配检测时要忽略的标签</li>
<li>on：定义匹配检测时只使用的标签</li>
</ul>
<p>范例：查询 HTTP 单个错误的监控数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例输入</span></span><br><span class="line">method_code:http_errors:rate5m&#123;method=<span class="string">&quot;get&quot;</span>, code=<span class="string">&quot;500&quot;</span>&#125; 24</span><br><span class="line">method_code:http_errors:rate5m&#123;method=<span class="string">&quot;get&quot;</span>, code=<span class="string">&quot;404&quot;</span>&#125; 30</span><br><span class="line">method_code:http_errors:rate5m&#123;method=<span class="string">&quot;put&quot;</span>, code=<span class="string">&quot;501&quot;</span>&#125; 3</span><br><span class="line">method_code:http_errors:rate5m&#123;method=<span class="string">&quot;post&quot;</span>, code=<span class="string">&quot;500&quot;</span>&#125; 6</span><br><span class="line">method_code:http_errors:rate5m&#123;method=<span class="string">&quot;post&quot;</span>, code=<span class="string">&quot;404&quot;</span>&#125; 21</span><br><span class="line"></span><br><span class="line">method:http_requests:rate5m&#123;method=<span class="string">&quot;get&quot;</span>&#125; 600</span><br><span class="line">method:http_requests:rate5m&#123;method=<span class="string">&quot;del&quot;</span>&#125; 34</span><br><span class="line">method:http_requests:rate5m&#123;method=<span class="string">&quot;post&quot;</span>&#125; 120</span><br></pre></td></tr></table></figure>

<p>比如我们想要计算使用GET方法中出现500错误的占比是多少</p>
<p>理想的计算公式是： GET请求出现500错误的总数 &#x2F; 总的GET请求数 * 100 &#x3D; GET请求出现500错误所占的比例</p>
<p>但由于两个向量的标签不完全相同（一个有code标签，一个没有），因此无法直接进行计算</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例查询</span></span><br><span class="line">method_code:http_errors:rate5m&#123;code=<span class="string">&quot;500&quot;</span>&#125; / ignoring(code) method:http_requests:rate5m</span><br></pre></td></tr></table></figure>

<p>使用 <code>ignoring(code)</code> 后，可以计算出以下比例</p>
<ul>
<li><code>&#123;method=&quot;get&quot;&#125;    0.04</code></li>
<li><code>&#123;method=&quot;post&quot;&#125;  0.05</code></li>
</ul>
<h3 id="4-3-2-向量一对多-多对一匹配"><a href="#4-3-2-向量一对多-多对一匹配" class="headerlink" title="4.3.2 向量一对多&#x2F;多对一匹配"></a>4.3.2 向量一对多&#x2F;多对一匹配</h3><p>多对一和一对多的匹配模式，可以理解为向量元素中的一个样本数据匹配到了多个样本数据标签</p>
<ul>
<li>“一” 侧的每个元素，可与“多”侧的多个元素进行匹配；</li>
<li>必须使用 group_left 或 group_right 明确指定哪侧为“多”侧；</li>
</ul>
<p>多对一和一对多两种模式一定是出现在操作符两侧表达式返回的向量标签不一致的情况。因此也需要使用 ignoring 和 on 修饰符来排除或者限定匹配的标签列表。</p>
<p>匹配表达式语法：<code>&lt;vector expr&gt; &lt;bin-op&gt; on|ignoring(&lt;label list&gt;) group_right|group_left(&lt;label list&gt;) &lt;vector expr&gt;</code></p>
<ul>
<li>group_left：用于在连接操作时保留左侧向量的所有时间序列，即使右侧向量中没有匹配的时间序列。如果右侧没有匹配的时间序列，则结果中的对应字段将为空</li>
<li>group_right：与 group_left 相反</li>
</ul>
<p>范例：查询 HTTP 全部错误的监控数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例查询</span></span><br><span class="line">method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m</span><br></pre></td></tr></table></figure>

<p>返回一个结果向量，包含每个 HTTP 方法在过去的 5 分钟内出现请求错误的比例</p>
<ul>
<li><code>&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125; 0.04</code>  </li>
<li><code>&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  0.05</code></li>
<li><code>&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 0.05</code></li>
<li><code>&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 0.175</code></li>
</ul>
<h1 id="5-Prometheus-API中使用PromQL"><a href="#5-Prometheus-API中使用PromQL" class="headerlink" title="5 Prometheus API中使用PromQL"></a>5 Prometheus API中使用PromQL</h1><h2 id="5-1-API响应格式"><a href="#5-1-API响应格式" class="headerlink" title="5.1 API响应格式"></a>5.1 API响应格式</h2><p>Prometheus当前稳定的HTTP API可以通过 <code>/api/v1</code> 访问</p>
<p>Prometheus API使用了JSON格式的响应内容。 当API调用成功后将会返回2xx的HTTP状态码。 反之，当API调用失败时可能返回以下几种不同的HTTP状态码：</p>
<ul>
<li>404 Bad Request:当参数错误或者缺失时。</li>
<li>422 Unprocessable Entity 当表达式无法执行时。</li>
<li>503 Service Unavailiable 当请求超时或者被中断时。</li>
</ul>
<p>所有的API请求均使用以下的JSON格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span> | <span class="string">&quot;error&quot;</span><span class="punctuation">,</span>  <span class="comment">// 请求状态</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> &lt;data&gt;<span class="punctuation">,</span>  <span class="comment">// 实际返回的数据</span></span><br><span class="line">  <span class="attr">&quot;errorType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;string&gt;&quot;</span><span class="punctuation">,</span>  <span class="comment">// 错误类型</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;string&gt;&quot;</span>  <span class="comment">// 错误描述信息</span></span><br><span class="line">  <span class="attr">&quot;warnings&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;string&gt;&quot;</span>  <span class="comment">// 警告信息（可选，如查询语法存在不影响执行的警告）</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2-在HTTP-API中使用PromQL"><a href="#5-2-在HTTP-API中使用PromQL" class="headerlink" title="5.2 在HTTP API中使用PromQL"></a>5.2 在HTTP API中使用PromQL</h2><p>通过HTTP API我们可以分别通过 <code>/api/v1/query</code> 和 <code>/api/v1/query_range</code> 查询PromQL表达式当前或者一定时间范围内的计算结果。</p>
<h3 id="5-2-1-即时数据查询"><a href="#5-2-1-即时数据查询" class="headerlink" title="5.2.1 即时数据查询"></a>5.2.1 即时数据查询</h3><p>通过使用query API我们可以查询PromQL在特定时间点下的计算结果</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET  /api/v1/query</span><br></pre></td></tr></table></figure>

<p>URL请求参数</p>
<ul>
<li>query &#x3D;: PromQL表达式。</li>
<li>time &#x3D;: 用于指定用于计算PromQL的时间戳。可选参数，默认情况下使用当前系统时间。</li>
<li>timeout &#x3D;: 超时设置。可选参数，默认情况下使用全局设置。</li>
</ul>
<p>例如使用以下表达式查询表达式up在时间点 2015-07-01T20:10:51.781Z 的计算结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;http://localhost:9090/api/v1/query?query=up&amp;time=2015-07-01T20:10:51.781Z&#x27;</span></span><br></pre></td></tr></table></figure>

<p>当API调用成功后，Prometheus会返回JSON格式的响应内容，并且在data节点中返回查询结果。data节点格式如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resultType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;matrix&quot;</span> | <span class="string">&quot;vector&quot;</span> | <span class="string">&quot;scalar&quot;</span> | <span class="string">&quot;string&quot;</span><span class="punctuation">,</span>  <span class="comment">// 数据类型</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> &lt;value&gt;  <span class="comment">// 实际数据数组，value是一个瞬时值</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>vector</code></td>
<td>瞬时向量，表示某一时刻的指标快照（如 <code>http_requests_total</code> 当前值）。</td>
</tr>
<tr>
<td><code>matrix</code></td>
<td>范围向量，表示一段时间内的指标变化（需搭配 <code>query_range</code> API 使用）。</td>
</tr>
<tr>
<td><code>scalar</code></td>
<td>标量值（如 <code>count(http_requests_total)</code> 返回的单个数值）。</td>
</tr>
<tr>
<td><code>string</code></td>
<td>字符串值（如 <code>time()</code> 返回的时间字符串）。</td>
</tr>
</tbody></table>
<h3 id="5-2-2-范围数据查询"><a href="#5-2-2-范围数据查询" class="headerlink" title="5.2.2 范围数据查询"></a>5.2.2 范围数据查询</h3><p>通过使用 query_range API 我们可以查询PromQL在一段时间内下的计算结果</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET  /api/v1/query_range</span><br></pre></td></tr></table></figure>

<p>URL请求参数</p>
<ul>
<li>query &#x3D;: PromQL表达式。</li>
<li>start &#x3D;: 起始时间。</li>
<li>end &#x3D;: 结束时间。</li>
<li>step &#x3D;: 查询步长。</li>
<li>timeout &#x3D;: 超时设置。可选参数，默认情况下使用全局设置。</li>
</ul>
<p>当使用QUERY_RANGE API查询PromQL表达式时，返回结果一定是一个范围向量。</p>
<p>需要注意的是，在QUERY_RANGE API中PromQL只能使用瞬时向量选择器类型的表达式</p>
<p>例如使用以下表达式查询表达式up在30秒范围内以15秒为间隔计算PromQL表达式的结果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;http://localhost:9090/api/v1/query_range?query=up&amp;start=2015-07-01T20:10:30.781Z&amp;end=2015-07-01T20:11:00.781Z&amp;step=15s&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;resultType&quot;</span>: <span class="string">&quot;matrix&quot;</span> | <span class="string">&quot;vector&quot;</span> | <span class="string">&quot;scalar&quot;</span> | <span class="string">&quot;string&quot;</span>,  // 数据类型</span><br><span class="line">    <span class="string">&quot;result&quot;</span>: &lt;value&gt;  // 范围值数组（时间戳 + 值）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://AquaPluto.github.io">Aquarius</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://aquapluto.github.io/Monitor/prometheus/promql/">https://aquapluto.github.io/Monitor/prometheus/promql/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://AquaPluto.github.io" target="_blank">代码推演录</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Prometheus/">Prometheus</a></div><div class="post-share"><div class="social-share" data-image="/img/paper1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/Monitor/prometheus/query-persist/" title="查询结果持久化"><img class="cover" src="/img/paper3.png" onerror="onerror=null;src='/img/error-page.png'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">查询结果持久化</div></div><div class="info-2"><div class="info-item-1">1 为什么需要查询结果持久化在Pr...</div></div></div></a><a class="pagination-related" href="/Monitor/prometheus/exporter/" title="Exporter"><img class="cover" src="/img/paper4.png" onerror="onerror=null;src='/img/error-page.png'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Exporter</div></div><div class="info-2"><div class="info-item-1">1 Exporter基础Expor...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/Monitor/prometheus/indicators-remarked/" title="指标重新打标"><img class="cover" src="/img/paper5.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-27</div><div class="info-item-2">指标重新打标</div></div><div class="info-2"><div class="info-item-1">1 指标抓取的生命周期发现 -&g...</div></div></div></a><a class="pagination-related" href="/Monitor/prometheus/cluster-ha/" title="集群与高可用"><img class="cover" src="/img/paper5.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="info-item-2">集群与高可用</div></div><div class="info-2"><div class="info-item-1">1 Prometheus的本地存储...</div></div></div></a><a class="pagination-related" href="/Monitor/prometheus/deploy/" title="部署与配置"><img class="cover" src="/img/paper6.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-27</div><div class="info-item-2">部署与配置</div></div><div class="info-2"><div class="info-item-1">1 使用包管理器Rocky&#x2...</div></div></div></a><a class="pagination-related" href="/Monitor/prometheus/pushmanager/" title="使用Pushmanager实现跨机房采集"><img class="cover" src="/img/paper1.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-12</div><div class="info-item-2">使用Pushmanager实现跨机房采集</div></div><div class="info-2"><div class="info-item-1">1 场景介绍跨机房监控服务器时，网...</div></div></div></a><a class="pagination-related" href="/Monitor/prometheus/introduce/" title="prometheus概述"><img class="cover" src="/img/paper2.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-27</div><div class="info-item-2">prometheus概述</div></div><div class="info-2"><div class="info-item-1">1 Prometheus概述Pro...</div></div></div></a><a class="pagination-related" href="/Monitor/prometheus/query-persist/" title="查询结果持久化"><img class="cover" src="/img/paper3.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-27</div><div class="info-item-2">查询结果持久化</div></div><div class="info-2"><div class="info-item-1">1 为什么需要查询结果持久化在Pr...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avator.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Aquarius</div><div class="author-info-description">分享运维开发相关技术</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">138</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" href="https://github.com/AquaPluto"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/AquaPluto" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://blog.csdn.net/m0_75233142" target="_blank" title="CSDN"><i class="fa-solid fa-code" style="color: #8a2be2;"></i></a><a class="social-icon" href="mailto:wujunlinq@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><p>持续更新文章中，有问题请添加wx</p>
<div>
  <img src="/img/wx.jpg" alt="wx" style="width: 100px">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE"><span class="toc-text">1 时间序列数据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E9%87%87%E9%9B%86%E6%A0%B7%E6%9C%AC%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-text">1.1 采集样本的数据格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%A8%A1%E5%9E%8B"><span class="toc-text">1.2 时间序列模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E6%8C%87%E6%A0%87%E5%90%8D%E7%A7%B0%E5%8F%8A%E6%A0%87%E7%AD%BE%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">1.3 指标名称及标签使用注意事项</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-PromQL%E6%A6%82%E5%BF%B5"><span class="toc-text">2 PromQL概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">2.1 数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-text">2.2 时间序列选择器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E5%90%91%E9%87%8F%E9%80%89%E6%8B%A9%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%BD%BF%E7%94%A8%E8%A6%81%E7%82%B9"><span class="toc-text">2.2.1 向量选择器表达式使用要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E5%8D%B3%E6%97%B6%E5%90%91%E9%87%8F%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-text">2.2.2 即时向量选择器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-1-%E5%8D%B3%E6%97%B6%E5%90%91%E9%87%8F"><span class="toc-text">2.2.2.1 即时向量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-2-%E5%8C%B9%E9%85%8D%E5%99%A8%EF%BC%88Matcher%EF%BC%89"><span class="toc-text">2.2.2.2 匹配器（Matcher）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E8%8C%83%E5%9B%B4%E5%90%91%E9%87%8F%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-text">2.2.3 范围向量选择器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-1-%E8%8C%83%E5%9B%B4%E5%90%91%E9%87%8F"><span class="toc-text">2.2.3.1 范围向量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-2-%E5%81%8F%E7%A7%BB%E9%87%8F%E4%BF%AE%E6%94%B9%E5%99%A8"><span class="toc-text">2.2.3.2 偏移量修改器</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B"><span class="toc-text">3 指标类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Counter%E5%9E%8B%E6%8C%87%E6%A0%87%E5%8F%8A%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-text">3.1 Counter型指标及常用函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Gauge%E5%9E%8B%E6%8C%87%E6%A0%87%E5%8F%8A%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-text">3.2 Gauge型指标及常用函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Histogram%E7%9B%B4%E6%96%B9%E6%95%B0%E6%8D%AE%E4%B8%8Esummary%E6%91%98%E8%A6%81"><span class="toc-text">3.3 Histogram直方数据与summary摘要</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E9%95%BF%E5%B0%BE%E9%97%AE%E9%A2%98"><span class="toc-text">3.3.1 长尾问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-Histogram"><span class="toc-text">3.3.2 Histogram</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-Summary"><span class="toc-text">3.3.3 Summary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-Histogram-%E4%B8%8E-Summary-%E7%9A%84%E6%AF%94%E8%BE%83"><span class="toc-text">3.3.4 Histogram 与 Summary 的比较</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-PromQL%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">4 PromQL表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0%E5%92%8C%E8%81%9A%E5%90%88%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">4.1 聚合函数和聚合表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E8%81%9A%E5%90%88%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">4.1.1 聚合表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-11%E4%B8%AA%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-text">4.1.2 11个聚合函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E4%BA%8C%E5%85%83%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">4.2 二元运算符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">4.2.1 算术运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">4.2.2 比较运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">4.2.3 逻辑运算符</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%90%91%E9%87%8F%E5%8C%B9%E9%85%8D"><span class="toc-text">4.3 向量匹配</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E5%90%91%E9%87%8F%E4%B8%80%E5%AF%B9%E4%B8%80%E5%8C%B9%E9%85%8D"><span class="toc-text">4.3.1 向量一对一匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E5%90%91%E9%87%8F%E4%B8%80%E5%AF%B9%E5%A4%9A-%E5%A4%9A%E5%AF%B9%E4%B8%80%E5%8C%B9%E9%85%8D"><span class="toc-text">4.3.2 向量一对多&#x2F;多对一匹配</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Prometheus-API%E4%B8%AD%E4%BD%BF%E7%94%A8PromQL"><span class="toc-text">5 Prometheus API中使用PromQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-API%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F"><span class="toc-text">5.1 API响应格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E5%9C%A8HTTP-API%E4%B8%AD%E4%BD%BF%E7%94%A8PromQL"><span class="toc-text">5.2 在HTTP API中使用PromQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-%E5%8D%B3%E6%97%B6%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2"><span class="toc-text">5.2.1 即时数据查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-%E8%8C%83%E5%9B%B4%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2"><span class="toc-text">5.2.2 范围数据查询</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/role/" title="Role角色"><img src="/img/paper4.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="Role角色"/></a><div class="content"><a class="title" href="/CICD/ansible/role/" title="Role角色">Role角色</a><time datetime="2025-09-13T10:07:53.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/playbook/" title="PlayBook"><img src="/img/paper6.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="PlayBook"/></a><div class="content"><a class="title" href="/CICD/ansible/playbook/" title="PlayBook">PlayBook</a><time datetime="2025-09-13T10:07:48.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/module/" title="常用模块"><img src="/img/paper2.jpg" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="常用模块"/></a><div class="content"><a class="title" href="/CICD/ansible/module/" title="常用模块">常用模块</a><time datetime="2025-09-13T10:07:42.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/command/" title="相关命令"><img src="/img/paper1.jpg" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="相关命令"/></a><div class="content"><a class="title" href="/CICD/ansible/command/" title="相关命令">相关命令</a><time datetime="2025-09-13T10:07:38.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD/ansible/deploy/" title="部署与配置"><img src="/img/paper4.png" onerror="this.onerror=null;this.src='/img/error-page.png'" alt="部署与配置"/></a><div class="content"><a class="title" href="/CICD/ansible/deploy/" title="部署与配置">部署与配置</a><time datetime="2025-09-13T10:07:29.000Z" title="发表于 2025-09-13 18:07">2025-09-13</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Aquarius</span></div><div class="footer_custom_text"><style>
div#runtime {
  font-size: 13px;
  font-weight: bold;
}

div#ghbdages_list {
  height: 1.5rem;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 10px
}

.github-badge {
  display: flex;
  align-items: center;
  margin-inline: 6px;
}
</style>
<div id="runtime"></div>
<div id="ghbdages"></div>
<script>
  function createtime() {
    const now = new Date();
    const grt = new Date("08/01/2025 00:00:00"); // 网站诞生时间

    // 计算天、小时、分钟和秒
    const days = Math.floor((now - grt) / (1000 * 60 * 60 * 24));
    const hours = Math.floor(((now - grt) / (1000 * 60 * 60)) % 24)
      .toString()
      .padStart(2, "0");
    const minutes = Math.floor(((now - grt) / (1000 * 60)) % 60)
      .toString()
      .padStart(2, "0");
    const seconds = Math.floor(((now - grt) / 1000) % 60)
      .toString()
      .padStart(2, "0");

    // HTML 输出
    const currentTimeHtml = `
          <div>
              本站已运行 ${days} 天 ${hours} 小时 ${minutes} 分 ${seconds} 秒 
          </div>`;

    const runtime = document.getElementById("runtime");
    if (runtime) runtime.innerHTML = currentTimeHtml;
  }

  // 设置每秒调用函数
  setInterval(createtime, 1000);

  function renderBadge() {
    const currentTimeHtml = `
      <div id="ghbdages_list">
          <a class="github-badge" target="_blank" href="https://hexo.io/" title="hexo:7.3.0">
              <img src="https://img.shields.io/badge/Frame-Hexo-blue?logo=hexo" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://github.com/" title="github">
              <img src="https://img.shields.io/badge/Code-GitHub-181717?logo=GitHub&color=%23FF7102" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://vercel.com/" title="vercel">
              <img src="https://img.shields.io/badge/Host-Vercel-%23F0D722?logo=Vercel" alt="Static Badge">
          </a>
          <a class="github-badge" target="_blank" href="https://analytics.sysio.ai/" title="umami">
              <img src="https://img.shields.io/badge/Analytics-Umami-%237FB100?logo=umami&logoColor=%237FB100" alt="Static Badge">
          </a>
      </div>`;

    const ghbdages = document.getElementById("ghbdages");
    if (ghbdages) {
      ghbdages.innerHTML = currentTimeHtml;
    }
  }

  window.onload = renderBadge;
</script>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/instant.page/instantpage.js" type="module"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://unpkg.com/mathjax/es5/tex-mml-chtml.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'forest'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://unpkg.com/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://cdn.jsdelivr.net/gh/xiabo2/CDN@latest/fishes.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://unpkg.com/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章..." type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>